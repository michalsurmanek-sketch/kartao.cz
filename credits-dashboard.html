<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kartao.cz ‚Äì Kreditn√≠ syst√©m</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { 
      theme: {
        extend: {
          colors: {
            fuchsia: tailwind.colors.fuchsia,
            amber: tailwind.colors.amber,
            neutral: tailwind.colors.neutral,
            emerald: tailwind.colors.emerald,
            sky: tailwind.colors.sky,
            rose: tailwind.colors.rose
          },
          boxShadow: {
            soft: "0 18px 45px rgba(15,23,42,0.85)"
          }
        }
      }
    };
  </script>

  <!-- Ikony - unified system -->
  <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>

  <!-- Pozad√≠ ‚Äì modro-ƒçern√Ω p≈ôechod -->
  <style>
    body {
      background:
        radial-gradient(circle at 60% 140%, rgba(14,165,233,0.55) 0%, rgba(2,6,23,0.90) 40%, #020617 90%),
        linear-gradient(to bottom right, #020617 65%, #0ea5e9 120%);
    }
  </style>
</head>
<body class="min-h-screen text-white">
  <!-- HLAVIƒåKA -->
  <header class="sticky top-0 z-30 border-b border-white/10 bg-neutral-950/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <a href="moje-karta.html" class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-2xl bg-gradient-to-tr from-fuchsia-500 to-amber-400 grid place-items-center shadow-soft">
          <i data-lucide="crown" class="w-5 h-5"></i>
        </div>
        <div>
          <div class="flex items-center gap-2">
            <span class="font-semibold text-lg">Kartao.cz</span>
            <span class="px-2 py-0.5 rounded-full text-xs bg-emerald-500/15 text-emerald-300 border border-emerald-400/40">Kreditn√≠ z√≥na</span>
          </div>
          <p class="text-xs text-white/60">K-Coins ¬∑ gamifikace pro tv≈Ørce</p>
        </div>
      </a>
      <div class="flex items-center gap-3">
        <div class="flex items-center gap-3">
          <!-- Aktu√°ln√≠ kredity -->
          <div class="hidden sm:flex items-center gap-1.5 rounded-2xl border border-amber-400/50 bg-amber-400/10 px-3 py-1.5">
            <span class="text-[11px] uppercase tracking-wide text-amber-200">K-Coins</span>
            <span id="currentCredits" class="text-sm font-semibold text-amber-100">0</span>
          </div>

          <!-- Zpƒõt ‚Äì zat√≠m zakomentovan√©
          <a
            href="credits-dashboard.html"
            class="inline-flex items-center gap-2 rounded-2xl border border-sky-500/60 bg-sky-500/10 px-3 py-1.5 text-xs font-medium text-sky-100 hover:bg-sky-500/20"
          >
            ‚Üê Zpƒõt na kredity
          </a>
          -->
        </div>

        <button id="topupTestButton" class="inline-flex items-center gap-2 px-3 sm:px-4 py-1.5 rounded-full bg-gradient-to-r from-fuchsia-500 to-amber-400 text-sm font-medium shadow-soft">
          <i data-lucide="shopping-bag" class="w-4 h-4"></i>
          <span>Dob√≠t kredity</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Drobeƒçkov√° navigace -->
  <nav class="max-w-6xl mx-auto px-4 py-3 text-sm text-white/60 flex items-center gap-2">
    <a href="index.html" class="hover:text-white transition">Dom≈Ø</a>
    <span>/</span>
    <span class="text-white">Kreditn√≠ syst√©m</span>
  </nav>

  <main class="max-w-6xl mx-auto px-4 py-8 space-y-8">
    <!-- HERO -->
    <section class="rounded-3xl border border-white/10 bg-neutral-950/80 p-6 shadow-soft text-center">
      <h1 class="text-3xl font-semibold mb-2">Kreditn√≠ syst√©m <span class="text-amber-300">K-Coins</span></h1>
      <p class="text-white/70 max-w-xl mx-auto mb-6">
        Pl≈à √∫koly, dokonƒçuj kampanƒõ a z√≠sk√°vej kredity. Za kredity m≈Ø≈æe≈° kupovat VIP, zv√Ωraznƒõn√≠ profilu,
        mystery boxy a dal≈°√≠ bonusy.
      </p>

      <div class="grid sm:grid-cols-3 gap-4 max-w-3xl mx-auto">
        <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
          <p class="text-xs text-white/60">Kredity</p>
          <p class="text-2xl font-semibold text-amber-300">
            <span id="creditsValueHero">0</span>
          </p>
        </div>
        <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
          <p class="text-xs text-white/60">Streak</p>
          <p class="text-2xl font-semibold text-emerald-300">
            <span id="streakValue">0</span> dn√≠
          </p>
        </div>
        <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
          <p class="text-xs text-white/60">Level</p>
          <p class="text-2xl font-semibold text-fuchsia-300">
            <span id="levelValue">1</span>
          </p>
        </div>
      </div>
    </section>

    <!-- REKLAMN√ç ODMƒöNY -->
    <section class="rounded-3xl border border-amber-400/30 bg-amber-500/5 p-6 shadow-soft">
      <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
        <i data-lucide="play" class="w-5 h-5 text-amber-300"></i>
        Reklamn√≠ odmƒõny
      </h2>

      <p class="text-white/70 text-sm mb-4 max-w-2xl">
        Sleduj kr√°tk√© reklamy (cca 10 sekund) a z√≠skej okam≈æit√© kredity.
        Ka≈æd√° reklama d√°v√° <span class="text-amber-300 font-semibold">+4 K-Coins</span>.
        Limit je 5 reklam dennƒõ (max. 20 K-Coins).
      </p>

      <div class="rounded-2xl bg-white/5 border border-white/10 p-4 flex items-center justify-between gap-4 flex-col sm:flex-row">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-amber-400/20 flex items-center justify-center">
            <i data-lucide="play-circle" class="w-6 h-6 text-amber-300"></i>
          </div>
          <div>
            <p class="font-medium text-sm">Sleduj reklamu a z√≠skej kredity</p>
            <p class="text-xs text-white/60">Limit: 5 reklam dennƒõ ¬∑ 20 K-Coins maxim√°lnƒõ</p>
          </div>
        </div>
        <button id="watchAdButton" class="px-4 py-2 rounded-xl bg-gradient-to-r from-amber-400 to-fuchsia-500 font-semibold text-neutral-900 text-sm shadow-soft w-full sm:w-auto">
          Spustit reklamu
        </button>
      </div>

      <div id="adStatus" class="mt-4 text-xs text-white/70 flex items-center justify-between gap-3 flex-col sm:flex-row">
        <span id="adMessage">P≈ôipraveno ke spu≈°tƒõn√≠ reklamy.</span>
        <span id="adCounter" class="text-amber-300">Dnes: 0 / 5</span>
      </div>

      <div class="mt-2 flex justify-end">
        <button id="resetAdsButton" class="text-[11px] text-white/40 hover:text-white underline underline-offset-2">
          Resetovat denn√≠ limit (test)
        </button>
      </div>

      <!-- OVERLAY S VIDEEM -->
      <div id="adOverlay" class="fixed inset-0 z-50 bg-neutral-950/95 backdrop-blur-sm flex flex-col items-center justify-center p-4 gap-4 hidden">
        <div class="w-full max-w-5xl">
          <div class="relative w-full rounded-2xl overflow-hidden bg-black shadow-soft border border-white/10">
            <video id="adVideo" class="w-full h-auto max-h-[90vh] object-contain" muted playsinline>
              <source id="adSrc" src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4" />
            </video>

            <!-- Odpoƒçet -->
            <div class="absolute top-4 right-4 flex items-center gap-2 px-3 py-2 rounded-full bg-neutral-950/80 border border-amber-300/70 shadow-soft text-xs">
              <div class="w-5 h-5 rounded-full border-2 border-amber-300 border-t-transparent animate-spin"></div>
              <div class="text-right">
                <p class="font-medium text-white/90">Reklama bƒõ≈æ√≠‚Ä¶</p>
                <p class="text-[11px] text-white/70"><span id="adCountdown">10</span></p>
              </div>
            </div>

            <!-- Dal≈°√≠ / Zav≈ô√≠t -->
            <button id="nextAdButton" class="hidden absolute bottom-4 right-4 flex items-center gap-2 px-3 py-2 rounded-full bg-neutral-950/80 border border-amber-300/70 shadow-soft text-xs text-amber-300 font-medium">
              <i data-lucide="skip-forward" class="w-4 h-4 text-amber-300"></i>
              <span>Dal≈°√≠ reklama</span>
            </button>
          </div>
        </div>

        <!-- OVL√ÅDAC√ç PANEL VIDEA -->
        <div id="adControlPanel" class="flex items-center gap-3 mt-2">
          <button id="adMuteToggle" class="px-3 py-1.5 rounded-full bg-white/10 border border-white/20 text-xs text-white flex items-center gap-1">
            <i data-lucide="volume-2" class="w-4 h-4"></i>
            Zvuk
          </button>
          <button id="adPauseToggle" class="px-3 py-1.5 rounded-full bg-white/10 border border-white/20 text-xs text-white flex items-center gap-1">
            <i data-lucide="pause" class="w-4 h-4"></i>
            Zastavit
          </button>
          <button id="adCloseButton" class="px-3 py-1.5 rounded-full bg-red-500/80 text-neutral-900 text-xs flex items-center gap-1">
            <i data-lucide="x" class="w-4 h-4"></i>
            Zav≈ô√≠t
          </button>
        </div>
      </div>
    </section>

    <!-- DENN√ç √öKOLY -->
    <section id="dailyTasksSection" class="rounded-3xl border border-white/10 bg-neutral-950/80 p-6 shadow-soft">
      <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
        <i data-lucide="list-checks" class="w-5 h-5 text-amber-300"></i>
        Denn√≠ √∫koly
      </h2>
      <ul class="space-y-3 text-sm">
        <!-- P≈ôihl√°≈°en√≠ ‚Äì v≈ædy splnƒõno, proto≈æe bez loginu se sem nedostane -->
        <li class="flex items-center justify-between p-3 rounded-xl bg-white/5 border border-white/10">
          <span>P≈ôihlas se dnes</span>
          <span class="text-emerald-300 text-xs flex items-center gap-1">
            +2 <i data-lucide="coins" class="w-3 h-3"></i>
            <span class="text-emerald-300 text-[11px] font-medium ml-2">Splnƒõno ‚úì</span>
          </span>
        </li>

        <!-- Aktualizuj statistiky -->
        <li id="taskStats" class="flex items-center justify-between p-3 rounded-xl bg-white/5 border border-white/10 cursor-pointer">
          <span>Aktualizuj statistiky</span>
          <span id="taskStatsBadge" class="text-red-400 text-xs flex items-center gap-1">
            +5 <i data-lucide="coins" class="w-3 h-3"></i>
          </span>
        </li>

        <!-- Odpovƒõz na kampa≈à -->
        <li id="taskCampaign" class="p-3 rounded-xl bg-white/5 border border-white/10 cursor-pointer">
          <div class="flex items-center justify-between gap-2">
            <span>Odpovƒõz na kampa≈à</span>
            <span id="taskCampaignBadge" class="text-red-400 text-xs flex items-center gap-1">
              +6 <i data-lucide="coins" class="w-3 h-3"></i>
            </span>
          </div>
          <!-- Rozbalen√° nab√≠dka dvou kampan√≠ -->
          <div id="campaignList" class="mt-3 hidden w-full text-xs text-white/80 space-y-2">
            <div class="rounded-xl border border-white/10 bg-white/5 p-3 flex items-start justify-between gap-3">
              <div>
                <p class="font-semibold text-sm">Kampa≈à #1 ‚Äì Produktov√° spolupr√°ce</p>
                <p class="text-[11px] text-white/60">Story + 1 feed post ¬∑ rozpoƒçet 3 000 Kƒç</p>
              </div>
              <button class="campaign-respond px-3 py-1.5 rounded-full bg-emerald-500/90 text-neutral-900 text-[11px] font-semibold">
                Odpovƒõdƒõt
              </button>
            </div>
            <div class="rounded-xl border border-white/10 bg-white/5 p-3 flex items-start justify-between gap-3">
              <div>
                <p class="font-semibold text-sm">Kampa≈à #2 ‚Äì Uveden√≠ nov√©ho e-shopu</p>
                <p class="text-[11px] text-white/60">Reels + swipe up ¬∑ barter + odmƒõna</p>
              </div>
              <button class="campaign-respond px-3 py-1.5 rounded-full bg-emerald-500/90 text-neutral-900 text-[11px] font-semibold">
                Odpovƒõdƒõt
              </button>
            </div>
          </div>
        </li>

        <!-- Karta Mystery Boxu -->
        <a
          href="mystery-box.html"
          class="group relative overflow-hidden rounded-3xl border border-amber-400/40 bg-gradient-to-br from-neutral-950 via-sky-950 to-amber-900/40 p-4 shadow-soft flex flex-col gap-2 hover:brightness-110 transition"
        >
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="inline-flex items-center gap-2 px-2 py-0.5 rounded-full bg-amber-400/15 border border-amber-300/40 text-[11px] text-amber-100">
                Mystery Box
                <span class="uppercase tracking-wide text-[10px] text-amber-200">Novinka</span>
              </div>
              <h3 class="mt-2 text-sm font-semibold text-white">
                K-Coins Mystery Box
              </h3>
              <p class="mt-1 text-xs text-sky-100/80">
                Vymƒõ≈à 30 K-Coins za ≈°anci z√≠skat a≈æ +50 K-Coins, VIP den nebo slevu 10 %.
              </p>
            </div>
            <div class="w-12 h-12 rounded-2xl bg-gradient-to-tr from-sky-500 to-amber-400 flex items-center justify-center shadow-lg shadow-amber-500/60">
              <span class="text-xl font-extrabold text-neutral-950"> üéÅ </span>
            </div>
          </div>

          <!-- MINI HISTORIE V√ùHER (jen n√°hled) -->
          <div
            id="mysteryBoxMiniHistory"
            class="mt-3 pt-2 border-t border-amber-400/30 text-[11px] text-amber-50/85 hidden"
          >
            <p class="mb-1 text-[11px] text-amber-100/80">
              Posledn√≠ v√Ωhry z Mystery Boxu:
            </p>
            <ul id="mysteryBoxMiniHistoryList" class="space-y-0.5"></ul>
          </div>
        </a>

        <!-- Sleduj kr√°tkou reklamu -->
        <li id="taskWatchAd" class="flex items-center justify-between p-3 rounded-xl bg-white/5 border border-white/10">
          <span class="flex items-center gap-2">
            <i data-lucide="play-circle" class="w-4 h-4 text-amber-300"></i>
            <span>Sleduj kr√°tkou reklamu (10 s)</span>
          </span>
          <span id="taskWatchAdBadge" class="text-red-400 text-xs flex flex-col items-end gap-0.5">
            <span class="inline-flex items-center gap-1">+4 <i data-lucide="coins" class="w-3 h-3"></i></span>
            <span class="text-[10px] text-white/60">Max. 5√ó dennƒõ</span>
            <span id="taskWatchAdDone" class="hidden text-[11px] font-medium mt-0.5">Splnƒõno ‚úì</span>
            <span id="adCooldown" class="hidden text-[11px] text-white/60">Dal≈°√≠ reklamy za 24:00:00</span>
          </span>
        </li>
      </ul>
    </section>

    <!-- ODMƒöNY ZA KREDITY -->
    <section class="rounded-3xl border border-white/10 bg-neutral-950/80 p-6 shadow-soft">
      <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
        <i data-lucide="gift" class="w-5 h-5 text-fuchsia-300"></i>
        Odmƒõny za kredity
      </h2>
      <div class="grid sm:grid-cols-2 gap-4">
        <div class="rounded-xl border border-amber-400/40 bg-amber-500/10 p-4 text-sm">
          <p class="font-semibold mb-1">Zv√Ωraznƒõn√≠ karty</p>
          <p class="text-xs text-white/70 mb-2">24 hodin top pozice v Marketplace.</p>
          <span class="inline-flex items-center gap-1 bg-neutral-950/40 px-2 py-1 rounded-full text-amber-300 text-xs">
            40 <i data-lucide="coins" class="w-3 h-3"></i>
          </span>
        </div>
        <div class="rounded-xl border border-fuchsia-400/40 bg-fuchsia-500/10 p-4 text-sm">
          <p class="font-semibold mb-1">VIP profil 7 dn√≠</p>
          <p class="text-xs text-white/70 mb-2">Lep≈°√≠ pozice &amp; VIP styl.</p>
          <span class="inline-flex items-center gap-1 bg-neutral-950/40 px-2 py-1 rounded-full text-fuchsia-300 text-xs">
            300 <i data-lucide="coins" class="w-3 h-3"></i>
          </span>
        </div>
      </div>
    </section>
  </main>

  <footer class="border-t border-white/10 text-center text-white/50 py-4 text-xs">
    ¬© 2025 Kartao.cz ‚Äì Kreditn√≠ syst√©m K-Coins
  </footer>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Konfigurace + jednotn√° inicializace -->
  <script src="supabase-config.js"></script>
  <script src="supabase-init.js"></script>
  <script src="supabase-compatibility.js"></script>
  <script src="auth-supabase.js"></script>
  <script src="auth-header.js"></script>

  <!-- Dal≈°√≠ inicializace (pokud m√°≈°) -->
  <script src="database-init.js"></script>

  <!-- Centr√°ln√≠ kreditn√≠ syst√©m -->
  <script src="credits-system-supabase.js"></script>
  <script src="credits-header.js"></script>

  <!-- Dashboard JS + kontrola p≈ôihl√°≈°en√≠ + STREAK + LEVEL + REKLAMY -->
  <script>
    document.addEventListener("DOMContentLoaded", async function () {
      if (window.lucide) {
        window.lucide.createIcons();
      }

      // Pou≈æij centr√°ln√≠ Supabase client
      const supabase = window.supabaseClient || window.sb;

      try {
        // Kontrola p≈ôihl√°≈°en√≠
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        
        if (authError || !user) {
          console.warn('‚ùå U≈æivatel nen√≠ p≈ôihl√°≈°en, p≈ôesmƒõrov√°n√≠ na login');
          window.location.href = 'login.html';
          return;
        }

        console.log('‚úÖ P≈ôihl√°≈°en√Ω u≈æivatel:', user.email);
        window.currentUserId = user.id;

        // Naƒçten√≠ creator dat
        const { data: creator, error: creatorError } = await supabase
          .from('creators')
          .select('*')
          .eq('id', user.id)
          .single();

        if (creatorError) {
          console.error('‚ùå Chyba naƒç√≠t√°n√≠ creator dat:', creatorError);
          
          if (creatorError.code === 'PGRST116') {
            alert('Nejprve mus√≠≈° vytvo≈ôit svoji kartu!');
            window.location.href = 'zalozit-kartu.html';
          }
          return;
        }

        if (creator) {
          console.log('üìä Creator data naƒçtena:', { name: creator.name, credits: creator.credits });
          
          // Aktualizuj zobrazen√≠ kredit≈Ø
          const currentCreditsEl = document.getElementById('currentCredits');
          if (currentCreditsEl) {
            currentCreditsEl.textContent = (creator.credits || 0).toLocaleString('cs-CZ');
          }

          // Inicializuj dashboard s creator daty
          await initDashboard(creator, user, supabase);
        }
      } catch (error) {
        console.error('üí• Kritick√° chyba:', error);
        alert('Chyba p≈ôi naƒç√≠t√°n√≠ str√°nky. Zkus to pros√≠m znovu.');
      }

      async function initDashboard(creator, user, supabase) {
        const streakValueEl        = document.getElementById("streakValue");
        const levelValueEl         = document.getElementById("levelValue");

        const watchAdButton        = document.getElementById("watchAdButton");
        const adOverlay            = document.getElementById("adOverlay");
        const adCountdownSpan      = document.getElementById("adCountdown");
        const adMessage            = document.getElementById("adMessage");
        const adCounter            = document.getElementById("adCounter");
        const adVideo              = document.getElementById("adVideo");
        const adSrc                = document.getElementById("adSrc");
        const nextAdButton         = document.getElementById("nextAdButton");
        const resetButton          = document.getElementById("resetAdsButton");

        const adCloseButton        = document.getElementById("adCloseButton");
        const adPauseToggle        = document.getElementById("adPauseToggle");
        const adMuteToggle         = document.getElementById("adMuteToggle");

        const taskStatsItem        = document.getElementById("taskStats");
        const taskStatsBadge       = document.getElementById("taskStatsBadge");
        const taskCampaignItem     = document.getElementById("taskCampaign");
        const taskCampaignBadge    = document.getElementById("taskCampaignBadge");
        const campaignList         = document.getElementById("campaignList");
        const taskWatchAdBadge     = document.getElementById("taskWatchAdBadge");
        const taskWatchAdDone      = document.getElementById("taskWatchAdDone");
        const campaignRespondButtons = document.querySelectorAll(".campaign-respond");
        const dailyTasksSection    = document.getElementById("dailyTasksSection");
        const adCooldown           = document.getElementById("adCooldown");
        const topupTestButton      = document.getElementById("topupTestButton");

        // Mini historie Mystery Boxu
        const mysteryBoxMiniHistory     = document.getElementById("mysteryBoxMiniHistory");
        const mysteryBoxMiniHistoryList = document.getElementById("mysteryBoxMiniHistoryList");
        const MYSTERY_HISTORY_KEY       = "kartao_mysteryBox_history";

        let adTimer       = null;
        let adInProgress  = false;
        let cooldownTimer = null;

        function todayString() {
          const d = new Date();
          const y = d.getFullYear();
          const m = String(d.getMonth() + 1).padStart(2, "0");
          const day = String(d.getDate()).padStart(2, "0");
          return `${y}-${m}-${day}`;
        }

        function formatNumber(num) {
          const s = String(num);
          let out = "";
          let count = 0;
          for (let i = s.length - 1; i >= 0; i--) {
            out = s[i] + out;
            count++;
            if (count === 3 && i > 0) {
              out = " " + out;
              count = 0;
            }
          }
          return out;
        }

        function formatMs(ms) {
          const h = Math.floor(ms / 3600000);
          const m = Math.floor((ms % 3600000) / 60000);
          const s = Math.floor((ms % 60000) / 1000);
          return (
            String(h).padStart(2, "0") +
            ":" +
            String(m).padStart(2, "0") +
            ":" +
            String(s).padStart(2, "0")
          );
        }

        function stopCooldownTimer() {
          if (cooldownTimer) {
            clearInterval(cooldownTimer);
            cooldownTimer = null;
          }
        }

        // üîê SAFE WRAPPERY ‚Äì zjednodu≈°en√° verze bez cooldown
        function getCooldownMsSafe() {
          return 0; // Vypnuto pro Supabase verzi
        }

        function hasAdsCooldownSafe() {
          return false; // Vypnuto pro Supabase verzi
        }

        function startCooldownTimer() {
          // Vypnuto pro Supabase verzi
        }

        function stopCooldownTimer() {
          if (cooldownTimer) {
            clearInterval(cooldownTimer);
            cooldownTimer = null;
          }
        }

        // Kredity se aktualizuj√≠ automaticky p≈ôes callback

        // === STREAK + LEVEL ===
        async function syncStreakAndLevel() {
          try {
            const today = todayString();
            let streak = creator.streak_days || 0;
            let last = creator.last_active_date || null;

            if (last === today) {
              // dne≈°ek u≈æ zapoƒç√≠tan√Ω
            } else if (last) {
              streak = streak + 1;
            } else {
              streak = 1;
            }

            // Level podle kredit≈Ø
            const credits = window.creditSys.getCredits();
            const level = Math.max(1, Math.floor(credits / 100) + 1);

            // Update v Supabase
            const { error } = await supabase
              .from('creators')
              .update({
                streak_days: streak,
                last_active_date: today,
                level: level
              })
              .eq('id', user.id);

            if (error) throw error;

            // Update lok√°lnƒõ
            creator.streak_days = streak;
            creator.last_active_date = today;
            creator.level = level;

            if (streakValueEl) streakValueEl.textContent = String(streak);
            if (levelValueEl) levelValueEl.textContent = String(level);
          } catch (e) {
            console.warn("Dashboard: chyba p≈ôi sync streak/level:", e);
          }
        }

        syncStreakAndLevel();

        // localStorage pro denn√≠ stav
        function getDaily() {
          const DAILY_KEY = `kartao_daily_${user.id}`;
          const stored = localStorage.getItem(DAILY_KEY);
          if (!stored) {
            const defaultDaily = {
              date: todayString(),
              adsWatched: 0,
              maxAds: 5,
              tasks: {}
            };
            localStorage.setItem(DAILY_KEY, JSON.stringify(defaultDaily));
            return defaultDaily;
          }
          
          const daily = JSON.parse(stored);
          // Reset pokud je nov√Ω den
          if (daily.date !== todayString()) {
            const newDaily = {
              date: todayString(),
              adsWatched: 0,
              maxAds: 5,
              tasks: {}
            };
            localStorage.setItem(DAILY_KEY, JSON.stringify(newDaily));
            return newDaily;
          }
          
          return daily;
        }

        function saveDaily(daily) {
          const DAILY_KEY = `kartao_daily_${user.id}`;
          localStorage.setItem(DAILY_KEY, JSON.stringify(daily));
        }

        function updateDailyTask(taskName) {
          const daily = getDaily();
          if (daily.tasks[taskName]) return false;
          
          daily.tasks[taskName] = true;
          saveDaily(daily);
          return true;
        }

        function resetDaily() {
          const daily = {
            date: todayString(),
            adsWatched: 0,
            maxAds: 5,
            tasks: {}
          };
          saveDaily(daily);
          return daily;
        }

        function addAdWatch() {
          const daily = getDaily();
          if (daily.adsWatched >= daily.maxAds) {
            return false;
          }
          
          daily.adsWatched++;
          saveDaily(daily);
          return true;
        }

        const videos = [
          "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4",
          "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4",
          "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4",
          "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerJoyrides.mp4",
          "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerMeltdowns.mp4"
        ];

        function setTaskBadgeState(badgeEl, done) {
          if (!badgeEl) return;
          badgeEl.classList.remove("text-red-400", "text-emerald-300");
          const doneLabel = badgeEl.querySelector(".task-done-label");
          if (done) {
            badgeEl.classList.add("text-emerald-300");
            if (!doneLabel) {
              const label = document.createElement("span");
              label.className = "task-done-label text-emerald-300 text-[11px] font-medium ml-2";
              label.textContent = "Splnƒõno ‚úì";
              badgeEl.appendChild(label);
            }
          } else {
            badgeEl.classList.add("text-red-400");
            if (doneLabel) doneLabel.remove();
          }
        }

        function updateUIFromDaily() {
          const daily   = getDaily();
          const maxAds  = daily.maxAds || 5;
          const cooldownMs  = getCooldownMsSafe();
          const inCooldown  = cooldownMs > 0;

          if (adCounter) {
            adCounter.textContent = `Dnes: ${daily.adsWatched} / ${maxAds}`;
          }

          if (watchAdButton) {
            const reachedLimit = daily.adsWatched >= maxAds;
            watchAdButton.disabled = reachedLimit || adInProgress || inCooldown;
            watchAdButton.classList.toggle("opacity-60", watchAdButton.disabled);
            watchAdButton.classList.toggle("cursor-not-allowed", watchAdButton.disabled);
          }

          if (adCooldown) {
            if (inCooldown) {
              adCooldown.classList.remove("hidden");
              adCooldown.textContent = "Dal≈°√≠ reklamy za " + formatMs(cooldownMs);
              startCooldownTimer();
            } else {
              adCooldown.classList.add("hidden");
            }
          }

          if (taskWatchAdBadge && taskWatchAdDone) {
            taskWatchAdBadge.classList.remove("text-red-400", "text-emerald-300");
            if (daily.adsWatched >= maxAds) {
              taskWatchAdBadge.classList.add("text-emerald-300");
              taskWatchAdDone.classList.remove("hidden");
            } else {
              taskWatchAdBadge.classList.add("text-red-400");
              taskWatchAdDone.classList.add("hidden");
            }
          }

          const tasks = daily.tasks || {};
          setTaskBadgeState(taskStatsBadge, !!tasks.stats);
          setTaskBadgeState(taskCampaignBadge, !!tasks.campaign);
        }

        function scrollToDailyTasks() {
          if (dailyTasksSection) {
            dailyTasksSection.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        }

        function loadMysteryHistory() {
          try {
            const raw = localStorage.getItem(MYSTERY_HISTORY_KEY);
            if (!raw) return [];
            const parsed = JSON.parse(raw);
            return Array.isArray(parsed) ? parsed : [];
          } catch (e) {
            console.warn("Dashboard: chyba p≈ôi naƒç√≠t√°n√≠ mystery history:", e);
            return [];
          }
        }

        function formatMysteryHistoryTime(isoString) {
          const d = new Date(isoString);
          if (isNaN(d.getTime())) return "";

          const now = new Date();
          const isToday =
            d.getFullYear() === now.getFullYear() &&
            d.getMonth() === now.getMonth() &&
            d.getDate() === now.getDate();

          const hh = String(d.getHours()).padStart(2, "0");
          const mm = String(d.getMinutes()).padStart(2, "0");

          if (isToday) {
            return `${hh}:${mm} dnes`;
          }

          const dd = String(d.getDate()).padStart(2, "0");
          const mo = String(d.getMonth() + 1).padStart(2, "0");
          return `${dd}.${mo}. ${hh}:${mm}`;
        }

        function renderMiniMysteryHistory() {
          if (!mysteryBoxMiniHistory || !mysteryBoxMiniHistoryList) return;

          const history = loadMysteryHistory();
          if (!history.length) {
            mysteryBoxMiniHistory.classList.add("hidden");
            mysteryBoxMiniHistoryList.innerHTML = "";
            return;
          }

          const latest = history.slice(0, 3);

          mysteryBoxMiniHistory.classList.remove("hidden");
          mysteryBoxMiniHistoryList.innerHTML = "";

          latest.forEach((item) => {
            const li = document.createElement("li");
            li.className = "flex items-center justify-between gap-2 text-[11px]";

            const labelSpan = document.createElement("span");
            labelSpan.className = "font-medium";
            labelSpan.textContent = item.label;

            const timeSpan = document.createElement("span");
            timeSpan.className = "text-[10px] text-amber-100/70";
            timeSpan.textContent = formatMysteryHistoryTime(item.ts);

            li.appendChild(labelSpan);
            li.appendChild(timeSpan);
            mysteryBoxMiniHistoryList.appendChild(li);
          });
        }

        updateUIFromDaily();
        renderMiniMysteryHistory();

        if (hasAdsCooldownSafe()) {
          startCooldownTimer();
        }

        function startAd() {
          const daily = getDaily();
          const maxAds = daily.maxAds || 5;
          if (!watchAdButton || !adOverlay || !adCountdownSpan) return;
          if (daily.adsWatched >= maxAds || adInProgress) return;

          adInProgress = true;
          let remaining = 10;
          adCountdownSpan.textContent = String(remaining);
          adOverlay.classList.remove("hidden");
          if (nextAdButton) nextAdButton.classList.add("hidden");
          if (adMessage) adMessage.textContent = "Reklama bƒõ≈æ√≠‚Ä¶";

          if (adVideo && adSrc) {
            try {
              const index = daily.adsWatched % videos.length;
              adSrc.src = videos[index];
              adVideo.load();
              adVideo.currentTime = 0;
              const playPromise = adVideo.play();
              if (playPromise && playPromise.catch) playPromise.catch(function () {});
            } catch (e) {}
          }

          updateUIFromDaily();

          if (adTimer) {
            window.clearInterval(adTimer);
          }

          adTimer = window.setInterval(async function () {
            remaining -= 1;

            if (remaining <= 0) {
              window.clearInterval(adTimer);
              adTimer = null;
              adInProgress = false;

              const ok = addAdWatch();
              if (ok) {
                await window.creditSys.addCredits(4);
                syncStreakAndLevel();
              }

              if (adCountdownSpan) {
                adCountdownSpan.innerHTML =
                  "<span style='color:#4ade80;font-weight:600'>p≈ôips√°no&nbsp;+4&nbsp;K-Coins</span>";
              }

              if (nextAdButton) {
                const dailyAfter   = getDaily();
                const maxAdsAfter  = dailyAfter.maxAds || 5;
                if (dailyAfter.adsWatched < maxAdsAfter) {
                  nextAdButton.innerHTML =
                    "<i data-lucide='skip-forward' class='w-4 h-4 text-amber-300'></i><span>Dal≈°√≠ reklama</span>";
                } else {
                  nextAdButton.innerHTML =
                    "<i data-lucide='x' class='w-4 h-4 text-amber-300'></i><span>Zav≈ô√≠t</span>";
                }
                nextAdButton.classList.remove("hidden");
                if (window.lucide) window.lucide.createIcons();
              }

              if (adMessage) adMessage.textContent = "Reklama dokonƒçena. Kredity p≈ôips√°ny.";

              updateUIFromDaily();
            } else {
              if (adCountdownSpan) adCountdownSpan.textContent = String(remaining);
            }
          }, 1000);
        }

        function cancelAd() {
          if (adTimer) {
            window.clearInterval(adTimer);
            adTimer = null;
          }
          adInProgress = false;
          if (adOverlay) adOverlay.classList.add("hidden");
          if (adVideo) {
            try {
              adVideo.pause();
              adVideo.currentTime = 0;
            } catch (e) {}
          }
          if (adMessage) adMessage.textContent = "Reklama zru≈°ena. Kredity nebyly p≈ôips√°ny.";
          updateUIFromDaily();
        }

        if (topupTestButton) {
          topupTestButton.addEventListener("click", async function () {
            await window.creditSys.addCredits(50);
            // UI se aktualizuje automaticky p≈ôes callback
            syncStreakAndLevel();
            alert("Test: p≈ôips√°no +50 K-Coins");
          });
        }

        if (watchAdButton) {
          watchAdButton.addEventListener("click", function () {
            const daily  = getDaily();
            const maxAds = daily.maxAds || 5;

            if (hasAdsCooldownSafe()) {
              if (adMessage) {
                adMessage.textContent = "Dne≈°n√≠ limit sledov√°n√≠ reklam je vyƒçerp√°n. Poƒçkej na obnoven√≠ limitu.";
              }
              updateUIFromDaily();
              scrollToDailyTasks();
              return;
            }

            if (daily.adsWatched >= maxAds) {
              if (adMessage) adMessage.textContent = "Dne≈°n√≠ limit sledov√°n√≠ reklam je vyƒçerp√°n.";
              updateUIFromDaily();
              scrollToDailyTasks();
              return;
            }
            startAd();
          });
        }

        if (adCloseButton) {
          adCloseButton.addEventListener("click", function () {
            cancelAd();
          });
        }

        if (adPauseToggle && adVideo) {
          adPauseToggle.addEventListener("click", function () {
            if (adVideo.paused) {
              adVideo.play();
              adPauseToggle.innerHTML = "<i data-lucide='pause' class='w-4 h-4'></i> Zastavit";
            } else {
              adVideo.pause();
              adPauseToggle.innerHTML = "<i data-lucide='play' class='w-4 h-4'></i> Pokraƒçovat";
            }
            if (window.lucide) window.lucide.createIcons();
          });
        }

        if (adMuteToggle && adVideo) {
          adMuteToggle.addEventListener("click", function () {
            adVideo.muted = !adVideo.muted;
            adMuteToggle.innerHTML = adVideo.muted
              ? "<i data-lucide='volume-x' class='w-4 h-4'></i> Zvuk"
              : "<i data-lucide='volume-2' class='w-4 h-4'></i> Zvuk";
            if (window.lucide) window.lucide.createIcons();
          });
        }

        if (nextAdButton) {
          nextAdButton.addEventListener("click", function () {
            const daily  = getDaily();
            const maxAds = daily.maxAds || 5;

            if (daily.adsWatched >= maxAds) {
              if (adOverlay) adOverlay.classList.add("hidden");
              if (adVideo) {
                try {
                  adVideo.pause();
                  adVideo.currentTime = 0;
                } catch (e) {}
              }
              adInProgress = false;
              if (adMessage) adMessage.textContent = "Dne≈°n√≠ limit reklam je splnƒõn. Kredity m√°≈° p≈ôipsan√©.";
              updateUIFromDaily();
              scrollToDailyTasks();
              return;
            }

            startAd();
          });
        }

        if (resetButton) {
          resetButton.addEventListener("click", function () {
            resetDaily();
            stopCooldownTimer();
            if (adCooldown) adCooldown.classList.add("hidden");
            updateUIFromDaily();
            if (adMessage) adMessage.textContent = "Denn√≠ limit byl resetov√°n (test).";
          });
        }

        if (taskStatsItem && taskStatsBadge) {
          taskStatsItem.addEventListener("click", async function () {
            const newlyDone = updateDailyTask("stats");
            if (newlyDone) {
              await window.creditSys.addCredits(5);
              syncStreakAndLevel();
              updateUIFromDaily();
            }
          });
        }

        if (taskCampaignItem && taskCampaignBadge) {
          taskCampaignItem.addEventListener("click", function () {
            const daily = getDaily();
            const tasks = daily.tasks || {};
            if (tasks.campaign) return;
            if (campaignList) campaignList.classList.toggle("hidden");
          });
        }

        if (campaignRespondButtons && campaignRespondButtons.length) {
          campaignRespondButtons.forEach(function (btn) {
            btn.addEventListener("click", async function (e) {
              e.preventDefault();
              const newlyDone = updateDailyTask("campaign");
              if (newlyDone) {
                await window.creditSys.addCredits(6);
                syncStreakAndLevel();
                updateUIFromDaily();
              }
              if (campaignList) campaignList.classList.add("hidden");
            });
          });
        }

        // Glob√°ln√≠ p≈ô√≠stup ‚Äì pou≈æ√≠vaj√≠ to jin√© str√°nky (mystery-box atd.)
        window.creditSys = {
          getCredits: () => creator.credits || 0,
          addCredits: async (amount) => {
            const newCredits = (creator.credits || 0) + amount;
            const { error } = await supabase
              .from('creators')
              .update({ credits: newCredits, updated_at: new Date().toISOString() })
              .eq('id', user.id);
            
            if (!error) {
              creator.credits = newCredits;
              const el = document.getElementById('currentCredits');
              if (el) el.textContent = newCredits.toLocaleString('cs-CZ');
            }
            return newCredits;
          },
          subtractCredits: async (amount) => {
            const newCredits = Math.max(0, (creator.credits || 0) - amount);
            const { error } = await supabase
              .from('creators')
              .update({ credits: newCredits, updated_at: new Date().toISOString() })
              .eq('id', user.id);
            
            if (!error) {
              creator.credits = newCredits;
              const el = document.getElementById('currentCredits');
              if (el) el.textContent = newCredits.toLocaleString('cs-CZ');
            }
            return newCredits;
          }
        };
      } // konec initDashboard
    });
  </script>
</body>
</html>
