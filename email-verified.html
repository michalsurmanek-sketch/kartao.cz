<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>OvÄ›Å™enÃ­ e-mailu - Kartao.cz</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>âœ‰ï¸</text></svg>">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <!-- Supabase + Unified Auth -->
  <script src="supabase-init.js"></script>
  <script src="auth-unified.js"></script>
  <script src="credits-system-supabase.js"></script>
  
  <style>
    body {
      background: radial-gradient(circle at top left, #db58f6 0, transparent 55%),
                  radial-gradient(circle at bottom right, #fbbf24 0, #020617 55%);
    }
  </style>
</head>
<body class="min-h-screen bg-neutral-950 text-white flex items-center justify-center p-4">
  <div class="w-full max-w-md">
    <!-- Logo -->
    <div class="text-center mb-6">
      <div class="inline-flex items-center gap-3 mb-4">
        <div class="w-12 h-12 rounded-2xl bg-gradient-to-tr from-fuchsia-500 to-amber-400 grid place-items-center shadow-lg">
          <span class="text-2xl">âœ‰ï¸</span>
        </div>
        <div>
          <div class="font-extrabold tracking-tight text-xl">Kartao.cz</div>
          <div class="text-xs text-white/60">OvÄ›Å™enÃ­ e-mailu</div>
        </div>
      </div>
    </div>

    <!-- Status box -->
    <div id="status-box" class="p-6 rounded-2xl bg-neutral-900/80 border border-white/10 shadow-xl backdrop-blur-md text-center">
      <!-- Loading state -->
      <div id="loading" class="space-y-4">
        <div class="w-16 h-16 mx-auto rounded-full border-4 border-amber-400/30 border-t-amber-400 animate-spin"></div>
        <h2 class="text-xl font-bold">OvÄ›Å™uji e-mail...</h2>
        <p class="text-sm text-white/60">ProsÃ­m Äekejte</p>
      </div>

      <!-- Success state -->
      <div id="success" class="hidden space-y-4">
        <div class="w-16 h-16 mx-auto rounded-full bg-emerald-500/20 border-2 border-emerald-400 flex items-center justify-center">
          <i data-lucide="check" class="w-8 h-8 text-emerald-400"></i>
        </div>
        <h2 class="text-xl font-bold text-emerald-400">âœ… E-mail ovÄ›Å™en!</h2>
        <p class="text-sm text-white/70">VÃ¡Å¡ e-mail byl ÃºspÄ›Å¡nÄ› ovÄ›Å™en.</p>
        <p class="text-sm text-white/60">PÅ™esmÄ›rovÃ¡nÃ­ na pÅ™ihlÃ¡Å¡enÃ­ za <span id="countdown">3</span> sekundy...</p>
        <a href="login.html" class="inline-block mt-4 px-6 py-2 rounded-xl bg-gradient-to-r from-fuchsia-500 to-amber-400 text-neutral-900 font-semibold hover:brightness-110">
          PÅ™ihlÃ¡sit se nynÃ­
        </a>
      </div>

      <!-- Error state -->
      <div id="error" class="hidden space-y-4">
        <div class="w-16 h-16 mx-auto rounded-full bg-red-500/20 border-2 border-red-400 flex items-center justify-center">
          <i data-lucide="x" class="w-8 h-8 text-red-400"></i>
        </div>
        <h2 class="text-xl font-bold text-red-400">âŒ Chyba pÅ™i ovÄ›Å™ovÃ¡nÃ­</h2>
        <p id="error-message" class="text-sm text-white/70">NÄ›co se pokazilo.</p>
        <div class="text-xs text-white/50 bg-neutral-800/50 rounded-lg p-3 font-mono" id="error-details"></div>
        <a href="login.html" class="inline-block mt-4 px-6 py-2 rounded-xl border border-white/20 text-white hover:bg-white/5">
          ZpÄ›t na pÅ™ihlÃ¡Å¡enÃ­
        </a>
      </div>

      <!-- Invalid link state -->
      <div id="invalid" class="hidden space-y-4">
        <div class="w-16 h-16 mx-auto rounded-full bg-amber-500/20 border-2 border-amber-400 flex items-center justify-center">
          <i data-lucide="alert-triangle" class="w-8 h-8 text-amber-400"></i>
        </div>
        <h2 class="text-xl font-bold text-amber-400">âš ï¸ NeplatnÃ½ odkaz</h2>
        <p class="text-sm text-white/70">Tento odkaz nenÃ­ platnÃ½ nebo jiÅ¾ byl pouÅ¾it.</p>
        <div class="text-left text-sm text-white/60 bg-neutral-800/50 rounded-lg p-3 space-y-1">
          <div>MoÅ¾nÃ© dÅ¯vody:</div>
          <ul class="list-disc list-inside ml-2 space-y-1">
            <li>Odkaz jiÅ¾ byl pouÅ¾it</li>
            <li>Odkaz vyprÅ¡el (platnost 24 hodin)</li>
            <li>NesprÃ¡vnÃ½ nebo poÅ¡kozenÃ½ odkaz</li>
          </ul>
        </div>
        <div class="space-x-2">
          <a href="login.html" class="inline-block px-6 py-2 rounded-xl bg-gradient-to-r from-fuchsia-500 to-amber-400 text-neutral-900 font-semibold hover:brightness-110">
            PÅ™ihlÃ¡sit se
          </a>
        </div>
      </div>
    </div>

    <!-- Help text -->
    <div class="mt-6 text-center text-xs text-white/40">
      <p>PotÅ™ebujete pomoct? NapiÅ¡te na <a href="mailto:podpora@kartao.cz" class="underline hover:text-white/60">podpora@kartao.cz</a></p>
    </div>
  </div>

  <script>
    // Inicializace Lucide ikon
    lucide.createIcons();

    // ZÃ­skÃ¡nÃ­ parametrÅ¯ z URL
    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode');
    const oobCode = urlParams.get('oobCode');
    const apiKey = urlParams.get('apiKey');
    const lang = urlParams.get('lang') || 'cs';

    console.log('ğŸ“§ Email verification handler');
    console.log('Mode:', mode);
    console.log('Code:', oobCode ? 'Present' : 'Missing');
    console.log('API Key:', apiKey ? 'Present' : 'Missing');

    const loadingEl = document.getElementById('loading');
    const successEl = document.getElementById('success');
    const errorEl = document.getElementById('error');
    const invalidEl = document.getElementById('invalid');

    function showSuccess() {
      loadingEl.classList.add('hidden');
      successEl.classList.remove('hidden');
      lucide.createIcons();
      
      // OdpoÄÃ­tÃ¡vÃ¡nÃ­
      let seconds = 3;
      const countdownEl = document.getElementById('countdown');
      const interval = setInterval(() => {
        seconds--;
        countdownEl.textContent = seconds;
        if (seconds <= 0) {
          clearInterval(interval);
          window.location.href = 'login.html';
        }
      }, 1000);
    }

    function showError(message, details) {
      loadingEl.classList.add('hidden');
      errorEl.classList.remove('hidden');
      document.getElementById('error-message').textContent = message;
      if (details) {
        document.getElementById('error-details').textContent = details;
      } else {
        document.getElementById('error-details').classList.add('hidden');
      }
      lucide.createIcons();
    }

    function showInvalid() {
      loadingEl.classList.add('hidden');
      invalidEl.classList.remove('hidden');
      lucide.createIcons();
    }

    // HlavnÃ­ logika
    async function handleEmailVerification() {
      // Kontrola reÅ¾imu
      if (mode !== 'verifyEmail') {
        console.error('Invalid mode:', mode);
        showInvalid();
        return;
      }

      // Kontrola kÃ³du
      if (!oobCode) {
        console.error('Missing oobCode');
        showInvalid();
        return;
      }

      try {
        console.log('Applying action code...');
        await auth.applyActionCode(oobCode);
        console.log('âœ… Email verified successfully');
        
        // Reload uÅ¾ivatele pro refresh emailVerified stavu
        if (auth.currentUser) {
          await auth.currentUser.reload();
          console.log('User reloaded, emailVerified:', auth.currentUser.emailVerified);
        }
        
        showSuccess();
      } catch (error) {
        console.error('âŒ Verification error:', error);
        
        if (error.code === 'auth/expired-action-code') {
          showError(
            'Odkaz vyprÅ¡el',
            'Tento ovÄ›Å™ovacÃ­ odkaz jiÅ¾ nenÃ­ platnÃ½. Platnost je 24 hodin od odeslÃ¡nÃ­.'
          );
        } else if (error.code === 'auth/invalid-action-code') {
          showError(
            'NeplatnÃ½ nebo jiÅ¾ pouÅ¾itÃ½ odkaz',
            'Tento odkaz jiÅ¾ byl pouÅ¾it nebo nenÃ­ platnÃ½.'
          );
        } else if (error.code === 'auth/user-disabled') {
          showError(
            'ÃšÄet byl deaktivovÃ¡n',
            'Kontaktujte prosÃ­m podporu.'
          );
        } else if (error.code === 'auth/user-not-found') {
          showError(
            'UÅ¾ivatel nenalezen',
            'ÃšÄet spojenÃ½ s tÃ­mto odkazem jiÅ¾ neexistuje.'
          );
        } else {
          showError(
            'Chyba pÅ™i ovÄ›Å™ovÃ¡nÃ­',
            `${error.code}: ${error.message}`
          );
        }
      }
    }

    // Spustit po naÄtenÃ­ Firebase
    if (typeof auth !== 'undefined') {
      handleEmailVerification();
    } else {
      // PoÄkat na Firebase init
      setTimeout(() => {
        if (typeof auth !== 'undefined') {
          handleEmailVerification();
        } else {
          showError('Firebase nenÃ­ naÄtenÃ½', 'Zkuste obnovit strÃ¡nku.');
        }
      }, 1000);
    }
  </script>
</body>
</html>
