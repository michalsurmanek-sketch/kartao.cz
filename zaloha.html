<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kartao Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-neutral-950 text-white min-h-screen">
  <div class="max-w-5xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-4">Kartao Admin Panel</h1>

    <!-- LOGIN -->
    <div id="login" class="space-y-3">
      <p class="text-white/80">Zadej admin klíč pro získání přístupu:</p>
      <input id="adminKey" type="password" placeholder="Admin klíč" class="w-full p-2 rounded bg-neutral-800 border border-white/20" />
      <div class="text-xs text-white/50">Pro rychlé lokální testování můžeš použít klíč: <code class="bg-white/10 px-2 py-0.5 rounded">kartao-dev</code></div>
      <button id="loginBtn" class="bg-fuchsia-500 hover:bg-fuchsia-600 px-4 py-2 rounded">Přihlásit se</button>
    </div>

    <!-- PANEL -->
    <div id="panel" class="hidden">
      <div class="flex flex-col gap-3 mt-6 mb-4">
        <div class="flex flex-col md:flex-row gap-3 md:items-end">
          <div class="grow">
            <label class="text-xs text-white/60">Hledat podle e‑mailu nebo ID</label>
            <input id="q" type="text" placeholder="např. name@example.com nebo 8p3f..." class="w-full p-2 rounded bg-neutral-800 border border-white/20" />
          </div>
          <div>
            <label class="text-xs text-white/60">Stav</label>
            <select id="status" class="p-2 rounded bg-neutral-800 border border-white/20">
              <option value="pending" selected>Pending</option>
              <option value="approved">Approved</option>
              <option value="rejected">Rejected</option>
            </select>
          </div>
          <div class="flex gap-2 flex-wrap">
            <button id="refreshBtn" class="text-sm border border-white/20 px-3 py-2 rounded">↻ Aktualizovat</button>
            <button id="clearBtn" class="text-sm border border-white/20 px-3 py-2 rounded">✕ Vyčistit</button>
            <button id="approveSelectedBtn" class="text-sm bg-emerald-600 hover:bg-emerald-700 px-3 py-2 rounded">✔ Schválit vybrané</button>
            <button id="rejectSelectedBtn" class="text-sm bg-rose-600 hover:bg-rose-700 px-3 py-2 rounded">✖ Zamítnout vybrané</button>
            <button id="exportCsvBtn" class="text-sm border border-white/20 px-3 py-2 rounded">⬇ Export CSV</button>
          </div>
        </div>
        <div class="flex items-center gap-3 text-sm text-white/60">
          <label class="inline-flex items-center gap-2"><input id="selectAll" type="checkbox" class="accent-fuchsia-500"> Označit vše na stránce</label>
          <span id="selectedCount" class="text-white/50">Vybráno: 0</span>
          <span id="modeBadge" class="hidden bg-amber-500/20 text-amber-200 text-xs px-2 py-1 rounded">LOCAL TEST MODE</span>
        </div>
        <p class="text-xs text-white/50">Tip: Přepni stav na „Approved“ pro přehled schválených karet. Hledání je case‑insensitive a podporuje částečnou shodu e‑mailu. ID se hledá přesnou shodou. Hromadné akce pracují s aktuálně zobrazeným seznamem a tvým výběrem.</p>
      </div>

      <div id="creatorsList" class="space-y-2"></div>
    </div>
  </div>

  <!-- DETAIL MODAL -->
  <div id="detailModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/70" id="detailBackdrop"></div>
    <div class="relative max-w-xl mx-auto mt-20 bg-neutral-900 border border-white/10 rounded-xl p-5">
      <div class="flex items-start justify-between gap-3">
        <h3 class="text-xl font-semibold">Detail tvůrce</h3>
        <button id="detailClose" class="text-white/70 hover:text-white">✕</button>
      </div>
      <div id="detailBody" class="mt-4 space-y-2 text-sm"></div>
      <div class="mt-5 flex items-center justify-between">
        <div class="text-xs text-white/50" id="detailMeta"></div>
        <div class="flex gap-2">
          <button id="detailApprove" class="bg-emerald-600 hover:bg-emerald-700 px-3 py-2 rounded text-sm">Schválit</button>
          <button id="detailReject" class="bg-rose-600 hover:bg-rose-700 px-3 py-2 rounded text-sm">Zamítnout</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const apiBase = 'https://api.kartao.cz';

    // ===== Lokální test mód =====
    const ENABLE_LOCAL_TEST = true;
    const LOCAL_TEST_KEY = 'kartao-dev';
    let localMode = false; // true, pokud se přihlásíme lokálním klíčem

    let token = localStorage.getItem('admin_jwt') || '';

    // Stav UI
    let currentList = []; // naposledy zobrazený (filtrovaný) seznam
    const selected = new Set(); // vybraná ID
    let detail = null; // aktuální detail objekt

    // ===== Helpers =====
    function showPanel() {
      document.getElementById('login').classList.add('hidden');
      document.getElementById('panel').classList.remove('hidden');
      document.getElementById('modeBadge').classList.toggle('hidden', !localMode);
    }
    function showLogin() {
      document.getElementById('panel').classList.add('hidden');
      document.getElementById('login').classList.remove('hidden');
    }
    function updateSelectedCount(){
      document.getElementById('selectedCount').textContent = `Vybráno: ${selected.size}`;
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (ch)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[ch]));
    }

    // Mock data pro localMode
    function mockCreators(status){
      const base = [
        {id:'cr_1', email:'anna@example.com', name:'Anna Influ', city:'Brno',  category:'Beauty', status:'pending',  created_at:'2025-11-07 10:15:00'},
        {id:'cr_2', email:'bob@example.com',  name:'Bob Maker',  city:'Praha', category:'Tech',   status:'pending',  created_at:'2025-11-07 10:20:00'},
        {id:'cr_3', email:'kaja@example.com', name:'Kája Fit',  city:'Zlín',  category:'Fitness',status:'approved', created_at:'2025-11-06 13:05:00'},
        {id:'cr_4', email:'dana@example.com', name:'Dana Food', city:'Ostrava',category:'Food', status:'rejected', created_at:'2025-11-05 09:40:00'},
      ];
      return base.filter(x => x.status === status);
    }

    async function login() {
      const key = (document.getElementById('adminKey').value || '').trim();
      if(!key) { alert('Zadej admin klíč'); return; }

      // Lokální test bez serveru
      if (ENABLE_LOCAL_TEST && key === LOCAL_TEST_KEY) {
        localMode = true;
        token = 'LOCAL_TEST';
        localStorage.setItem('admin_jwt', token);
        showPanel();
        loadCreators();
        return;
      }

      // Produkční ověření přes API
      const res = await fetch(`${apiBase}/admin/token`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ key })
      });
      const out = await res.json();
      if(out.token) {
        token = out.token;
        localMode = false;
        localStorage.setItem('admin_jwt', token);
        showPanel();
        loadCreators();
      } else {
        alert('Neplatný klíč');
      }
    }

    async function fetchByStatus(status) {
      if (localMode) {
        // simulace bez serveru
        return mockCreators(status);
      }
      const res = await fetch(`${apiBase}/admin/creators?status=${encodeURIComponent(status)}` ,{
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if(res.status === 401) { localStorage.removeItem('admin_jwt'); token=''; showLogin(); throw new Error('Unauthorized'); }
      return res.json();
    }

    function renderList(list) {
      currentList = Array.isArray(list) ? list : [];
      const container = document.getElementById('creatorsList');
      container.innerHTML = '';

      // Po každém renderu synchronizuj „označit vše“ podle stavu výběru
      const pageIds = new Set(currentList.map(c => String(c.id)));
      const allSelected = currentList.length > 0 && [...pageIds].every(id => selected.has(id));
      document.getElementById('selectAll').checked = allSelected;

      if (currentList.length === 0) {
        container.innerHTML = '<p class="text-white/60">Nic nenalezeno.</p>';
        updateSelectedCount();
        return;
      }

      currentList.forEach(c => {
        const idStr = String(c.id);
        const div = document.createElement('div');
        div.className = 'p-3 border border-white/10 rounded flex justify-between items-center gap-3';
        div.innerHTML = `
          <div class="flex items-start gap-3">
            <input type="checkbox" class="rowChk mt-1 accent-fuchsia-500" data-id="${idStr}" ${selected.has(idStr) ? 'checked' : ''}>
            <button class="text-left" data-open-detail="${idStr}">
              <div class="font-semibold">${escapeHtml(c.name || '(bez jména)')} ${c.city ? '– ' + escapeHtml(c.city) : ''}</div>
              <div class="text-sm text-white/60">${escapeHtml(c.email || '')}</div>
              <div class="text-xs text-white/40">ID: ${escapeHtml(idStr)} • Stav: ${escapeHtml(c.status || '')}${c.created_at ? ' • Vytvořeno: ' + escapeHtml(c.created_at) : ''}</div>
            </button>
          </div>
          <div class="flex gap-2">${actionButtons(c)}</div>`;
        container.appendChild(div);
      });

      // navěs checkboxy
      container.querySelectorAll('.rowChk').forEach(chk => {
        chk.addEventListener('change', (e)=>{
          const id = e.target.getAttribute('data-id');
          if(e.target.checked) selected.add(id); else selected.delete(id);
          updateSelectedCount();
        });
      });

      // navěs otevření detailu
      container.querySelectorAll('[data-open-detail]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-open-detail');
          const obj = currentList.find(x=> String(x.id) === id);
          if(obj) openDetail(obj);
        })
      })

      updateSelectedCount();
    }

    function actionButtons(c){
      if(c.status === 'pending'){
        return `
          <button class="bg-emerald-500 hover:bg-emerald-600 px-3 py-1 rounded text-sm" onclick="approve('${c.id}')">Schválit</button>
          <button class="bg-rose-500 hover:bg-rose-600 px-3 py-1 rounded text-sm" onclick="reject('${c.id}')">Zamítnout</button>`;
      }
      if(c.status === 'approved'){
        return `<button class="bg-rose-500 hover:bg-rose-600 px-3 py-1 rounded text-sm" onclick="reject('${c.id}')">Zamítnout</button>`;
      }
      return `<button class="bg-emerald-500 hover:bg-emerald-600 px-3 py-1 rounded text-sm" onclick="approve('${c.id}')">Schválit</button>`;
    }

    // Debounce search
    let debounceTimer;
    function debounce(fn, wait=250){
      clearTimeout(debounceTimer); debounceTimer = setTimeout(fn, wait);
    }

    async function loadCreators() {
      const status = (document.getElementById('status').value || 'pending');
      const q = (document.getElementById('q').value || '').toLowerCase().trim();

      let list = await fetchByStatus(status);

      // Klientská filtrace: email (contains, case-insensitive) nebo ID (přesná shoda)
      if(q){
        list = (list || []).filter((c)=>{
          const idMatch = (String(c.id) || '').toLowerCase() === q;
          const emailMatch = (c.email || '').toLowerCase().includes(q);
          return idMatch || emailMatch;
        })
      }
      renderList(list);
    }

    async function approve(id) {
      if(!confirm('Schválit tuto kartu?')) return;
      if (localMode) {
        // simulace schválení v mock datech
        currentList = currentList.map(x => x.id===id ? {...x, status:'approved'} : x);
        selected.delete(String(id));
        renderList(currentList);
        if(detail && String(detail.id) === String(id)) closeDetail();
        return;
      }
      await fetch(`${apiBase}/admin/creators/${id}/approve`, {
        method: 'PATCH',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      selected.delete(String(id));
      loadCreators();
      if(detail && String(detail.id) === String(id)) closeDetail();
    }

    async function reject(id) {
      if(!confirm('Zamítnout tuto kartu?')) return;
      if (localMode) {
        currentList = currentList.map(x => x.id===id ? {...x, status:'rejected'} : x);
        selected.delete(String(id));
        renderList(currentList);
        if(detail && String(detail.id) === String(id)) closeDetail();
        return;
      }
      await fetch(`${apiBase}/admin/creators/${id}/reject`, {
        method: 'PATCH',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      selected.delete(String(id));
      loadCreators();
      if(detail && String(detail.id) === String(id)) closeDetail();
    }

    // ===== Detail modal =====
    function openDetail(obj){
      detail = obj;
      const body = document.getElementById('detailBody');
      const meta = document.getElementById('detailMeta');
      body.innerHTML = `
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2">
          <div><div class="text-white/60 text-xs">Jméno</div><div class="font-medium">${escapeHtml(obj.name || '(bez jména)')}</div></div>
          <div><div class="text-white/60 text-xs">E‑mail</div><div class="font-medium">${escapeHtml(obj.email || '')}</div></div>
          <div><div class="text-white/60 text-xs">Město</div><div class="font-medium">${escapeHtml(obj.city || '')}</div></div>
          <div><div class="text-white/60 text-xs">Kategorie</div><div class="font-medium">${escapeHtml(obj.category || '')}</div></div>
          <div class="sm:col-span-2"><div class="text-white/60 text-xs">ID</div><div class="font-mono text-sm">${escapeHtml(String(obj.id || ''))}</div></div>
        </div>`;
      meta.textContent = `Stav: ${obj.status || ''}${obj.created_at ? ' • Vytvořeno: ' + obj.created_at : ''}`;
      document.getElementById('detailModal').classList.remove('hidden');
    }
    function closeDetail(){
      document.getElementById('detailModal').classList.add('hidden');
      detail = null;
    }

    document.getElementById('detailClose').addEventListener('click', closeDetail);
    document.getElementById('detailBackdrop').addEventListener('click', closeDetail);
    document.getElementById('detailApprove').addEventListener('click', ()=>{ if(detail) approve(detail.id); });
    document.getElementById('detailReject').addEventListener('click', ()=>{ if(detail) reject(detail.id); });

    // Events
    document.getElementById('loginBtn').addEventListener('click', login);
    document.getElementById('refreshBtn').addEventListener('click', loadCreators);
    document.getElementById('clearBtn').addEventListener('click', ()=>{ document.getElementById('q').value=''; loadCreators(); });
    document.getElementById('status').addEventListener('change', ()=>{ selected.clear(); loadCreators(); });
    document.getElementById('q').addEventListener('input', ()=>debounce(loadCreators, 250));

    document.getElementById('approveSelectedBtn').addEventListener('click', approveSelected);
    document.getElementById('rejectSelectedBtn').addEventListener('click', rejectSelected);
    document.getElementById('exportCsvBtn').addEventListener('click', exportCSV);

    document.getElementById('selectAll').addEventListener('change', (e)=>{
      const check = e.target.checked;
      currentList.forEach(c => {
        const id = String(c.id);
        if(check) selected.add(id); else selected.delete(id);
      })
      // přeznačit checkboxy na stránce
      document.querySelectorAll('.rowChk').forEach(ch => { ch.checked = check; });
      updateSelectedCount();
    });

    // Hromadné akce
    async function approveSelected(){
      if(selected.size === 0){ alert('Není nic vybráno.'); return; }
      if(!confirm(`Schválit ${selected.size} vybraných karet?`)) return;
      if (localMode) {
        currentList = currentList.map(x => selected.has(String(x.id)) ? {...x, status:'approved'} : x);
        selected.clear();
        renderList(currentList);
        if(detail && !currentList.find(x=> String(x.id) === String(detail.id))) closeDetail();
        return;
      }
      for(const id of selected){
        await fetch(`${apiBase}/admin/creators/${id}/approve`, { method:'PATCH', headers:{ 'Authorization': `Bearer ${token}` }});
      }
      selected.clear();
      loadCreators();
      if(detail && !currentList.find(x=> String(x.id) === String(detail.id))) closeDetail();
    }
    async function rejectSelected(){
      if(selected.size === 0){ alert('Není nic vybráno.'); return; }
      if(!confirm(`Zamítnout ${selected.size} vybraných karet?`)) return;
      if (localMode) {
        currentList = currentList.map(x => selected.has(String(x.id)) ? {...x, status:'rejected'} : x);
        selected.clear();
        renderList(currentList);
        if(detail && !currentList.find(x=> String(x.id) === String(detail.id))) closeDetail();
        return;
      }
      for(const id of selected){
        await fetch(`${apiBase}/admin/creators/${id}/reject`, { method:'PATCH', headers:{ 'Authorization': `Bearer ${token}` }});
      }
      selected.clear();
      loadCreators();
      if(detail && !currentList.find(x=> String(x.id) === String(detail.id))) closeDetail();
    }

    function exportCSV(){
      if(!currentList || currentList.length === 0){ alert('Není co exportovat.'); return; }
      const header = ['id','email','name','city','category','status','created_at'];
      const rows = currentList.map(c => header.map(h => (c[h] ?? '')).map(val => `"${String(val).replace(/"/g,'""')}"`).join(','));
      const csv = [header.join(','), ...rows].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `kartao-creators-${(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Auto-login if token
    if(token) { showPanel(); loadCreators(); }
  </script>
</body>
</html>
