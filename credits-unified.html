<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kreditn√≠ Syst√©m - Kartao.cz</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üöÄ</text></svg>">
    <script src="https://cdn.tailwindcss.com/3.3.2"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        body { 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); 
            min-height: 100vh;
        }
        .card-glow { 
            box-shadow: 0 4px 20px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
        }
        .card-hover { 
            transition: all 0.3s ease; 
        }
        .card-hover:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 30px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.1);
        }
        .gradient-text {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .progress-bar { 
            background: rgba(255,255,255,0.1); 
            border-radius: 10px; 
            overflow: hidden;
        }
        .progress-fill { 
            background: linear-gradient(90deg, #fbbf24, #f59e0b); 
            border-radius: 10px; 
            transition: width 0.5s ease; 
        }
        .btn-primary {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #0f172a;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(251, 191, 36, 0.3);
        }
        .navbar-brand {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }
    </style>
</head>
<body class="text-white">
    <!-- Navigation -->
    <nav class="backdrop-blur-md bg-slate-900/70 border-b border-white/10 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center shadow-lg">
                            <i data-lucide="coins" class="w-6 h-6 text-slate-900"></i>
                        </div>
                        <h1 class="text-2xl navbar-brand">Kreditn√≠ Syst√©m</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="userInfo" class="text-sm text-slate-300"></div>
                    <button id="backBtn" class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg transition-colors flex items-center backdrop-blur-sm">
                        <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
                        Zpƒõt
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-8 px-4">
        <!-- User Stats Overview -->
        <div id="statsSection" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- Aktu√°ln√≠ kredity -->
            <div class="bg-slate-800/50 rounded-xl card-glow p-6 card-hover border border-white/5">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-400 text-sm">Aktu√°ln√≠ kredity</p>
                        <p id="currentCredits" class="text-3xl font-bold gradient-text">0</p>
                    </div>
                    <div class="bg-amber-500/20 p-3 rounded-xl">
                        <i data-lucide="coins" class="w-8 h-8 text-amber-400"></i>
                    </div>
                </div>
            </div>

            <!-- Level -->
            <div class="bg-slate-800/50 rounded-xl card-glow p-6 card-hover border border-white/5">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-400 text-sm">Level</p>
                        <p id="currentLevel" class="text-3xl font-bold text-green-400">1</p>
                        <p id="levelName" class="text-sm text-slate-300">Zaƒç√°teƒçn√≠k</p>
                    </div>
                    <div class="bg-green-500/20 p-3 rounded-xl">
                        <i data-lucide="trophy" class="w-8 h-8 text-green-400"></i>
                    </div>
                </div>
            </div>

            <!-- Streak -->
            <div class="bg-slate-800/50 rounded-xl card-glow p-6 card-hover border border-white/5">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-400 text-sm">Denn√≠ s√©rie</p>
                        <p id="currentStreak" class="text-3xl font-bold text-orange-400">0</p>
                        <p class="text-sm text-slate-300">dn√≠ v ≈ôadƒõ</p>
                    </div>
                    <div class="bg-orange-500/20 p-3 rounded-xl">
                        <i data-lucide="flame" class="w-8 h-8 text-orange-400"></i>
                    </div>
                </div>
            </div>

            <!-- Celkem vydƒõlan√© -->
            <div class="bg-slate-800/50 rounded-xl card-glow p-6 card-hover border border-white/5">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-400 text-sm">Celkem vydƒõlan√©</p>
                        <p id="totalEarned" class="text-3xl font-bold text-purple-400">0</p>
                    </div>
                    <div class="bg-purple-500/20 p-3 rounded-xl">
                        <i data-lucide="trending-up" class="w-8 h-8 text-purple-400"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Left Column: Tasks & Check-in -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Daily Check-in -->
                <div class="bg-slate-800/50 rounded-xl card-glow p-6 border border-white/5">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold flex items-center text-white">
                            <i data-lucide="calendar-check" class="w-5 h-5 mr-2 text-blue-400"></i>
                            Denn√≠ Check-in
                        </h2>
                        <span id="checkInTime" class="text-sm text-slate-400">Reset za: --:--:--</span>
                    </div>
                    <div class="text-center">
                        <button id="checkInBtn" class="btn-primary px-8 py-3 rounded-xl font-semibold hover:shadow-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="gift" class="w-5 h-5 inline mr-2"></i>
                            Denn√≠ Check-in (+10 kredit≈Ø)
                        </button>
                        <div id="checkInResult" class="mt-3 text-sm"></div>
                    </div>
                </div>

        <!-- Daily Tasks -->
        <div class="bg-slate-800/50 rounded-xl card-glow p-6 border border-white/5">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold flex items-center text-white">
                    <i data-lucide="list-checks" class="w-5 h-5 mr-2 text-green-400"></i>
                    Denn√≠ √∫koly
                </h2>
                <span class="text-sm text-slate-400">Obnov√≠ se za: <span id="tasksReset" class="font-mono text-amber-400">--:--:--</span></span>
            </div>
            <div id="dailyTasksList" class="space-y-4">
                <!-- Tasks will be loaded here -->
            </div>
        </div>
            </div>

            <!-- Right Column: Progress & Actions -->
            <div class="space-y-6">
                <!-- Level Progress -->
                <div class="bg-slate-800/50 rounded-xl card-glow p-6 border border-white/5">
                    <h3 class="text-lg font-semibold mb-4 flex items-center text-white">
                        <i data-lucide="bar-chart-3" class="w-5 h-5 mr-2 text-amber-400"></i>
                        Pokrok k dal≈°√≠mu levelu
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between text-sm">
                            <span id="currentLevelText" class="text-slate-300">Level 1</span>
                            <span id="nextLevelText" class="text-amber-400">Level 2</span>
                        </div>
                        <div class="progress-bar h-3">
                            <div id="levelProgress" class="progress-fill h-full" style="width: 0%"></div>
                        </div>
                        <div id="levelBenefits" class="text-sm text-slate-400">
                            <!-- Level benefits will be shown here -->
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-slate-800/50 rounded-xl card-glow p-6 border border-white/5">
                    <h3 class="text-lg font-semibold mb-4 flex items-center text-white">
                        <i data-lucide="zap" class="w-5 h-5 mr-2 text-amber-400"></i>
                        Rychl√© akce
                    </h3>
                    <div class="space-y-3">
                        <button id="sharePostBtn" class="w-full bg-amber-500/20 hover:bg-amber-500/30 text-amber-300 py-3 px-4 rounded-lg transition-colors flex items-center justify-center border border-amber-500/20 card-hover">
                            <i data-lucide="share-2" class="w-4 h-4 mr-2"></i>
                            Sd√≠let p≈ô√≠spƒõvek (+15)
                        </button>
                        <button id="watchAdBtn" class="w-full bg-green-500/20 hover:bg-green-500/30 text-green-300 py-3 px-4 rounded-lg transition-colors flex items-center justify-center border border-green-500/20 card-hover">
                            <i data-lucide="tv" class="w-4 h-4 mr-2"></i>
                            Zhl√©dnout reklamu (+5)
                        </button>
                        <button id="updateProfileBtn" class="w-full bg-purple-500/20 hover:bg-purple-500/30 text-purple-300 py-3 px-4 rounded-lg transition-colors flex items-center justify-center border border-purple-500/20 card-hover">
                            <i data-lucide="user-cog" class="w-4 h-4 mr-2"></i>
                            Aktualizovat profil (+20)
                        </button>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="bg-slate-800/50 rounded-xl card-glow p-6 border border-white/5">
                    <h3 class="text-lg font-semibold mb-4 flex items-center text-white">
                        <i data-lucide="history" class="w-5 h-5 mr-2 text-slate-400"></i>
                        Ned√°vn√° aktivita
                    </h3>
                    <div id="recentTransactions" class="space-y-3 max-h-64 overflow-y-auto">
                        <!-- Recent transactions will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-slate-800 rounded-xl p-6 flex items-center space-x-4 card-glow border border-white/10">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-amber-400"></div>
            <span class="text-white">Naƒç√≠t√°n√≠...</span>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="successToast" class="fixed top-4 right-4 bg-green-500/90 backdrop-blur-sm text-white px-6 py-3 rounded-xl shadow-lg transform translate-x-full transition-transform z-50 border border-green-400/20">
        <div class="flex items-center">
            <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>
            <span id="successMessage">√öspƒõch!</span>
        </div>
    </div>

    <!-- Error Toast -->
    <div id="errorToast" class="fixed top-4 right-4 bg-red-500/90 backdrop-blur-sm text-white px-6 py-3 rounded-xl shadow-lg transform translate-x-full transition-transform z-50 border border-red-400/20">
        <div class="flex items-center">
            <i data-lucide="alert-circle" class="w-5 h-5 mr-2"></i>
            <span id="errorMessage">Chyba!</span>
        </div>
    </div>

    <!-- Scripts -->
    <script src="firebase-init.js"></script>
    <script src="credits-system-unified.js"></script>

    <script>
        // Initialize
        let creditsSystem;
        let currentUser = null;
        let countdownInterval = null;

        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();

            try {
                creditsSystem = new UnifiedCreditsSystem();
                await creditsSystem.init();
                
                // Firebase auth pouze pro ostr√Ω provoz
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    firebase.auth().onAuthStateChanged(async (user) => {
                        currentUser = user;
                        if (user) {
                            await loadUserData();
                            startCountdown();
                        } else {
                            showLoginPrompt();
                        }
                    });
                } else {
                    showError('Firebase nen√≠ spr√°vnƒõ nakonfigurov√°n');
                }

                setupEventListeners();
            } catch (error) {
                showError('Chyba p≈ôi inicializaci aplikace: ' + error.message);
            }
        });

        // Event Listeners
        function setupEventListeners() {
            // Back button
            document.getElementById('backBtn').addEventListener('click', () => {
                // Try to go back in history
                if (window.history.length > 1) {
                    window.history.back();
                } else {
                    // Fallback to main page
                    window.location.href = 'index.html';
                }
            });
            
            // Check-in button
            document.getElementById('checkInBtn').addEventListener('click', async () => {
                if (!currentUser) return;
                
                try {
                    showLoading(true);
                    const result = await creditsSystem.dailyCheckIn(currentUser.uid);
                    
                    if (result.success) {
                        showSuccess(`Check-in √∫spƒõ≈°n√Ω! +${result.creditsEarned} kredit≈Ø`);
                        document.getElementById('checkInResult').innerHTML = `
                            <div class="text-green-600 font-medium">
                                ‚úÖ +${result.creditsEarned} kredit≈Ø | S√©rie: ${result.streakDays} dn√≠
                            </div>
                        `;
                        await loadUserData();
                    } else {
                        showError(result.message);
                    }
                } catch (error) {
                    showError('Chyba p≈ôi check-in: ' + error.message);
                } finally {
                    showLoading(false);
                }
            });

            // Quick actions
            document.getElementById('sharePostBtn').addEventListener('click', () => {
                performQuickAction('SHARE_POST', 'P≈ô√≠spƒõvek sd√≠len');
            });
            
            document.getElementById('watchAdBtn').addEventListener('click', () => {
                performQuickAction('WATCH_AD', 'Reklama zhl√©dnuta');
            });
            
            document.getElementById('updateProfileBtn').addEventListener('click', () => {
                performQuickAction('PROFILE_UPDATE', 'Profil aktualizov√°n');
            });
        }

        // Quick action handler
        async function performQuickAction(taskType, successMsg) {
            if (!currentUser) {
                showError('Mus√≠≈° b√Ωt p≈ôihl√°≈°en!');
                return;
            }
            
            if (!creditsSystem) {
                showError('Kreditn√≠ syst√©m nen√≠ inicializov√°n');
                return;
            }
            
            try {
                console.log('Prov√°d√≠m akci:', taskType, 'pro u≈æivatele:', currentUser.uid);
                showLoading(true);
                
                const result = await creditsSystem.addCredits(currentUser.uid, taskType, { 
                    source: 'quick_action',
                    timestamp: new Date().toISOString()
                });
                
                console.log('V√Ωsledek akce:', result);
                
                if (result && result.success) {
                    showSuccess(`${successMsg}! +${result.creditsEarned} kredit≈Ø`);
                    await loadUserData();
                    await loadDailyTasks();
                } else {
                    const errorMsg = result?.message || 'Nezn√°m√° chyba';
                    showError(`Akce se nezda≈ôila: ${errorMsg}`);
                    console.error('Detail chyby:', result);
                }
            } catch (error) {
                console.error('Chyba p≈ôi akci:', error);
                showError(`Chyba p≈ôi akci: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        // Load user data
        async function loadUserData() {
            if (!currentUser || !creditsSystem) {
                return;
            }

            try {
                const userData = await creditsSystem.getUserCredits(currentUser.uid);
                
                // Update user info
                document.getElementById('userInfo').innerHTML = `
                    <span class="font-medium">${currentUser.displayName || currentUser.email || 'U≈æivatel'}</span>
                    <span class="text-white/70">(${userData.levelName || 'Tv≈Ørce'})</span>
                `;

                // Update stats
                document.getElementById('currentCredits').textContent = (userData.balance || 0).toLocaleString();
                document.getElementById('currentLevel').textContent = userData.level || 1;
                document.getElementById('levelName').textContent = userData.levelName || 'Zaƒç√°teƒçn√≠k';
                document.getElementById('currentStreak').textContent = userData.streakDays || 0;
                document.getElementById('totalEarned').textContent = (userData.totalEarned || 0).toLocaleString();

                // Update level progress
                document.getElementById('currentLevelText').textContent = `Level ${userData.level || 1}`;
                document.getElementById('nextLevelText').textContent = userData.nextLevelRequirement ? `Level ${(userData.level || 1) + 1}` : 'Max Level';
                document.getElementById('levelProgress').style.width = `${userData.progressToNextLevel || 0}%`;
                
                // Show level benefits
                const benefits = (userData.levelBenefits && userData.levelBenefits.length > 0) ? userData.levelBenefits.join(', ') : 'Z√°kladn√≠ funkce';
                document.getElementById('levelBenefits').innerHTML = `<strong>V√Ωhody:</strong> ${benefits}`;

                // Load other data
                await loadDailyTasks();
                await loadRecentTransactions();

            } catch (error) {
                showError('Chyba p≈ôi naƒç√≠t√°n√≠ dat: ' + error.message);
            }
        }

        // Load daily tasks
        async function loadDailyTasks() {
            if (!currentUser || !creditsSystem) return;

            try {
                const tasks = await creditsSystem.getDailyTasks(currentUser.uid);
                const container = document.getElementById('dailyTasksList');

                if (tasks.length === 0) {
                    container.innerHTML = '<div class="text-center py-4 text-slate-400">≈Ω√°dn√© √∫koly pro dnes</div>';
                    return;
                }

                container.innerHTML = tasks.map(task => `
                    <div class="flex items-center justify-between p-4 bg-slate-700/50 rounded-lg border border-white/5 ${task.completed ? 'opacity-60' : ''}">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full ${task.completed ? 'bg-green-500/20' : 'bg-amber-500/20'} flex items-center justify-center">
                                ${task.completed ? '<i data-lucide="check" class="w-5 h-5 text-green-400"></i>' : '<i data-lucide="target" class="w-5 h-5 text-amber-400"></i>'}
                            </div>
                            <div>
                                <div class="font-medium text-white ${task.completed ? 'line-through' : ''}">${task.name}</div>
                                <div class="text-sm text-slate-400">+${task.credits} kredit≈Ø</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-medium ${task.completed ? 'text-green-400' : 'text-amber-400'}">
                                ${task.progress}/${task.target}
                            </div>
                            <div class="w-16 bg-slate-600 rounded-full h-2 mt-1">
                                <div class="bg-amber-400 h-2 rounded-full transition-all" style="width: ${(task.progress / task.target) * 100}%"></div>
                            </div>
                        </div>
                    </div>
                `).join('');

                lucide.createIcons();
            } catch (error) {
                // Chyba p≈ôi naƒç√≠t√°n√≠ √∫kol≈Ø
            }
        }

        // Load recent transactions
        async function loadRecentTransactions() {
            if (!currentUser || !creditsSystem) return;

            try {
                const transactions = await creditsSystem.getTransactionHistory(currentUser.uid, 5);
                const container = document.getElementById('recentTransactions');

                if (transactions.length === 0) {
                    container.innerHTML = '<div class="text-center py-4 text-slate-400 text-sm">≈Ω√°dn√° ned√°vn√° aktivita</div>';
                    return;
                }

                container.innerHTML = transactions.map(transaction => `
                    <div class="flex items-center justify-between py-2 border-b border-slate-700 last:border-0">
                        <div>
                            <div class="font-medium text-sm text-white">${transaction.reason}</div>
                            <div class="text-xs text-slate-400">${new Date(transaction.timestamp).toLocaleString('cs-CZ')}</div>
                        </div>
                        <div class="font-semibold ${transaction.amount > 0 ? 'text-green-400' : 'text-red-400'}">
                            ${transaction.amount > 0 ? '+' : ''}${transaction.amount}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                // Chyba p≈ôi naƒç√≠t√°n√≠ transakc√≠
            }
        }

        // Start countdown
        function startCountdown() {
            if (countdownInterval) clearInterval(countdownInterval);
            
            countdownInterval = setInterval(() => {
                if (creditsSystem) {
                    const timeUntilReset = creditsSystem.getTimeUntilReset();
                    document.getElementById('checkInTime').textContent = `Reset za: ${timeUntilReset.formatted}`;
                    document.getElementById('tasksReset').textContent = timeUntilReset.formatted;
                }
            }, 1000);
        }

        // Show login prompt
        function showLoginPrompt() {
            document.getElementById('userInfo').innerHTML = '<span class="text-white/70">Nep≈ôihl√°≈°en</span>';
            document.getElementById('statsSection').innerHTML = `
                <div class="col-span-full text-center py-12">
                    <i data-lucide="user-x" class="w-16 h-16 text-white/50 mx-auto mb-4"></i>
                    <h2 class="text-2xl font-semibold text-white mb-2">P≈ôihlas se pro p≈ô√≠stup ke kredit≈Øm</h2>
                    <p class="text-slate-400 mb-6">Kredity jsou dostupn√© pouze pro tv≈Ørce</p>
                    <a href="login.html" class="btn-primary px-6 py-3 rounded-lg hover:shadow-lg transition-all transform hover:scale-105 inline-block">
                        P≈ôihl√°sit se
                    </a>
                </div>
            `;
            lucide.createIcons();
        }

        // Utility functions
        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
        }

        function showSuccess(message) {
            const toast = document.getElementById('successToast');
            document.getElementById('successMessage').textContent = message;
            toast.classList.remove('translate-x-full');
            setTimeout(() => toast.classList.add('translate-x-full'), 3000);
        }

        function showError(message) {
            const toast = document.getElementById('errorToast');
            document.getElementById('errorMessage').textContent = message;
            toast.classList.remove('translate-x-full');
            setTimeout(() => toast.classList.add('translate-x-full'), 3000);
        }
    </script>
</body>
</html>