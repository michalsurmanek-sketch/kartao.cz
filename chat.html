<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kartao.cz ‚Äì Chat & zpr√°vy</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üí¨</text></svg>">
  
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            night: {
              900: '#050816',
              950: '#02010a'
            }
          },
          boxShadow: {
            'card-soft': '0 22px 70px rgba(0,0,0,0.8)',
            'glow-fuchsia': '0 0 35px rgba(217,70,239,0.45)',
            'glow-amber': '0 0 35px rgba(251,191,36,0.45)'
          }
        }
      }
    };
  </script>
  
  <!-- Ikony Lucide ‚Äì jsDelivr -->
  <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>

  <style>
    .gradient-shell {
      background:
        radial-gradient(circle at top left, rgba(251,191,36,0.13), transparent 55%),
        radial-gradient(circle at bottom right, rgba(217,70,239,0.16), transparent 55%),
        #020617;
    }
    .glass-panel {
      background: rgba(15,23,42,0.9);
      backdrop-filter: blur(18px);
    }
    .chat-bubble {
      max-width: 80%;
      word-wrap: break-word;
      border-radius: 1.3rem;
      padding: 0.65rem 0.9rem;
      font-size: 0.875rem;
      line-height: 1.35;
    }
    .chat-bubble.own {
      margin-left: auto;
      background: linear-gradient(135deg,#db58f6,#ffb347);
      box-shadow: 0 10px 25px rgba(0,0,0,0.6);
      color: #020617;
    }
    .chat-bubble.other {
      margin-right: auto;
      background: rgba(31,41,55,0.95);
      border: 1px solid rgba(148,163,184,0.4);
    }
    .pill {
      border-radius: 9999px;
    }
  </style>
</head>

<body class="min-h-screen gradient-shell text-white">
  <!-- Firebase Setup -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="firebase-init.js"></script>
  <script src="api-services.js"></script>
  <!-- üí∞ K-Coins logika -->
  <script src="credits-system.js"></script>

  <!-- HORN√ç NAVBAR -->
  <header class="border-b border-white/10 bg-gradient-to-b from-black/90 to-black/60 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <!-- Logo -->
      <div class="flex items-center gap-3">
        <a href="index.html" class="flex items-center gap-2">
          <div class="w-9 h-9 rounded-2xl bg-gradient-to-br from-fuchsia-500 via-amber-400 to-yellow-400 shadow-glow-amber grid place-items-center">
            <span class="font-black text-sm text-black">K</span>
          </div>
          <div class="leading-tight">
            <div class="font-extrabold text-sm sm:text-base">Kartao.cz</div>
            <div class="text-[11px] text-slate-300">Chat &amp; zpr√°vy</div>
          </div>
        </a>
        <span class="hidden sm:inline-flex items-center pill bg-emerald-500/10 border border-emerald-400/40 px-3 py-1 text-[11px] font-semibold text-emerald-200 ml-2">
          <span class="w-2 h-2 rounded-full bg-emerald-400 mr-1.5 animate-pulse"></span>
          P≈ôihl√°≈°en√Ω u≈æivatel
        </span>
      </div>

      <!-- St≈ôedn√≠ navigace -->
      <nav class="hidden md:flex items-center gap-2 text-xs">
        <a href="creator-dashboard.html" class="pill px-3 py-1.5 bg-white/5 border border-white/15 hover:bg-white/10 transition flex items-center gap-1.5">
          <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
          <span>Dashboard</span>
        </a>
        <a href="moje-karta.html" class="pill px-3 py-1.5 bg-white/5 border border-white/15 hover:bg-white/10 transition flex items-center gap-1.5">
          <i data-lucide="id-card" class="w-4 h-4"></i>
          <span>Moje karta</span>
        </a>
      </nav>

      <!-- Prav√° ƒç√°st ‚Äì K-Coins + logout -->
      <div class="flex items-center gap-2 text-xs">
        <div class="hidden sm:flex items-center pill bg-black/60 border border-yellow-500/60 px-3 py-1.5 shadow-inner">
          <span class="text-[10px] tracking-[0.16em] text-yellow-200/80 uppercase mr-2">K-Coins</span>
          <span id="headerCredits" class="font-semibold text-yellow-300">‚Äî</span>
        </div>

        <button id="logout" class="hidden md:inline-flex pill px-3 py-1.5 bg-white/5 border border-white/15 hover:bg-white/10 text-[11px] font-medium items-center gap-1.5">
          <i data-lucide="log-out" class="w-4 h-4"></i>
          Odhl√°sit
        </button>

        <button id="logout-mobile" class="md:hidden pill px-2.5 py-1.5 bg-white/5 border border-white/15 hover:bg-white/10 text-[11px]">
          <i data-lucide="log-out" class="w-4 h-4"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- DROBEƒåKOV√Å NAVIGACE -->
  <nav class="border-b border-white/10 bg-black/40" aria-label="breadcrumb">
    <div class="max-w-6xl mx-auto px-4 py-2 text-xs text-slate-300 flex items-center gap-2">
      <a href="index.html" class="hover:text-white transition flex items-center gap-1">
        <i data-lucide="home" class="w-3 h-3"></i> Dom≈Ø
      </a>
      <span class="text-slate-500">/</span>
      <a href="creator-dashboard.html" class="hover:text-white transition">Dashboard</a>
      <span class="text-slate-500">/</span>
      <span class="text-white">Chat</span>
    </div>
  </nav>

  <!-- HLAVN√ç LAYOUT -->
  <main class="max-w-6xl mx-auto px-4 py-5">
    <div class="grid grid-cols-1 lg:grid-cols-[minmax(0,1.1fr)_minmax(0,2fr)] gap-5 h-[calc(100vh-170px)]">
      
      <!-- LEV√ù PANEL ‚Äì seznam konverzac√≠ -->
      <section class="glass-panel rounded-3xl border border-white/12 shadow-card-soft flex flex-col overflow-hidden">
        <div class="px-4 py-3 border-b border-white/10 flex items-center justify-between">
          <div>
            <p class="text-[11px] uppercase tracking-wide text-slate-400 mb-0.5 flex items-center gap-1.5">
              <i data-lucide="messages-square" class="w-3 h-3"></i>
              Konverzace
            </p>
            <h2 class="text-sm font-semibold">Chat se znaƒçkami a tv≈Ørci</h2>
          </div>
          <button id="newConvBtn" class="hidden text-[11px] pill px-3 py-1 bg-white/5 border border-white/15 hover:bg-white/10">
            Nov√° zpr√°va
          </button>
        </div>

        <div id="conversationsList" class="flex-1 overflow-y-auto">
          <div class="p-8 text-center text-white/60">
            <i data-lucide="message-circle" class="w-10 h-10 mx-auto mb-3 text-white/40"></i>
            <div class="text-sm font-medium">Naƒç√≠t√°n√≠ konverzac√≠...</div>
          </div>
        </div>
      </section>

      <!-- PRAV√ù PANEL ‚Äì samotn√Ω chat -->
      <section class="glass-panel rounded-3xl border border-white/12 shadow-card-soft flex flex-col overflow-hidden">
        <!-- Header chatu -->
        <div id="chatHeader" class="px-4 py-3 border-b border-white/10 hidden">
          <div class="flex items-center gap-3">
            <img id="chatAvatar" src="" alt="Avatar u≈æivatele" class="w-9 h-9 rounded-full object-cover bg-neutral-800 border border-white/15">
            <div class="min-w-0">
              <div id="chatName" class="font-semibold text-sm truncate">‚Äî</div>
              <div id="chatStatus" class="text-[11px] text-emerald-300 flex items-center gap-1 mt-0.5">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                Online
              </div>
            </div>
          </div>
        </div>

        <!-- Oblast zpr√°v -->
        <div id="messagesArea" class="flex-1 overflow-y-auto px-4 py-4 space-y-3">
          <div class="h-full flex items-center justify-center text-white/60">
            <div class="text-center max-w-xs">
              <i data-lucide="message-square" class="w-14 h-14 mx-auto mb-3 text-white/30"></i>
              <div class="text-base font-medium mb-1">Vyberte konverzaci</div>
              <div class="text-xs text-slate-400">Vlevo klikni na libovolnou konverzaci nebo zaƒçni novou z profilu tv≈Ørce ƒçi kampanƒõ.</div>
            </div>
          </div>
        </div>

        <!-- Input -->
        <div id="messageInput" class="hidden px-4 py-3 border-t border-white/10 bg-black/40">
          <div class="flex items-end gap-3">
            <div class="flex-1">
              <input
                id="messageText"
                type="text"
                autocomplete="off"
                placeholder="Napi≈°te zpr√°vu..."
                class="w-full bg-neutral-900/90 border border-white/20 rounded-2xl px-3.5 py-2.5 text-sm text-white placeholder:text-white/40 outline-none focus:border-fuchsia-500 focus:ring-1 focus:ring-fuchsia-500/60"
              >
              <p class="text-[10px] text-slate-500 mt-1">Enter = odeslat. Shift + Enter = nov√Ω ≈ô√°dek.</p>
            </div>
            <button
              id="sendMessage"
              class="pill px-4 py-2.5 bg-gradient-to-r from-fuchsia-500 via-amber-400 to-yellow-400 text-black text-xs font-semibold shadow-glow-fuchsia hover:brightness-110 transition flex items-center justify-center gap-1.5"
            >
              <i data-lucide="send" class="w-4 h-4"></i>
              <span>Odeslat</span>
            </button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    let chatService;
    let currentUser = null;
    let currentConversationId = null;
    let messagesListener = null;
    let conversationsListener = null;

    // ikony
    function refreshIcons() {
      if (typeof lucide !== 'undefined') {
        setTimeout(() => {
          try { lucide.createIcons(); } catch (e) { console.warn('Lucide error:', e); }
        }, 10);
      }
    }

    // p≈ôevod ƒçasu
    function toMillis(ts) {
      if (!ts) return 0;
      if (typeof ts.toMillis === 'function') return ts.toMillis();
      if (ts instanceof Date) return ts.getTime();
      return Number(ts) || 0;
    }

    // K-Coins v headeru
    function updateHeaderCredits(userId) {
      try {
        if (typeof CreditsSystem === 'undefined') return;
        const cs = new CreditsSystem(userId);
        const credits = cs.getCredits ? cs.getCredits() : 0;
        const el = document.getElementById('headerCredits');
        if (el) el.textContent = (credits || 0).toLocaleString('cs-CZ');
      } catch (e) {
        console.warn('Chyba p≈ôi naƒç√≠t√°n√≠ K-Coins v headeru:', e);
      }
    }

    // Firebase auth
    kartaoAuth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      currentUser = user;
      if (typeof ChatService === 'undefined') {
        console.error('ChatService nen√≠ k dispozici (api-services.js).');
        return;
      }
      chatService = new ChatService();

      // üí∞ K-Coins
      updateHeaderCredits(currentUser.uid);

      // prvn√≠ naƒçten√≠ konverzac√≠
      loadConversations();

      // realtime listener
      conversationsListener = chatService.listenToConversations(user.uid, (snapshot) => {
        const conversations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderConversations(conversations);
      });
    });

    async function loadConversations() {
      try {
        const conversations = await chatService.getUserConversations(currentUser.uid);
        renderConversations(conversations);
      } catch (error) {
        console.error('Chyba p≈ôi naƒç√≠t√°n√≠ konverzac√≠:', error);
        const container = document.getElementById('conversationsList');
        container.innerHTML = `
          <div class="p-6 text-center text-red-300 text-sm">
            Do≈°lo k chybƒõ p≈ôi naƒç√≠t√°n√≠ konverzac√≠. Zkuste str√°nku obnovit.
          </div>
        `;
        refreshIcons();
      }
    }

    function renderConversations(conversations) {
      const container = document.getElementById('conversationsList');

      if (!conversations || conversations.length === 0) {
        container.innerHTML = `
          <div class="p-8 text-center text-white/60">
            <i data-lucide="message-circle" class="w-10 h-10 mx-auto mb-3 text-white/40"></i>
            <div class="text-sm font-medium">Zat√≠m ≈æ√°dn√© konverzace</div>
            <div class="text-xs mt-1 text-slate-400">Prvn√≠ zpr√°vu m≈Ø≈æete poslat z profilu tv≈Ørce nebo z detailu kampanƒõ.</div>
          </div>
        `;
        refreshIcons();
        return;
      }

      container.innerHTML = conversations.map(conv => {
        const participants = conv.participants || [];
        const otherUserId = participants.find(p => p !== currentUser.uid) || 'U≈æivatel';
        const unreadCount = conv.unreadCount?.[currentUser.uid] || 0;
        const lastMessage = conv.lastMessage;

        return `
          <button
            class="conversation-item w-full text-left px-4 py-3 border-b border-white/8 hover:bg-white/5 transition flex items-center gap-3"
            data-conversation-id="${conv.id}"
            data-other-id="${otherUserId}"
          >
            <img
              src="https://api.dicebear.com/7.x/initials/svg?seed=${encodeURIComponent(otherUserId)}"
              alt="Avatar u≈æivatele ${otherUserId}"
              class="w-10 h-10 rounded-full object-cover bg-neutral-800 border border-white/15 flex-shrink-0"
            >
            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between gap-2">
                <div class="font-medium text-sm truncate">${otherUserId}</div>
                ${unreadCount > 0 ? `<span class="bg-fuchsia-500 text-white text-[10px] rounded-full min-w-[20px] h-5 flex items-center justify-center px-1">${unreadCount}</span>` : ''}
              </div>
              <div class="text-xs text-white/60 truncate">
                ${lastMessage ? lastMessage.text : 'Nov√° konverzace'}
              </div>
              <div class="text-[10px] text-white/35 mt-0.5">
                ${lastMessage ? ChatService.formatMessageTime(lastMessage.createdAt) : ''}
              </div>
            </div>
          </button>
        `;
      }).join('');

      container.querySelectorAll('.conversation-item').forEach(btn => {
        btn.addEventListener('click', () => {
          const convId = btn.dataset.conversationId;
          const otherId = btn.dataset.otherId;
          openConversation(convId, otherId);
        });
      });

      refreshIcons();
    }

    async function openConversation(conversationId, otherUserId) {
      currentConversationId = conversationId;

      try {
        await chatService.markAsRead(conversationId, currentUser.uid);
      } catch (err) {
        console.warn('Nepovedlo se oznaƒçit jako p≈ôeƒçten√©:', err);
      }

      document.getElementById('chatHeader').classList.remove('hidden');
      document.getElementById('messageInput').classList.remove('hidden');

      const avatarUrl = `https://api.dicebear.com/7.x/initials/svg?seed=${encodeURIComponent(otherUserId)}`;
      document.getElementById('chatAvatar').src = avatarUrl;
      document.getElementById('chatName').textContent = otherUserId;
      document.getElementById('chatStatus').textContent = 'Online';

      await loadMessages(conversationId);

      if (messagesListener) messagesListener();
      messagesListener = chatService.listenToMessages(conversationId, (snapshot) => {
        const messages = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        })).sort((a, b) => toMillis(a.createdAt) - toMillis(b.createdAt));
        renderMessages(messages);
      });

      refreshIcons();
    }

    async function loadMessages(conversationId) {
      try {
        const messages = await chatService.getMessages(conversationId);
        messages.sort((a, b) => toMillis(a.createdAt) - toMillis(b.createdAt));
        renderMessages(messages);
      } catch (error) {
        console.error('Chyba p≈ôi naƒç√≠t√°n√≠ zpr√°v:', error);
        const container = document.getElementById('messagesArea');
        container.innerHTML = `
          <div class="h-full flex items-center justify-center text-red-300 text-sm">
            Do≈°lo k chybƒõ p≈ôi naƒç√≠t√°n√≠ zpr√°v. Zkuste to pros√≠m znovu.
          </div>
        `;
        refreshIcons();
      }
    }

    function renderMessages(messages) {
      const container = document.getElementById('messagesArea');

      if (!messages || messages.length === 0) {
        container.innerHTML = `
          <div class="h-full flex items-center justify-center text-white/60">
            <div class="text-center max-w-xs">
              <i data-lucide="message-square" class="w-14 h-14 mx-auto mb-3 text-white/30"></i>
              <div class="text-base font-medium mb-1">Zaƒçnƒõte konverzaci</div>
              <div class="text-xs text-slate-400">Napi≈°te prvn√≠ zpr√°vu do pole dole.</div>
            </div>
          </div>
        `;
        refreshIcons();
        return;
      }

      container.innerHTML = messages.map(message => {
        const isOwn = message.senderId === currentUser.uid;
        const timeLabel = ChatService.formatMessageTime(message.createdAt);
        const readMark = isOwn ? (message.read ? ' ‚úì‚úì' : ' ‚úì') : '';

        return `
          <div class="flex ${isOwn ? 'justify-end' : 'justify-start'}">
            <div class="chat-bubble ${isOwn ? 'own' : 'other'}">
              <div>${message.text}</div>
              <div class="text-[10px] opacity-70 mt-1 text-right">
                ${timeLabel}${readMark}
              </div>
            </div>
          </div>
        `;
      }).join('');

      container.scrollTop = container.scrollHeight;
      refreshIcons();
    }

    // ODESL√ÅN√ç ZPR√ÅVY
    const messageInputEl = document.getElementById('messageText');
    const sendBtn = document.getElementById('sendMessage');

    async function sendMessage() {
      const text = messageInputEl.value.trim();
      if (!text || !currentConversationId) return;

      try {
        sendBtn.disabled = true;
        await chatService.sendMessage(currentConversationId, currentUser.uid, text);
        messageInputEl.value = '';
      } catch (error) {
        console.error('Chyba p≈ôi odes√≠l√°n√≠ zpr√°vy:', error);
        alert('Zpr√°vu se nepoda≈ôilo odeslat. Zkuste to znovu.');
      } finally {
        sendBtn.disabled = false;
        messageInputEl.focus();
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    messageInputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Logout (desktop + mobil)
    async function handleLogout() {
      try {
        await kartaoAuth.logout();
        window.location.href = 'index.html';
      } catch (error) {
        console.error('Chyba p≈ôi odhla≈°ov√°n√≠:', error);
      }
    }

    const logoutBtn = document.getElementById('logout');
    const logoutMobileBtn = document.getElementById('logout-mobile');

    if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
    if (logoutMobileBtn) logoutMobileBtn.addEventListener('click', handleLogout);

    // √öklid listener≈Ø
    window.addEventListener('beforeunload', () => {
      if (messagesListener) messagesListener();
      if (conversationsListener) conversationsListener();
    });

    // prvn√≠ vykreslen√≠ ikon
    document.addEventListener('DOMContentLoaded', () => {
      refreshIcons();
    });
  </script>
</body>
</html>
