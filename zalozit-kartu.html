<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />

  <!-- BRUT√ÅLN√ç ZABIT√ç V≈†ECH SERVICE WORKER≈Æ ‚Äì jen pro jistotu -->
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker
        .getRegistrations()
        .then((regs) => {
          regs.forEach((reg) => {
            console.log("üî• Odstra≈àuji service worker:", reg);
            reg.unregister();
          });
        })
        .catch((err) => console.error("SW error:", err));
    }
  </script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kartao.cz ‚Äì Zalo≈æit kartu</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            fuchsia: tailwind.colors.fuchsia,
            amber: tailwind.colors.amber,
            neutral: tailwind.colors.neutral,
            emerald: tailwind.colors.emerald,
            sky: tailwind.colors.sky,
          },
          boxShadow: {
            soft: "0 18px 45px rgba(15,23,42,0.85)",
          },
          borderRadius: {
            "2xl": "1rem",
          },
        },
      },
    };
  </script>

  <!-- Ikony -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }
    .card {
      border-radius: 1rem;
      background: radial-gradient(
        circle at top left,
        rgba(236, 72, 153, 0.16),
        rgba(15, 23, 42, 0.98)
      );
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 0 24px 80px rgba(15, 23, 42, 0.9);
    }
    .btn {
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.875rem;
      padding: 0.6rem 1.2rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      border-width: 1px;
      border-style: solid;
      transition: all 150ms ease;
    }
    .btn-primary {
      background-image: linear-gradient(
        to right,
        #fbbf24,
        #ec4899,
        #38bdf8
      );
      color: #020617;
      border-color: transparent;
      box-shadow: 0 15px 45px rgba(236, 72, 153, 0.5);
    }
    .btn-primary:hover {
      filter: brightness(1.08);
      transform: translateY(-1px);
    }
    .btn-outline {
      background: transparent;
      color: #e5e7eb;
      border-color: rgba(148, 163, 184, 0.6);
    }
    .btn-outline:hover {
      background: rgba(148, 163, 184, 0.15);
    }
    .input {
      width: 100%;
      border-radius: 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background-color: rgba(15, 23, 42, 0.85);
      padding: 0.6rem 0.85rem;
      font-size: 0.9rem;
      color: #e5e7eb;
      outline: none;
    }
    .input:focus {
      border-color: #ec4899;
      box-shadow: 0 0 0 1px rgba(236, 72, 153, 0.6);
    }
    .label {
      font-size: 0.8rem;
      color: #9ca3af;
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    .pill {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 0.25rem 0.65rem;
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      color: #e5e7eb;
      background: rgba(15, 23, 42, 0.6);
    }
  </style>
</head>
<body
  class="min-h-screen bg-gradient-to-br from-neutral-950 via-slate-950 to-fuchsia-950 text-white"
>
  <div class="max-w-4xl mx-auto px-4 py-6 md:py-10">
    <!-- Hlaviƒçka -->
    <div class="flex items-center justify-between gap-3 mb-6">
      <div>
        <h1
          class="text-2xl md:text-3xl font-bold tracking-tight flex items-center gap-2"
        >
          <span
            class="inline-flex h-8 w-8 items-center justify-center rounded-2xl bg-fuchsia-500/20 border border-fuchsia-500/40"
          >
            <i
              data-lucide="credit-card"
              class="w-4 h-4 text-fuchsia-300"
            ></i>
          </span>
          Zalo≈æit kartu influencera
        </h1>
        <p class="text-sm text-white/60 mt-1">
          Vypl≈à z√°kladn√≠ informace o sobƒõ. Kdykoliv je m≈Ø≈æe≈° pozdƒõji upravit.
        </p>
      </div>
      <a href="index.html" class="btn btn-outline">
        <i data-lucide="arrow-left" class="w-4 h-4"></i>
        Zpƒõt na marketplace
      </a>
    </div>

    <!-- Info o stavu -->
    <div id="statusBox" class="mb-4 hidden">
      <div class="pill" id="statusText"></div>
    </div>

    <!-- Status indik√°tor odstranƒõn -->

    <!-- KARTA S FORMUL√Å≈òEM -->
    <div class="card p-4 md:p-6">
      <form id="creatorForm" class="space-y-6">
        <!-- Z√°kladn√≠ info -->
        <div class="grid md:grid-cols-2 gap-4">
          <div class="space-y-1.5">
            <label class="label">
              <i data-lucide="user" class="w-4 h-4"></i>
              Jm√©no / n√°zev profilu
            </label>
            <input
              id="name"
              type="text"
              class="input"
              placeholder="Nap≈ô. Michal ‚Äì obsah o businessu"
              required
            />
          </div>
          <div class="space-y-1.5">
            <label class="label">
              <i data-lucide="at-sign" class="w-4 h-4"></i>
              Handle (bez @)
            </label>
            <input
              id="handle"
              type="text"
              class="input"
              placeholder="michalsurmanek"
              required
            />
          </div>
        </div>

        <div class="grid md:grid-cols-3 gap-4">
          <div class="space-y-1.5">
            <label class="label">
              <i data-lucide="map-pin" class="w-4 h-4"></i>
              Mƒõsto
            </label>
            <input id="city" type="text" class="input" placeholder="Brno" />
          </div>
          <div class="space-y-1.5">
            <label class="label">
              <i data-lucide="sparkles" class="w-4 h-4"></i>
              Kategorie
            </label>
            <select id="category" class="input">
              <option value="Lifestyle">Lifestyle</option>
              <option value="Beauty">Beauty</option>
              <option value="Fitness">Fitness</option>
              <option value="Gaming">Gaming</option>
              <option value="Tech">Tech</option>
              <option value="Food">Food</option>
              <option value="Travel">Travel</option>
              <option value="Auto">Auto</option>
              <option value="Music">Music</option>
              <option value="Other">Jin√©</option>
            </select>
          </div>
          <div class="space-y-1.5">
            <label class="label">
              <i data-lucide="ticket-percent" class="w-4 h-4"></i>
              Cena od (Kƒç / post)
            </label>
            <input
              id="price"
              type="number"
              min="0"
              class="input"
              placeholder="1500"
            />
          </div>
        </div>

        <div class="space-y-1.5">
          <label class="label">
            <i data-lucide="file-text" class="w-4 h-4"></i>
            Kr√°tk√Ω popis / bio
          </label>
          <textarea
            id="bio"
            class="input"
            rows="3"
            placeholder="O ƒçem je tv≈Øj obsah, co firmy z√≠skaj√≠ spoluprac√≠?"
          ></textarea>
        </div>

        <!-- OBR√ÅZKY KARTY -->
        <section class="space-y-6 mt-6">
          <h2 class="text-sm font-semibold text-white/80">
            Fotky karty influencera
          </h2>

          <!-- Avatar -->
          <div class="space-y-2">
            <label class="label">
              <i data-lucide="image" class="w-4 h-4"></i>
              Profilov√° fotka (avatar)
            </label>

            <img
              id="previewAvatar"
              src=""
              alt="N√°hled avataru"
              class="w-24 h-24 rounded-xl object-cover border border-white/10 hidden"
            />

            <input
              id="avatarFile"
              type="file"
              accept="image/*"
              class="input"
            />

            <p class="text-[11px] text-white/50">
              Doporuƒçeno min. 400√ó400 px, ƒçtvercov√Ω form√°t.
            </p>
          </div>

          <!-- Cover -->
          <div class="space-y-2">
            <label class="label">
              <i data-lucide="panels-top-left" class="w-4 h-4"></i>
              √övodn√≠ fotka (cover)
            </label>

            <img
              id="previewCover"
              src=""
              alt="N√°hled coveru"
              class="w-full h-32 rounded-xl object-cover border border-white/10 hidden"
            />

            <input
              id="coverFile"
              type="file"
              accept="image/*"
              class="input"
            />

            <p class="text-[11px] text-white/50">
              Doporuƒçeno min. 1200√ó400 px, horizont√°ln√≠ fotka.
            </p>
          </div>

          <!-- Galerie -->
          <div class="space-y-2">
            <label class="label">
              <i data-lucide="images" class="w-4 h-4"></i>
              Galerie (3 fotky)
            </label>

            <div class="grid grid-cols-3 gap-3">
              <div class="space-y-1.5">
                <img
                  id="previewGal1"
                  src=""
                  alt="Galerie 1"
                  class="w-full h-20 rounded-lg object-cover border border-white/10 hidden"
                />
                <input
                  id="gal1File"
                  type="file"
                  accept="image/*"
                  class="input text-[11px] px-2 py-1.5"
                />
              </div>

              <div class="space-y-1.5">
                <img
                  id="previewGal2"
                  src=""
                  alt="Galerie 2"
                  class="w-full h-20 rounded-lg object-cover border border-white/10 hidden"
                />
                <input
                  id="gal2File"
                  type="file"
                  accept="image/*"
                  class="input text-[11px] px-2 py-1.5"
                />
              </div>

              <div class="space-y-1.5">
                <img
                  id="previewGal3"
                  src=""
                  alt="Galerie 3"
                  class="w-full h-20 rounded-lg object-cover border border-white/10 hidden"
                />
                <input
                  id="gal3File"
                  type="file"
                  accept="image/*"
                  class="input text-[11px] px-2 py-1.5"
                />
              </div>
            </div>

            <p class="text-[11px] text-white/50">
              M≈Ø≈æou b√Ωt fotky z feedu, z kampan√≠, portr√©ty atd.
            </p>
          </div>
        </section>

        <!-- Platformy + followers -->
        <div class="space-y-2">
          <div class="flex items-center justify-between gap-3">
            <span class="label">
              <i data-lucide="share-2" class="w-4 h-4"></i>
              P≈ôipojen√© platformy & followers
            </span>
            <span class="text-xs text-white/50">
              Staƒç√≠ vyplnit ty, kter√© pou≈æ√≠v√°≈°.
            </span>
          </div>

          <div class="grid md:grid-cols-2 gap-3">
            <div class="flex items-center gap-3">
              <label class="pill min-w-[120px]">
                <input
                  id="pf-instagram"
                  type="checkbox"
                  class="h-3.5 w-3.5 rounded border-slate-600 bg-slate-900"
                />
                <i
                  data-lucide="camera"
                  class="w-3.5 h-3.5 text-fuchsia-300"
                ></i>
                Instagram
              </label>
              <input
                id="followers-instagram"
                type="number"
                min="0"
                class="input"
                placeholder="Followers"
              />
            </div>

            <div class="flex items-center gap-3">
              <label class="pill min-w-[120px]">
                <input
                  id="pf-tiktok"
                  type="checkbox"
                  class="h-3.5 w-3.5 rounded border-slate-600 bg-slate-900"
                />
                <i
                  data-lucide="music-4"
                  class="w-3.5 h-3.5 text-sky-300"
                ></i>
                TikTok
              </label>
              <input
                id="followers-tiktok"
                type="number"
                min="0"
                class="input"
                placeholder="Followers"
              />
            </div>

            <div class="flex items-center gap-3">
              <label class="pill min-w-[120px]">
                <input
                  id="pf-youtube"
                  type="checkbox"
                  class="h-3.5 w-3.5 rounded border-slate-600 bg-slate-900"
                />
                <i
                  data-lucide="play"
                  class="w-3.5 h-3.5 text-red-300"
                ></i>
                YouTube
              </label>
              <input
                id="followers-youtube"
                type="number"
                min="0"
                class="input"
                placeholder="Subscribers"
              />
            </div>

            <div class="flex items-center gap-3">
              <label class="pill min-w-[120px]">
                <input
                  id="pf-facebook"
                  type="checkbox"
                  class="h-3.5 w-3.5 rounded border-slate-600 bg-slate-900"
                />
                <i
                  data-lucide="facebook"
                  class="w-3.5 h-3.5 text-blue-300"
                ></i>
                Facebook
              </label>
              <input
                id="followers-facebook"
                type="number"
                min="0"
                class="input"
                placeholder="Followers"
              />
            </div>

            <div class="flex items-center gap-3">
              <label class="pill min-w-[120px]">
                <input
                  id="pf-pinterest"
                  type="checkbox"
                  class="h-3.5 w-3.5 rounded border-slate-600 bg-slate-900"
                />
                <i
                  data-lucide="image"
                  class="w-3.5 h-3.5 text-rose-300"
                ></i>
                Pinterest
              </label>
              <input
                id="followers-pinterest"
                type="number"
                min="0"
                class="input"
                placeholder="Followers"
              />
            </div>
          </div>
        </div>

        <!-- Extra parametry -->
        <div class="grid md:grid-cols-3 gap-4">
          <div class="space-y-1.5">
            <label class="label">
              <i data-lucide="star" class="w-4 h-4"></i>
              Hodnocen√≠ (0‚Äì5, voliteln√©)
            </label>
            <input
              id="rating"
              type="number"
              min="0"
              max="5"
              step="0.1"
              class="input"
              placeholder="4.9"
            />
          </div>
          <div class="space-y-1.5">
            <label class="label">
              <i data-lucide="activity" class="w-4 h-4"></i>
              Engagement (%) ‚Äì voliteln√©
            </label>
            <input
              id="engagement"
              type="number"
              min="0"
              step="0.1"
              class="input"
              placeholder="7.5"
            />
          </div>
          <div class="flex items-center gap-3 mt-6">
            <label
              class="inline-flex items-center gap-2 text-sm text-white/80"
            >
              <input
                id="premium"
                type="checkbox"
                class="h-4 w-4 rounded border-slate-600 bg-slate-900"
              />
              <span>Premium profil (doporuƒçovan√Ω)</span>
            </label>
          </div>
        </div>

        <!-- Tlaƒç√≠tka -->
        <div
          class="flex flex-col md:flex-row items-stretch md:items-center justify-between gap-3 pt-2"
        >
          <div class="text-xs text-white/60">
            Ulo≈æen√≠m vytvo≈ô√≠≈° / aktualizuje≈° svou kartu v marketplace. D√° se
            kdykoliv znovu upravit.
          </div>
          <div class="flex items-center gap-2">
            <button type="button" id="cancelBtn" class="btn btn-outline">
              Zru≈°it
            </button>
            <button type="submit" class="btn btn-primary">
              <i data-lucide="save" class="w-4 h-4"></i>
              Ulo≈æit kartu
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Konfigurace + inicializace -->
  <script src="supabase-config.js"></script>
  <script src="supabase-init.js"></script>
  <script src="supabase-compatibility.js"></script>
  <script src="auth-supabase.js"></script>
  <script src="auth-header.js"></script>
  <script src="credits-system-supabase.js"></script>
  <script src="credits-header.js"></script>
  <script src="zalozit-kartu-supabase.js"></script>

  <script>
    // üõ°Ô∏è GLOB√ÅLN√ç PROMƒöNN√â - MUS√ç B√ùT MIMO DOMContentLoaded!
    window.isSubmitting = false;
    window.formHasData = false;
    window.authChecked = false;
    
    // Default obr√°zky
    const DEFAULT_AVATAR =
      "https://images.unsplash.com/photo-1544723795-3fb6469f5b39?w=300&h=300&fit=crop&crop=faces";
    const DEFAULT_COVER =
      "https://images.unsplash.com/photo-1526481280695-3c687fd543c0?w=800&h=320&fit=crop&crop=center";
    const DEFAULT_GALLERY = [
      "https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=400&h=250&fit=crop&crop=center",
      "https://images.unsplash.com/photo-1521737604893-d14cc237f11d?w=400&h=250&fit=crop&crop=center",
      "https://images.unsplash.com/photo-1487412720507-e7ab37603c6f?w=400&h=250&fit=crop&crop=center",
    ];

    let existingAvatarURL = DEFAULT_AVATAR;
    let existingCoverURL = DEFAULT_COVER;
    let existingGalleryURLs = [...DEFAULT_GALLERY];

    function showStatus(text, ok = true) {
      const box = document.getElementById("statusBox");
      const span = document.getElementById("statusText");
      if (!box || !span) return;
      span.textContent = text;
      span.style.borderColor = ok
        ? "rgba(52,211,153,0.7)"
        : "rgba(248,113,113,0.8)";
      span.style.background = ok
        ? "rgba(22,163,74,0.25)"
        : "rgba(127,29,29,0.35)";
      box.classList.remove("hidden");
    }

    function setupPreview(inputId, imgId) {
      const input = document.getElementById(inputId);
      const img = document.getElementById(imgId);
      if (!input || !img) return;

      input.addEventListener("change", () => {
        const file = input.files && input.files[0];
        if (!file) return;
        const url = URL.createObjectURL(file);
        img.src = url;
        img.classList.remove("hidden");
      });
    }

    async function uploadImageIfNeeded(fileInputId, defaultUrl, path) {
      const input = document.getElementById(fileInputId);
      if (!input || !input.files || !input.files[0]) {
        return defaultUrl;
      }

      const file = input.files[0];

      if (!window.storage) {
        console.warn("Storage nen√≠ inicializov√°no, vrac√≠m default URL.");
        return defaultUrl;
      }

      try {
        const ref = window.storage.ref().child(path);
        await ref.put(file);
        const url = await ref.getDownloadURL();
        return url || defaultUrl;
      } catch (err) {
        console.error(
          "Upload obr√°zku selhal (CORS / Storage), pou≈æ√≠v√°m fallback URL:",
          err
        );
        showStatus(
          "Nahr√°n√≠ fotky se nepovedlo, ale karta se ulo≈æ√≠ bez n√≠.",
          false
        );
        return defaultUrl;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      if (window.lucide?.createIcons) lucide.createIcons();

      // üî• VYƒåISTIT FIRESTORE PERSISTENCE CACHE
      if (window.indexedDB) {
        try {
          const dbDeleteRequest = indexedDB.deleteDatabase('firestore/kartao-97df7/[DEFAULT]');
          dbDeleteRequest.onsuccess = () => console.log("üóëÔ∏è Firestore IndexedDB cache vymaz√°na");
          dbDeleteRequest.onerror = () => console.warn("‚ö†Ô∏è Nepoda≈ôilo se vymazat IndexedDB");
          
          // Dal≈°√≠ mo≈æn√© datab√°ze
          indexedDB.deleteDatabase('firebaseLocalStorageDb');
        } catch (e) {
          console.warn("‚ö†Ô∏è IndexedDB delete error:", e.message);
        }
      }

      // üî• FIREBASE STATUS MONITOR
      // Status odstranƒõn
      
      const form = document.getElementById("creatorForm");

      function updateFirebaseStatus(online) {
        if (online) {
          statusIcon.className = "h-2.5 w-2.5 rounded-full bg-emerald-400";
          statusIcon.style.animation = "none";
          statusText.textContent = "Firebase ONLINE ‚Äì m≈Ø≈æe≈° ukl√°dat kartu";
          statusEl.style.borderColor = "rgba(52,211,153,0.5)";
          statusEl.style.backgroundColor = "rgba(22,163,74,0.15)";
        } else {
          statusIcon.className = "h-2.5 w-2.5 rounded-full bg-rose-500 animate-pulse";
          statusText.textContent = "‚ö†Ô∏è Firebase OFFLINE ‚Äì nep≈Øjde ulo≈æit kartu!";
          statusEl.style.borderColor = "rgba(248,113,113,0.5)";
          statusEl.style.backgroundColor = "rgba(127,29,29,0.25)";
        }
      }

      // Kontrola p≈ôipojen√≠
      let isOnline = false;
      
      async function checkFirebaseConnection() {
        if (!window.db) {
          console.warn("‚ö†Ô∏è window.db nen√≠ dostupn√©");
          updateFirebaseStatus(false);
          return false;
        }
        
        try {
          // Jednoduch√Ω test - p≈ôeƒç√≠st .info/connected (neexistuje v Firestore, ale test p≈ôipojen√≠)
          const testRef = window.db.collection("_ping").doc("test");
          await testRef.set({ t: Date.now() }, { merge: true });
          
          if (!isOnline) {
            isOnline = true;
            updateFirebaseStatus(true);
            console.log("‚úÖ Firebase ONLINE");
          }
          return true;
        } catch (err) {
          if (isOnline || isOnline === false) {
            isOnline = false;
            updateFirebaseStatus(false);
            console.error("‚ùå Firebase OFFLINE:", err.message);
          }
          return false;
        }
      }

      // Opakovan√° kontrola ka≈æd√© 2s
      setInterval(checkFirebaseConnection, 2000);

      // Prvn√≠ kontrola ihned po naƒçten√≠ (s ƒçek√°n√≠m na Firebase init a auth)
      let initAttempts = 0;
      let authReady = false;
      
      // Posluchaƒç na auth zmƒõnu
      if (window.kartaoAuth) {
        window.kartaoAuth.onAuthStateChanged((user) => {
          if (user) {
            authReady = true;
            console.log(`[Auth] P≈ôihl√°≈°en: ${user.id}`);
            
            // Ihned po p≈ôihl√°≈°en√≠ zkus test READ
            if (window.db) {
              window.db.collection('creators').doc(user.uid).get()
                .then((doc) => {
                  console.log(`‚úÖ Test READ creators/${user.uid}:`, doc.exists ? 'existuje' : 'neexistuje (OK)');
                })
                .catch((err) => {
                  console.error(`‚ùå Test READ SELHAL:`, err.code, err.message);
                  if (err.code === 'permission-denied') {
                    console.error(`üî¥üî¥üî¥ FIRESTORE RULES BLOKUJ√ç ƒåTEN√ç! Mus√≠≈° nasadit nov√° pravidla!`);
                  }
                });
            }
          }
        });
      }
      
      // form u≈æ je deklarovan√Ω v√Ω≈° (≈ô√°dek 682)

      setupPreview("avatarFile", "previewAvatar");
      setupPreview("coverFile", "previewCover");
      setupPreview("gal1File", "previewGal1");
      setupPreview("gal2File", "previewGal2");
      setupPreview("gal3File", "previewGal3");

      // Z√°kladn√≠ n√°hledy
      const prevA = document.getElementById("previewAvatar");
      const prevC = document.getElementById("previewCover");
      const prevG1 = document.getElementById("previewGal1");
      const prevG2 = document.getElementById("previewGal2");
      const prevG3 = document.getElementById("previewGal3");

      if (prevA) {
        prevA.src = existingAvatarURL;
        prevA.classList.remove("hidden");
      }
      if (prevC) {
        prevC.src = existingCoverURL;
        prevC.classList.remove("hidden");
      }
      if (prevG1) {
        prevG1.src = existingGalleryURLs[0];
        prevG1.classList.remove("hidden");
      }
      if (prevG2) {
        prevG2.src = existingGalleryURLs[1];
        prevG2.classList.remove("hidden");
      }
      if (prevG3) {
        prevG3.src = existingGalleryURLs[2];
        prevG3.classList.remove("hidden");
      }

      // Zkontroluj Supabase client
      if (!window.supabaseClient && !window.sb) {
        showStatus(
          "Supabase nen√≠ inicializovan√Ω ‚Äì zkontroluj supabase-config.js a supabase-init.js.",
          false
        );
        console.error("‚ùå Supabase client nen√≠ p≈ôipraven.");
        return;
      }
      
      // Pou≈æ√≠v√°me GLOB√ÅLN√ç promƒõnn√© (window.isSubmitting, window.formHasData, window.authChecked)
      
      // üî• BLOKOVAT REDIRECT NA T√âTO STR√ÅNCE √öPLNƒö
      window.PREVENT_AUTH_REDIRECT = true;

      kartaoAuth.onAuthStateChanged(async (user) => {
        console.log("Auth state changed:", user ? user.id : null, "isSubmitting:", window.isSubmitting, "formHasData:", window.formHasData, "PREVENT:", window.PREVENT_AUTH_REDIRECT);
        
        // üõ°Ô∏è ABSOLUTN√ç OCHRANA #1: Na zalozit-kartu.html NIKDY nep≈ôesmƒõrov√°vat pokud nen√≠ user
        if (window.PREVENT_AUTH_REDIRECT && !user && window.authChecked) {
          console.warn("üõ°Ô∏èüõ°Ô∏èüõ°Ô∏è PREVENT_AUTH_REDIRECT=true + user=null + authChecked=true ‚Üí BLOKUJI REDIRECT!");
          showStatus("‚ö†Ô∏è P≈ôihl√°≈°en√≠ se ztratilo. Obnovuji str√°nku...", false);
          // M√≠sto redirectu na login, zkus reload (mo≈æn√° se auth obnov√≠)
          setTimeout(() => window.location.reload(), 2000);
          return; // KONEC, nic dal≈°√≠ho
        }
        
        // OCHRANA 2: Pokud pr√°vƒõ ukl√°d√°me, ignoruj auth zmƒõny
        if (window.isSubmitting) {
          console.log("üõ°Ô∏è Auth change bƒõhem submitu - IGNORUJI (isSubmitting=true)");
          return;
        }
        
        // OCHRANA 3: Pokud je formul√°≈ô vyplnƒõn√Ω, neodhla≈°uj
        if (!user && window.formHasData) {
          console.warn("üõ°Ô∏è Auth change to null ale formul√°≈ô m√° data - IGNORUJI");
          showStatus("‚ö†Ô∏è Ztraceno p≈ôipojen√≠, ale z≈Øst√°v√°≈° p≈ôihl√°≈°en. Zkus odeslat znovu.", false);
          return;
        }
        
        // Prvn√≠ naƒçten√≠ str√°nky bez p≈ôihl√°≈°en√≠
        if (!user && !window.authChecked) {
          window.authChecked = true;
          console.log("‚ö†Ô∏è Prvn√≠ check: user=null, p≈ôesmƒõrov√°v√°m na login");
          
          // üõ°Ô∏è Pokud je PREVENT_AUTH_REDIRECT=true, NEredirectovat!
          if (window.PREVENT_AUTH_REDIRECT) {
            console.error("üõë PREVENT_AUTH_REDIRECT=true ‚Üí BLOKUJI redirect na login!");
            showStatus("‚ö†Ô∏è P≈ôihl√°≈°en√≠ selhalo. Zkus reload str√°nky (F5).", false);
            return;
          }
          
          showStatus(
            "Pro zalo≈æen√≠ karty se mus√≠≈° p≈ôihl√°sit. P≈ôesmƒõrov√°v√°m na login‚Ä¶",
            false
          );
          setTimeout(() => (window.location.href = "login.html"), 1200);
          return;
        }
        
        if (!user && window.authChecked) {
          console.warn("‚ö†Ô∏è Auth state changed to null - mo≈æn√° logout nebo error");
          return;
        }
        
        window.authChecked = true;
        console.log("‚úÖ U≈æivatel p≈ôihl√°≈°en, id:", user.id);

        // üî• NAƒåTI existuj√≠c√≠ kartu (pokud existuje)
        try {
          const existingCard = await loadCreatorCard(user.id);
          if (existingCard) {
            console.log("üìã Naƒçtena existuj√≠c√≠ karta:", existingCard);
            showStatus("Naƒç√≠t√°m tvou kartu...");
            
            // Vypl≈à formul√°≈ô
            if (existingCard.name) document.getElementById("name").value = existingCard.name;
            if (existingCard.handle) document.getElementById("handle").value = existingCard.handle;
            if (existingCard.bio) document.getElementById("bio").value = existingCard.bio;
            if (existingCard.categories && existingCard.categories.length > 0) {
              document.getElementById("category").value = existingCard.categories[0];
            }
            if (existingCard.city) document.getElementById("city").value = existingCard.city;
            if (existingCard.price) document.getElementById("price").value = existingCard.price;
            if (existingCard.rating) document.getElementById("rating").value = existingCard.rating;
            if (existingCard.engagement) document.getElementById("engagement").value = existingCard.engagement;
            if (existingCard.premium) document.getElementById("premium").checked = existingCard.premium;
            
            // Metriky
            if (existingCard.instagram_followers) document.getElementById("instagram-followers").value = existingCard.instagram_followers;
            if (existingCard.tiktok_followers) document.getElementById("tiktok-followers").value = existingCard.tiktok_followers;
            if (existingCard.youtube_followers) document.getElementById("youtube-followers").value = existingCard.youtube_followers;
            if (existingCard.facebook_followers) document.getElementById("facebook-followers").value = existingCard.facebook_followers;
            if (existingCard.pinterest_followers) document.getElementById("pinterest-followers").value = existingCard.pinterest_followers;
            
            // Obr√°zky - nastav preview
            if (existingCard.avatar_url) {
              const avatarPreview = document.getElementById("avatar-preview");
              if (avatarPreview) {
                avatarPreview.src = existingCard.avatar_url;
                avatarPreview.style.display = "block";
              }
            }
            if (existingCard.cover_url) {
              const coverPreview = document.getElementById("cover-preview");
              if (coverPreview) {
                coverPreview.src = existingCard.cover_url;
                coverPreview.style.display = "block";
              }
            }
            if (existingCard.gallery_urls && Array.isArray(existingCard.gallery_urls)) {
              existingCard.gallery_urls.forEach((url, index) => {
                const preview = document.getElementById(`gallery-preview-${index}`);
                if (preview && url) {
                  preview.src = url;
                  preview.style.display = "block";
                }
              });
            }
            
            showStatus("‚úÖ Karta naƒçtena - m≈Ø≈æe≈° ji upravit a ulo≈æit");
            window.formHasData = true;
          } else {
            console.log("‚ÑπÔ∏è ≈Ω√°dn√° existuj√≠c√≠ karta - vytv√°≈ô√≠≈° novou");
            showStatus("Vytv√°≈ô√≠≈° svou prvn√≠ kartu influencera ‚ú®");
          }
        } catch (error) {
          console.error("‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ karty:", error);
          showStatus("‚ö†Ô∏è Nepoda≈ôilo se naƒç√≠st existuj√≠c√≠ kartu");
        }

        if (form) {
          // Sleduj zmƒõny ve formul√°≈ôi
          form.addEventListener("input", () => {
            window.formHasData = true;
            console.log("üìù Formul√°≈ô m√° data - formHasData=true");
          });
          
          form.addEventListener("submit", async (e) => {
            e.preventDefault();
            
            // Zamknout auth zmƒõny bƒõhem submitu
            window.isSubmitting = true;
            window.formHasData = true;
            console.log("[FORM] Start submit, uid =", user.id, "üîí isSubmitting=true");

            try {
              const uid = user.id;

              // Validace
              const name = document.getElementById("name").value.trim();
              const handleRaw = document.getElementById("handle").value.trim();
              const category = document.getElementById("category").value || "Lifestyle";
              const bio = document.getElementById("bio").value.trim() || "";
              const ratingVal = document.getElementById("rating").value.trim();

              if (!name || !handleRaw) {
                showStatus("Vypl≈à pros√≠m jm√©no a handle.", false);
                console.warn("[FORM] Chyb√≠ jm√©no nebo handle.");
                window.isSubmitting = false;
                return;
              }

              showStatus("Ukl√°d√°m kartu‚Ä¶ (m≈Ø≈æe chvilku trvat p≈ôi nahr√°v√°n√≠ fotek)", true);
              console.log("[FORM] Validace OK, pokraƒçuji");

              // Followers metrics
              function getFollowers(pid) {
                const inp = document.getElementById("followers-" + pid);
                if (!inp) return 0;
                const v = inp.value.trim();
                return v ? Number(v) : 0;
              }

              const metrics = {
                instagram: { followers: getFollowers("instagram") },
                tiktok: { followers: getFollowers("tiktok") },
                youtube: { followers: getFollowers("youtube") },
                facebook: { followers: getFollowers("facebook") },
                pinterest: { followers: getFollowers("pinterest") },
              };

              // Files
              const avatarFile = document.getElementById("avatarFile")?.files[0];
              const coverFile = document.getElementById("coverFile")?.files[0];
              const gal1File = document.getElementById("gal1File")?.files[0];
              const gal2File = document.getElementById("gal2File")?.files[0];
              const gal3File = document.getElementById("gal3File")?.files[0];

              // Dal≈°√≠ pole
              const city = document.getElementById("city")?.value.trim() || "";
              const price = document.getElementById("price")?.value.trim();
              const engagement = document.getElementById("engagement")?.value.trim();
              const premium = document.getElementById("premium")?.checked || false;

              // Zavolej Supabase save funkci
              const formData = {
                name,
                handle: handleRaw,
                bio,
                category,
                city,
                price: price ? Number(price) : 0,
                rating: ratingVal ? Number(ratingVal) : 0,
                engagement: engagement ? Number(engagement) : 0,
                premium,
                metrics,
                avatarFile,
                coverFile,
                gal1File,
                gal2File,
                gal3File,
                existingAvatarURL,
                existingCoverURL,
                existingGalleryURLs
              };

              await saveCreatorCard(formData, uid);

              showStatus("‚úÖ Karta √∫spƒõ≈°nƒõ ulo≈æena! P≈ôesmƒõrov√°v√°m...", true);
              setTimeout(() => {
                window.location.href = "moje-karta.html";
              }, 1500);
              
            } catch (err) {
              console.error("‚ùå Chyba p≈ôi ukl√°d√°n√≠ karty:", err);
              showStatus(
                `‚ùå Chyba: ${err.message}. Zkus to pros√≠m znovu.`,
                false
              );
            } finally {
              // Odemknout auth zmƒõny
              window.isSubmitting = false;
              console.log("[FORM] üîì isSubmitting=false (finally)");
            }
          });
        }

        if (cancelBtn) {
          cancelBtn.addEventListener("click", () => {
            window.location.href = "index.html";
          });
        }
      });
    });
  </script>
</body>
</html>
