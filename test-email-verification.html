<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test ovÄ›Å™ovacÃ­ch emailÅ¯ - Kartao.cz</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="firebase-init.js"></script>
  <script src="auth.js"></script>
  <script src="auth-header.js"></script>
  <script src="credits-system.js"></script>
  <script src="credits-header.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-neutral-950 via-neutral-900 to-neutral-950 min-h-screen text-white p-8">
  
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-8">ğŸ” Test ovÄ›Å™ovacÃ­ch emailÅ¯</h1>
    
    <!-- Firebase Status -->
    <div class="bg-neutral-900 rounded-xl p-6 mb-6 border border-white/10">
      <h2 class="text-xl font-semibold mb-4">ğŸ“Š Firebase Status</h2>
      <div id="firebase-status" class="space-y-2 font-mono text-sm"></div>
    </div>

    <!-- Current User -->
    <div class="bg-neutral-900 rounded-xl p-6 mb-6 border border-white/10">
      <h2 class="text-xl font-semibold mb-4">ğŸ‘¤ AktuÃ¡lnÃ­ uÅ¾ivatel</h2>
      <div id="current-user" class="font-mono text-sm text-white/60">Å½Ã¡dnÃ½ uÅ¾ivatel pÅ™ihlÃ¡Å¡en</div>
    </div>

    <!-- Test Form -->
    <div class="bg-neutral-900 rounded-xl p-6 mb-6 border border-white/10">
      <h2 class="text-xl font-semibold mb-4">âœ‰ï¸ Test odeslÃ¡nÃ­ ovÄ›Å™ovacÃ­ho emailu</h2>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm mb-2">Email:</label>
          <input 
            type="email" 
            id="test-email" 
            class="w-full px-4 py-2 rounded-lg bg-neutral-800 border border-white/10 text-white"
            placeholder="test@example.com"
          />
        </div>
        
        <div>
          <label class="block text-sm mb-2">Heslo:</label>
          <input 
            type="password" 
            id="test-password" 
            class="w-full px-4 py-2 rounded-lg bg-neutral-800 border border-white/10 text-white"
            placeholder="TestovacÃ­ heslo"
          />
        </div>

        <button 
          id="register-btn"
          class="w-full py-3 bg-emerald-600 hover:bg-emerald-700 rounded-lg font-semibold transition"
        >
          Zaregistrovat testovacÃ­ ÃºÄet
        </button>

        <button 
          id="resend-btn"
          class="w-full py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition"
        >
          Znovu odeslat ovÄ›Å™ovacÃ­ email (pro pÅ™ihlÃ¡Å¡enÃ©ho uÅ¾ivatele)
        </button>

        <button 
          id="logout-btn"
          class="w-full py-3 bg-red-600 hover:bg-red-700 rounded-lg font-semibold transition"
        >
          OdhlÃ¡sit
        </button>
      </div>

      <div id="result" class="mt-4 p-4 rounded-lg hidden"></div>
    </div>

    <!-- Console Log -->
    <div class="bg-neutral-900 rounded-xl p-6 mb-6 border border-white/10">
      <h2 class="text-xl font-semibold mb-4">ğŸ“‹ KonzolovÃ© logy</h2>
      <div id="console-log" class="font-mono text-xs text-white/60 max-h-96 overflow-auto space-y-1"></div>
    </div>

    <!-- Action URL Test -->
    <div class="bg-neutral-900 rounded-xl p-6 mb-6 border border-white/10">
      <h2 class="text-xl font-semibold mb-4">ğŸ”— Action URL konfigurace</h2>
      <div class="space-y-2 font-mono text-sm">
        <div>Origin: <span class="text-emerald-400" id="origin"></span></div>
        <div>Verification URL: <span class="text-emerald-400" id="verification-url"></span></div>
      </div>
    </div>

    <a href="login.html" class="block text-center text-sm text-white/60 hover:text-white">
      â† ZpÄ›t na login.html
    </a>
  </div>

  <script>
    // Console logging
    const consoleLogEl = document.getElementById('console-log');
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;

    function addLog(type, ...args) {
      const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a)).join(' ');
      const div = document.createElement('div');
      div.className = type === 'error' ? 'text-red-400' : type === 'warn' ? 'text-amber-400' : 'text-white/80';
      div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      consoleLogEl.appendChild(div);
      consoleLogEl.scrollTop = consoleLogEl.scrollHeight;
    }

    console.log = (...args) => { originalLog(...args); addLog('log', ...args); };
    console.error = (...args) => { originalError(...args); addLog('error', ...args); };
    console.warn = (...args) => { originalWarn(...args); addLog('warn', ...args); };

    // Display Action URLs
    document.getElementById('origin').textContent = window.location.origin;
    document.getElementById('verification-url').textContent = window.location.origin + '/email-verified.html';

    // Firebase status
    const statusEl = document.getElementById('firebase-status');
    const currentUserEl = document.getElementById('current-user');
    const resultEl = document.getElementById('result');

    function checkFirebase() {
      let status = [];
      
      if (typeof firebase !== 'undefined') {
        status.push('âœ… Firebase naÄtenÃ½');
      } else {
        status.push('âŒ Firebase nenÃ­ naÄtenÃ½');
        statusEl.innerHTML = status.join('<br>');
        return;
      }

      if (typeof auth !== 'undefined' && auth) {
        status.push('âœ… Auth inicializovanÃ½');
      } else {
        status.push('âŒ Auth nenÃ­ inicializovanÃ½');
      }

      status.push(`ğŸ“§ Auth Domain: ${auth.app.options.authDomain || 'N/A'}`);
      status.push(`ğŸ†” Project ID: ${auth.app.options.projectId || 'N/A'}`);
      
      statusEl.innerHTML = status.join('<br>');
    }

    checkFirebase();

    // Auth state observer
    auth.onAuthStateChanged((user) => {
      if (user) {
        currentUserEl.innerHTML = `
          <div class="text-emerald-400">âœ… PÅ™ihlÃ¡Å¡en: ${user.email}</div>
          <div class="text-white/60">UID: ${user.uid}</div>
          <div class="${user.emailVerified ? 'text-emerald-400' : 'text-amber-400'}">
            Email ovÄ›Å™en: ${user.emailVerified ? 'âœ… ANO' : 'âŒ NE'}
          </div>
        `;
        console.log('ğŸ‘¤ UÅ¾ivatel pÅ™ihlÃ¡Å¡en:', user.email);
      } else {
        currentUserEl.innerHTML = '<div class="text-white/60">Å½Ã¡dnÃ½ uÅ¾ivatel pÅ™ihlÃ¡Å¡en</div>';
        console.log('ğŸ‘¤ Å½Ã¡dnÃ½ uÅ¾ivatel pÅ™ihlÃ¡Å¡en');
      }
    });

    // Register test account
    document.getElementById('register-btn').addEventListener('click', async () => {
      const email = document.getElementById('test-email').value;
      const password = document.getElementById('test-password').value;

      if (!email || !password) {
        resultEl.className = 'mt-4 p-4 rounded-lg bg-red-500/20 border border-red-500/50 text-red-300';
        resultEl.textContent = 'VyplÅˆte email a heslo';
        resultEl.classList.remove('hidden');
        return;
      }

      console.log('ğŸ“ Pokus o registraci:', email);

      try {
        const cred = await kartaoAuth.registerWithEmail(email, password, 'influencer');
        console.log('âœ… ÃšÄet vytvoÅ™en:', cred.user.email);
        
        // Send verification email
        console.log('ğŸ“§ OdesÃ­lÃ¡m ovÄ›Å™ovacÃ­ email...');
        
        const actionCodeSettings = {
          url: window.location.origin + '/email-verified.html',
          handleCodeInApp: true
        };
        
        console.log('ğŸ”— Action URL:', actionCodeSettings.url);
        
        await cred.user.sendEmailVerification(actionCodeSettings);
        
        console.log('âœ… OvÄ›Å™ovacÃ­ email odeslÃ¡n!');
        
        resultEl.className = 'mt-4 p-4 rounded-lg bg-emerald-500/20 border border-emerald-500/50 text-emerald-300';
        resultEl.innerHTML = `
          <div class="font-semibold mb-2">âœ… ÃšspÄ›ch!</div>
          <div class="text-sm space-y-1">
            <div>â€¢ ÃšÄet vytvoÅ™en: ${cred.user.email}</div>
            <div>â€¢ OvÄ›Å™ovacÃ­ email odeslÃ¡n</div>
            <div>â€¢ Zkontrolujte schrÃ¡nku (i SPAM)</div>
            <div>â€¢ Email z: noreply@kartao-cz.firebaseapp.com</div>
            <div>â€¢ Verification URL: ${actionCodeSettings.url}</div>
          </div>
        `;
        resultEl.classList.remove('hidden');
        
      } catch (error) {
        console.error('âŒ Chyba:', error.code, error.message);
        
        resultEl.className = 'mt-4 p-4 rounded-lg bg-red-500/20 border border-red-500/50 text-red-300';
        resultEl.innerHTML = `
          <div class="font-semibold mb-2">âŒ Chyba</div>
          <div class="text-sm space-y-1">
            <div>KÃ³d: ${error.code}</div>
            <div>ZprÃ¡va: ${error.message}</div>
          </div>
        `;
        resultEl.classList.remove('hidden');
      }
    });

    // Resend verification email
    document.getElementById('resend-btn').addEventListener('click', async () => {
      const user = auth.currentUser;
      
      if (!user) {
        resultEl.className = 'mt-4 p-4 rounded-lg bg-red-500/20 border border-red-500/50 text-red-300';
        resultEl.textContent = 'Nejste pÅ™ihlÃ¡Å¡enÃ½. NejdÅ™Ã­v se zaregistrujte.';
        resultEl.classList.remove('hidden');
        return;
      }

      console.log('ğŸ“§ OpÄ›tovnÃ© odeslÃ¡nÃ­ ovÄ›Å™ovacÃ­ho emailu pro:', user.email);

      try {
        const actionCodeSettings = {
          url: window.location.origin + '/email-verified.html',
          handleCodeInApp: true
        };
        
        console.log('ğŸ”— Action URL:', actionCodeSettings.url);
        
        await user.sendEmailVerification(actionCodeSettings);
        
        console.log('âœ… Email znovu odeslÃ¡n!');
        
        resultEl.className = 'mt-4 p-4 rounded-lg bg-emerald-500/20 border border-emerald-500/50 text-emerald-300';
        resultEl.innerHTML = `
          <div class="font-semibold mb-2">âœ… Email odeslÃ¡n!</div>
          <div class="text-sm space-y-1">
            <div>â€¢ Email: ${user.email}</div>
            <div>â€¢ Zkontrolujte schrÃ¡nku (i SPAM)</div>
            <div>â€¢ Email z: noreply@kartao-cz.firebaseapp.com</div>
          </div>
        `;
        resultEl.classList.remove('hidden');
        
      } catch (error) {
        console.error('âŒ Chyba:', error.code, error.message);
        
        let errorMsg = error.message;
        if (error.code === 'auth/too-many-requests') {
          errorMsg = 'PÅ™Ã­liÅ¡ mnoho pokusÅ¯. PoÄkejte chvÃ­li.';
        }
        
        resultEl.className = 'mt-4 p-4 rounded-lg bg-red-500/20 border border-red-500/50 text-red-300';
        resultEl.innerHTML = `
          <div class="font-semibold mb-2">âŒ Chyba</div>
          <div class="text-sm">${errorMsg}</div>
        `;
        resultEl.classList.remove('hidden');
      }
    });

    // Logout
    document.getElementById('logout-btn').addEventListener('click', async () => {
      try {
        await kartaoAuth.logout();
        console.log('ğŸ‘‹ OdhlÃ¡Å¡eno');
        
        resultEl.className = 'mt-4 p-4 rounded-lg bg-blue-500/20 border border-blue-500/50 text-blue-300';
        resultEl.textContent = 'âœ… OdhlÃ¡Å¡eno';
        resultEl.classList.remove('hidden');
      } catch (error) {
        console.error('âŒ Chyba pÅ™i odhlÃ¡Å¡enÃ­:', error);
      }
    });
  </script>

</body>
</html>
