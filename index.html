<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kartao.cz – síť influencerů</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { neutral: tailwind.colors.neutral, fuchsia: tailwind.colors.fuchsia, amber: tailwind.colors.amber, sky: tailwind.colors.sky, emerald: tailwind.colors.emerald } } } }
  </script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    .line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .backdrop-blur{backdrop-filter: blur(8px)}
    .shadow-soft{box-shadow:0 10px 30px rgba(236,72,153,.15)}
    .card{background-color:rgba(23,23,23,.6);border:1px solid rgba(255,255,255,.1);border-radius:1rem}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem .75rem;border-radius:.75rem}
    .btn-primary{background:#e879f9}
    .btn-primary:hover{background:#db58f6}
    .btn-light{background:#fff;color:#111}
    .btn-light:hover{background:#f3f3f3}
    .btn-outline{border:1px solid rgba(255,255,255,.2)}
    .tag{display:inline-flex;align-items:center;gap:.35rem;border:1px solid rgba(255,255,255,.1);padding:.25rem .5rem;border-radius:.5rem;background:rgba(38,38,38,.9)}
    .modal-enter{transform:translateX(100%);opacity:.5}
    .modal-enter.active{transform:translateX(0);opacity:1;transition:transform .35s cubic-bezier(.2,.8,.2,1),opacity .35s}
  </style>
</head>
<body class="min-h-screen bg-neutral-950 text-white">
  <header class="sticky top-0 z-40 backdrop-blur supports-[backdrop-filter]:bg-neutral-950/70 border-b border-white/10">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-2xl bg-gradient-to-tr from-fuchsia-500 to-amber-400 grid place-items-center shadow-soft">
          <i data-lucide="crown" class="w-5 h-5"></i>
        </div>
        <div>
          <div class="font-extrabold tracking-tight text-lg">Kartao.cz</div>
          <div class="text-xs text-white/60 -mt-0.5">Síť influencerů a tvůrců</div>
        </div>
      </div>
      <div class="hidden md:flex items-center gap-2">
        <a href="kartao-pro-firmy.html#brief" class="btn btn-light">Pro firmy</a>
        <a href="kartao-pro-tvurce.html#form" class="btn btn-primary">Založit kartu</a>
      </div>
      <div class="flex items-center gap-2">
        <!-- Přihlášení -->
        <a href="login.html" class="ml-2 flex items-center justify-center w-11 h-11 rounded-full bg-sky-500 text-white hover:bg-sky-600 transition" title="Přihlásit">
          <i data-lucide="user" class="w-4 h-4"></i>
        </a>
        <!-- Admin tlačítko (otevře modal s klíčem) -->
        <button id="adminFab" class="ml-2 hidden md:inline-flex items-center justify-center w-11 h-11 rounded-full border border-white/20 text-white/80 hover:text-white transition" title="Admin">Admin</button>
      </div>
    </div>
  </header>
  
  <!-- Admin modal -->
  <div id="adminModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/70" data-close></div>
    <div class="relative max-w-sm mx-auto mt-24 bg-neutral-900 border border-white/10 rounded-xl p-5">
      <div class="flex items-start justify-between gap-3">
        <h3 class="text-lg font-semibold">Přihlášení administrátora</h3>
        <button class="text-white/70 hover:text-white" data-close aria-label="Zavřít">✕</button>
      </div>
      <p class="text-sm text-white/70 mt-2">Zadej admin klíč a potvrď.</p>
      <input id="adminKeyInput" type="password" placeholder="Admin klíč"
             class="mt-3 w-full p-2 rounded bg-neutral-800 border border-white/20" />
      <div class="text-[11px] text-white/45 mt-1">
        Pro lokální test: <code class="bg-white/10 px-1.5 py-0.5 rounded">kartao-dev</code>
      </div>
      <button id="adminLoginBtn"
              class="mt-4 w-full bg-fuchsia-500 hover:bg-fuchsia-600 px-4 py-2 rounded">
        Přihlásit
      </button>
    </div>
  </div>

  <script>
    (function () {
      const apiBase = 'https://kartao-api.onrender.com';
      const ENABLE_LOCAL_TEST = true;
      const LOCAL_TEST_KEY = 'kartao-dev';

      const fab   = document.getElementById('adminFab');
      const modal = document.getElementById('adminModal');
      const input = document.getElementById('adminKeyInput');
      const login = document.getElementById('adminLoginBtn');

      function show() { modal.classList.remove('hidden'); setTimeout(()=>input.focus(), 0); }
      function hide() { modal.classList.add('hidden'); input.value = ''; }

      if (fab) fab.addEventListener('click', show);
      modal.querySelectorAll('[data-close]').forEach(el => el.addEventListener('click', hide));
      document.addEventListener('keydown', e => { if (e.key === 'Escape') hide(); });

      async function doLogin() {
        const key = (input.value || '').trim();
        if (!key) { alert('Zadej admin klíč'); return; }

        if (ENABLE_LOCAL_TEST && key === LOCAL_TEST_KEY) {
          localStorage.setItem('admin_jwt', 'LOCAL_TEST');
          hide();
          location.href = 'admin.html';
          return;
        }
        try {
          const res = await fetch(`${apiBase}/admin/token`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ key })
          });
          const out = await res.json();
          if (out.token) {
            localStorage.setItem('admin_jwt', out.token);
            hide();
            location.href = 'admin.html';
          } else {
            alert('Neplatný klíč');
          }
        } catch (e) {
          alert('Nepodařilo se ověřit klíč.');
        }
      }

      login.addEventListener('click', doLogin);
      input.addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
    })();
  </script>

  <!-- HERO + FILTRY -->
  <section class="border-b border-white/10 bg-[radial-gradient(80%_50%_at_50%_0%,rgba(236,72,153,0.2),transparent_60%)]">
    <div class="max-w-7xl mx-auto px-4 py-12">
      <h1 class="text-3xl md:text-5xl font-extrabold tracking-tight">Najdi toho pravého influencera. <span class="text-fuchsia-400">Rychle a chytře.</span></h1>
      <p class="mt-3 text-white/70 max-w-2xl">Propojujeme značky a tvůrce. Karty s portfoliem, ověřené statistiky a přímé nabídky spolupráce.</p>

      <div class="mt-6 grid gap-3 md:grid-cols-8 items-stretch">
        <div class="md:col-span-3">
          <div class="relative">
            <input id="q" type="text" placeholder="Hledat podle jména, oboru, města…" class="w-full pl-10 pr-3 py-2 rounded-xl bg-neutral-900 border border-white/10 text-white placeholder:text-white/40 outline-none"/>
            <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-white/50"></i>
          </div>
        </div>

        <select id="platform" class="rounded-xl bg-neutral-900 border border-white/10 px-3 py-2">
          <option value="all">Vše</option>
          <option value="instagram">Instagram</option>
          <option value="tiktok">TikTok</option>
          <option value="youtube">YouTube</option>
          <option value="facebook">Facebook</option>
        </select>

        <select id="mode" class="rounded-xl bg-neutral-900 border border-white/10 px-3 py-2">
          <option value="sum">Součet (Σ)</option>
          <option value="max">Maximum (MAX)</option>
        </select>

        <select id="category" class="rounded-xl bg-neutral-900 border border-white/10 px-3 py-2">
          <option value="all">Vše</option>
          <option>Fashion</option>
          <option>Beauty</option>
          <option>Fitness</option>
          <option>Lifestyle</option>
          <option>Gaming</option>
          <option>Tech</option>
          <option>Food</option>
          <option>Travel</option>
          <option>Auto</option>
          <option>Music</option>
        </select>

        <select id="city" class="rounded-xl bg-neutral-900 border border-white/10 px-3 py-2">
          <option value="all">Celá ČR</option>
          <option>Praha</option>
          <option>Brno</option>
          <option>Ostrava</option>
          <option>Plzeň</option>
          <option>Olomouc</option>
          <option>Zlín</option>
          <option>Hradec Králové</option>
          <option>České Budějovice</option>
        </select>
        <select id="sort" class="rounded-xl bg-neutral-900 border border-white/10 px-3 py-2">
          <option value="relevance">Relevance</option>
          <option value="followers">Nejvíc followerů (API)</option>
          <option value="priceLow">Nejnižší cena</option>
          <option value="rating">Nejlepší hodnocení</option>
        </select>
        <select id="pageSize" class="rounded-xl bg-neutral-900 border border-white/10 px-3 py-2">
          <option value="12">12</option>
          <option value="24">24</option>
          <option value="48">48</option>
        </select>
        <button id="advancedBtn" class="btn btn-primary md:col-span-1"><i data-lucide="filter" class="w-4 h-4"></i> Pokročilé</button>
      </div>

      <div class="mt-3 grid gap-3 md:grid-cols-5" id="advancedWrap">
        <input id="maxPrice" type="number" min="0" placeholder="Max rozpočet na post (Kč)" class="rounded-xl bg-neutral-900 border border-white/10 px-3 py-2" />
        <div class="relative">
          <input id="minFollowers" type="number" min="0" placeholder="Min. followeři (jen z API)" class="rounded-xl bg-neutral-900 border border-white/10 px-3 py-2 disabled:opacity-50" />
          <div class="text-xs text-white/50 mt-1" id="minFollowersHint" style="display:none">Filtr se uplatní jen při výběru konkrétní platformy</div>
        </div>
        <label class="flex items-center gap-2 text-sm text-white/80 select-none">
          <input id="premiumOnly" type="checkbox" class="accent-fuchsia-500" />
          Pouze prémiové (ověřené / 100k+ z API)
        </label>
        <label class="flex items-center gap-2 text-sm text-white/80 select-none">
          <input id="infinite" type="checkbox" class="accent-fuchsia-500" />
          Nekonečné načítání místo stránek
        </label>
        <div class="flex items-center gap-2 text-sm text-white/60"><i data-lucide="sparkles" class="w-4 h-4"></i> Tip: Pro přesné počty propojte účty v detailu karty</div>
      </div>
    </div>
  </section>

  <!-- GRID -->
  <section>
    <div class="max-w-7xl mx-auto px-4 py-8">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2 text-white/70 text-sm">
          <i data-lucide="users" class="w-4 h-4"></i> <span>Nalezeno</span> <span id="total" class="font-semibold text-white">0</span>
          <span>tvůrců</span>
          <span id="modeBadge" class="ml-2 inline-flex items-center gap-1 rounded bg-white/10 px-1.5 py-0.5 text-[10px] font-semibold">Režim: Σ Součet</span>
        </div>
        <div class="hidden md:flex items-center gap-2 text-xs" id="platformTags"></div>
      </div>

      <div id="grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      <div id="empty" class="hidden border border-white/10 rounded-2xl p-8 text-center bg-neutral-900/40">
        <i data-lucide="sparkles" class="w-6 h-6 mx-auto"></i>
        <div class="font-semibold mt-2">Zkuste upravit filtry</div>
        <div class="text-white/60 text-sm">Nenašli jsme žádné tvůrce pro zadaná kritéria.</div>
      </div>

      <div id="pagination" class="mt-8 flex items-center justify-between"></div>
      <div id="sentinel" class="h-10 mt-6 grid place-items-center text-white/60 text-sm"></div>
    </div>
  </section>

  <!-- PRO FIRMY -->
  <section class="border-t border-white/10 bg-neutral-900/30">
    <div class="max-w-7xl mx-auto px-4 py-10 grid md:grid-cols-2 gap-6 items-center">
      <div>
        <h2 class="text-2xl md:text-3xl font-extrabold tracking-tight">Pro firmy a agentury</h2>
        <p class="text-white/70 mt-2">Zadejte kampaň a získejte nabídky od vhodných tvůrců během hodin. Kurátorské seznamy, ověřené statistiky a escrow platby.</p>
        <div class="flex gap-2 mt-4">
          <span class="tag"><i data-lucide="badge-check" class="w-3 h-3"></i> Ověření tvůrci</span>
          <span class="tag"><i data-lucide="trending-up" class="w-3 h-3"></i> Záruka výkonu</span>
        </div>
        <div class="mt-6 flex gap-3">
          <a class="btn btn-primary" href="kartao-pro-firmy.html#brief">Zadat kampaň</a>
          <a class="btn btn-light" href="kartao-pro-firmy.html#faq">Domluvit demo</a>
        </div>
      </div>
      <div>
        <div class="card overflow-hidden p-4">
          <div class="font-semibold mb-2 flex items-center gap-2"><i data-lucide="crown" class="w-5 h-5 text-amber-400"></i> Proč Kartao</div>
          <div class="space-y-2 text-sm text-white/80">
            <div class="flex items-start gap-2"><i data-lucide="badge-check" class="w-4 h-4 mt-0.5 text-fuchsia-300"></i> Ověření tvůrců a metriky</div>
            <div class="flex items-start gap-2"><i data-lucide="star" class="w-4 h-4 mt-0.5 text-amber-300"></i> Recenze po dokončení spolupráce</div>
            <div class="flex items-start gap-2"><i data-lucide="globe" class="w-4 h-4 mt-0.5 text-sky-300"></i> Multiplatformní profily a odkazy</div>
            <div class="flex items-start gap-2"><i data-lucide="users" class="w-4 h-4 mt-0.5 text-emerald-300"></i> Kurátorské výběry a top karty týdne</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="border-t border-white/10">
    <div class="max-w-7xl mx-auto px-4 py-8 grid md:grid-cols-3 gap-6 text-sm text-white/60">
      <div>
        <div class="font-bold text-white">Kartao.cz</div>
        <p>Síť influencerů a tvůrců – každý má svou kartu.</p>
      </div>
      <div class="space-y-1">
        <div class="text-white/80 font-medium">Odkazy</div>
        <a class="block hover:text-white" href="kartao-pro-tvurce.html">Pro tvůrce</a>
        <a class="block hover:text-white" href="kartao-pro-firmy.html">Pro firmy</a>
        <a class="block hover:text-white" href="cenik.html">Ceník</a>
      </div>
      <div class="space-y-1">
        <div class="text-white/80 font-medium">Právo</div>
        <a class="block hover:text-white" href="podminky.html">Podmínky</a>
        <a class="block hover:text-white" href="ochrana-soukromi.html">Ochrana soukromí</a>
      </div>
    </div>
  </footer>

  <!-- Drawer (detail karty) -->
  <div id="overlay" class="fixed inset-0 z-50 hidden">
    <div id="overlayBg" class="absolute inset-0 bg-black/70"></div>
    <aside id="drawer" class="absolute right-0 top-0 h-full w-full sm:w-[560px] bg-neutral-950 border-l border-white/10 overflow-y-auto modal-enter">
      <div class="p-4 border-b border-white/10 flex items-center justify-between sticky top-0 bg-neutral-950/80 backdrop-blur">
        <div class="font-bold">Karta influencera</div>
        <button id="closeDrawer" class="btn btn-light">Zavřít</button>
      </div>
      <div id="drawerBody" class="p-4"></div>
    </aside>
  </div>
    <script src="data-model.js"></script>
  <script>
    // --- platformy (doplněn Facebook) ---
    const PLATFORMS = [
      {id:'instagram',label:'Instagram',icon:'camera'},
      {id:'tiktok',label:'TikTok',icon:'music-4'},
      {id:'youtube',label:'YouTube',icon:'play'},
      {id:'facebook',label:'Facebook',icon:'facebook'}
    ];

    // --- demo dataset ---
    const MOCK = [
      {id:'1',name:'Marie Novotná',handle:'@mariemakeup',avatar:'https://images.unsplash.com/photo-1494790108377-be9c29b29330?q=80&w=400&auto=format&fit=crop',cover:'https://images.unsplash.com/photo-1519741497674-611481863552?q=80&w=1200&auto=format&fit=crop',city:'Praha',category:'Beauty',platforms:['instagram','tiktok'],price:12000,rating:4.8,verified:true,engagement:4.2,metrics:{instagram:{connected:false,followers:null,updatedAt:null},youtube:{connected:false,followers:null,updatedAt:null},tiktok:{connected:false,followers:null,updatedAt:null},facebook:{connected:false,followers:null,updatedAt:null}},gallery:['https://images.unsplash.com/photo-1522335789203-aabd1fc54bc9?q=80&w=600&auto=format&fit=crop','https://images.unsplash.com/photo-1491553895911-0055eca6402d?q=80&w=600&auto=format&fit=crop','https://images.unsplash.com/photo-1526045612212-70caf35c14df?q=80&w=600&auto=format&fit=crop'],bio:'Beauty & lifestyle tvůrkyně. Spolupráce s DM, Notino, Sephora. Otevřeno novým kampaním.'},
      {id:'2',name:'Adam Král',handle:'@adamfit',avatar:'https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=400&auto=format&fit=crop',cover:'https://images.unsplash.com/photo-1526506118085-60ce8714f8c5?q=80&w=1200&auto=format&fit=crop',city:'Brno',category:'Fitness',platforms:['instagram','youtube'],price:8000,rating:4.6,verified:true,engagement:5.1,metrics:{instagram:{connected:false,followers:null,updatedAt:null},youtube:{connected:false,followers:null,updatedAt:null},tiktok:{connected:false,followers:null,updatedAt:null},facebook:{connected:false,followers:null,updatedAt:null}},gallery:['https://images.unsplash.com/photo-1558611848-73f7eb4001a1?q=80&w=600&auto=format&fit=crop','https://images.unsplash.com/photo-1434754205268-ad3b5f549b11?q=80&w=600&auto=format&fit=crop','https://images.unsplash.com/photo-1517836357463-d25dfeac3438?q=80&w=600&auto=format&fit=crop'],bio:'Fitness, zdraví a výživa. Spolupráce: GymBeam, MyProtein. Videa 2× týdně.'},
      {id:'3',name:'Lukáš Procházka',handle:'@lukas_plays',avatar:'https://images.unsplash.com/photo-1547425260-76bcadfb4f2c?q=80&w=400&auto=format&fit=crop',cover:'https://images.unsplash.com/photo-1605369059929-6f369e12a1f3?q=80&w=1200&auto=format&fit=crop',city:'Ostrava',category:'Gaming',platforms:['tiktok','youtube'],price:15000,rating:4.7,verified:false,engagement:6.3,metrics:{instagram:{connected:false,followers:null,updatedAt:null},youtube:{connected:false,followers:null,updatedAt:null},tiktok:{connected:false,followers:null,updatedAt:null},facebook:{connected:false,followers:null,updatedAt:null}},gallery:['https://images.unsplash.com/photo-1542751371-adc38448a05e?q=80&w=600&auto=format&fit=crop','https://images.unsplash.com/photo-1542751110-97427bbecf20?q=80&w=600&auto=format&fit=crop','https://images.unsplash.com/photo-1511512578047-dfb367046420?q=80&w=600&auto=format&fit=crop'],bio:'Gaming videa, livestreamy a e-sport. Otevřeno sponzoringu a product placementu.'},
      {id:'4',name:'Eliška Dvořáková',handle:'@elitravels',avatar:'https://images.unsplash.com/photo-1544006659-f0b21884ce1d?q=80&w=400&auto=format&fit=crop',cover:'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1200&auto=format&fit=crop',city:'Plzeň',category:'Travel',platforms:['instagram'],price:6000,rating:4.5,verified:true,engagement:3.8,metrics:{instagram:{connected:false,followers:null,updatedAt:null},youtube:{connected:false,followers:null,updatedAt:null},tiktok:{connected:false,followers:null,updatedAt:null},facebook:{connected:false,followers:null,updatedAt:null}},gallery:['https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=600&auto=format&fit=crop','https://images.unsplash.com/photo-1519681391401-22d216bb9170?q=80&w=600&auto=format&fit=crop','https://images.unsplash.com/photo-1470770903676-69b98201ea1c?q=80&w=600&auto=format&fit=crop'],bio:'Cestování chytře a za málo. Spolupráce s aerolinkami a hotely.'}
    ];

    function fmtFollowers(n){ if(typeof n!== 'number') return null; if(n>=1_000_000) return (n/1_000_000).toFixed(1)+'M'; if(n>=1_000) return (n/1000).toFixed(0)+'k'; return String(n) }

    function platformFollowers(item, pid, mode){
      if(pid==='all'){
        const vals = ['instagram','youtube','tiktok','facebook'].map(k=>{
          const m=item.metrics?.[k];
          return m&&m.connected&&typeof m.followers==='number'?m.followers:0;
        });
        return mode==='max'? Math.max(0,...vals) : vals.reduce((a,b)=>a+b,0);
      }
      const m=item.metrics?.[pid];
      return m&&m.connected&&typeof m.followers==='number'?m.followers:0;
    }

    const state = { q: '', platform: 'all', mode: 'sum', category: 'all', city: 'all', sort: 'relevance', maxPrice: null, minFollowers: null, premiumOnly: false, page: 1, pageSize: 12, infinite: false };

    function readQS(){
      const qs = new URLSearchParams(location.search);
      if(qs.get('q')) state.q = qs.get('q');
      const pf = qs.get('platform'); if(['all','instagram','tiktok','youtube','facebook'].includes(pf)) state.platform = pf;
      const md = qs.get('mode'); if(['sum','max'].includes(md)) state.mode = md;
      const cat = qs.get('category'); if(['all','Fashion','Beauty','Fitness','Lifestyle','Gaming','Tech','Food','Travel','Auto','Music'].includes(cat)) state.category = cat;
      const city = qs.get('city'); if(['all','Praha','Brno','Ostrava','Plzeň','Olomouc','Zlín','Hradec Králové','České Budějovice'].includes(city)) state.city = city;
      const sort = qs.get('sort'); if(['relevance','followers','priceLow','rating'].includes(sort)) state.sort = sort;
      if(qs.get('maxPrice')!==null) state.maxPrice = qs.get('maxPrice')? Number(qs.get('maxPrice')): null;
      if(qs.get('minFollowers')!==null) state.minFollowers = qs.get('minFollowers')? Number(qs.get('minFollowers')): null;
      state.premiumOnly = qs.get('premium')==='1';
      state.page = Math.max(1, parseInt(qs.get('page')||'1',10));
      const ps = parseInt(qs.get('pageSize')||'12',10); if([12,24,48].includes(ps)) state.pageSize = ps;
      state.infinite = qs.get('infinite')==='1';
    }

    function writeQS(){
      const qs = new URLSearchParams();
      if(state.q) qs.set('q', state.q);
      if(state.platform!=='all') qs.set('platform', state.platform);
      if(state.mode!=='sum') qs.set('mode', state.mode);
      if(state.category!=='all') qs.set('category', state.category);
      if(state.city!=='all') qs.set('city', state.city);
      if(state.sort!=='relevance') qs.set('sort', state.sort);
      if(state.maxPrice!=null) qs.set('maxPrice', String(state.maxPrice));
      if(state.minFollowers!=null && state.platform!=='all') qs.set('minFollowers', String(state.minFollowers));
      if(state.premiumOnly) qs.set('premium', '1');
      if(state.page>1) qs.set('page', String(state.page));
      if(state.pageSize!==12) qs.set('pageSize', String(state.pageSize));
      if(state.infinite) qs.set('infinite','1');
      const next = location.pathname + (qs.toString()? '?' + qs.toString(): '');
      history.replaceState({}, '', next);
    }

    function applyFilters(){
      let list = [...MOCK];
      const s = state.q.trim().toLowerCase();
      if(s){ list = list.filter(i=> [i.name,i.handle,i.city,i.category].some(v=> v.toLowerCase().includes(s))); }
      if(state.platform!=='all') list = list.filter(i=> i.platforms.includes(state.platform));
      if(state.category!=='all') list = list.filter(i=> i.category===state.category);
      if(state.city!=='all') list = list.filter(i=> i.city===state.city);
      if(state.maxPrice!=null) list = list.filter(i=> i.price <= state.maxPrice);
      if(state.minFollowers!=null && state.platform!=='all') list = list.filter(i=> platformFollowers(i,state.platform,state.mode) >= state.minFollowers);
      if(state.premiumOnly) list = list.filter(i=> i.verified || platformFollowers(i,state.platform,state.mode) > 100000);

      switch(state.sort){
        case 'followers': list.sort((a,b)=> platformFollowers(b,state.platform,state.mode) - platformFollowers(a,state.platform,state.mode)); break;
        case 'priceLow': list.sort((a,b)=> a.price - b.price); break;
        case 'rating': list.sort((a,b)=> b.rating - a.rating); break;
        default: list.sort((a,b)=> (b.verified?1:0) - (a.verified?1:0) || b.engagement - a.engagement);
      }
      return list;
    }

    function btn(label, onClick, disabled){
      const b = document.createElement('button');
      b.textContent = label;
      if(onClick) b.addEventListener('click', onClick);
      if(disabled){ b.disabled = true; b.classList.add('opacity-50','cursor-not-allowed'); }
      return b;
    }

    function card(data){
      const el = document.createElement('div');
      el.className = 'card overflow-hidden';
      const followersObj = pickFollowers(data);
      const followersLabel = followersObj.val!=null ? fmtFollowers(followersObj.val) : null;
      const aggregateBadge = state.mode==='max' ? '<span class="inline-flex items-center justify-center px-1.5 h-4 text-[10px] font-bold rounded bg-white/10">MAX</span>' : '<span class="inline-flex items-center justify-center w-4 h-4 text-[10px] font-bold rounded bg-white/10">Σ</span>';

      el.innerHTML = `
        <div class="h-32 bg-cover bg-center" style="background-image:url('${data.cover}')"></div>
        <div class="p-4">
          <div class="flex items-start gap-3 -mt-10">
            <img src="${data.avatar}" alt="${data.name}" class="w-16 h-16 rounded-2xl object-cover ring-2 ring-neutral-900" />
            <div class="flex-1">
              <div class="flex items-center gap-2">
                <h3 class="font-bold text-lg leading-tight">${data.name}</h3>
                ${data.verified? '<span class="tag bg-fuchsia-500/20 text-fuchsia-300 border border-fuchsia-500/30"><i data-lucide="badge-check" class="w-3 h-3"></i> Ověřeno</span>':''}
              </div>
              <div class="text-white/60 text-sm">${data.handle} • ${data.category}</div>
              <div class="flex items-center gap-3 mt-2 text-sm text-white/70">
                ${followersLabel ? `
                  <span class="flex items-center gap-1">
                    ${followersObj.mode==='single' ? `<i data-lucide="${followersObj.icon}" class="w-4 h-4"></i>` : aggregateBadge}
                    ${followersLabel}${state.mode==='max' && followersObj.mode!=='single' && followersObj.topPid ? `<span class="ml-1 inline-flex items-center gap-1 text-xs text-white/60">• Top: ${followersObj.topLabel}</span>`:''}
                  </span>
                ` : `
                  <span class="tag text-white/60 cursor-pointer"><i data-lucide="plug-zap" class="w-3.5 h-3.5"></i> ${state.platform!=='all' ? (PLATFORMS.find(p=>p.id===state.platform)?.label || 'Platforma') + ' nepřipojen' : 'Účty nepřipojeny'}</span>
                `}
                <span class="flex items-center gap-1"><i data-lucide="star" class="w-4 h-4"></i>${data.rating}</span>
                <span class="flex items-center gap-1"><i data-lucide="map-pin" class="w-4 h-4"></i>${data.city}</span>
              </div>
            </div>
          </div>
          <p class="text-white/70 text-sm mt-3 line-clamp-2">${data.bio}</p>
          <div class="flex flex-wrap gap-2 mt-3">
            ${data.platforms.map(p=> `<span class=\"tag\"><i data-lucide=\"${PLATFORMS.find(x=>x.id===p)?.icon||'camera'}\" class=\"w-4 h-4\"></i> ${PLATFORMS.find(x=>x.id===p)?.label||p}</span>`).join('')}
          </div>
          <div class="mt-4 flex items-center justify-between">
            <div class="text-sm text-white/70">od <span class="text-white font-semibold">${data.price.toLocaleString('cs-CZ')} Kč</span> / post</div>
            <div class="flex gap-2">
              <button class="btn btn-light js-open">Zobrazit kartu <i data-lucide="chevron-right" class="w-4 h-4"></i></button>
              <a class="btn btn-primary" href="kartao-pro-firmy.html#brief">Chci spolupráci</a>
            </div>
          </div>
        </div>`;

      el.querySelector('.js-open').addEventListener('click', ()=> openDetail(data));
      return el;
    }

    function pickFollowers(data){
      if(state.platform==='all'){
        const parts = ['instagram','youtube','tiktok','facebook'].map(pid=>{
          const m = data.metrics?.[pid];
          const val = m && m.connected && typeof m.followers==='number' ? m.followers : 0;
          return { pid, val, connected: !!m?.connected, updatedAt: m?.updatedAt };
        });
        const sum = parts.reduce((s,p)=>s+p.val,0);
        const max = parts.reduce((m,p)=> Math.max(m,p.val),0);
        const top = parts.reduce((best,p)=> p.val>best.val? {pid:p.pid,val:p.val} : best, {pid:null,val:0});
        const updatedAt = parts.map(p=> p.updatedAt? new Date(p.updatedAt).getTime(): 0).reduce((a,b)=>Math.max(a,b),0);
        const val = state.mode==='max'? max : sum;
        const topLabel = PLATFORMS.find(p=>p.id===top.pid)?.label || top.pid;
        return { mode: state.mode, parts, val, updatedAt: updatedAt? new Date(updatedAt).toISOString(): null, topPid: top.pid, topLabel };
      }
      const m = data.metrics?.[state.platform];
      if(m && m.connected && typeof m.followers==='number'){
        const icon = PLATFORMS.find(p=>p.id===state.platform)?.icon || 'camera';
        return { mode: 'single', pid: state.platform, icon, val: m.followers, updatedAt: m.updatedAt };
      }
      return { mode: 'none', pid: null, val: null, updatedAt: null };
    }

    function stat(label, value){
      return `<div class="p-3 rounded-xl border border-white/10 bg-neutral-900/40"><div class="text-white/60 text-xs">${label}</div><div class="font-semibold">${value}</div></div>`
    }

    function platformRow(pid, label, data){
      const m = data.metrics?.[pid] || {};
      const val = typeof m.followers==='number' ? fmtFollowers(m.followers) : '—';
      const connected = !!m.connected;
      const updatedAt = connected ? (m.updatedAt ? new Date(m.updatedAt).toLocaleString('cs-CZ') : '—') : 'Nepřipojeno';
      const icon = PLATFORMS.find(p=>p.id===pid)?.icon || 'camera';
      return `
        <div class="p-3 rounded-xl border border-white/10 bg-neutral-900/50">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-white/70 text-xs flex items-center gap-2"><i data-lucide="${icon}" class="w-4 h-4"></i> ${label}</div>
              <div class="text-lg font-bold">${val}</div>
              <div class="text-xs text-white/50">${connected? 'Aktualizováno: '+ updatedAt : 'Nepřipojeno'}</div>
            </div>
            <div class="flex gap-2">
              ${!connected ? `<span class="tag text-white/60"><i data-lucide="plug-zap" class="w-3.5 h-3.5"></i> Účet není připojen</span>` : `<span class="tag" style="background:rgba(16,185,129,.2);border-color:rgba(16,185,129,.3);color:#86efac"><i data-lucide="badge-check" class="w-3 h-3"></i> Ověřeno</span>`}
            </div>
          </div>
        </div>`;
    }

    function openDetail(data){
      const ov = document.getElementById('overlay');
      const body = document.getElementById('drawerBody');
      const drawer = document.getElementById('drawer');
      body.innerHTML = `
        <div class="h-40 rounded-xl bg-cover bg-center" style="background-image:url('${data.cover}')"></div>
        <div class="flex items-start gap-3 -mt-10 p-2">
          <img src="${data.avatar}" class="w-16 h-16 rounded-2xl object-cover ring-2 ring-neutral-900"/>
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <h3 class="font-bold text-xl leading-tight">${data.name}</h3>
              ${data.verified? '<span class="tag bg-fuchsia-500/20 text-fuchsia-300 border border-fuchsia-500/30"><i data-lucide="badge-check" class="w-3 h-3"></i> Ověřeno</span>':''}
            </div>
            <div class="text-white/60 text-sm">${data.handle} • ${data.category} • ${data.city}</div>
          </div>
        </div>
        <p class="text-white/80 text-sm mt-2">${data.bio}</p>
        <div class="grid grid-cols-3 gap-2 mt-4">${data.gallery.map(src=>`<img src="${src}" class="rounded-lg object-cover w-full h-28"/>`).join('')}</div>
        <div class="mt-4 grid grid-cols-1 gap-3">
          ${platformRow('instagram','Instagram followers', data)}
          ${platformRow('youtube','YouTube subscribers', data)}
          ${platformRow('tiktok','TikTok followers', data)}
          ${platformRow('facebook','Facebook followers', data)}
        </div>
        <div class="mt-6 flex items-center justify-end gap-2">
          <a href="kartao-pro-firmy.html#brief" class="btn btn-primary"><i data-lucide="mail" class="w-4 h-4"></i> Poptejte spolupráci</a>
        </div>
      `;
      lucide.createIcons();
      ov.classList.remove('hidden');
      setTimeout(()=> drawer.classList.add('active'), 0);
    }

    function closeDetail(){
      const ov = document.getElementById('overlay');
      const drawer = document.getElementById('drawer');
      drawer.classList.remove('active');
      setTimeout(()=> ov.classList.add('hidden'), 200);
    }

    function syncInputsFromState(){
      q.value = state.q; platform.value = state.platform; mode.value = state.mode; category.value = state.category; city.value = state.city; sort.value = state.sort; pageSize.value = String(state.pageSize);
      minFollowers.disabled = (state.platform==='all');
      document.getElementById('minFollowersHint').style.display = state.platform==='all' ? '' : 'none';
      premiumOnly.checked = state.premiumOnly; infinite.checked = state.infinite;
    }

    function resetPageAndRender(){ state.page = 1; writeQS(); render(); }

    document.addEventListener('DOMContentLoaded', ()=>{
      lucide.createIcons();
      readQS();

      // inputs
      window.q = document.getElementById('q');
      window.platform = document.getElementById('platform');
      window.mode = document.getElementById('mode');
      window.category = document.getElementById('category');
      window.city = document.getElementById('city');
      window.sort = document.getElementById('sort');
      window.pageSize = document.getElementById('pageSize');
      window.maxPrice = document.getElementById('maxPrice');
      window.minFollowers = document.getElementById('minFollowers');
      window.premiumOnly = document.getElementById('premiumOnly');
      window.infinite = document.getElementById('infinite');

      syncInputsFromState();
      writeQS();
      // render();  // zatím vypnuto, protože funkce není definovaná

      // listeners
      q.addEventListener('input', (e)=>{ state.q = e.target.value; resetPageAndRender(); });
      platform.addEventListener('change', (e)=>{ state.platform = e.target.value; syncInputsFromState(); resetPageAndRender(); });
      mode.addEventListener('change', (e)=>{ state.mode = e.target.value; resetPageAndRender(); });
      category.addEventListener('change', (e)=>{ state.category = e.target.value; resetPageAndRender(); });
      city.addEventListener('change', (e)=>{ state.city = e.target.value; resetPageAndRender(); });
      sort.addEventListener('change', (e)=>{ state.sort = e.target.value; resetPageAndRender(); });
      pageSize.addEventListener('change', (e)=>{ state.pageSize = Number(e.target.value); resetPageAndRender(); });
      maxPrice.addEventListener('input', (e)=>{ const v = e.target.value.trim(); state.maxPrice = v? Number(v) : null; resetPageAndRender(); });
      minFollowers.addEventListener('input', (e)=>{ const v = e.target.value.trim(); state.minFollowers = v? Number(v) : null; resetPageAndRender(); });
      premiumOnly.addEventListener('change', (e)=>{ state.premiumOnly = e.target.checked; resetPageAndRender(); });
      infinite.addEventListener('change', (e)=>{ state.infinite = e.target.checked; resetPageAndRender(); });

      document.getElementById('advancedBtn').addEventListener('click', ()=>{
        document.getElementById('maxPrice').focus();
      });
      document.getElementById('overlayBg').addEventListener('click', closeDetail);
      document.getElementById('closeDrawer').addEventListener('click', closeDetail);

      // infinite scroll
      const sent = document.getElementById('sentinel');
      const io = new IntersectionObserver(entries=>{
        if(!state.infinite) return;
        if(entries.some(e=> e.isIntersecting)){
          const all = applyFilters();
          const pageCount = Math.max(1, Math.ceil(all.length / state.pageSize));
          if(state.page < pageCount){ state.page++; writeQS(); render(); }
        }
      }, { rootMargin: '200px' });
      io.observe(sent);

      // mini testy
      console.assert(Array.isArray(MOCK) && MOCK.length===4, 'Test dataset length=4');
      console.assert(['sum','max'].includes(state.mode), 'Test mode valid');
      console.assert([12,24,48].includes(state.pageSize), 'Test pageSize valid');
      console.assert(typeof state.infinite === 'boolean', 'Test infinite boolean');
    });
  </script>
</body>
</html>
