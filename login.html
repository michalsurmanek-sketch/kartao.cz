<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Přihlášení - Kartao.cz</title>
  
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="firebase-init.js"></script>
  
  <style>
    body {
      background: linear-gradient(135deg, #1e1b4b 0%, #0f172a 100%);
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

<div class="w-full max-w-md bg-white/10 backdrop-blur-lg rounded-2xl p-8 shadow-2xl">
  
  <!-- Logo -->
  <div class="text-center mb-8">
    <h1 class="text-3xl font-bold text-white mb-2">Kartao.cz</h1>
    <p class="text-white/60">Přihlášení</p>
  </div>

  <!-- Zprávy -->
  <div id="msg" class="hidden mb-4 p-3 rounded-lg text-sm"></div>

  <!-- Přepínač -->
  <div class="flex gap-2 mb-6 bg-white/5 rounded-lg p-1">
    <button id="tab-login" class="flex-1 py-2 rounded-md font-medium bg-white/20 text-white">
      Přihlášení
    </button>
    <button id="tab-register" class="flex-1 py-2 rounded-md font-medium text-white/60 hover:text-white">
      Registrace
    </button>
  </div>

  <!-- LOGIN FORM -->
  <form id="form-login" class="space-y-4">
    <div>
      <input id="login-email" type="email" placeholder="E-mail" required
             class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/40 focus:outline-none focus:border-fuchsia-500">
    </div>
    <div>
      <input id="login-password" type="password" placeholder="Heslo" required
             class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/40 focus:outline-none focus:border-fuchsia-500">
    </div>
    <button type="submit" class="w-full py-3 bg-gradient-to-r from-fuchsia-600 to-purple-600 text-white font-semibold rounded-lg hover:brightness-110">
      Přihlásit se
    </button>
  </form>

  <!-- REGISTER FORM -->
  <form id="form-register" class="space-y-4 hidden">
    <div>
      <input id="reg-email" type="email" placeholder="E-mail" required
             class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/40 focus:outline-none focus:border-fuchsia-500">
    </div>
    <div>
      <input id="reg-password" type="password" placeholder="Heslo (min. 6 znaků)" required minlength="6"
             class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/40 focus:outline-none focus:border-fuchsia-500">
    </div>
    <div>
      <input id="reg-password2" type="password" placeholder="Heslo znovu" required minlength="6"
             class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/40 focus:outline-none focus:border-fuchsia-500">
    </div>
    <button type="submit" class="w-full py-3 bg-gradient-to-r from-fuchsia-600 to-purple-600 text-white font-semibold rounded-lg hover:brightness-110">
      Vytvořit účet
    </button>
  </form>

  <!-- OAuth -->
  <div class="mt-6">
    <div class="text-center text-white/40 text-sm mb-4">nebo</div>
    <button id="btn-google" class="w-full py-3 bg-white/10 border border-white/20 text-white rounded-lg hover:bg-white/20 flex items-center justify-center gap-2">
      <span>G</span>
      <span>Google</span>
    </button>
  </div>

  <div class="mt-6 text-center">
    <a href="index.html" class="text-white/60 text-sm hover:text-white">← Zpět na hlavní stránku</a>
  </div>
</div>

<script>
// Firebase již inicializováno v firebase-init.js
const googleProvider = new firebase.auth.GoogleAuthProvider();

// Elements
const msg = document.getElementById('msg');
const tabLogin = document.getElementById('tab-login');
const tabRegister = document.getElementById('tab-register');
const formLogin = document.getElementById('form-login');
const formRegister = document.getElementById('form-register');
const btnGoogle = document.getElementById('btn-google');

let mode = 'login';
let busy = false;

// Helpers
function showMsg(text, type) {
  msg.className = 'mb-4 p-3 rounded-lg text-sm ';
  if (type === 'error') msg.className += 'bg-red-500/20 text-red-200 border border-red-500/50';
  else if (type === 'success') msg.className += 'bg-green-500/20 text-green-200 border border-green-500/50';
  else msg.className += 'bg-yellow-500/20 text-yellow-200 border border-yellow-500/50';
  msg.textContent = text;
  msg.classList.remove('hidden');
}

function hideMsg() {
  msg.classList.add('hidden');
}

function switchMode(m) {
  mode = m;
  hideMsg();
  
  if (m === 'login') {
    tabLogin.className = 'flex-1 py-2 rounded-md font-medium bg-white/20 text-white';
    tabRegister.className = 'flex-1 py-2 rounded-md font-medium text-white/60 hover:text-white';
    formLogin.classList.remove('hidden');
    formRegister.classList.add('hidden');
  } else {
    tabRegister.className = 'flex-1 py-2 rounded-md font-medium bg-white/20 text-white';
    tabLogin.className = 'flex-1 py-2 rounded-md font-medium text-white/60 hover:text-white';
    formRegister.classList.remove('hidden');
    formLogin.classList.add('hidden');
  }
}

async function saveProfile(user) {
  if (!user) return;
  try {
    await db.collection('users').doc(user.uid).set({
      email: user.email,
      displayName: user.displayName || '',
      photoURL: user.photoURL || '',
      provider: user.providerData?.[0]?.providerId || 'password',
      updatedAt: new Date().toISOString()
    }, { merge: true });
  } catch (e) {
    console.error('Profile save error:', e);
  }
}

async function redirect(user) {
  try {
    const doc = await db.collection('users').doc(user.uid).get();
    const role = doc.exists ? doc.data()?.role : null;
    
    if (role === 'tvurce') {
      window.location.href = 'creator-dashboard.html';
    } else if (role === 'firma') {
      window.location.href = 'firm-dashboard.html';
    } else {
      window.location.href = 'kartao-vyber-uctu.html';
    }
  } catch (e) {
    window.location.href = 'kartao-vyber-uctu.html';
  }
}

// Tabs
tabLogin.onclick = () => switchMode('login');
tabRegister.onclick = () => switchMode('register');

// Login
formLogin.onsubmit = async (e) => {
  e.preventDefault();
  if (busy) return;
  busy = true;
  hideMsg();
  
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  const btn = formLogin.querySelector('button');
  
  btn.disabled = true;
  btn.textContent = 'Přihlašuji...';
  
  try {
    const cred = await auth.signInWithEmailAndPassword(email, password);
    await saveProfile(cred.user);
    showMsg('Přihlášení úspěšné!', 'success');
    setTimeout(() => redirect(cred.user), 500);
  } catch (error) {
    let msg = 'Chyba při přihlášení';
    if (error.code === 'auth/user-not-found') msg = 'Uživatel nenalezen';
    else if (error.code === 'auth/wrong-password') msg = 'Špatné heslo';
    else if (error.code === 'auth/invalid-email') msg = 'Neplatný e-mail';
    showMsg(msg, 'error');
    btn.disabled = false;
    btn.textContent = 'Přihlásit se';
    busy = false;
  }
};

// Register
formRegister.onsubmit = async (e) => {
  e.preventDefault();
  if (busy) return;
  busy = true;
  hideMsg();
  
  const email = document.getElementById('reg-email').value.trim();
  const password = document.getElementById('reg-password').value;
  const password2 = document.getElementById('reg-password2').value;
  const btn = formRegister.querySelector('button');
  
  if (password !== password2) {
    showMsg('Hesla se neshodují', 'error');
    busy = false;
    return;
  }
  
  if (password.length < 6) {
    showMsg('Heslo musí mít alespoň 6 znaků', 'error');
    busy = false;
    return;
  }
  
  btn.disabled = true;
  btn.textContent = 'Vytvářím...';
  
  try {
    if (auth.currentUser) await auth.signOut();
    
    const cred = await auth.createUserWithEmailAndPassword(email, password);
    await saveProfile(cred.user);
    showMsg('Účet vytvořen!', 'success');
    setTimeout(() => redirect(cred.user), 500);
  } catch (error) {
    let msg = 'Chyba při registraci';
    if (error.code === 'auth/email-already-in-use') msg = 'E-mail již existuje';
    else if (error.code === 'auth/invalid-email') msg = 'Neplatný e-mail';
    else if (error.code === 'auth/weak-password') msg = 'Slabé heslo';
    showMsg(msg, 'error');
    btn.disabled = false;
    btn.textContent = 'Vytvořit účet';
    busy = false;
  }
};

// Google
btnGoogle.onclick = async () => {
  if (busy) return;
  busy = true;
  hideMsg();
  
  btnGoogle.disabled = true;
  const txt = btnGoogle.innerHTML;
  btnGoogle.textContent = 'Přihlašuji...';
  
  try {
    const result = await auth.signInWithPopup(googleProvider);
    await saveProfile(result.user);
    showMsg('Přihlášení úspěšné!', 'success');
    setTimeout(() => redirect(result.user), 500);
  } catch (error) {
    if (error.code !== 'auth/popup-closed-by-user' && error.code !== 'auth/cancelled-popup-request') {
      showMsg('Chyba Google přihlášení', 'error');
    }
    btnGoogle.innerHTML = txt;
    btnGoogle.disabled = false;
    busy = false;
  }
};

// Redirect result
auth.getRedirectResult().then(async (result) => {
  if (result.user) {
    await saveProfile(result.user);
    await redirect(result.user);
  }
}).catch(console.error);
</script>

</body>
</html>
