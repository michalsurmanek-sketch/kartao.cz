  <script>
    // =========================
    // 1) Předpoklad: Firebase už je inicializovaná ve firebase-init.js
    // =========================
    const googleProvider = new firebase.auth.GoogleAuthProvider();
    const facebookProvider = new firebase.auth.FacebookAuthProvider();

    // KAM přesměrovat po přihlášení
    function getReturnUrl() {
      const p = new URLSearchParams(location.search);
      const next = p.get("next");
      const ret  = p.get("returnUrl");
      // když nic není v URL, pošli třeba na Můj účet (změň podle sebe)
      return next || ret || "kartao-muj-ucet.html";
    }

    // =========================
    // 2) Helper na hlášky
    // =========================
    const messageBox = document.getElementById("auth-message");
    const btnResend = document.getElementById("btn-resend");
    const btnGoogle = document.getElementById("btn-google");
    const btnFacebook = document.getElementById("btn-facebook");

    function showMessage(text, type = "info") {
      if (!messageBox) return;
      messageBox.textContent = text;
      messageBox.classList.remove(
        "hidden",
        "border-red-400",
        "bg-red-900/60",
        "border-emerald-400",
        "bg-emerald-900/60",
        "border-amber-300",
        "bg-amber-900/40"
      );

      if (type === "error") {
        messageBox.classList.add("border-red-400", "bg-red-900/60");
      } else if (type === "success") {
        messageBox.classList.add("border-emerald-400", "bg-emerald-900/60");
      } else {
        messageBox.classList.add("border-amber-300", "bg-amber-900/40");
      }
    }

    function clearMessage() {
      if (!messageBox) return;
      messageBox.classList.add("hidden");
      messageBox.textContent = "";
    }

    // Uložení / aktualizace profilu uživatele ve Firestore
    async function saveUserProfile(user) {
      if (!user || !db) return;
      try {
        const userRef = db.collection("users").doc(user.uid);
        const providerId = user.providerData && user.providerData[0]
          ? user.providerData[0].providerId
          : "password";
        await userRef.set(
          {
            email: user.email || "",
            displayName: user.displayName || "",
            photoURL: user.photoURL || "",
            provider: providerId,
            emailVerified: !!user.emailVerified,
            updatedAt: new Date().toISOString(),
          },
          { merge: true }
        );
      } catch (err) {
        console.error("Chyba při ukládání profilu:", err);
      }
    }

    // =========================
    // 3) Přepínání záložek
    // =========================
    const tabLogin = document.getElementById("tab-login");
    const tabRegister = document.getElementById("tab-register");
    const loginForm = document.getElementById("login-form");
    const registerForm = document.getElementById("register-form");

    function setActiveTab(tab) {
      clearMessage();
      if (btnResend) btnResend.classList.add("hidden");

      if (tab === "login") {
        tabLogin.classList.add("bg-neutral-900", "text-white");
        tabLogin.classList.remove("text-white/70");
        tabRegister.classList.remove("bg-neutral-900", "text-white");
        tabRegister.classList.add("text-white/70");
        loginForm.classList.remove("hidden");
        registerForm.classList.add("hidden");
      } else {
        tabRegister.classList.add("bg-neutral-900", "text-white");
        tabRegister.classList.remove("text-white/70");
        tabLogin.classList.remove("bg-neutral-900", "text-white");
        tabLogin.classList.add("text-white/70");
        registerForm.classList.remove("hidden");
        loginForm.classList.add("hidden");
      }
    }

    tabLogin.addEventListener("click", () => setActiveTab("login"));
    tabRegister.addEventListener("click", () => setActiveTab("register"));

    // default
    setActiveTab("login");

    // =========================
    // 4) Registrace + ověření e-mailu
    // =========================
    registerForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearMessage();

      const email = document.getElementById("reg-email").value.trim();
      const password = document.getElementById("reg-password").value;
      const password2 = document.getElementById("reg-password2").value;

      if (password !== password2) {
        showMessage("Hesla se neshodují.", "error");
        return;
      }

      if (password.length < 6) {
        showMessage("Heslo musí mít alespoň 6 znaků.", "error");
        return;
      }

      try {
        const cred = await auth.createUserWithEmailAndPassword(email, password);
        if (cred.user) {
          await saveUserProfile(cred.user);
          await cred.user.sendEmailVerification();
          showMessage(
            "Účet byl vytvořen. Zkontrolujte e-mail a potvrďte ověřovací odkaz.",
            "success"
          );
          registerForm.reset();
          setActiveTab("login");
        }
      } catch (error) {
        console.error(error);
        showMessage(error.message || "Při registraci došlo k chybě.", "error");
      }
    });

    // =========================
    // 5) Přihlášení (kontrola ověření e-mailu)
    // =========================
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearMessage();
      if (btnResend) btnResend.classList.add("hidden");

      const email = document.getElementById("login-email").value.trim();
      const password = document.getElementById("login-password").value;

      try {
        const cred = await auth.signInWithEmailAndPassword(email, password);
        const user = cred.user;

        if (!user.emailVerified) {
          showMessage(
            "Účet je vytvořen, ale e-mail zatím není ověřen. Zkontrolujte schránku nebo klikněte na 'Znovu poslat ověřovací e-mail'.",
            "info"
          );
          if (btnResend) btnResend.classList.remove("hidden");
          return;
        }

        await saveUserProfile(user);
        // ✅ TADY UŽ NEHLÁSÍME SUCCESS, ALE ROVNOU PŘESMĚRUJEME
        window.location.href = getReturnUrl();

      } catch (error) {
        console.error(error);
        showMessage(error.message || "Při přihlášení došlo k chybě.", "error");
      }
    });

    // =========================
    // 6) Přihlášení přes Google
    // =========================
    if (btnGoogle) {
      btnGoogle.addEventListener("click", async () => {
        clearMessage();
        try {
          const result = await auth.signInWithPopup(googleProvider);
          const user = result.user;
          if (user) {
            await saveUserProfile(user);
            window.location.href = getReturnUrl();
          }
        } catch (error) {
          console.error(error);
          showMessage(error.message || "Přihlášení přes Google se nepodařilo.", "error");
        }
      });
    }

    // =========================
    // 7) Přihlášení přes Facebook
    // =========================
    if (btnFacebook) {
      btnFacebook.addEventListener("click", async () => {
        clearMessage();
        try {
          const result = await auth.signInWithPopup(facebookProvider);
          const user = result.user;
          if (user) {
            await saveUserProfile(user);
            window.location.href = getReturnUrl();
          }
        } catch (error) {
          console.error(error);
          showMessage(error.message || "Přihlášení přes Facebook se nepodařilo.", "error");
        }
      });
    }

    // =========================
    // 8) Znovu poslat ověřovací e-mail
    // =========================
    if (btnResend) {
      btnResend.addEventListener("click", async () => {
        clearMessage();
        const user = auth.currentUser;
        if (!user) {
          showMessage("Nejste přihlášený. Zkuste se znovu přihlásit.", "error");
          return;
        }

        try {
          await user.sendEmailVerification();
          showMessage(
            "Ověřovací e-mail byl znovu odeslán. Zkontrolujte schránku (i SPAM).",
            "success"
          );
        } catch (error) {
          console.error(error);
          showMessage(error.message || "Ověřovací e-mail se nepodařilo odeslat.", "error");
        }
      });
    }
  </script>
