 <!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="P≈ôihlaste se do Kartao.cz - platformy pro influencery a znaƒçky. Spravujte sv≈Øj profil, kampanƒõ a komunikaci s partnery." />
  <meta name="robots" content="noindex, nofollow" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://unpkg.com https://www.gstatic.com https://apis.google.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com https://*.firebaseapp.com https://accounts.google.com https://www.facebook.com https://facebook.com wss://*.firebaseio.com; frame-src 'self' https://kartao-cz.firebaseapp.com https://*.firebaseapp.com https://accounts.google.com https://www.facebook.com https://facebook.com; child-src 'self' https://accounts.google.com https://www.facebook.com; form-action 'self' https://accounts.google.com; object-src 'none';">
  <title>Kartao.cz ‚Äì P≈ôihl√°≈°en√≠ & Registrace</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üîë</text></svg>">
  
  <!-- Open Graph -->
  <meta property="og:title" content="P≈ôihl√°≈°en√≠ - Kartao.cz" />
  <meta property="og:description" content="P≈ôihlaste se do sv√© √∫ƒçtu na Kartao.cz" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.kartao.cz/login.html" />

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            fuchsia: tailwind.colors.fuchsia,
            amber: tailwind.colors.amber,
            neutral: tailwind.colors.neutral,
          },
        },
      },
    };
  </script>

    <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <!-- Jednotn√° inicializace Firebase pro cel√Ω web -->
  <script src="firebase-init.js"></script>

  <style>
    /* Lehk√Ω rozmazan√Ω gradient na pozad√≠ */
    body {
      min-height: 100vh;
      background: radial-gradient(circle at top left, #db58f6 0, transparent 55%),
                  radial-gradient(circle at bottom right, #fbbf24 0, #020617 55%);
    }
  </style>
</head>
<body class="min-h-screen bg-neutral-950 text-white">

<!-- MINIM√ÅLN√ç HEADER -->
<header class="border-b border-white/10 bg-neutral-900/50">
  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
    <a href="index.html" class="flex items-center gap-3">
      <div class="w-9 h-9 rounded-2xl bg-gradient-to-tr from-fuchsia-500 to-amber-400 grid place-items-center">
        <span class="text-lg font-bold">K</span>
      </div>
      <div>
        <div class="font-extrabold tracking-tight text-lg">Kartao.cz</div>
        <div class="text-xs text-white/60 -mt-0.5">S√≠≈• influencer≈Ø a tv≈Ørc≈Ø</div>
      </div>
    </a>
    <nav class="hidden md:flex items-center gap-4 text-sm">
      <a href="index.html" class="text-white/70 hover:text-white transition">Dom≈Ø</a>
      <a href="kartao-marketplace.html" class="text-white/70 hover:text-white transition">Marketplace</a>
      <a href="kartao-pro-tvurce.html" class="text-white/70 hover:text-white transition">Pro tv≈Ørce</a>
    </nav>
  </div>
</header>

<!-- BREADCRUMBS -->
<nav class="border-b border-white/10 bg-neutral-900/50" aria-label="breadcrumb">
  <div class="max-w-7xl mx-auto px-4 py-2">
    <ol class="flex items-center gap-2 text-sm">
      <li><a href="index.html" class="text-white/70 hover:text-white transition">Dom≈Ø</a></li>
      <i data-lucide="chevron-right" class="w-3 h-3 text-white/40"></i>
      <li class="text-white">P≈ôihl√°≈°en√≠</li>
    </ol>
  </div>
</nav>

<main class="flex-1 flex items-center justify-center px-4 py-10">
  <div class="w-full max-w-md bg-neutral-900/80 border border-white/10 rounded-2xl shadow-xl backdrop-blur-md p-6">
    <!-- Logo + claim -->
    <div class="flex items-center gap-3 mb-6">
      <div class="w-10 h-10 rounded-2xl bg-gradient-to-tr from-fuchsia-500 to-amber-400 grid place-items-center shadow-lg">
        <span class="text-xl font-bold">K</span>
      </div>
      <div>
        <div class="font-extrabold tracking-tight text-lg">Kartao.cz</div>
        <div class="text-xs text-white/60 -mt-0.5">S√≠≈• influencer≈Ø a tv≈Ørc≈Ø</div>
      </div>
    </div>

    <!-- P≈ôep√≠naƒç P≈ôihl√°≈°en√≠ / Registrace -->
    <div class="flex mb-4 rounded-xl bg-neutral-800/80 p-1 text-sm">
      <button id="tab-login" data-tab="login" type="button" class="flex-1 py-2 rounded-lg font-medium bg-neutral-900 text-white">P≈ôihl√°≈°en√≠</button>
      <button id="tab-register" data-tab="register" type="button" class="flex-1 py-2 rounded-lg font-medium text-white/70 hover:text-white">Registrace</button>
    </div>

    <!-- Box na hl√°≈°ky -->
    <div id="auth-message" class="hidden mb-4 text-sm rounded-lg px-3 py-2 border"></div>

    <!-- FORM: P≈ôihl√°≈°en√≠ -->
    <form id="login-form" class="space-y-4">
      <div>
        <label class="block text-sm mb-1" for="login-email">E-mail</label>
        <input id="login-email" type="email" required autocomplete="email"
               class="w-full rounded-xl bg-neutral-900 border border-white/10 px-3 py-2 text-sm focus:outline-none focus:border-fuchsia-400" />
      </div>
      <div>
        <label class="block text-sm mb-1" for="login-password">Heslo</label>
        <input id="login-password" type="password" required autocomplete="current-password"
               class="w-full rounded-xl bg-neutral-900 border border-white/10 px-3 py-2 text-sm focus:outline-none focus:border-fuchsia-400" />
      </div>

      <button type="submit" class="w-full py-2.5 rounded-xl bg-gradient-to-r from-fuchsia-500 to-amber-400 text-sm font-semibold text-neutral-900 hover:brightness-110 transition">
        P≈ôihl√°sit se
      </button>

      <!-- Tlaƒç√≠tko pro znovu-posl√°n√≠ ovƒõ≈ôovac√≠ho e-mailu (standardnƒõ skryt√©) -->
      <button type="button" id="btn-resend" class="hidden w-full py-2 rounded-xl border border-amber-300/60 text-xs text-amber-200 hover:bg-amber-300/10 transition">
        Znovu poslat ovƒõ≈ôovac√≠ e-mail
      </button>

      <div class="mt-3 text-center text-[11px] text-white/40">
        <span class="inline-block px-2 text-white/60">nebo</span>
      </div>

      <button type="button" id="btn-google" class="mt-2 w-full py-2.5 rounded-xl border border-white/15 bg-neutral-900/80 text-sm font-medium text-white/80 hover:bg-neutral-800 transition flex items-center justify-center gap-2">
        <span class="text-lg">G</span>
        <span>P≈ôihl√°sit se p≈ôes Google</span>
      </button>

      <button type="button" id="btn-facebook" class="mt-2 w-full py-2.5 rounded-xl border border-white/15 bg-neutral-900/80 text-sm font-medium text-white/80 hover:bg-neutral-800 transition flex items-center justify-center gap-2">
        <span class="text-lg">f</span>
        <span>P≈ôihl√°sit se p≈ôes Facebook</span>
      </button>
    </form>

    <!-- FORM: Registrace (schovan√Ω, p≈ôep√≠n√° se tlaƒç√≠tky naho≈ôe) -->
    <form id="register-form" class="space-y-4 hidden">
      <div>
        <label class="block text-sm mb-1" for="reg-email">E-mail</label>
        <input id="reg-email" type="email" required autocomplete="email"
               class="w-full rounded-xl bg-neutral-900 border border-white/10 px-3 py-2 text-sm focus:outline-none focus:border-fuchsia-400" />
      </div>
      <div>
        <label class="block text-sm mb-1" for="reg-password">Heslo</label>
        <input id="reg-password" type="password" required minlength="6" autocomplete="new-password"
               class="w-full rounded-xl bg-neutral-900 border border-white/10 px-3 py-2 text-sm focus:outline-none focus:border-fuchsia-400" />
        <p class="mt-1 text-[11px] text-white/50">Min. 6 znak≈Ø.</p>
      </div>
      <div>
        <label class="block text-sm mb-1" for="reg-password2">Heslo znovu</label>
        <input id="reg-password2" type="password" required minlength="6" autocomplete="new-password"
               class="w-full rounded-xl bg-neutral-900 border border-white/10 px-3 py-2 text-sm focus:outline-none focus:border-fuchsia-400" />
      </div>

      <button type="submit" class="w-full py-2.5 rounded-xl bg-gradient-to-r from-fuchsia-500 to-amber-400 text-sm font-semibold text-neutral-900 hover:brightness-110 transition">
        Vytvo≈ôit √∫ƒçet a poslat ovƒõ≈ôen√≠
      </button>

      <p class="text-[11px] text-white/50 text-center">
        Registrac√≠ souhlas√≠te s&nbsp;<a href="obchodni-podminky.html" class="underline">podm√≠nkami pou≈æit√≠</a> a
        <a href="ochrana-osobnich-udaju.html" class="underline">zpracov√°n√≠m osobn√≠ch √∫daj≈Ø</a>.
      </p>
    </form>

    <p class="mt-5 text-center text-[11px] text-white/40">
      Pot≈ôebujete pomoct? Napi≈°te na <a href="mailto:podpora@kartao.cz" class="underline">podpora@kartao.cz</a>
    </p>
  </div>

  <script src="form-validation.js"></script>
  <script>
    // =========================
    // 1) Firebase providery
    // =========================
    const googleProvider = new firebase.auth.GoogleAuthProvider();
    const facebookProvider = new firebase.auth.FacebookAuthProvider();

    // =========================
    // 1b) Handler pro OAuth redirect (pokud se vrac√≠ z Google/Facebook)
    // =========================
    auth.getRedirectResult()
      .then(async (result) => {
        if (result.user) {
          console.log('‚úÖ OAuth redirect √∫spƒõ≈°n√©:', result.user.email);
          await saveUserProfile(result.user);
          
          // Z√≠skat roli a p≈ôesmƒõrovat
          const userDoc = await db.collection('users').doc(result.user.uid).get();
          const role = userDoc.exists ? userDoc.data()?.role : null;
          
          if (role === 'creator') {
            window.location.href = "creator-dashboard.html";
          } else if (role === 'company') {
            window.location.href = "firm-dashboard.html";
          } else {
            window.location.href = "kartao-vyber-uctu.html";
          }
        }
      })
      .catch((error) => {
        if (error.code !== 'auth/popup-closed-by-user') {
          console.error('‚ùå Redirect error:', error);
          showMessage('Chyba p≈ôi p≈ôihl√°≈°en√≠: ' + (error.message || error.code), 'error');
        }
      });

    // =========================
    // 2) Helper na hl√°≈°ky
    // =========================
    const messageBox = document.getElementById("auth-message");
    const btnResend = document.getElementById("btn-resend");
    const btnGoogle = document.getElementById("btn-google");
    const btnFacebook = document.getElementById("btn-facebook");

    function showMessage(text, type = "info") {
      if (!messageBox) return;
      messageBox.innerHTML = text; // Zmƒõnƒõno na innerHTML pro podporu HTML
      messageBox.classList.remove("hidden", "border-red-400", "bg-red-900/60", "border-emerald-400", "bg-emerald-900/60", "border-amber-300", "bg-amber-900/40");

      if (type === "error") {
        messageBox.classList.add("border-red-400", "bg-red-900/60");
      } else if (type === "success") {
        messageBox.classList.add("border-emerald-400", "bg-emerald-900/60");
      } else {
        messageBox.classList.add("border-amber-300", "bg-amber-900/40");
      }
    }

    function clearMessage() {
      if (!messageBox) return;
      messageBox.classList.add("hidden");
      messageBox.innerHTML = ""; // Zmƒõnƒõno na innerHTML
    }

    // Ulo≈æen√≠ / aktualizace profilu u≈æivatele ve Firestore
    async function saveUserProfile(user) {
      if (!user || !db) return;
      try {
        const userRef = db.collection("users").doc(user.uid);
        const providerId = user.providerData && user.providerData[0] ? user.providerData[0].providerId : "password";
        await userRef.set({
          email: user.email || "",
          displayName: user.displayName || "",
          photoURL: user.photoURL || "",
          provider: providerId,
          emailVerified: !!user.emailVerified,
          updatedAt: new Date().toISOString(),
        }, { merge: true });
      } catch (err) {
        console.error("Chyba p≈ôi ukl√°d√°n√≠ profilu:", err);
      }
    }

    // =========================
    // 3) P≈ôep√≠n√°n√≠ z√°lo≈æek
    // =========================
    const tabLogin = document.getElementById("tab-login");
    const tabRegister = document.getElementById("tab-register");
    const loginFormEl = document.getElementById("login-form");
    const registerFormEl = document.getElementById("register-form");

    function setActiveTab(tab) {
      clearMessage();
      if (btnResend) btnResend.classList.add("hidden");

      if (tab === "login") {
        tabLogin.classList.add("bg-neutral-900", "text-white");
        tabLogin.classList.remove("text-white/70");
        tabRegister.classList.remove("bg-neutral-900", "text-white");
        tabRegister.classList.add("text-white/70");
        loginFormEl.classList.remove("hidden");
        registerFormEl.classList.add("hidden");
      } else {
        tabRegister.classList.add("bg-neutral-900", "text-white");
        tabRegister.classList.remove("text-white/70");
        tabLogin.classList.remove("bg-neutral-900", "text-white");
        tabLogin.classList.add("text-white/70");
        registerFormEl.classList.remove("hidden");
        loginFormEl.classList.add("hidden");
      }
    }

    tabLogin.addEventListener("click", () => setActiveTab("login"));
    tabRegister.addEventListener("click", () => setActiveTab("register"));

    // default
    setActiveTab("login");

    // =========================
    // 4) Valid√°tory formul√°≈ô≈Ø
    // =========================
    const loginValidator = new FormValidator(loginFormEl);
    loginValidator
      .addRule('login-email', { required: true, email: true })
      .addRule('login-password', { required: true, minLength: 6 });
    loginValidator.enableRealTimeValidation();

    const regValidator = new FormValidator(registerFormEl);
    regValidator
      .addRule('reg-email', { required: true, email: true })
      .addRule('reg-password', { required: true, minLength: 6 })
      .addRule('reg-password2', { 
        required: true,
        custom: (value) => {
          const pass1 = document.getElementById('reg-password').value;
          if (value !== pass1) {
            return 'Hesla se neshoduj√≠';
          }
          return null;
        }
      });
    regValidator.enableRealTimeValidation();

    // =========================
    // 4.5) Auth State Observer - Automatick√© p≈ôesmƒõrov√°n√≠
    // =========================
    let authStateHandled = false;
    let isRegistering = false; // Flag pro rozli≈°en√≠ registrace vs. p≈ôihl√°≈°en√≠
    let emailCheckInterval = null;
    
    auth.onAuthStateChanged(async (user) => {
      console.log('üîê Auth state changed:', user ? user.email : 'No user');
      console.log('üìç isRegistering:', isRegistering, 'authStateHandled:', authStateHandled);
      
      // Pokud je u≈æivatel p≈ôihl√°≈°en
      if (user) {
        console.log('üë§ U≈æivatel p≈ôihl√°≈°en:', user.email);
        console.log('‚úâÔ∏è Email ovƒõ≈ôen:', user.emailVerified);
        
        // D≈ÆLE≈ΩIT√â: P≈ôesmƒõrujeme POUZE pokud je email ovƒõ≈ôen√Ω
        // A souƒçasnƒõ nen√≠ registrace a je≈°tƒõ jsme nep≈ôesmƒõrovali
        if (user.emailVerified && !authStateHandled && !isRegistering) {
          authStateHandled = true;
          console.log('üöÄ Email je ovƒõ≈ôen! Zahajuji p≈ôesmƒõrov√°n√≠...');
          
          // Zastavit periodickou kontrolu
          if (emailCheckInterval) {
            clearInterval(emailCheckInterval);
            emailCheckInterval = null;
          }
          
          setTimeout(async () => {
            try {
              console.log('üìÇ Naƒç√≠t√°m profil u≈æivatele z Firestore...');
              const userDoc = await db.collection('users').doc(user.uid).get();
              const userData = userDoc.exists ? userDoc.data() : null;
              const role = userData?.role;
              
              console.log('üìä Role u≈æivatele:', role || '≈æ√°dn√° role (nov√Ω u≈æivatel)');
              
              if (role === 'creator') {
                console.log('‚Ü™Ô∏è P≈ôesmƒõrov√°n√≠ na creator-dashboard.html');
                window.location.href = "creator-dashboard.html";
              } else if (role === 'company') {
                console.log('‚Ü™Ô∏è P≈ôesmƒõrov√°n√≠ na firm-dashboard.html');
                window.location.href = "firm-dashboard.html";
              } else {
                console.log('‚Ü™Ô∏è P≈ôesmƒõrov√°n√≠ na kartao-vyber-uctu.html (v√Ωbƒõr role)');
                window.location.href = "kartao-vyber-uctu.html";
              }
            } catch (err) {
              console.error('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ role:', err);
              console.log('‚Ü™Ô∏è Fallback na kartao-vyber-uctu.html');
              window.location.href = "kartao-vyber-uctu.html";
            }
          }, 1000);
        } else if (!user.emailVerified && !emailCheckInterval) {
          console.log('‚è≥ Email NEN√ç ovƒõ≈ôen - zahajuji periodickou kontrolu...');
          console.log('üí° U≈æivatel mus√≠ kliknout na link v emailu');
          
          // Periodicky kontrolovat, zda u≈æ je email ovƒõ≈ôen√Ω
          emailCheckInterval = setInterval(async () => {
            try {
              await user.reload();
              console.log('üîÑ Kontrola ovƒõ≈ôen√≠ emailu...');
              
              if (user.emailVerified) {
                console.log('‚úÖ Email byl ovƒõ≈ôen! Triggering auth state change...');
                clearInterval(emailCheckInterval);
                emailCheckInterval = null;
                
                // Znovu zavolat auth observer manu√°lnƒõ
                authStateHandled = false;
                auth.onAuthStateChanged.call(auth, user);
              }
            } catch (err) {
              console.error('Chyba p≈ôi reload u≈æivatele:', err);
            }
          }, 3000); // Kontrola ka≈æd√© 3 sekundy
        }
      }
      
      // Reset flag po odhl√°≈°en√≠
      if (!user) {
        console.log('üëã U≈æivatel odhl√°≈°en - reset flag≈Ø');
        authStateHandled = false;
        isRegistering = false;
        
        if (emailCheckInterval) {
          clearInterval(emailCheckInterval);
          emailCheckInterval = null;
        }
      }
    });

    // =========================
    // 5) Registrace + ovƒõ≈ôen√≠ e-mailu
    // =========================
    registerFormEl.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearMessage();

      // Validace
      if (!regValidator.validate()) {
        return;
      }

      const email = document.getElementById("reg-email").value.trim();
      const password = document.getElementById("reg-password").value;
      const password2 = document.getElementById("reg-password2").value;

      // Pokud je u≈æivatel ji≈æ p≈ôihl√°≈°en√Ω, automaticky ho odhl√°sit
      if (auth.currentUser) {
        console.log('‚ö†Ô∏è U≈æivatel ji≈æ p≈ôihl√°≈°en, odhla≈°uji p≈ôed registrac√≠...');
        await auth.signOut();
        // Kr√°tk√° pauza pro dokonƒçen√≠ odhl√°≈°en√≠
        await new Promise(resolve => setTimeout(resolve, 500));
      }

      const btn = registerFormEl.querySelector('button[type="submit"]');
      const originalText = btn.textContent;
      btn.textContent = 'Vytv√°≈ô√≠m √∫ƒçet...';
      btn.disabled = true;
      
      isRegistering = true; // Nastavit flag - registrace prob√≠h√°
      console.log('üìù Zahajuji registraci pro:', email);

      try {
        const cred = await auth.createUserWithEmailAndPassword(email, password);
        console.log('‚úÖ √öƒçet vytvo≈ôen:', cred.user.uid);
        
        if (cred.user) {
          await saveUserProfile(cred.user);
          console.log('‚úÖ Profil ulo≈æen do Firestore');
          
          // Pokus o odesl√°n√≠ ovƒõ≈ôovac√≠ho emailu s detailn√≠m logov√°n√≠m
          try {
            console.log('üìß Odes√≠l√°m ovƒõ≈ôovac√≠ email na:', cred.user.email);
            
            // Konfigurace Action URL pro ovƒõ≈ôovac√≠ email
            const actionCodeSettings = {
              url: window.location.origin + '/email-verified.html',
              handleCodeInApp: true
            };
            
            await cred.user.sendEmailVerification(actionCodeSettings);
            console.log('‚úÖ Ovƒõ≈ôovac√≠ email byl odesl√°n');
            console.log('üîó Verification URL:', actionCodeSettings.url);
            
            showMessage(
              `‚úÖ <strong>Registrace √∫spƒõ≈°n√°!</strong><br><br>` +
              `Ovƒõ≈ôovac√≠ email byl odesl√°n na <strong>${cred.user.email}</strong><br><br>` +
              `üìß <strong>D≈ÆLE≈ΩIT√â: Zkontrolujte schr√°nku (i SPAM slo≈æku) a kliknƒõte na odkaz!</strong><br>` +
              `üì® Email p≈ôich√°z√≠ z: noreply@kartao-cz.firebaseapp.com<br><br>` +
              `<em>Po ovƒõ≈ôen√≠ emailu budete automaticky p≈ôesmƒõrov√°ni...</em>`,
              "success"
            );
            
            // Zobrazit tlaƒç√≠tko pro opƒõtovn√© odesl√°n√≠
            if (btnResend) btnResend.classList.remove("hidden");
            
          } catch (emailError) {
            console.error('‚ùå Chyba p≈ôi odes√≠l√°n√≠ ovƒõ≈ôovac√≠ho emailu:', emailError);
            showMessage(
              `‚ö†Ô∏è <strong>√öƒçet byl vytvo≈ôen!</strong><br><br>` +
              `Ovƒõ≈ôovac√≠ email se bohu≈æel nepoda≈ôilo odeslat.<br>` +
              `Pou≈æijte tlaƒç√≠tko n√≠≈æe pro opƒõtovn√© odesl√°n√≠.<br><br>` +
              `<em>Po ovƒõ≈ôen√≠ emailu budete automaticky p≈ôesmƒõrov√°ni...</em>`,
              "info"
            );
            
            if (btnResend) btnResend.classList.remove("hidden");
          }
          
          // D≈ÆLE≈ΩIT√â: NEODHLASUJI u≈æivatele!
          // U≈æivatel z≈Østane p≈ôihl√°≈°en√Ω, ale bez ovƒõ≈ôen√©ho emailu
          // Auth observer ho p≈ôesmƒõruje a≈æ po ovƒõ≈ôen√≠ emailu
          
          registerFormEl.reset();
          isRegistering = false;
          console.log('‚úÖ Registrace dokonƒçena, u≈æivatel z≈Øst√°v√° p≈ôihl√°≈°en (ƒçek√° na ovƒõ≈ôen√≠ emailu)');
        }
      } catch (error) {
        console.error('‚ùå Chyba p≈ôi registraci:', error.code, error.message);
        let errorMsg = "P≈ôi registraci do≈°lo k chybƒõ.";
        
        if (error.code === 'auth/email-already-in-use') {
          errorMsg = "‚ö†Ô∏è Tento e-mail je ji≈æ registrov√°n. <br><br>" +
                     "<strong>M√°te dva mo≈ænosti:</strong><br>" +
                     "1. P≈ôejdƒõte na z√°lo≈æku 'P≈ôihl√°≈°en√≠' a p≈ôihla≈°te se<br>" +
                     "2. Pokud jste zapomnƒõli heslo, kliknƒõte na 'Zapomnƒõli jste heslo?'";
        } else if (error.code === 'auth/invalid-email') {
          errorMsg = "Neplatn√Ω form√°t e-mailu.";
        } else if (error.code === 'auth/weak-password') {
          errorMsg = "Heslo je p≈ô√≠li≈° slab√©. Pou≈æijte alespo≈à 6 znak≈Ø.";
        } else if (error.code === 'auth/operation-not-allowed') {
          errorMsg = "‚ö†Ô∏è Registrace emailem/heslem nen√≠ povolena.<br>" +
                     "Kontaktujte administr√°tora.";
        }
        showMessage(errorMsg, "error");
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    });

    // =========================
    // 6) P≈ôihl√°≈°en√≠ (kontrola ovƒõ≈ôen√≠ e-mailu)
    // =========================
    loginFormEl.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearMessage();
      if (btnResend) btnResend.classList.add("hidden");

      // Validace
      if (!loginValidator.validate()) {
        return;
      }

      const email = document.getElementById("login-email").value.trim();
      const password = document.getElementById("login-password").value;

      const btn = loginFormEl.querySelector('button[type="submit"]');
      const originalText = btn.textContent;
      btn.textContent = 'P≈ôihla≈°uji...';
      btn.disabled = true;

      try {
        const cred = await auth.signInWithEmailAndPassword(email, password);
        const user = cred.user;

        // Upozornƒõn√≠ na neovƒõ≈ôen√Ω email, ale NEP≈òERU≈†UJEME p≈ôihl√°≈°en√≠
        if (!user.emailVerified) {
          showMessage("‚ö†Ô∏è P≈ôihl√°≈°en√≠ √∫spƒõ≈°n√©, ale e-mail je≈°tƒõ nen√≠ ovƒõ≈ôen√Ω. Pro plnou funkƒçnost pros√≠m ovƒõ≈ôte e-mail.", "info");
          if (btnResend) btnResend.classList.remove("hidden");
          // Pokraƒçujeme d√°l - nep≈ôeru≈°ujeme p≈ôihl√°≈°en√≠!
        }

        await saveUserProfile(user);
        if (user.emailVerified) {
          showMessage("P≈ôihl√°≈°en√≠ probƒõhlo √∫spƒõ≈°nƒõ. P≈ôesmƒõrov√°v√°m...", "success");
        }

        // Auth observer se postar√° o p≈ôesmƒõrov√°n√≠ automaticky
        // Nemus√≠me zde nic dƒõlat - onAuthStateChanged to za≈ô√≠d√≠

      } catch (error) {
        console.error(error);
        let errorMsg = "P≈ôi p≈ôihl√°≈°en√≠ do≈°lo k chybƒõ.";
        if (error.code === 'auth/user-not-found') {
          errorMsg = "U≈æivatel s t√≠mto e-mailem neexistuje.";
        } else if (error.code === 'auth/wrong-password') {
          errorMsg = "Nespr√°vn√© heslo.";
        } else if (error.code === 'auth/invalid-email') {
          errorMsg = "Neplatn√Ω form√°t e-mailu.";
        } else if (error.code === 'auth/user-disabled') {
          errorMsg = "Tento √∫ƒçet byl deaktivov√°n.";
        }
        showMessage(errorMsg, "error");
        btn.textContent = originalText;
        btn.disabled = false;
      }
    });

    // =========================
    // 7) P≈ôihl√°≈°en√≠ p≈ôes Google
    // =========================
    if (btnGoogle) {
      btnGoogle.addEventListener("click", async () => {
        // Prevence duplicitn√≠ch pokus≈Ø
        if (isOAuthInProgress) {
          console.warn('‚ö†Ô∏è OAuth ji≈æ prob√≠h√°, ignoruji duplicitn√≠ kliknut√≠');
          return;
        }
        
        isOAuthInProgress = true;
        clearMessage();
        btnGoogle.disabled = true;
        const originalText = btnGoogle.textContent;
        btnGoogle.textContent = 'P≈ôihla≈°uji p≈ôes Google...';
        
        try {
          // Kontrola zda je Google provider spr√°vnƒõ nakonfigurov√°n
          if (!googleProvider) {
            throw new Error('Google provider nen√≠ inicializovan√Ω');
          }
          
          console.log('üîê Pokus o Google OAuth...');
          
          // Pokus o popup - pokud sel≈æe, zkus√≠me redirect
          let result;
          try {
            result = await auth.signInWithPopup(googleProvider);
          } catch (popupError) {
            console.warn('‚ö†Ô∏è Popup selhalo, zkou≈°√≠m redirect:', popupError);
            
            // Pokud popup nefunguje (CSP, blokace), pou≈æijeme redirect
            if (popupError.code === 'auth/popup-blocked' || 
                popupError.code === 'auth/internal-error') {
              showMessage("Popup bylo zablokov√°no. P≈ôesmƒõrov√°v√°m na Google...", "info");
              await auth.signInWithRedirect(googleProvider);
              return; // Redirect zp≈Øsob√≠ reload str√°nky
            }
            throw popupError;
          }
          
          const user = result.user;
          if (user) {
            console.log('‚úÖ Google OAuth √∫spƒõ≈°n√©:', user.email);
            await saveUserProfile(user);
            showMessage("P≈ôihl√°≈°en√≠ p≈ôes Google probƒõhlo √∫spƒõ≈°nƒõ. P≈ôesmƒõrov√°v√°m...", "success");
            
            setTimeout(async () => {
              try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                const userData = userDoc.exists ? userDoc.data() : null;
                const role = userData?.role;
                
                if (role === 'creator') {
                  window.location.href = "creator-dashboard.html";
                } else if (role === 'company') {
                  window.location.href = "firm-dashboard.html";
                } else {
                  window.location.href = "kartao-vyber-uctu.html";
                }
              } catch (err) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ role:', err);
                window.location.href = "kartao-vyber-uctu.html";
              }
            }, 1500);
          }
        } catch (error) {
          console.error('Google OAuth error:', error);
          console.error('Error code:', error.code);
          console.error('Error message:', error.message);
          
          // Tich√° ignorace zru≈°en√©ho popupu (u≈æivatel klikl v√≠cekr√°t)
          if (error.code === 'auth/cancelled-popup-request') {
            console.warn('‚ö†Ô∏è Popup zru≈°en kv≈Øli duplicitn√≠mu pokusu');
            btnGoogle.textContent = originalText;
            btnGoogle.disabled = false;
            isOAuthInProgress = false;
            return;
          }
          
          let errorMsg = "P≈ôihl√°≈°en√≠ p≈ôes Google se nepoda≈ôilo.";
          
          if (error.code === 'auth/popup-closed-by-user') {
            errorMsg = "P≈ôihl√°≈°en√≠ bylo zru≈°eno.";
          } else if (error.code === 'auth/popup-blocked') {
            errorMsg = "Popup okno bylo blokov√°no prohl√≠≈æeƒçem. Povolte pros√≠m popup okna nebo zkuste znovu.";
          } else if (error.code === 'auth/unauthorized-domain') {
            errorMsg = "‚ö†Ô∏è Tato dom√©na nen√≠ autorizovan√° pro Google p≈ôihl√°≈°en√≠.<br><br>" +
                       "P≈ôidejte do Firebase Console:<br>" +
                       "Authentication ‚Üí Settings ‚Üí Authorized domains ‚Üí " +
                       "p≈ôidejte: <code>" + window.location.hostname + "</code>";
          } else if (error.code === 'auth/operation-not-allowed') {
            errorMsg = "‚ö†Ô∏è Google p≈ôihl√°≈°en√≠ nen√≠ povoleno!<br><br>" +
                       "Povolte ve Firebase Console:<br>" +
                       "Authentication ‚Üí Sign-in method ‚Üí Google ‚Üí Enable";
          } else if (error.code === 'auth/account-exists-with-different-credential') {
            errorMsg = "√öƒçet s t√≠mto emailem ji≈æ existuje s jin√Ωm p≈ôihla≈°ovac√≠m poskytovatelem.";
          } else if (error.code === 'auth/internal-error') {
            errorMsg = "‚ö†Ô∏è Intern√≠ chyba Firebase.<br><br>" +
                       "<strong>Mo≈æn√© p≈ô√≠ƒçiny:</strong><br>" +
                       "1. Google OAuth nen√≠ povolen ve Firebase Console<br>" +
                       "2. Dom√©na nen√≠ v Authorized domains<br>" +
                       "3. CSP politika blokuje OAuth<br>" +
                       "4. Nespr√°vn√° Firebase konfigurace<br><br>" +
                       "<strong>≈òe≈°en√≠:</strong><br>" +
                       "‚Ä¢ Zkontrolujte konzoli prohl√≠≈æeƒçe (F12)<br>" +
                       "‚Ä¢ Viz FIREBASE-SETUP.md ‚Üí Google Sign-In";
          } else {
            errorMsg = `P≈ôihl√°≈°en√≠ p≈ôes Google se nepoda≈ôilo: ${error.message || error.code || 'Nezn√°m√° chyba'}`;
          }
          showMessage(errorMsg, "error");
        } finally {
          btnGoogle.textContent = originalText;
          btnGoogle.disabled = false;
          isOAuthInProgress = false;
        }
      });
    }

    // =========================
    // 8) P≈ôihl√°≈°en√≠ p≈ôes Facebook
    // =========================
    if (btnFacebook) {
      btnFacebook.addEventListener("click", async () => {
        // Prevence duplicitn√≠ch pokus≈Ø
        if (isOAuthInProgress) {
          console.warn('‚ö†Ô∏è OAuth ji≈æ prob√≠h√°, ignoruji duplicitn√≠ kliknut√≠');
          return;
        }
        
        isOAuthInProgress = true;
        clearMessage();
        btnFacebook.disabled = true;
        const originalText = btnFacebook.textContent;
        btnFacebook.textContent = 'P≈ôihla≈°uji p≈ôes Facebook...';
        
        try {
          // Kontrola zda je Facebook provider spr√°vnƒõ nakonfigurov√°n
          if (!facebookProvider) {
            throw new Error('Facebook provider nen√≠ inicializovan√Ω');
          }
          
          console.log('üîê Pokus o Facebook OAuth...');
          
          // Pokus o popup - pokud sel≈æe, zkus√≠me redirect
          let result;
          try {
            result = await auth.signInWithPopup(facebookProvider);
          } catch (popupError) {
            console.warn('‚ö†Ô∏è Popup selhalo, zkou≈°√≠m redirect:', popupError);
            
            // Pokud popup nefunguje (CSP, blokace), pou≈æijeme redirect
            if (popupError.code === 'auth/popup-blocked' || 
                popupError.code === 'auth/internal-error') {
              showMessage("Popup bylo zablokov√°no. P≈ôesmƒõrov√°v√°m na Facebook...", "info");
              await auth.signInWithRedirect(facebookProvider);
              return; // Redirect zp≈Øsob√≠ reload str√°nky
            }
            throw popupError;
          }
          
          const user = result.user;
          if (user) {
            console.log('‚úÖ Facebook OAuth √∫spƒõ≈°n√©:', user.email);
            await saveUserProfile(user);
            showMessage("P≈ôihl√°≈°en√≠ p≈ôes Facebook probƒõhlo √∫spƒõ≈°nƒõ. P≈ôesmƒõrov√°v√°m...", "success");
            
            setTimeout(async () => {
              try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                const userData = userDoc.exists ? userDoc.data() : null;
                const role = userData?.role;
                
                if (role === 'creator') {
                  window.location.href = "creator-dashboard.html";
                } else if (role === 'company') {
                  window.location.href = "firm-dashboard.html";
                } else {
                  window.location.href = "kartao-vyber-uctu.html";
                }
              } catch (err) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ role:', err);
                window.location.href = "kartao-vyber-uctu.html";
              }
            }, 1500);
          }
        } catch (error) {
          console.error('Facebook OAuth error:', error);
          console.error('Error code:', error.code);
          console.error('Error message:', error.message);
          
          // Tich√° ignorace zru≈°en√©ho popupu (u≈æivatel klikl v√≠cekr√°t)
          if (error.code === 'auth/cancelled-popup-request') {
            console.warn('‚ö†Ô∏è Popup zru≈°en kv≈Øli duplicitn√≠mu pokusu');
            btnFacebook.textContent = originalText;
            btnFacebook.disabled = false;
            isOAuthInProgress = false;
            return;
          }
          
          let errorMsg = "P≈ôihl√°≈°en√≠ p≈ôes Facebook se nepoda≈ôilo.";
          
          if (error.code === 'auth/popup-closed-by-user') {
            errorMsg = "P≈ôihl√°≈°en√≠ bylo zru≈°eno.";
          } else if (error.code === 'auth/popup-blocked') {
            errorMsg = "Popup okno bylo blokov√°no prohl√≠≈æeƒçem. Povolte pros√≠m popup okna nebo zkuste znovu.";
          } else if (error.code === 'auth/unauthorized-domain') {
            errorMsg = "‚ö†Ô∏è Tato dom√©na nen√≠ autorizovan√° pro Facebook p≈ôihl√°≈°en√≠.<br><br>" +
                       "P≈ôidejte do Firebase Console:<br>" +
                       "Authentication ‚Üí Settings ‚Üí Authorized domains ‚Üí " +
                       "p≈ôidejte: <code>" + window.location.hostname + "</code>";
          } else if (error.code === 'auth/operation-not-allowed') {
            errorMsg = "‚ö†Ô∏è Facebook p≈ôihl√°≈°en√≠ nen√≠ povoleno!<br><br>" +
                       "Povolte ve Firebase Console:<br>" +
                       "Authentication ‚Üí Sign-in method ‚Üí Facebook ‚Üí Enable";
          } else if (error.code === 'auth/account-exists-with-different-credential') {
            errorMsg = "√öƒçet s t√≠mto emailem ji≈æ existuje s jin√Ωm p≈ôihla≈°ovac√≠m poskytovatelem.";
          } else if (error.code === 'auth/internal-error') {
            errorMsg = "‚ö†Ô∏è Intern√≠ chyba Firebase.<br><br>" +
                       "<strong>Mo≈æn√© p≈ô√≠ƒçiny:</strong><br>" +
                       "1. Facebook OAuth nen√≠ povolen ve Firebase Console<br>" +
                       "2. Facebook App ID/Secret nen√≠ nastaveno<br>" +
                       "3. Dom√©na nen√≠ v Authorized domains<br>" +
                       "4. CSP politika blokuje OAuth<br>" +
                       "5. Facebook App nen√≠ v re≈æimu Live<br><br>" +
                       "<strong>≈òe≈°en√≠:</strong><br>" +
                       "‚Ä¢ Zkontrolujte konzoli prohl√≠≈æeƒçe (F12)<br>" +
                       "‚Ä¢ Viz FIREBASE-SETUP.md ‚Üí Facebook Sign-In";
          } else if (error.message && error.message.includes('App ID')) {
            errorMsg = "‚ö†Ô∏è Facebook App ID nen√≠ spr√°vnƒõ nakonfigurovan√©!<br><br>" +
                       "Zkontrolujte Firebase Console:<br>" +
                       "Authentication ‚Üí Sign-in method ‚Üí Facebook<br>" +
                       "Viz FIREBASE-SETUP.md pro kompletn√≠ n√°vod";
          } else {
            errorMsg = `P≈ôihl√°≈°en√≠ p≈ôes Facebook se nepoda≈ôilo: ${error.message || error.code || 'Nezn√°m√° chyba'}`;
          }
          showMessage(errorMsg, "error");
        } finally {
          btnFacebook.textContent = originalText;
          btnFacebook.disabled = false;
          isOAuthInProgress = false;
        }
      });
    }

    // =========================
    // 9) Znovu poslat ovƒõ≈ôovac√≠ e-mail
    // =========================
    if (btnResend) {
      btnResend.addEventListener("click", async () => {
        clearMessage();
        const user = auth.currentUser;
        if (!user) {
          showMessage("Nejste p≈ôihl√°≈°en√Ω. Zkuste se znovu p≈ôihl√°sit.", "error");
          return;
        }

        btnResend.disabled = true;
        const originalText = btnResend.textContent;
        btnResend.textContent = 'Odes√≠l√°m...';

        try {
          console.log('üìß Opƒõtovn√© odesl√°n√≠ ovƒõ≈ôovac√≠ho emailu na:', user.email);
          
          // Konfigurace Action URL pro ovƒõ≈ôovac√≠ email
          const actionCodeSettings = {
            url: window.location.origin + '/email-verified.html',
            handleCodeInApp: true
          };
          
          await user.sendEmailVerification(actionCodeSettings);
          console.log('‚úÖ Email odesl√°n √∫spƒõ≈°nƒõ');
          console.log('üîó Verification URL:', actionCodeSettings.url);
          
          showMessage(
            `‚úÖ Ovƒõ≈ôovac√≠ e-mail byl znovu odesl√°n na ${user.email}. ` +
            `Zkontrolujte schr√°nku vƒçetnƒõ SPAM slo≈æky. ` +
            `Email p≈ôich√°z√≠ z noreply@kartao-cz.firebaseapp.com`,
            "success"
          );
        } catch (error) {
          console.error('‚ùå Chyba p≈ôi odes√≠l√°n√≠ emailu:', error);
          
          let errorMsg = "Ovƒõ≈ôovac√≠ e-mail se nepoda≈ôilo odeslat.";
          if (error.code === 'auth/too-many-requests') {
            errorMsg = "P≈ô√≠li≈° mnoho pokus≈Ø. Poƒçkejte chv√≠li a zkuste to znovu.";
          } else if (error.code === 'auth/user-disabled') {
            errorMsg = "Tento √∫ƒçet byl deaktivov√°n.";
          } else {
            errorMsg = `Chyba: ${error.message}`;
          }
          showMessage(errorMsg, "error");
        } finally {
          btnResend.textContent = originalText;
          btnResend.disabled = false;
        }
      });
    }
  </script>

  <script>
    // Inicializace Lucide ikon
    lucide.createIcons();
  </script>
</main>
</body>
</html>
