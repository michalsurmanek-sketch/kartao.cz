<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>P≈ôihl√°≈°en√≠ - Kartao.cz</title>
  
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="firebase-init.js"></script>
  
  <style>
    body {
      background: linear-gradient(135deg, #1e1b4b 0%, #0f172a 100%);
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

<div class="w-full max-w-md bg-white/10 backdrop-blur-lg rounded-2xl p-8 shadow-2xl">
  
  <!-- Logo -->
  <div class="text-center mb-8">
    <h1 class="text-3xl font-bold text-white mb-2">Kartao.cz</h1>
    <p class="text-white/60">P≈ôihl√°≈°en√≠</p>
  </div>

  <!-- Zpr√°vy -->
  <div id="msg" class="hidden mb-4 p-3 rounded-lg text-sm"></div>

  <!-- P≈ôep√≠naƒç -->
  <div class="flex gap-2 mb-6 bg-white/5 rounded-lg p-1">
    <button id="tab-login" class="flex-1 py-2 rounded-md font-medium bg-white/20 text-white">
      P≈ôihl√°≈°en√≠
    </button>
    <button id="tab-register" class="flex-1 py-2 rounded-md font-medium text-white/60 hover:text-white">
      Registrace
    </button>
  </div>

  <!-- LOGIN FORM -->
  <form id="form-login" class="space-y-4">
    <div>
      <input id="login-email" type="email" placeholder="E-mail" required
             class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/40 focus:outline-none focus:border-fuchsia-500">
    </div>
    <div>
      <input id="login-password" type="password" placeholder="Heslo" required
             class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/40 focus:outline-none focus:border-fuchsia-500">
    </div>
    <button type="submit" class="w-full py-3 bg-gradient-to-r from-fuchsia-600 to-purple-600 text-white font-semibold rounded-lg hover:brightness-110">
      P≈ôihl√°sit se
    </button>
  </form>

  <!-- REGISTER FORM -->
  <form id="form-register" class="space-y-4 hidden">
    <div>
      <input id="reg-email" type="email" placeholder="E-mail" required
             class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/40 focus:outline-none focus:border-fuchsia-500">
    </div>
    <div>
      <input id="reg-password" type="password" placeholder="Heslo (min. 6 znak≈Ø)" required minlength="6"
             class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/40 focus:outline-none focus:border-fuchsia-500">
    </div>
    <div>
      <input id="reg-password2" type="password" placeholder="Heslo znovu" required minlength="6"
             class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/40 focus:outline-none focus:border-fuchsia-500">
    </div>
    <button type="submit" class="w-full py-3 bg-gradient-to-r from-fuchsia-600 to-purple-600 text-white font-semibold rounded-lg hover:brightness-110">
      Vytvo≈ôit √∫ƒçet
    </button>
  </form>

  <!-- OAuth -->
  <div class="mt-6">
    <div class="text-center text-white/40 text-sm mb-4">nebo</div>
    <button id="btn-google" class="w-full py-3 bg-white/10 border border-white/20 text-white rounded-lg hover:bg-white/20 flex items-center justify-center gap-2">
      <span>G</span>
      <span>Google</span>
    </button>
  </div>

  <div class="mt-6 text-center">
    <a href="index.html" class="text-white/60 text-sm hover:text-white">‚Üê Zpƒõt na hlavn√≠ str√°nku</a>
  </div>
</div>

<script>
console.log('üöÄ LOGIN.HTML SCRIPT STARTED');
console.log('‚úÖ Firebase:', typeof firebase);
console.log('‚úÖ Auth:', typeof auth);
console.log('‚úÖ DB:', typeof db);

// Google provider
const googleProvider = new firebase.auth.GoogleAuthProvider();

// Elements
const msg = document.getElementById('msg');
const tabLogin = document.getElementById('tab-login');
const tabRegister = document.getElementById('tab-register');
const formLogin = document.getElementById('form-login');
const formRegister = document.getElementById('form-register');
const btnGoogle = document.getElementById('btn-google');

let mode = 'login';
let busy = false;

// Helpers
function showMsg(text, type) {
  msg.className = 'mb-4 p-3 rounded-lg text-sm ';
  if (type === 'error') msg.className += 'bg-red-500/20 text-red-200 border border-red-500/50';
  else if (type === 'success') msg.className += 'bg-green-500/20 text-green-200 border border-green-500/50';
  else msg.className += 'bg-yellow-500/20 text-yellow-200 border border-yellow-500/50';
  msg.textContent = text;
  msg.classList.remove('hidden');
}

function hideMsg() {
  msg.classList.add('hidden');
}

function switchMode(m) {
  mode = m;
  hideMsg();
  
  if (m === 'login') {
    tabLogin.className = 'flex-1 py-2 rounded-md font-medium bg-white/20 text-white';
    tabRegister.className = 'flex-1 py-2 rounded-md font-medium text-white/60 hover:text-white';
    formLogin.classList.remove('hidden');
    formRegister.classList.add('hidden');
  } else {
    tabRegister.className = 'flex-1 py-2 rounded-md font-medium bg-white/20 text-white';
    tabLogin.className = 'flex-1 py-2 rounded-md font-medium text-white/60 hover:text-white';
    formRegister.classList.remove('hidden');
    formLogin.classList.add('hidden');
  }
}

async function saveProfile(user) {
  if (!user) return;
  console.log('üíæ SaveProfile called for:', user.email);
  console.log('üíæ DB available?', typeof db, db);
  try {
    const docRef = db.collection('users').doc(user.uid);
    const doc = await docRef.get();
    
    const profileData = {
      email: user.email,
      displayName: user.displayName || '',
      photoURL: user.photoURL || '',
      provider: user.providerData?.[0]?.providerId || 'password',
      updatedAt: new Date().toISOString()
    };
    
    if (!doc.exists) {
      // Nov√Ω u≈æivatel - CREATE
      console.log('üíæ Creating new user profile');
      await docRef.set(profileData);
    } else {
      // Existuj√≠c√≠ - UPDATE (bez role)
      console.log('üíæ Updating existing user profile');
      await docRef.update(profileData);
    }
    
    console.log('üíæ Profile saved to Firestore');
  } catch (e) {
    console.error('‚ùå Profile save error:', e);
    throw e; // Re-throw aby se chyba propagovala
  }
}

async function redirect(user) {
  console.log('üîÑ Redirect called for user:', user.email);
  
  // Kdy≈æ Firestore nefunguje, jdeme rovnou na v√Ωbƒõr role
  console.log('‚Üí Redirecting to role selection (Firestore offline)');
  window.location.href = 'kartao-vyber-uctu.html';
}

// Tabs
tabLogin.onclick = () => switchMode('login');
tabRegister.onclick = () => switchMode('register');

// Login
formLogin.onsubmit = async (e) => {
  e.preventDefault();
  console.log('üîµ Login submit triggered');
  
  if (busy) {
    console.log('‚ö†Ô∏è Already busy, ignoring');
    return;
  }
  busy = true;
  hideMsg();
  
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  const btn = formLogin.querySelector('button');
  
  console.log('üìß Attempting login for:', email);
  
  btn.disabled = true;
  btn.textContent = 'P≈ôihla≈°uji...';
  
  try {
    console.log('üîê Calling signInWithEmailAndPassword...');
    const cred = await auth.signInWithEmailAndPassword(email, password);
    console.log('‚úÖ Login successful:', cred.user.email);
    
    // P≈ôeskoƒç√≠me saveProfile - jdeme rovnou na redirect
    showMsg('P≈ôihl√°≈°en√≠ √∫spƒõ≈°n√©!', 'success');
    
    console.log('‚è≥ Redirecting immediately...');
    redirect(cred.user);
  } catch (error) {
    console.error('‚ùå Login error:', error);
    let msg = 'Chyba p≈ôi p≈ôihl√°≈°en√≠';
    if (error.code === 'auth/user-not-found') msg = 'U≈æivatel nenalezen';
    else if (error.code === 'auth/wrong-password') msg = '≈†patn√© heslo';
    else if (error.code === 'auth/invalid-email') msg = 'Neplatn√Ω e-mail';
    showMsg(msg, 'error');
    btn.disabled = false;
    btn.textContent = 'P≈ôihl√°sit se';
    busy = false;
  }
};

// Register
formRegister.onsubmit = async (e) => {
  e.preventDefault();
  if (busy) return;
  busy = true;
  hideMsg();
  
  const email = document.getElementById('reg-email').value.trim();
  const password = document.getElementById('reg-password').value;
  const password2 = document.getElementById('reg-password2').value;
  const btn = formRegister.querySelector('button');
  
  if (password !== password2) {
    showMsg('Hesla se neshoduj√≠', 'error');
    busy = false;
    return;
  }
  
  if (password.length < 6) {
    showMsg('Heslo mus√≠ m√≠t alespo≈à 6 znak≈Ø', 'error');
    busy = false;
    return;
  }
  
  btn.disabled = true;
  btn.textContent = 'Vytv√°≈ô√≠m...';
  
  try {
    if (auth.currentUser) await auth.signOut();
    
    const cred = await auth.createUserWithEmailAndPassword(email, password);
    await saveProfile(cred.user);
    showMsg('√öƒçet vytvo≈ôen!', 'success');
    
    // Poƒçkej a pak p≈ôesmƒõruj
    setTimeout(() => {
      redirect(cred.user);
    }, 500);
    
  } catch (error) {
    console.error('‚ùå Registrace error:', error);
    let msg = 'Chyba p≈ôi registraci';
    if (error.code === 'auth/email-already-in-use') msg = 'E-mail ji≈æ existuje';
    else if (error.code === 'auth/invalid-email') msg = 'Neplatn√Ω e-mail';
    else if (error.code === 'auth/weak-password') msg = 'Slab√© heslo';
    showMsg(msg, 'error');
    btn.disabled = false;
    btn.textContent = 'Vytvo≈ôit √∫ƒçet';
    busy = false;
  }
};

// Google
btnGoogle.onclick = async () => {
  if (busy) return;
  busy = true;
  hideMsg();
  
  btnGoogle.disabled = true;
  const txt = btnGoogle.innerHTML;
  btnGoogle.textContent = 'P≈ôihla≈°uji...';
  
  try {
    const result = await auth.signInWithPopup(googleProvider);
    await saveProfile(result.user);
    showMsg('P≈ôihl√°≈°en√≠ √∫spƒõ≈°n√©!', 'success');
    setTimeout(() => redirect(result.user), 500);
  } catch (error) {
    if (error.code !== 'auth/popup-closed-by-user' && error.code !== 'auth/cancelled-popup-request') {
      showMsg('Chyba Google p≈ôihl√°≈°en√≠', 'error');
    }
    btnGoogle.innerHTML = txt;
    btnGoogle.disabled = false;
    busy = false;
  }
};

// Redirect result
auth.getRedirectResult().then(async (result) => {
  if (result.user) {
    await saveProfile(result.user);
    await redirect(result.user);
  }
}).catch(console.error);
</script>

</body>
</html>
