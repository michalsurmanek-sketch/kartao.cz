<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kartao.cz ‚Äì M≈Øj √∫ƒçet</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üë§</text></svg>">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            fuchsia: tailwind.colors.fuchsia,
            amber: tailwind.colors.amber,
            neutral: tailwind.colors.neutral,
          },
        },
      },
    };
  </script>

  <!-- Firebase + spoleƒçn√° inicializace -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <!-- tady m√°≈° sv≈Øj projektov√Ω init se stejn√Ωm configem jako jinde -->
  <script src="firebase-init.js"></script>

  <style>
    body {
      min-height: 100vh;
      background:
        radial-gradient(circle at top left, #db58f6 0, transparent 55%),
        radial-gradient(circle at bottom right, #fbbf24 0, #020617 55%);
    }
    .shadow-soft {
      box-shadow: 0 18px 45px rgba(15,23,42,0.85);
    }
  </style>
</head>
<body class="text-white">
  <!-- HLAVIƒåKA -->
  <header class="border-b border-white/10 bg-neutral-950/80 backdrop-blur sticky top-0 z-20">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="index.html" class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-2xl bg-gradient-to-tr from-fuchsia-500 to-amber-400 grid place-items-center shadow-soft">
          <span class="font-bold text-lg">K</span>
        </div>
        <div>
          <div class="font-extrabold tracking-tight">Kartao.cz</div>
          <div class="text-xs text-white/60 -mt-0.5">S√≠≈• influencer≈Ø a tv≈Ørc≈Ø</div>
        </div>
      </a>

      <button id="logoutBtn" class="px-3 py-1.5 rounded-xl text-sm border border-white/20 hover:bg-white/10">
        Odhl√°sit se
      </button>
    </div>
  </header>

  <!-- OBSAH -->
  <main class="max-w-6xl mx-auto px-4 py-8 md:py-12">
    <!-- Zpƒõt na dashboard -->
    <div class="mb-4">
      <a id="backLink" href="moje-karta.html" class="inline-flex items-center gap-2 text-sm text-white/70 hover:text-white">
        <span class="text-lg">‚Üê</span>
        <span>Zpƒõt na dashboard</span>
      </a>
    </div>

    <div class="grid md:grid-cols-[minmax(0,220px)_minmax(0,1fr)] gap-6 items-start">
      <!-- LEV√ù PROFIL BOX -->
      <section class="rounded-2xl bg-neutral-900/80 border border-white/10 p-6 shadow-soft">
        <div class="flex items-center gap-4 mb-4">
          <div class="w-14 h-14 rounded-2xl bg-gradient-to-tr from-fuchsia-500 to-amber-400 grid place-items-center text-2xl font-bold text-neutral-950" id="avatarInitial">
            U
          </div>
          <div>
            <div id="displayName" class="font-semibold text-lg leading-tight">
              U≈æivatel Kartao
            </div>
            <div id="emailLabel" class="text-xs text-white/60 break-all">
              ‚Äî
            </div>
          </div>
        </div>

        <div id="roleBadge" class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/10 text-xs text-white/80 mb-3">
          <span>‚≠ê</span>
          <span>Influencer √∫ƒçet</span>
        </div>

        <div class="space-y-1">
          <div id="roleLabel" class="text-sm font-semibold">
            Influencer √∫ƒçet
          </div>
          <p id="roleDescription" class="text-xs text-white/60">
            Tento √∫ƒçet je veden√Ω jako influencer / tv≈Ørce obsahu.
          </p>
        </div>

        <div class="mt-5 space-y-2 text-xs text-white/60">
          <div class="inline-flex items-center gap-1">
            <span class="w-2 h-2 rounded-full bg-emerald-400"></span>
            <span>Bezpeƒçn√© p≈ôihl√°≈°en√≠ p≈ôes Firebase.</span>
          </div>
          <div class="inline-flex items-center gap-1">
            <span class="w-2 h-2 rounded-full bg-amber-400"></span>
            <span>Jeden √∫ƒçet pro v≈°echny dashboardy.</span>
          </div>
        </div>
      </section>

      <!-- PRAV√ù FORMUL√Å≈ò -->
      <section class="rounded-2xl bg-neutral-900/80 border border-white/10 p-6 md:p-8 shadow-soft">
        <header class="mb-4">
          <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight mb-1">
            M≈Øj √∫ƒçet
          </h1>
          <p class="text-sm text-white/60">
            Upravit z√°kladn√≠ √∫daje a kontakty. Zat√≠m se ukl√°d√° jen do tohoto za≈ô√≠zen√≠ (localStorage).
          </p>
        </header>

        <!-- Stav / zpr√°va -->
        <div id="messageBox" class="hidden mb-4 rounded-xl border px-3 py-2 text-sm"></div>

        <!-- Loader text -->
        <div id="loader" class="mb-4 text-sm text-white/60">
          Naƒç√≠t√°m √∫daje o √∫ƒçtu‚Ä¶
        </div>

        <!-- Role chip (druh√° instance) -->
        <div id="roleChip" class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/5 text-xs text-white/70 mb-4">
          <span>‚≠ê</span>
          <span>Influencer √∫ƒçet</span>
        </div>

        <!-- FORMUL√Å≈ò √öƒåTU -->
        <form id="accountForm" class="space-y-5">
          <!-- E-mail -->
          <div class="space-y-1.5">
            <label for="email" class="text-xs uppercase tracking-wide text-white/40">E-mail (p≈ôihla≈°ovac√≠)</label>
            <input
              id="email"
              type="email"
              class="w-full rounded-xl bg-neutral-900 border border-white/15 px-3 py-2 text-sm outline-none focus:border-amber-400"
              readonly
            />
          </div>

          <!-- Jm√©no + p≈ôezd√≠vka -->
          <div class="grid md:grid-cols-2 gap-4">
            <div class="space-y-1.5">
              <label for="name" class="text-xs uppercase tracking-wide text-white/40">Jm√©no / n√°zev</label>
              <input
                id="name"
                type="text"
                placeholder="Tvoje jm√©no nebo n√°zev firmy"
                class="w-full rounded-xl bg-neutral-900 border border-white/15 px-3 py-2 text-sm outline-none focus:border-amber-400"
              />
            </div>
            <div class="space-y-1.5">
              <label for="nickname" class="text-xs uppercase tracking-wide text-white/40">P≈ôezd√≠vka / znaƒçka</label>
              <input
                id="nickname"
                type="text"
                placeholder="Nap≈ô. @kartao_influencer"
                class="w-full rounded-xl bg-neutral-900 border border-white/15 px-3 py-2 text-sm outline-none focus:border-amber-400"
              />
            </div>
          </div>

          <!-- Telefon -->
          <div class="space-y-1.5">
            <label for="phone" class="text-xs uppercase tracking-wide text-white/40">Telefon (nepovinn√©)</label>
            <input
              id="phone"
              type="tel"
              placeholder="+420 ..."
              class="w-full rounded-xl bg-neutral-900 border border-white/15 px-3 py-2 text-sm outline-none focus:border-amber-400"
            />
          </div>

          <!-- Zabezpeƒçen√≠ -->
          <div class="border-t border-white/10 pt-4 mt-2">
            <div class="flex flex-wrap items-center justify-between gap-3">
              <div>
                <div class="text-xs uppercase tracking-wide text-white/40 mb-1">Zabezpeƒçen√≠</div>
                <p class="text-xs text-white/60">
                  Heslo neum√≠me zobrazit, ale m≈Ø≈æeme ti poslat odkaz na zmƒõnu.
                </p>
              </div>
              <button
                type="button"
                id="resetPasswordBtn"
                class="px-3 py-1.5 rounded-xl border border-white/20 text-xs hover:bg-white/10"
              >
                Poslat odkaz na reset hesla
              </button>
            </div>
          </div>

          <!-- Tlaƒç√≠tko ulo≈æit -->
          <div class="pt-2">
            <button
              type="submit"
              class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl bg-gradient-to-r from-amber-400 via-amber-300 to-yellow-300 text-sm font-semibold text-neutral-950 shadow-soft hover:brightness-110"
            >
              Ulo≈æit zmƒõny
            </button>
          </div>
        </form>
      </section>
    </div>
  </main>

  <!-- Patiƒçka -->
  <footer class="border-t border-white/10 bg-neutral-950/80 mt-8">
    <div class="max-w-6xl mx-auto px-4 py-3 text-xs text-white/50 flex items-center justify-between">
      <span>¬© <span id="year"></span> Kartao.cz</span>
      <span>Beta verze ‚Äì √∫daje √∫ƒçtu se zat√≠m ukl√°daj√≠ jen lok√°lnƒõ.</span>
    </div>
  </footer>

  <!-- LOGIKA √öƒåTU (Auth + localStorage, bez Firestore) -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const auth = window.auth || firebase.auth();

      // DOM prvky
      const loader = document.getElementById("loader");
      const messageBox = document.getElementById("messageBox");
      const accountForm = document.getElementById("accountForm");
      const backLink = document.getElementById("backLink");

      const emailInput = document.getElementById("email");
      const nameInput = document.getElementById("name");
      const nicknameInput = document.getElementById("nickname");
      const phoneInput = document.getElementById("phone");

      const displayNameEl = document.getElementById("displayName");
      const avatarInitialEl = document.getElementById("avatarInitial");
      const emailLabelEl = document.getElementById("emailLabel");
      const roleLabelEl = document.getElementById("roleLabel");
      const roleBadgeEl = document.getElementById("roleBadge");
      const roleDescriptionEl = document.getElementById("roleDescription");
      const roleChipEl = document.getElementById("roleChip");

      const resetPasswordBtn = document.getElementById("resetPasswordBtn");
      const logoutBtn = document.getElementById("logoutBtn");

      const yearEl = document.getElementById("year");
      if (yearEl) yearEl.textContent = new Date().getFullYear();

      function setLoading(isLoading) {
        if (!loader || !accountForm) return;
        loader.classList.toggle("hidden", !isLoading);
        accountForm.classList.toggle("opacity-50", isLoading);
      }

      function showMessage(text, type = "success") {
        if (!messageBox) return;
        messageBox.textContent = text;
        messageBox.classList.remove("hidden", "border-rose-500/50", "bg-rose-500/10", "border-emerald-500/50", "bg-emerald-500/10");
        if (type === "success") {
          messageBox.classList.add("border-emerald-500/50", "bg-emerald-500/10");
        } else {
          messageBox.classList.add("border-rose-500/50", "bg-rose-500/10");
        }
      }

      function hideMessage() {
        if (!messageBox) return;
        messageBox.classList.add("hidden");
        messageBox.textContent = "";
      }

      function applyRoleUI(role) {
        let label = "Influencer √∫ƒçet";
        let desc = "Tento √∫ƒçet je veden√Ω jako influencer / tv≈Ørce obsahu.";
        let chipIcon = "‚≠ê";
        let backHref = "moje-karta.html";

        if (role === "firma") {
          label = "Firemn√≠ √∫ƒçet";
          desc = "Tento √∫ƒçet je veden√Ω jako firma / znaƒçka / agentura.";
          chipIcon = "üè¢";
          backHref = "moje-firma.html";
        }

        if (roleLabelEl) roleLabelEl.textContent = label;
        if (roleDescriptionEl) roleDescriptionEl.textContent = desc;
        if (roleBadgeEl) roleBadgeEl.innerHTML = `<span>${chipIcon}</span><span>${label}</span>`;
        if (roleChipEl) roleChipEl.innerHTML = `<span>${chipIcon}</span><span>${label}</span>`;
        if (backLink) backLink.href = backHref;
      }

      function applyUserUI(user, data) {
        const email = user.email || data.email || "";
        const name = data.name || user.displayName || "U≈æivatel Kartao";
        const nickname = data.nickname || "";
        const phone = data.phone || "";
        const role =
          data.role ||
          localStorage.getItem("userRole") ||
          "influencer";

        if (emailInput) emailInput.value = email;
        if (emailLabelEl) emailLabelEl.textContent = email || "Bez e-mailu";
        if (nameInput) nameInput.value = name;
        if (nicknameInput) nicknameInput.value = nickname;
        if (phoneInput) phoneInput.value = phone;

        if (displayNameEl) displayNameEl.textContent = name;
        if (avatarInitialEl) avatarInitialEl.textContent = name.trim().charAt(0).toUpperCase() || "U";

        applyRoleUI(role);
      }

      function loadLocalProfile(uid) {
        try {
          const raw = localStorage.getItem("kartaoProfile_" + uid);
          if (!raw) return {};
          return JSON.parse(raw) || {};
        } catch (e) {
          console.error("Chyba p≈ôi ƒçten√≠ local profile:", e);
          return {};
        }
      }

      function saveLocalProfile(uid, payload) {
        try {
          localStorage.setItem("kartaoProfile_" + uid, JSON.stringify(payload));
        } catch (e) {
          console.error("Chyba p≈ôi ukl√°d√°n√≠ local profile:", e);
        }
      }

      // Naƒçten√≠ u≈æivatele ‚Äì BEZ Firestore, jen Auth + localStorage
      setLoading(true);
      auth.onAuthStateChanged((user) => {
        if (!user) {
          window.location.href = "login.html";
          return;
        }

        try {
          const uid = user.uid;
          const localData = loadLocalProfile(uid);
          applyUserUI(user, localData);
        } catch (err) {
          console.error("Chyba p≈ôi naƒç√≠t√°n√≠ √∫ƒçtu (local):", err);
          showMessage("Nepoda≈ôilo se naƒç√≠st √∫daje √∫ƒçtu z tohoto za≈ô√≠zen√≠.", "error");
        } finally {
          setLoading(false);
        }
      });

      // Ulo≈æen√≠ zmƒõn ‚Äì jen do localStorage (na tomto za≈ô√≠zen√≠)
      if (accountForm) {
        accountForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          hideMessage();
          setLoading(true);

          const user = auth.currentUser;
          if (!user) {
            window.location.href = "login.html";
            return;
          }

          const uid = user.uid;

          const payload = {
            email: user.email || (emailInput ? emailInput.value.trim() : ""),
            name: nameInput ? nameInput.value.trim() || null : null,
            nickname: nicknameInput ? nicknameInput.value.trim() || null : null,
            phone: phoneInput ? phoneInput.value.trim() || null : null,
            updatedAt: new Date().toISOString(),
          };

          try {
            saveLocalProfile(uid, payload);
            showMessage("√ödaje byly ulo≈æeny do tohoto za≈ô√≠zen√≠.");
          } catch (err) {
            console.error("Chyba p≈ôi ukl√°d√°n√≠ √∫ƒçtu (local):", err);
            showMessage("Nepoda≈ôilo se ulo≈æit zmƒõny na tomto za≈ô√≠zen√≠.", "error");
          } finally {
            setLoading(false);
          }
        });
      }

      // Reset hesla
      if (resetPasswordBtn) {
        resetPasswordBtn.addEventListener("click", async () => {
          hideMessage();
          const user = auth.currentUser;
          if (!user || !user.email) {
            showMessage("Nepoda≈ôilo se zjistit e-mail √∫ƒçtu.", "error");
            return;
          }

          try {
            await auth.sendPasswordResetEmail(user.email);
            showMessage("Odeslali jsme ti e-mail s odkazem na zmƒõnu hesla.");
          } catch (err) {
            console.error("Chyba p≈ôi resetu hesla:", err);
            showMessage("Nepoda≈ôilo se odeslat e-mail pro zmƒõnu hesla.", "error");
          }
        });
      }

      // Odhl√°≈°en√≠
      if (logoutBtn) {
        logoutBtn.addEventListener("click", async () => {
          try {
            await auth.signOut();
            window.location.href = "login.html";
          } catch (err) {
            console.error("Chyba p≈ôi odhl√°≈°en√≠:", err);
            showMessage("Nepoda≈ôilo se odhl√°sit.", "error");
          }
        });
      }
    });
  </script>
</body>
</html>
