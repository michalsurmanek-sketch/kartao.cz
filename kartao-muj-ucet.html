<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kartao.cz ‚Äì M≈Øj √∫ƒçet</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üë§</text></svg>">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Rok v patiƒçce
    document.getElementById("year").textContent = new Date().getFullYear();

    // Firebase config ‚Äì stejn√Ω jako v login.html
    const firebaseConfig = {
      apiKey: "AIzaSyC-jRAsCQ7dn3xT-JUxG1Jg675Sej7vp2o",
      authDomain: "kartao-97df7.firebaseapp.com",
      projectId: "kartao-97df7",
      storageBucket: "kartao-97df7.firebasestorage.app",
      messagingSenderId: "1041236043484",
      appId: "1:1041236043484:web:6b916ba41fb82aeb2bf619",
      measurementId: "G-77NDPH3TXM"
    };

    if (!firebase.apps || !firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    const auth = firebase.auth();

    // DOM prvky
    const loader = document.getElementById("loader");
    const messageBox = document.getElementById("messageBox");
    const accountForm = document.getElementById("accountForm");
    const backLink = document.getElementById("backLink");

    const emailInput = document.getElementById("email");
    const nameInput = document.getElementById("name");
    const nicknameInput = document.getElementById("nickname");
    const phoneInput = document.getElementById("phone");

    const displayNameEl = document.getElementById("displayName");
    const avatarInitialEl = document.getElementById("avatarInitial");
    const emailLabelEl = document.getElementById("emailLabel");
    const roleLabelEl = document.getElementById("roleLabel");
    const roleBadgeEl = document.getElementById("roleBadge");
    const roleDescriptionEl = document.getElementById("roleDescription");
    const roleChipEl = document.getElementById("roleChip");

    const resetPasswordBtn = document.getElementById("resetPasswordBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    function setLoading(isLoading) {
      loader.classList.toggle("hidden", !isLoading);
      accountForm.classList.toggle("opacity-50", isLoading);
    }

    function showMessage(text, type = "success") {
      messageBox.textContent = text;
      messageBox.classList.remove("hidden");
      if (type === "success") {
        messageBox.classList.remove("border-rose-500/50", "bg-rose-500/10");
        messageBox.classList.add("border-emerald-500/50", "bg-emerald-500/10");
      } else {
        messageBox.classList.remove("border-emerald-500/50", "bg-emerald-500/10");
        messageBox.classList.add("border-rose-500/50", "bg-rose-500/10");
      }
    }

    function hideMessage() {
      messageBox.classList.add("hidden");
      messageBox.textContent = "";
    }

    function applyRoleUI(role) {
      let label = "Influencer √∫ƒçet";
      let desc = "Tento √∫ƒçet je veden√Ω jako influencer / tv≈Ørce obsahu.";
      let chipIcon = "‚≠ê";
      let backHref = "moje-karta.html";

      if (role === "firma") {
        label = "Firemn√≠ √∫ƒçet";
        desc = "Tento √∫ƒçet je veden√Ω jako firma / znaƒçka / agentura.";
        chipIcon = "üè¢";
        backHref = "moje-firma.html";
      }

      roleLabelEl.textContent = label;
      roleDescriptionEl.textContent = desc;
      roleBadgeEl.innerHTML = `<span>${chipIcon}</span><span>${label}</span>`;
      roleChipEl.innerHTML = `<span>${chipIcon}</span><span>${label}</span>`;
      backLink.href = backHref;
    }

    function applyUserUI(user, data) {
      const email = user.email || data.email || "";
      const name = data.name || user.displayName || "U≈æivatel Kartao";
      const nickname = data.nickname || "";
      const phone = data.phone || "";
      const role =
        data.role ||
        localStorage.getItem("userRole") ||
        "influencer";

      emailInput.value = email;
      emailLabelEl.textContent = email || "Bez e‚Äëmailu";
      nameInput.value = name;
      nicknameInput.value = nickname;
      phoneInput.value = phone;

      displayNameEl.textContent = name;
      avatarInitialEl.textContent = name.trim().charAt(0).toUpperCase() || "U";

      applyRoleUI(role);
    }

    function loadLocalProfile(uid) {
      try {
        const raw = localStorage.getItem("kartaoProfile_" + uid);
        if (!raw) return {};
        return JSON.parse(raw) || {};
      } catch (e) {
        console.error("Chyba p≈ôi ƒçten√≠ local profile:", e);
        return {};
      }
    }

    function saveLocalProfile(uid, payload) {
      try {
        localStorage.setItem("kartaoProfile_" + uid, JSON.stringify(payload));
      } catch (e) {
        console.error("Chyba p≈ôi ukl√°d√°n√≠ local profile:", e);
      }
    }

    // Naƒçten√≠ u≈æivatele ‚Äì BEZ Firestore, jen Auth + localStorage
    setLoading(true);
    auth.onAuthStateChanged((user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      try {
        const uid = user.uid;
        const localData = loadLocalProfile(uid);
        applyUserUI(user, localData);
      } catch (err) {
        console.error("Chyba p≈ôi naƒç√≠t√°n√≠ √∫ƒçtu (local):", err);
        showMessage("Nepoda≈ôilo se naƒç√≠st √∫daje √∫ƒçtu z tohoto za≈ô√≠zen√≠.", "error");
      } finally {
        setLoading(false);
      }
    });

    // Ulo≈æen√≠ zmƒõn ‚Äì jen do localStorage (na tomto za≈ô√≠zen√≠)
    accountForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      hideMessage();
      setLoading(true);

      const user = auth.currentUser;
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      const uid = user.uid;

      const payload = {
        email: user.email || emailInput.value.trim(),
        name: nameInput.value.trim() || null,
        nickname: nicknameInput.value.trim() || null,
        phone: phoneInput.value.trim() || null,
        updatedAt: new Date().toISOString(),
      };

      try {
        saveLocalProfile(uid, payload);
        showMessage("√ödaje byly ulo≈æeny do tohoto za≈ô√≠zen√≠.");
      } catch (err) {
        console.error("Chyba p≈ôi ukl√°d√°n√≠ √∫ƒçtu (local):", err);
        showMessage("Nepoda≈ôilo se ulo≈æit zmƒõny na tomto za≈ô√≠zen√≠.", "error");
      } finally {
        setLoading(false);
      }
    });

    // Reset hesla
    resetPasswordBtn.addEventListener("click", async () => {
      hideMessage();
      const user = auth.currentUser;
      if (!user || !user.email) {
        showMessage("Nepoda≈ôilo se zjistit e‚Äëmail √∫ƒçtu.", "error");
        return;
      }

      try {
        await auth.sendPasswordResetEmail(user.email);
        showMessage("Odeslali jsme ti e‚Äëmail s odkazem na zmƒõnu hesla.");
      } catch (err) {
        console.error("Chyba p≈ôi resetu hesla:", err);
        showMessage("Nepoda≈ôilo se odeslat e‚Äëmail pro zmƒõnu hesla.", "error");
      }
    });

    // Odhl√°≈°en√≠
    logoutBtn.addEventListener("click", async () => {
      try {
        await auth.signOut();
        window.location.href = "login.html";
      } catch (err) {
        console.error("Chyba p≈ôi odhl√°≈°en√≠:", err);
        showMessage("Nepoda≈ôilo se odhl√°sit.", "error");
      }
    });
  </script>
</body>
</html>
