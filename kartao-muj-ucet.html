<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kartao.cz ‚Äì M≈Øj √∫ƒçet</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üë§</text></svg>">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Rok v patiƒçce
    document.getElementById("year").textContent = new Date().getFullYear();

    // Firebase config ‚Äì stejn√Ω jako v login.html
    const firebaseConfig = {
      apiKey: "AIzaSyC-jRAsCQ7dn3xT-JUxG1Jg675Sej7vp2o",
      authDomain: "kartao-97df7.firebaseapp.com",
      projectId: "kartao-97df7",
      storageBucket: "kartao-97df7.firebasestorage.app",
      messagingSenderId: "1041236043484",
      appId: "1:1041236043484:web:6b916ba41fb82aeb2bf619",
      measurementId: "G-77NDPH3TXM"
    };

    if (!firebase.apps || !firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM prvky
    const loader = document.getElementById("loader");
    const messageBox = document.getElementById("messageBox");
    const accountForm = document.getElementById("accountForm");
    const backLink = document.getElementById("backLink");

    const emailInput = document.getElementById("email");
    const nameInput = document.getElementById("name");
    const nicknameInput = document.getElementById("nickname");
    const phoneInput = document.getElementById("phone");

    const displayNameEl = document.getElementById("displayName");
    const avatarInitialEl = document.getElementById("avatarInitial");
    const emailLabelEl = document.getElementById("emailLabel");
    const roleLabelEl = document.getElementById("roleLabel");
    const roleBadgeEl = document.getElementById("roleBadge");
    const roleDescriptionEl = document.getElementById("roleDescription");
    const roleChipEl = document.getElementById("roleChip");

    const resetPasswordBtn = document.getElementById("resetPasswordBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    function setLoading(isLoading) {
      loader.classList.toggle("hidden", !isLoading);
      accountForm.classList.toggle("opacity-50", isLoading);
    }

    function showMessage(text, type = "success") {
      messageBox.textContent = text;
      messageBox.classList.remove("hidden");
      if (type === "success") {
        messageBox.classList.remove("border-rose-500/50", "bg-rose-500/10");
        messageBox.classList.add("border-emerald-500/50", "bg-emerald-500/10");
      } else {
        messageBox.classList.remove("border-emerald-500/50", "bg-emerald-500/10");
        messageBox.classList.add("border-rose-500/50", "bg-rose-500/10");
      }
    }

    function hideMessage() {
      messageBox.classList.add("hidden");
    }

    function applyRoleUI(role) {
      let label = "Influencer √∫ƒçet";
      let desc = "Tento √∫ƒçet je veden√Ω jako influencer / tv≈Ørce obsahu.";
      let chipIcon = "‚≠ê";
      let backHref = "moje-karta.html";

      if (role === "firma") {
        label = "Firemn√≠ √∫ƒçet";
        desc = "Tento √∫ƒçet je veden√Ω jako firma / znaƒçka / agentura.";
        chipIcon = "üè¢";
        backHref = "moje-firma.html";
      }

      roleLabelEl.textContent = label;
      roleDescriptionEl.textContent = desc;
      roleBadgeEl.innerHTML = `<span>${chipIcon}</span><span>${label}</span>`;
      roleChipEl.innerHTML = `<span>${chipIcon}</span><span>${label}</span>`;
      backLink.href = backHref;
    }

    function applyUserUI(user, data) {
      const email = user.email || data.email || "";
      const name = data.name || user.displayName || "U≈æivatel Kartao";
      const nickname = data.nickname || "";
      const phone = data.phone || "";
      const role = data.role || "influencer";

      emailInput.value = email;
      emailLabelEl.textContent = email || "Bez e‚Äëmailu";
      nameInput.value = name;
      nicknameInput.value = nickname;
      phoneInput.value = phone;

      displayNameEl.textContent = name;
      avatarInitialEl.textContent = name.trim().charAt(0).toUpperCase() || "U";

      applyRoleUI(role);
    }

    // Naƒçten√≠ u≈æivatele a profilu
    setLoading(true);
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      try {
        const uid = user.uid;

        // zkus√≠me naƒç√≠st dokument z `users`, p≈ô√≠padnƒõ fallback na star√Ω `user`
        let doc = await db.collection("users").doc(uid).get();
        if (!doc.exists) {
          doc = await db.collection("user").doc(uid).get();
        }

        let data = doc.exists ? doc.data() : {};

        // pokud nic neexistuje, vytvo≈ô√≠me z√°kladn√≠ profil v `users`
        if (!doc.exists) {
          data = {
            email: user.email || null,
            role: "influencer",
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          };
          await db.collection("users").doc(uid).set(data, { merge: true });
        }

        applyUserUI(user, data || {});
      } catch (err) {
        console.error("Chyba p≈ôi naƒç√≠t√°n√≠ √∫ƒçtu:", err);
        showMessage("Nepoda≈ôilo se naƒç√≠st √∫daje √∫ƒçtu.", "error");
      } finally {
        setLoading(false);
      }
    });

    // Ulo≈æen√≠ zmƒõn
    accountForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      hideMessage();
      setLoading(true);

      const user = auth.currentUser;
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      const uid = user.uid;
      const payload = {
        email: user.email || emailInput.value.trim(),
        name: nameInput.value.trim() || null,
        nickname: nicknameInput.value.trim() || null,
        phone: phoneInput.value.trim() || null,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      };

      try {
        // hlavn√≠ z√°pis do `users`
        await db.collection("users").doc(uid).set(payload, { merge: true });

        // optional: z√°pis i do star√© kolekce `user`, pokud existuje≈°
        try {
          await db.collection("user").doc(uid).set(payload, { merge: true });
        } catch (innerErr) {
          console.error("Chyba p≈ôi z√°pisu do star√© kolekce user", innerErr);
        }

        showMessage("√ödaje byly √∫spƒõ≈°nƒõ ulo≈æeny.");
      } catch (err) {
        console.error("Chyba p≈ôi ukl√°d√°n√≠ √∫ƒçtu:", err);
        showMessage("Nepoda≈ôilo se ulo≈æit zmƒõny.", "error");
      } finally {
        setLoading(false);
      }
    });

    // Reset hesla
    resetPasswordBtn.addEventListener("click", async () => {
      hideMessage();
      const user = auth.currentUser;
      if (!user || !user.email) {
        showMessage("Nepoda≈ôilo se zjistit e‚Äëmail √∫ƒçtu.", "error");
        return;
      }

      try {
        await auth.sendPasswordResetEmail(user.email);
        showMessage("Odeslali jsme ti e‚Äëmail s odkazem na zmƒõnu hesla.");
      } catch (err) {
        console.error("Chyba p≈ôi resetu hesla:", err);
        showMessage("Nepoda≈ôilo se odeslat e‚Äëmail pro zmƒõnu hesla.", "error");
      }
    });

    // Odhl√°≈°en√≠
    logoutBtn.addEventListener("click", async () => {
      try {
        await auth.signOut();
        window.location.href = "login.html";
      } catch (err) {
        console.error("Chyba p≈ôi odhl√°≈°en√≠:", err);
        showMessage("Nepoda≈ôilo se odhl√°sit.", "error");
      }
    });
  </script>
</body>
</html>
