<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kartao.cz ‚Äì M≈Øj √∫ƒçet</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üë§</text></svg>">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            fuchsia: tailwind.colors.fuchsia,
            amber: tailwind.colors.amber,
            neutral: tailwind.colors.neutral,
            emerald: tailwind.colors.emerald,
            sky: tailwind.colors.sky,
          },
          boxShadow: {
            soft: "0 18px 45px rgba(15,23,42,0.85)"
          }
        },
      },
    };
  </script>

  <!-- Ikony -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <!-- üî• Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

  <!-- Konfigurace + init -->
  <script src="firebase-config.js"></script>
  <script src="firebase-init.js"></script>
  <script src="auth.js"></script>

  <style>
    body {
      min-height: 100vh;
      background:
        radial-gradient(circle at top left, rgba(236,72,153,0.18), transparent 55%),
        radial-gradient(circle at bottom right, rgba(251,191,36,0.16), transparent 55%),
        radial-gradient(circle at bottom left, rgba(56,189,248,0.10), transparent 55%),
        #020617;
    }
    .shadow-soft {
      box-shadow: 0 18px 45px rgba(15,23,42,0.85);
    }
    .glass {
      background: radial-gradient(circle at top left, rgba(248,250,252,0.10), rgba(15,23,42,0.96));
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
    }
  </style>
</head>
<body class="text-white">
  <!-- HLAVIƒåKA -->
  <header class="border-b border-white/10 bg-neutral-950/85 backdrop-blur sticky top-0 z-30">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <a href="index.html" class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-2xl bg-gradient-to-tr from-fuchsia-500 to-amber-400 grid place-items-center shadow-soft">
          <span class="font-bold text-lg">K</span>
        </div>
        <div>
          <div class="font-extrabold tracking-tight flex items-center gap-2">
            <span>Kartao.cz</span>
            <span class="hidden sm:inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-emerald-500/15 text-[11px] text-emerald-200 border border-emerald-400/50">
              <span class="w-1.5 h-1.5 rounded-full bg-emerald-300"></span>
              M≈Øj √∫ƒçet
            </span>
          </div>
          <div class="text-xs text-white/60 -mt-0.5">S√≠≈• influencer≈Ø & firemn√≠ch √∫ƒçt≈Ø</div>
        </div>
      </a>

      <div class="flex items-center gap-3">
        <a id="backLink" href="moje-karta.html" class="hidden sm:inline-flex items-center gap-1.5 text-xs text-white/70 hover:text-white">
          <i data-lucide="arrow-left" class="w-3.5 h-3.5"></i>
          <span>Zpƒõt na dashboard</span>
        </a>
        <button id="logoutBtn" class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-xl text-xs border border-white/20 hover:bg-white/10">
          <i data-lucide="log-out" class="w-3.5 h-3.5"></i>
          <span>Odhl√°sit se</span>
        </button>
      </div>
    </div>
  </header>

  <!-- OBSAH -->
  <main class="max-w-6xl mx-auto px-4 py-8 md:py-10 space-y-6">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div class="inline-flex items-center gap-2 text-[11px] text-white/60">
        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-white/5 border border-white/10">
          <i data-lucide="user" class="w-3 h-3"></i>
        </span>
        <span>√öƒçet & profil ¬∑ p≈ôihl√°≈°en√≠ ¬∑ vizitka</span>
      </div>
      <div class="flex items-center gap-2 text-[11px] text-white/50">
        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-white/5 border border-white/10">
          <span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>
          Bezpeƒçn√© p≈ôihl√°≈°en√≠ p≈ôes Firebase
        </span>
      </div>
    </div>

    <div class="grid lg:grid-cols-[minmax(0,260px)_minmax(0,1.1fr)] gap-6 items-start">
      <!-- LEV√ù PROFIL BOX + INLINE VIZITKA N√ÅHLED -->
      <section class="glass rounded-3xl border border-white/10 p-6 shadow-soft space-y-5">
        <!-- Profil -->
        <div class="flex items-center gap-4">
          <div class="w-16 h-16 rounded-2xl bg-gradient-to-tr from-fuchsia-500 via-amber-400 to-sky-400 p-[2px] shadow-[0_0_25px_rgba(236,72,153,0.7)]">
            <div class="w-full h-full rounded-2xl bg-neutral-950/95 grid place-items-center text-2xl font-bold text-amber-100" id="avatarInitial">
              U
            </div>
          </div>
          <div class="space-y-1">
            <div id="displayName" class="font-semibold text-lg leading-tight">
              U≈æivatel Kartao
            </div>
            <div id="emailLabel" class="text-xs text-white/60 break-all">
              ‚Äî
            </div>
            <div id="roleBadge" class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-white/5 text-[11px] text-white/75 border border-white/15">
              <span>‚≠ê</span>
              <span>Influencer √∫ƒçet</span>
            </div>
          </div>
        </div>

        <div class="space-y-1 text-xs text-white/60">
          <div id="roleLabel" class="text-sm font-semibold text-white/85">
            Influencer √∫ƒçet
          </div>
          <p id="roleDescription">
            Tento √∫ƒçet je veden√Ω jako influencer / tv≈Ørce obsahu. Pro firemn√≠ p≈ô√≠stup se p≈ôepni na firemn√≠ dashboard.
          </p>
        </div>

        <!-- MINI STATY -->
        <div class="grid grid-cols-3 gap-2 text-[11px] mt-3">
          <div class="rounded-2xl bg-white/5 border border-white/10 px-2.5 py-2">
            <p class="text-white/60">Typ √∫ƒçtu</p>
            <p id="roleChipText" class="text-xs font-semibold text-white">
              Influencer
            </p>
          </div>
          <div class="rounded-2xl bg-emerald-500/10 border border-emerald-400/40 px-2.5 py-2">
            <p class="text-emerald-100/80">P≈ôihl√°≈°en√≠</p>
            <p class="text-[10px] text-emerald-50">Firebase Auth</p>
          </div>
          <div class="rounded-2xl bg-amber-500/10 border border-amber-400/40 px-2.5 py-2">
            <p class="text-amber-100/90">√ödaje profilu</p>
            <p class="text-[10px] text-amber-50">Ulo≈æen√© ve Firestore</p>
          </div>
        </div>

        <!-- Inline vizitka ‚Äì n√°hled -->
        <div class="border-t border-white/10 pt-4 mt-2 space-y-2">
          <div class="flex items-center justify-between gap-2">
            <p class="text-xs uppercase tracking-wide text-white/40">
              Inline vizitka ¬∑ n√°hled
            </p>
            <span class="text-[11px] text-white/45">
              Sd√≠lej jako kartu v e-mailech & webech
            </span>
          </div>

          <div id="inlineCardPreview" class="rounded-2xl bg-neutral-950/80 border border-white/10 px-3.5 py-3 text-xs space-y-1 shadow-soft">
            <div class="flex items-center gap-3">
              <div class="w-9 h-9 rounded-xl bg-gradient-to-tr from-fuchsia-500 via-amber-400 to-sky-400 p-[1px]">
                <div class="w-full h-full rounded-xl bg-neutral-950/95 grid place-items-center text-sm font-bold text-amber-100" id="inlineAvatarInitial">
                  U
                </div>
              </div>
              <div class="flex-1 min-w-0">
                <div class="flex flex-wrap items-center gap-1.5">
                  <span id="inlineName" class="font-semibold truncate">
                    U≈æivatel Kartao
                  </span>
                  <span id="inlineNickname" class="px-1.5 py-0.5 rounded-full bg-white/5 text-[10px] text-white/70 border border-white/10 truncate max-w-[140px]">
                    @znaƒçka
                  </span>
                </div>
                <p id="inlineRole" class="text-[10px] text-white/55">
                  Influencer ¬∑ Kartao.cz
                </p>
                <p id="inlineEmail" class="text-[10px] text-white/45 truncate">
                  ‚Äî
                </p>
              </div>
              <div class="hidden sm:flex flex-col items-end gap-1">
                <span class="text-[10px] text-emerald-300">Kartao.cz</span>
                <span class="text-[9px] text-white/40">digit√°ln√≠ vizitka</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- PRAV√ù PANEL ‚Äì FORM + SD√çLEN√ç -->
      <section class="glass rounded-3xl border border-white/10 p-6 md:p-7 shadow-soft space-y-6">
        <header class="space-y-1">
          <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">
            M≈Øj √∫ƒçet & profil
          </h1>
          <p class="text-sm text-white/65">
            Z√°kladn√≠ √∫daje, kontakty a zabezpeƒçen√≠. √ödaje se ukl√°daj√≠ do Firestore do tv√©ho profilu
            <span class="text-amber-200">(kolekce ‚Äûusers‚Äú)</span>.
          </p>
        </header>

        <!-- Stav / zpr√°va -->
        <div id="messageBox" class="hidden mb-1 rounded-xl border px-3 py-2 text-sm"></div>

        <!-- Loader text -->
        <div id="loader" class="mb-2 text-sm text-white/60 flex items-center gap-2">
          <span class="w-4 h-4 rounded-full border border-white/30 border-t-transparent animate-spin"></span>
          <span>Naƒç√≠t√°m √∫daje o √∫ƒçtu‚Ä¶</span>
        </div>

        <!-- Role chip -->
        <div id="roleChip" class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/5 text-[11px] text-white/70 mb-3">
          <span>‚≠ê</span>
          <span>Influencer √∫ƒçet</span>
        </div>

        <!-- FORMUL√Å≈ò √öƒåTU -->
        <form id="accountForm" class="space-y-5">
          <!-- E-mail -->
          <div class="space-y-1.5">
            <label for="email" class="text-xs uppercase tracking-wide text-white/40">E-mail (p≈ôihla≈°ovac√≠)</label>
            <input
              id="email"
              type="email"
              class="w-full rounded-xl bg-neutral-950/70 border border-white/15 px-3 py-2 text-sm outline-none focus:border-amber-400"
              readonly
            />
            <p class="text-[11px] text-white/45">
              P≈ôihla≈°ovac√≠ e-mail z Firebase. Zmƒõnu ≈ôe≈°√≠me p≈ôes podporu / ovƒõ≈ôen√≠.
            </p>
          </div>

          <!-- Jm√©no + p≈ôezd√≠vka -->
          <div class="grid md:grid-cols-2 gap-4">
            <div class="space-y-1.5">
              <label for="name" class="text-xs uppercase tracking-wide text-white/40">Jm√©no / n√°zev</label>
              <input
                id="name"
                type="text"
                placeholder="Tvoje jm√©no nebo n√°zev firmy"
                class="w-full rounded-xl bg-neutral-950/70 border border-white/15 px-3 py-2 text-sm outline-none focus:border-amber-400"
              />
            </div>
            <div class="space-y-1.5">
              <label for="nickname" class="text-xs uppercase tracking-wide text-white/40">P≈ôezd√≠vka / znaƒçka</label>
              <input
                id="nickname"
                type="text"
                placeholder="Nap≈ô. @kartao_influencer"
                class="w-full rounded-xl bg-neutral-950/70 border border-white/15 px-3 py-2 text-sm outline-none focus:border-amber-400"
              />
              <p class="text-[11px] text-white/45">
                Bude pou≈æita i ve vizitce a marketplace.
              </p>
            </div>
          </div>

          <!-- Telefon -->
          <div class="space-y-1.5">
            <label for="phone" class="text-xs uppercase tracking-wide text-white/40">Telefon (nepovinn√©)</label>
            <input
              id="phone"
              type="tel"
              placeholder="+420 ..."
              class="w-full rounded-xl bg-neutral-950/70 border border-white/15 px-3 py-2 text-sm outline-none focus:border-amber-400"
            />
          </div>

          <!-- Zabezpeƒçen√≠ -->
          <div class="border-t border-white/10 pt-4 mt-2">
            <div class="flex flex-wrap items-center justify-between gap-3">
              <div>
                <div class="text-xs uppercase tracking-wide text-white/40 mb-1">Zabezpeƒçen√≠</div>
                <p class="text-xs text-white/60">
                  Heslo neum√≠me zobrazit, ale m≈Ø≈æeme poslat odkaz na zmƒõnu na tv≈Øj p≈ôihla≈°ovac√≠ e-mail.
                </p>
              </div>
              <button
                type="button"
                id="resetPasswordBtn"
                class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-xl border border-white/25 text-xs hover:bg-white/10"
              >
                <i data-lucide="key-round" class="w-3.5 h-3.5"></i>
                <span>Poslat odkaz na reset hesla</span>
              </button>
            </div>
          </div>

          <!-- SD√çLEN√ç VIZITKY -->
          <div class="border-t border-white/10 pt-4 space-y-3">
            <div class="flex flex-wrap items-center justify-between gap-2">
              <div>
                <div class="text-xs uppercase tracking-wide text-white/40 mb-1">Sd√≠len√≠ vizitky</div>
                <p class="text-xs text-white/60">
                  Vygenerovan√Ω odkaz a HTML vizitky m≈Ø≈æe≈° vlo≈æit do webu, e-mailu nebo chatu.
                </p>
              </div>
            </div>

            <div class="space-y-2">
              <div class="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center">
                <input
                  id="shareUrl"
                  type="text"
                  readonly
                  class="flex-1 rounded-xl bg-neutral-950/70 border border-white/15 px-3 py-2 text-xs outline-none text-white/80"
                  placeholder="Odkaz na tvoji vizitku se objev√≠ po naƒçten√≠ √∫ƒçtu‚Ä¶"
                />
                <button
                  type="button"
                  id="copyShareUrlBtn"
                  class="inline-flex items-center justify-center gap-1.5 px-3 py-2 rounded-xl bg-white/10 border border-white/20 text-[11px] hover:bg-white/15"
                >
                  <i data-lucide="link-2" class="w-3.5 h-3.5"></i>
                  <span>Zkop√≠rovat odkaz</span>
                </button>
              </div>

              <button
                type="button"
                id="copyShareCardBtn"
                class="inline-flex items-center gap-1.5 px-3 py-2 rounded-xl bg-gradient-to-r from-amber-400 via-amber-300 to-yellow-300 text-[11px] font-semibold text-neutral-950 shadow-soft hover:brightness-110"
              >
                <i data-lucide="copy" class="w-3.5 h-3.5"></i>
                <span>Zkop√≠rovat HTML vizitky (inline)</span>
              </button>

              <p class="text-[11px] text-white/45">
                HTML vizitky obsahuje malou Kartao kartu s tv√Ωm jm√©nem, p≈ôezd√≠vkou a e-mailem ‚Äì p≈ôipraven√© pro vlo≈æen√≠ do webu / newsletteru.
              </p>
            </div>
          </div>

          <!-- Tlaƒç√≠tko ulo≈æit -->
          <div class="pt-2 flex flex-wrap items-center justify-between gap-3">
            <button
              type="submit"
              class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl bg-gradient-to-r from-amber-400 via-amber-300 to-yellow-300 text-sm font-semibold text-neutral-950 shadow-soft hover:brightness-110"
            >
              <i data-lucide="save" class="w-4 h-4"></i>
              <span>Ulo≈æit zmƒõny</span>
            </button>
            <p class="text-[11px] text-white/45">
              √ödaje se ukl√°daj√≠ do Firestore (profil v kolekci <code>users</code>).
            </p>
          </div>
        </form>
      </section>
    </div>
  </main>

  <!-- Patiƒçka -->
  <footer class="border-t border-white/10 bg-neutral-950/85 mt-4">
    <div class="max-w-6xl mx-auto px-4 py-3 text-[11px] text-white/50 flex flex-wrap items-center justify-between gap-2">
      <span>¬© <span id="year"></span> Kartao.cz</span>
      <span>Digit√°ln√≠ ekosyst√©m ¬∑ √∫ƒçty ¬∑ kampanƒõ ¬∑ vizitky</span>
    </div>
  </footer>

  <!-- LOGIKA √öƒåTU (Auth + Firestore + inline vizitka) -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      if (window.lucide) {
        try { lucide.createIcons(); } catch (e) { console.warn("Lucide ikonky ne≈°ly inicializovat:", e); }
      }

      // ‚úÖ Pou≈æijeme JEN glob√°ln√≠ instanci z firebase-init.js
      if (!window.firebase || !window.auth || !window.db) {
        console.error("‚ùå Firebase nen√≠ spr√°vnƒõ inicializovan√° na t√©to str√°nce.", {
          firebase: !!window.firebase,
          auth: !!window.auth,
          db: !!window.db,
        });
        return;
      }

      const auth = window.auth;
      const db   = window.db;

      console.log("‚úÖ kartao-muj-ucet.html ‚Äì Firebase OK, pou≈æ√≠v√°m jednu instanci", {
        authReady: !!auth,
        dbReady: !!db,
      });

      // DOM prvky
      const loader = document.getElementById("loader");
      const messageBox = document.getElementById("messageBox");
      const accountForm = document.getElementById("accountForm");
      const backLink = document.getElementById("backLink");

      const emailInput = document.getElementById("email");
      const nameInput = document.getElementById("name");
      const nicknameInput = document.getElementById("nickname");
      const phoneInput = document.getElementById("phone");

      const displayNameEl = document.getElementById("displayName");
      const avatarInitialEl = document.getElementById("avatarInitial");
      const emailLabelEl = document.getElementById("emailLabel");
      const roleLabelEl = document.getElementById("roleLabel");
      const roleBadgeEl = document.getElementById("roleBadge");
      const roleDescriptionEl = document.getElementById("roleDescription");
      const roleChipEl = document.getElementById("roleChip");
      const roleChipTextEl = document.getElementById("roleChipText");

      const resetPasswordBtn = document.getElementById("resetPasswordBtn");
      const logoutBtn = document.getElementById("logoutBtn");

      const inlineAvatarInitial = document.getElementById("inlineAvatarInitial");
      const inlineName = document.getElementById("inlineName");
      const inlineNickname = document.getElementById("inlineNickname");
      const inlineRole = document.getElementById("inlineRole");
      const inlineEmail = document.getElementById("inlineEmail");

      const shareUrlInput = document.getElementById("shareUrl");
      const copyShareUrlBtn = document.getElementById("copyShareUrlBtn");
      const copyShareCardBtn = document.getElementById("copyShareCardBtn");

      const yearEl = document.getElementById("year");
      if (yearEl) yearEl.textContent = new Date().getFullYear();

      let currentUserUid = null;
      let currentProfileData = {};

      function setLoading(isLoading) {
        if (!loader || !accountForm) return;
        loader.classList.toggle("hidden", !isLoading);
        accountForm.classList.toggle("opacity-50", isLoading);
        accountForm.classList.toggle("pointer-events-none", isLoading);
      }

      function showMessage(text, type = "success") {
        if (!messageBox) return;
        messageBox.textContent = text;
        messageBox.classList.remove(
          "hidden",
          "border-rose-500/50",
          "bg-rose-500/10",
          "border-emerald-500/50",
          "bg-emerald-500/10"
        );
        if (type === "success") {
          messageBox.classList.add("border-emerald-500/50", "bg-emerald-500/10");
        } else {
          messageBox.classList.add("border-rose-500/50", "bg-rose-500/10");
        }
      }

      function hideMessage() {
        if (!messageBox) return;
        messageBox.classList.add("hidden");
        messageBox.textContent = "";
      }

      function applyRoleUI(role) {
        let label = "Influencer √∫ƒçet";
        let desc = "Tento √∫ƒçet je veden√Ω jako influencer / tv≈Ørce obsahu.";
        let chipIcon = "‚≠ê";
        let backHref = "moje-karta.html";
        let shortRole = "Influencer";

        if (role === "firma") {
          label = "Firemn√≠ √∫ƒçet";
          desc = "Tento √∫ƒçet je veden√Ω jako firma / znaƒçka / agentura.";
          chipIcon = "üè¢";
          backHref = "moje-firma.html";
          shortRole = "Firma / znaƒçka";
        }

        if (roleLabelEl) roleLabelEl.textContent = label;
        if (roleDescriptionEl) roleDescriptionEl.textContent = desc;
        if (roleBadgeEl) roleBadgeEl.innerHTML = `<span>${chipIcon}</span><span>${label}</span>`;
        if (roleChipEl) roleChipEl.innerHTML = `<span>${chipIcon}</span><span>${label}</span>`;
        if (roleChipTextEl) roleChipTextEl.textContent = shortRole;
        if (backLink) backLink.href = backHref;

        if (inlineRole) inlineRole.textContent = `${shortRole} ¬∑ Kartao.cz`;
      }

      function applyInlineCard(name, nickname, email, role) {
        if (inlineAvatarInitial && name) {
          inlineAvatarInitial.textContent = name.trim().charAt(0).toUpperCase() || "U";
        }
        if (inlineName && name) {
          inlineName.textContent = name;
        }
        if (inlineNickname) {
          if (nickname) {
            inlineNickname.textContent = nickname;
          } else {
            inlineNickname.textContent = role === "firma" ? "@tvoje_znacka" : "@tvoje_prezdivka";
          }
        }
        if (inlineEmail) {
          inlineEmail.textContent = email || "Bez e-mailu";
        }
      }

      function applyUserUI(user, data) {
        const email = user.email || data.email || "";
        const name = data.name || data.displayName || user.displayName || "U≈æivatel Kartao";
        const nickname = data.nickname || "";
        const phone = data.phone || "";

        const role =
          data.role ||
          data.activerole ||
          "influencer";

        currentProfileData.role = role;

        if (emailInput) emailInput.value = email;
        if (emailLabelEl) emailLabelEl.textContent = email || "Bez e-mailu";
        if (nameInput) nameInput.value = name;
        if (nicknameInput) nicknameInput.value = nickname;
        if (phoneInput) phoneInput.value = phone;

        if (displayNameEl) displayNameEl.textContent = name;
        if (avatarInitialEl) avatarInitialEl.textContent = name.trim().charAt(0).toUpperCase() || "U";

        applyRoleUI(role);
        applyInlineCard(name, nickname, email, role);
      }

      function updateInlinePreviewFromInputs() {
        const name = (nameInput && nameInput.value.trim()) || (displayNameEl && displayNameEl.textContent) || "U≈æivatel Kartao";
        const nickname = (nicknameInput && nicknameInput.value.trim()) || (currentProfileData.nickname || "");
        const email = (emailInput && emailInput.value.trim()) || (currentProfileData.email || "");
        const role = currentProfileData.role || "influencer";
        applyInlineCard(name, nickname, email, role);
      }

      // ==========================
      // Naƒçten√≠ u≈æivatele + profilu
      // ==========================
      setLoading(true);

      kartaoAuth.onAuthStateChanged(async (user) => {
        console.log("üë§ onAuthStateChanged ‚Äì kartao-muj-ucet.html", user ? { uid: user.uid, email: user.email } : null);

        if (!user) {
          window.location.href = "login.html";
          return;
        }

        currentUserUid = user.uid;

        let docData = null;

        try {
          const docRef = db.collection("users").doc(user.uid);
          const snap = await docRef.get();

          if (snap.exists) {
            docData = snap.data() || {};
          } else {
            docData = {
              email: user.email || null,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            };
            try {
              await docRef.set(docData, { merge: true });
            } catch (setErr) {
              console.warn("Profil se nepoda≈ôilo ulo≈æit na server, ale jedu d√°l s lok√°ln√≠mi daty:", setErr);
            }
          }
        } catch (e) {
          console.warn("Profil se nepoda≈ôilo naƒç√≠st z Firestore (pou≈æiju data z Auth):", e);
        }

        currentProfileData = docData || {
          email: user.email || "",
        };

        applyUserUI(user, currentProfileData);

        // URL vizitky
        if (shareUrlInput) {
          const origin = window.location.origin || "https://kartao.cz";
          const profileUrl = origin + "/vizitka.html?uid=" + user.uid;
          shareUrlInput.value = profileUrl;
        }

        setLoading(false);
      });

      // Realtime n√°hled inline vizitky p≈ôi psan√≠
      [nameInput, nicknameInput, phoneInput].forEach((el) => {
        if (!el) return;
        el.addEventListener("input", () => {
          updateInlinePreviewFromInputs();
        });
      });

      // Ulo≈æen√≠ zmƒõn ‚Äì Firestore
      if (accountForm) {
        accountForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          hideMessage();
          setLoading(true);

          const user = auth.currentUser;
          if (!user) {
            window.location.href = "login.html";
            return;
          }

          const uid = user.uid;

          const payload = {
            email: user.email || (emailInput ? emailInput.value.trim() : ""),
            name: nameInput ? (nameInput.value.trim() || null) : null,
            nickname: nicknameInput ? (nicknameInput.value.trim() || null) : null,
            phone: phoneInput ? (phoneInput.value.trim() || null) : null,
            displayName: nameInput ? (nameInput.value.trim() || null) : null,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          };

          try {
            await db.collection("users").doc(uid).set(payload, { merge: true });

            if (payload.displayName) {
              try {
                await user.updateProfile({ displayName: payload.displayName });
              } catch (err) {
                console.warn("Nepoda≈ôilo se aktualizovat displayName v Auth:", err);
              }
            }

            currentProfileData = { ...currentProfileData, ...payload };
            applyInlineCard(
              payload.name || "U≈æivatel Kartao",
              payload.nickname || "",
              payload.email || "",
              currentProfileData.role || "influencer"
            );

            showMessage("√ödaje byly ulo≈æeny do Firestore.");
          } catch (err) {
            console.warn("Chyba p≈ôi ukl√°d√°n√≠ profilu do Firestore:", err);
            showMessage("Nepoda≈ôilo se ulo≈æit zmƒõny do datab√°ze.", "error");
          } finally {
            setLoading(false);
          }
        });
      }

      // Reset hesla
      if (resetPasswordBtn) {
        resetPasswordBtn.addEventListener("click", async () => {
          hideMessage();
          const user = auth.currentUser;
          if (!user || !user.email) {
            showMessage("Nepoda≈ôilo se zjistit e-mail √∫ƒçtu.", "error");
            return;
          }

          try {
            await auth.sendPasswordResetEmail(user.email);
            showMessage("Odeslali jsme ti e-mail s odkazem na zmƒõnu hesla.");
          } catch (err) {
            console.warn("Chyba p≈ôi resetu hesla:", err);
            showMessage("Nepoda≈ôilo se odeslat e-mail pro zmƒõnu hesla.", "error");
          }
        });
      }

      // Kop√≠rov√°n√≠ URL vizitky
      if (copyShareUrlBtn && shareUrlInput) {
        copyShareUrlBtn.addEventListener("click", async () => {
          hideMessage();
          const url = shareUrlInput.value.trim();
          if (!url) {
            showMessage("URL vizitky je≈°tƒõ nen√≠ p≈ôipraven√°.", "error");
            return;
          }
          try {
            await navigator.clipboard.writeText(url);
            showMessage("Odkaz na vizitku byl zkop√≠rov√°n do schr√°nky.");
          } catch (e) {
            console.warn("Chyba p≈ôi kop√≠rov√°n√≠ URL:", e);
            showMessage("Nepoda≈ôilo se zkop√≠rovat odkaz do schr√°nky.", "error");
          }
        });
      }

      // Kop√≠rov√°n√≠ HTML vizitky
      if (copyShareCardBtn) {
        copyShareCardBtn.addEventListener("click", async () => {
          hideMessage();
          const user = auth.currentUser;
          if (!user) {
            showMessage("U vizitky je pot≈ôeba b√Ωt p≈ôihl√°≈°en√Ω.", "error");
            return;
          }

          const uid = currentUserUid || user.uid;
          const origin = window.location.origin || "https://kartao.cz";

          const name = (nameInput && nameInput.value.trim()) || currentProfileData.name || currentProfileData.displayName || user.displayName || "U≈æivatel Kartao";
          const nickname = (nicknameInput && nicknameInput.value.trim()) || currentProfileData.nickname || "";
          const email = user.email || (emailInput && emailInput.value.trim()) || currentProfileData.email || "";
          const role = currentProfileData.role || "influencer";
          const shortRole = role === "firma" ? "Firma / znaƒçka" : "Influencer";

          const profileUrl = origin + "/vizitka.html?uid=" + uid;

          const cardHtml =
`<div class="kartao-inline-card" style="font-family:-apple-system,BlinkMacSystemFont,system-ui,Segoe UI,sans-serif;font-size:13px;color:#e5e7eb;background:linear-gradient(135deg,#020617,#020617);border-radius:14px;border:1px solid rgba(148,163,184,0.7);padding:10px 12px;display:flex;align-items:center;gap:10px;max-width:420px;">
  <div style="width:38px;height:38px;border-radius:12px;background:linear-gradient(135deg,#ec4899,#fbbf24,#22d3ee);padding:1px;display:flex;align-items:center;justify-content:center;">
    <div style="width:100%;height:100%;border-radius:11px;background:#020617;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;color:#fef3c7;">
      ${name.trim().charAt(0).toUpperCase() || "U"}
    </div>
  </div>
  <div style="flex:1;min-width:0;">
    <div style="display:flex;align-items:center;gap:6px;margin-bottom:2px;">
      <span style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${name}</span>
      ${nickname ? `<span style="font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid rgba(148,163,184,0.7);color:#e5e7eb;white-space:nowrap;max-width:140px;overflow:hidden;text-overflow:ellipsis;">${nickname}</span>` : ""}
    </div>
    <div style="font-size:11px;color:#9ca3af;margin-bottom:1px;">${shortRole} ¬∑ Kartao.cz</div>
    ${email ? `<div style="font-size:11px;color:#6b7280;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${email}</div>` : ""}
    <a href="${profileUrl}" style="margin-top:4px;display:inline-flex;align-items:center;gap:4px;font-size:11px;color:#facc15;text-decoration:none;">
      <span>Otev≈ô√≠t vizitku na Kartao.cz</span>
      <span style="font-size:10px;">‚Üó</span>
    </a>
  </div>
</div>`;

          try {
            await navigator.clipboard.writeText(cardHtml);
            showMessage("HTML vizitky bylo zkop√≠rov√°no do schr√°nky. Staƒç√≠ vlo≈æit do e-mailu nebo na web.");
          } catch (e) {
            console.warn("Chyba p≈ôi kop√≠rov√°n√≠ HTML vizitky:", e);
            showMessage("Nepoda≈ôilo se zkop√≠rovat HTML vizitky do schr√°nky.", "error");
          }
        });
      }

      // ‚úÖ Odhl√°≈°en√≠ ‚Äì jen jedna instance, logujeme do konzole
      if (logoutBtn) {
        logoutBtn.addEventListener("click", async () => {
          hideMessage();
          console.log("üö™ Pokus o odhl√°≈°en√≠ ‚Äì kartao-muj-ucet.html");
          try {
            await kartaoAuth.logout();
            console.log("‚úÖ Odhl√°≈°en√≠ probƒõhlo, p≈ôesmƒõrov√°v√°m na login.html");
            window.location.href = "login.html";
          } catch (err) {
            console.warn("Chyba p≈ôi odhl√°≈°en√≠:", err);
            showMessage("Nepoda≈ôilo se odhl√°sit.", "error");
          }
        });
      }
    });
  </script>
</body>
</html>
