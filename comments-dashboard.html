<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Koment√°≈ôe ke kampani ‚Äì Kartao.cz</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            fuchsia: tailwind.colors.fuchsia,
            amber: tailwind.colors.amber,
            neutral: tailwind.colors.neutral,
            emerald: tailwind.colors.emerald,
            sky: tailwind.colors.sky,
            rose: tailwind.colors.rose,
          },
        },
      },
    };
  </script>

  <!-- Ikony + Firebase -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="firebase-init.js"></script>
  <script src="comments-system.js"></script>
</head>
<body class="bg-gradient-to-b from-neutral-950 via-neutral-950 to-black text-white">
  <div class="min-h-screen flex flex-col">
    <!-- HEADER Kartao -->
    <header class="sticky top-0 z-50 backdrop-blur supports-[backdrop-filter]:bg-neutral-950/80 bg-neutral-950/60 border-b border-white/10">
      <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
        <a href="index.html" class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-2xl bg-gradient-to-tr from-fuchsia-500 to-amber-400 grid place-items-center shadow">
            <i data-lucide="crown" class="w-5 h-5 text-neutral-900"></i>
          </div>
          <span class="font-semibold text-white text-lg">Kartao.cz</span>
        </a>
        <nav class="hidden md:flex items-center gap-6 text-white/80 text-sm">
          <a href="kartao-marketplace.html" class="hover:text-white transition">Marketplace</a>
          <a href="kartao-zalozit-kartu.html" class="hover:text-white transition">Zalo≈æit kartu</a>
          <a href="kartao-zadat-kampan.html" class="hover:text-white transition">Zadat kampa≈à</a>
        </nav>
      </div>
    </header>

    <main class="flex-1">
      <!-- HERO / Info o kampani -->
      <section class="border-b border-white/10 bg-gradient-to-r from-fuchsia-600/15 via-amber-400/10 to-emerald-500/15">
        <div class="max-w-5xl mx-auto px-4 py-8 md:py-10">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
            <div class="flex items-start gap-4">
              <div class="w-16 h-16 rounded-2xl overflow-hidden flex-shrink-0 ring-2 ring-amber-300/70">
                <img src="https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?w=200&h=200&fit=crop&crop=face" alt="Kampa≈à" class="w-full h-full object-cover" />
              </div>
              <div>
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-black/30 border border-white/10 mb-3">
                  <i data-lucide="message-square" class="w-4 h-4 text-amber-300"></i>
                  <span class="text-xs font-semibold tracking-wide uppercase text-white/70">Koment√°≈ôe ke kampani</span>
                </div>
                <h1 class="text-2xl md:text-3xl font-bold text-white mb-2">
                  Demo kampa≈à: Ekologick√© produkty 2025
                </h1>
                <p class="text-sm md:text-base text-white/70 max-w-xl">
                  Diskuze ke spolupr√°ci na kampani zamƒõ≈ôen√© na udr≈æiteln√Ω, zero‚Äëwaste a eco‚Äëfriendly ≈æivotn√≠ styl.
                </p>
              </div>
            </div>
            <div class="flex flex-col items-start md:items-end gap-3 text-sm text-white/70">
              <div class="flex items-center gap-4">
                <span class="flex items-center gap-1"><i data-lucide="user" class="w-4 h-4 text-emerald-300"></i>EcoInfluencer</span>
                <span class="flex items-center gap-1"><i data-lucide="calendar" class="w-4 h-4 text-amber-300"></i>15. 11. 2025</span>
              </div>
              <div class="flex items-center gap-4">
                <span class="flex items-center gap-1 text-white/60"><i data-lucide="eye" class="w-4 h-4"></i>1 234 zobrazen√≠</span>
                <span id="campaignCommentCount" class="flex items-center gap-1 text-white/60">
                  <i data-lucide="message-square" class="w-4 h-4"></i>0 koment√°≈ô≈Ø
                </span>
              </div>
              <button class="mt-1 inline-flex items-center gap-2 px-4 py-2 rounded-full bg-gradient-to-r from-fuchsia-500 to-amber-400 text-neutral-950 text-xs font-semibold shadow hover:shadow-[0_0_25px_rgba(250,204,21,0.4)] transition">
                <i data-lucide="bell" class="w-4 h-4"></i>
                Sledovat kampa≈à
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- OBSAH KOMENT√Å≈ò≈Æ -->
      <section class="max-w-5xl mx-auto px-4 py-8 md:py-10">
        <!-- Blok koment√°≈ô≈Ø -->
        <div class="bg-neutral-950/80 border border-white/10 rounded-2xl shadow-[0_0_40px_rgba(0,0,0,0.7)] p-5 md:p-7">
          <!-- Formul√°≈ô koment√°≈ôe -->
          <div id="commentForm" class="mb-8">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
              <i data-lucide="edit-3" class="w-5 h-5 text-amber-300"></i>
              <span>Napsat koment√°≈ô</span>
            </h2>

            <!-- V√Ωzva k p≈ôihl√°≈°en√≠ -->
            <div id="loginPrompt" class="text-center py-8 border-2 border-dashed border-white/15 rounded-2xl bg-neutral-900/40">
              <div class="text-4xl mb-3">üë§</div>
              <h3 class="text-lg font-semibold text-white mb-1">P≈ôihlaste se pro komentov√°n√≠</h3>
              <p class="text-sm text-white/60 mb-4">Pro p≈ôid√°n√≠ koment√°≈ôe je pot≈ôeba m√≠t √∫ƒçet na Kartao.cz.</p>
              <button id="loginBtn" class="inline-flex items-center gap-2 bg-gradient-to-r from-fuchsia-500 to-amber-400 text-neutral-950 px-6 py-2.5 rounded-full text-sm font-semibold hover:shadow-[0_0_30px_rgba(250,204,21,0.45)] transition">
                <i data-lucide="log-in" class="w-4 h-4"></i>
                P≈ôihl√°sit se
              </button>
            </div>

            <!-- Editor koment√°≈ôe -->
            <div id="commentEditor" class="hidden">
              <div class="flex items-start gap-4">
                <div id="currentUserAvatar" class="w-11 h-11 rounded-full bg-white/10 flex-shrink-0"></div>
                <div class="flex-1">
                  <textarea
                    id="commentTextarea"
                    placeholder="Napi≈°te sv≈Øj koment√°≈ô ke kampani..."
                    class="w-full px-4 py-3 rounded-2xl bg-neutral-900/80 border border-white/10 text-sm text-white placeholder:text-white/40 resize-none focus:outline-none focus:ring-2 focus:ring-amber-400/70 focus:border-transparent"
                    rows="4"
                    maxlength="1000"
                  ></textarea>
                  <div class="flex flex-col md:flex-row md:items-center justify-between gap-3 mt-3 text-xs md:text-sm">
                    <div class="flex items-center gap-4 text-white/50">
                      <span id="charCount">0/1000</span>
                      <label class="inline-flex items-center gap-2 cursor-pointer select-none">
                        <input type="checkbox" id="notifyReplies" class="rounded border-white/20 bg-neutral-900" />
                        <span>Upozornit mƒõ na odpovƒõdi</span>
                      </label>
                    </div>
                    <div class="flex items-center gap-2 justify-end">
                      <button id="cancelComment" class="px-4 py-2 rounded-full text-white/60 hover:text-white hover:bg-white/5 transition">
                        Zru≈°it
                      </button>
                      <button id="submitComment" class="px-6 py-2 rounded-full bg-gradient-to-r from-fuchsia-500 to-amber-400 text-neutral-950 font-semibold text-sm hover:shadow-[0_0_30px_rgba(236,72,153,0.5)] transition disabled:opacity-50">
                        Publikovat koment√°≈ô
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Filtr + ≈ôazen√≠ -->
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6 pb-4 border-b border-white/10">
            <div class="flex items-center gap-3">
              <h3 class="text-lg font-semibold text-white">Koment√°≈ôe</h3>
              <span id="totalCommentsCount" class="text-sm text-white/50">(0)</span>
            </div>
            <div class="flex items-center gap-3 text-sm">
              <select
                id="commentSort"
                class="bg-neutral-900/80 border border-white/15 rounded-xl px-3 py-1.5 text-white/80 focus:outline-none focus:ring-2 focus:ring-amber-400/70"
              >
                <option value="newest">Nejnovƒõj≈°√≠</option>
                <option value="oldest">Nejstar≈°√≠</option>
                <option value="popular">Nejobl√≠benƒõj≈°√≠</option>
              </select>
              <button
                id="toggleCommentSearch"
                class="w-9 h-9 rounded-full border border-white/15 bg-neutral-900/80 flex items-center justify-center text-white/70 hover:text-white hover:bg-white/5 transition"
              >
                <i data-lucide="search" class="w-4 h-4"></i>
              </button>
            </div>
          </div>

          <!-- Vyhled√°v√°n√≠ v koment√°≈ô√≠ch -->
          <div id="commentSearchBar" class="hidden mb-6">
            <div class="relative">
              <input
                type="text"
                id="commentSearchInput"
                placeholder="Hledat v koment√°≈ô√≠ch..."
                class="w-full pl-10 pr-10 py-2.5 rounded-2xl bg-neutral-900/80 border border-white/15 text-sm text-white placeholder:text-white/40 focus:outline-none focus:ring-2 focus:ring-amber-400/70"
              />
              <i data-lucide="search" class="w-4 h-4 text-white/40 absolute left-3 top-2.5"></i>
              <button id="clearSearch" class="absolute right-3 top-2.5 text-white/40 hover:text-white/80">
                <i data-lucide="x" class="w-4 h-4"></i>
              </button>
            </div>
          </div>

          <!-- Seznam koment√°≈ô≈Ø -->
          <div id="commentsList" class="space-y-5 hidden"></div>

          <!-- Naƒç√≠st v√≠ce -->
          <div id="loadMoreSection" class="hidden text-center mt-8">
            <button
              id="loadMoreBtn"
              class="inline-flex items-center gap-2 px-5 py-2.5 rounded-full bg-neutral-900/80 border border-white/15 text-sm text-white/80 hover:bg-white/5 transition"
            >
              <i data-lucide="loader-2" class="w-4 h-4 animate-spin hidden"></i>
              <span>Naƒç√≠st v√≠ce koment√°≈ô≈Ø</span>
            </button>
          </div>

          <!-- ≈Ω√°dn√© koment√°≈ôe -->
          <div id="noCommentsMessage" class="text-center py-10 text-white/60">
            <div class="text-5xl mb-3">üí¨</div>
            <h3 class="text-lg font-semibold text-white mb-1">Zat√≠m ≈æ√°dn√© koment√°≈ôe</h3>
            <p class="text-sm">Buƒète prvn√≠, kdo se k t√©to kampani vyj√°d≈ô√≠.</p>
          </div>

          <!-- Loading stav -->
          <div id="commentsLoading" class="hidden text-center py-8">
            <div class="mx-auto mb-3 h-8 w-8 rounded-full border-2 border-fuchsia-500/40 border-t-transparent animate-spin"></div>
            <p class="text-sm text-white/60">Naƒç√≠t√°m koment√°≈ôe...</p>
          </div>
        </div>
      </section>

      <!-- MODAL ‚Äì editace koment√°≈ôe -->
      <div
        id="editCommentModal"
        class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50"
      >
        <div class="bg-neutral-950 border border-white/15 rounded-2xl p-6 max-w-lg w-full mx-4 shadow-[0_0_40px_rgba(0,0,0,0.8)]">
          <h3 class="text-lg font-bold text-white mb-3">Upravit koment√°≈ô</h3>
          <textarea
            id="editCommentTextarea"
            class="w-full px-4 py-3 rounded-2xl bg-neutral-900/80 border border-white/15 text-sm text-white resize-none focus:outline-none focus:ring-2 focus:ring-amber-400/70"
            rows="4"
            maxlength="1000"
          ></textarea>
          <div class="flex items-center justify-between mt-3 text-xs text-white/50">
            <span id="editCharCount">0/1000</span>
            <div class="flex items-center gap-2">
              <button id="cancelEdit" class="px-4 py-2 rounded-full text-white/60 hover:text-white hover:bg-white/5 transition">
                Zru≈°it
              </button>
              <button
                id="saveEdit"
                class="px-6 py-2 rounded-full bg-gradient-to-r from-fuchsia-500 to-amber-400 text-neutral-950 font-semibold text-sm hover:shadow-[0_0_30px_rgba(236,72,153,0.5)] transition"
              >
                Ulo≈æit
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- MODAL ‚Äì odpovƒõƒè -->
      <div
        id="replyModal"
        class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50"
      >
        <div class="bg-neutral-950 border border-white/15 rounded-2xl p-6 max-w-lg w-full mx-4 shadow-[0_0_40px_rgba(0,0,0,0.8)]">
          <h3 class="text-lg font-bold text-white mb-4">Odpovƒõdƒõt na koment√°≈ô</h3>
          <div id="replyToComment" class="bg-neutral-900/60 border border-white/10 rounded-2xl p-4 mb-4 text-sm text-white/70"></div>
          <textarea
            id="replyTextarea"
            placeholder="Napi≈°te svou odpovƒõƒè..."
            class="w-full px-4 py-3 rounded-2xl bg-neutral-900/80 border border-white/15 text-sm text-white resize-none focus:outline-none focus:ring-2 focus:ring-amber-400/70"
            rows="4"
            maxlength="1000"
          ></textarea>
          <div class="flex items-center justify-between mt-3 text-xs text-white/50">
            <span id="replyCharCount">0/1000</span>
            <div class="flex items-center gap-2">
              <button id="cancelReply" class="px-4 py-2 rounded-full text-white/60 hover:text-white hover:bg-white/5 transition">
                Zru≈°it
              </button>
              <button
                id="submitReply"
                class="px-6 py-2 rounded-full bg-gradient-to-r from-fuchsia-500 to-amber-400 text-neutral-950 font-semibold text-sm hover:shadow-[0_0_30px_rgba(236,72,153,0.5)] transition"
              >
                Odpovƒõdƒõt
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- MODAL ‚Äì nahl√°≈°en√≠ -->
      <div
        id="flagModal"
        class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50"
      >
        <div class="bg-neutral-950 border border-white/15 rounded-2xl p-6 max-w-md w-full mx-4 shadow-[0_0_40px_rgba(0,0,0,0.8)]">
          <h3 class="text-lg font-bold text-white mb-3">Nahl√°sit koment√°≈ô</h3>
          <p class="text-sm text-white/70 mb-4">Vyberte d≈Øvod, proƒç je koment√°≈ô probl√©mov√Ω.</p>
          <div class="space-y-2 mb-5 text-sm text-white/80">
            <label class="flex items-center gap-2">
              <input type="radio" name="flagReason" value="spam" class="accent-fuchsia-500" />
              <span>Spam nebo reklama</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="radio" name="flagReason" value="inappropriate" class="accent-fuchsia-500" />
              <span>Nevhodn√Ω obsah</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="radio" name="flagReason" value="harassment" class="accent-fuchsia-500" />
              <span>Obtƒõ≈æov√°n√≠ nebo √∫tok</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="radio" name="flagReason" value="misinformation" class="accent-fuchsia-500" />
              <span>Dezinformace</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="radio" name="flagReason" value="other" class="accent-fuchsia-500" />
              <span>Jin√Ω d≈Øvod</span>
            </label>
          </div>
          <div class="flex items-center gap-2">
            <button
              id="cancelFlag"
              class="flex-1 px-4 py-2 rounded-full border border-white/20 text-white/70 hover:text-white hover:bg-white/5 transition"
            >
              Zru≈°it
            </button>
            <button
              id="submitFlag"
              class="flex-1 px-4 py-2 rounded-full bg-red-600 text-white font-semibold text-sm hover:bg-red-500 transition"
            >
              Nahl√°sit
            </button>
          </div>
        </div>
      </div>

      <!-- TOAST -->
      <div
        id="toast"
        class="hidden fixed top-4 right-4 max-w-xs bg-emerald-500 text-white text-sm px-4 py-3 rounded-xl shadow-lg z-50 flex items-start gap-2"
      >
        <i data-lucide="check-circle" class="w-4 h-4 mt-0.5"></i>
        <span id="toastMessage">√öspƒõch!</span>
      </div>
    </main>

    <!-- FOOTER Kartao -->
    <footer class="border-t border-white/10 text-center text-white/60 py-8 text-sm mt-8">
      <div class="flex flex-col md:flex-row items-center justify-center gap-4 mb-3">
        <a href="ochrana-osobnich-udaju.html" class="hover:text-white">Ochrana osobn√≠ch √∫daj≈Ø</a>
        <span class="hidden md:block">‚Ä¢</span>
        <a href="obchodni-podminky.html" class="hover:text-white">Obchodn√≠ podm√≠nky</a>
        <span class="hidden md:block">‚Ä¢</span>
        <a href="kontakt.html" class="hover:text-white">Kontakt</a>
      </div>
      ¬© 2025 <i data-lucide="crown" class="inline w-4 h-4 text-amber-300 align-text-bottom"></i> Kartao.cz ‚Äì S√≠≈• influencer≈Ø a tv≈Ørc≈Ø
    </footer>
  </div>

  <script>
    let commentsSystem = null;
    let currentUserId = null;
    let currentCampaignId = 'demo-campaign-123';
    let comments = [];
    let currentEditingCommentId = null;
    let currentReplyingToCommentId = null;
    let currentFlaggingCommentId = null;

    document.addEventListener('DOMContentLoaded', async () => {
      console.log('üöÄ Inicializuji Comments System...');
      lucide.createIcons();

      try {
        commentsSystem = new CommentsSystem();
      } catch (e) {
        console.warn('CommentsSystem nen√≠ dostupn√Ω, pobƒõ≈æ√≠ pouze demo re≈æim.');
      }

      setupEventListeners();
      setupAuthStateListener();
      await loadComments();
    });

    function setupAuthStateListener() {
      if (firebase?.auth) {
        firebase.auth().onAuthStateChanged((user) => {
          currentUserId = user?.uid || null;
          updateUIForAuthState(user);
        });
      } else {
        // fallback ‚Äì demo u≈æivatel nen√≠ automaticky p≈ôihl√°≈°en
        updateUIForAuthState(null);
      }
    }

    function updateUIForAuthState(user) {
      const loginPrompt = document.getElementById('loginPrompt');
      const commentEditor = document.getElementById('commentEditor');
      const currentUserAvatar = document.getElementById('currentUserAvatar');

      if (user) {
        loginPrompt.classList.add('hidden');
        commentEditor.classList.remove('hidden');

        const initial = (user.displayName || user.email || 'U').charAt(0).toUpperCase();
        if (user.photoURL) {
          currentUserAvatar.innerHTML = `<img src="${user.photoURL}" alt="${user.displayName || ''}" class="w-full h-full rounded-full object-cover" />`;
        } else {
          currentUserAvatar.innerHTML = `<div class="w-full h-full rounded-full bg-gradient-to-br from-fuchsia-500 to-amber-400 text-neutral-950 flex items-center justify-center font-semibold">${initial}</div>`;
        }
      } else {
        loginPrompt.classList.remove('hidden');
        commentEditor.classList.add('hidden');
      }
    }

    function setupEventListeners() {
      // Login (demo)
      document.getElementById('loginBtn').addEventListener('click', simulateLogin);

      // Koment√°≈ô
      document.getElementById('submitComment').addEventListener('click', submitComment);
      document.getElementById('cancelComment').addEventListener('click', cancelComment);
      document.getElementById('commentTextarea').addEventListener('input', updateCharCount);

      // Edit
      document.getElementById('editCommentTextarea').addEventListener('input', updateEditCharCount);
      document.getElementById('cancelEdit').addEventListener('click', closeEditModal);
      document.getElementById('saveEdit').addEventListener('click', saveEdit);

      // Reply
      document.getElementById('replyTextarea').addEventListener('input', updateReplyCharCount);
      document.getElementById('cancelReply').addEventListener('click', closeReplyModal);
      document.getElementById('submitReply').addEventListener('click', submitReply);

      // Flag
      document.getElementById('cancelFlag').addEventListener('click', closeFlagModal);
      document.getElementById('submitFlag').addEventListener('click', submitFlag);

      // ≈òazen√≠ + hled√°n√≠
      document.getElementById('commentSort').addEventListener('change', sortComments);
      document.getElementById('toggleCommentSearch').addEventListener('click', toggleSearch);
      document.getElementById('commentSearchInput').addEventListener('input', searchComments);
      document.getElementById('clearSearch').addEventListener('click', clearSearch);
    }

    async function simulateLogin() {
      try {
        const mockUser = {
          uid: 'demo-user-' + Date.now(),
          displayName: 'Demo u≈æivatel',
          email: 'demo@kartao.cz',
          photoURL:
            'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=100&h=100&fit=crop&crop=face',
        };

        currentUserId = mockUser.uid;
        updateUIForAuthState(mockUser);
        showToast('√öspƒõ≈°nƒõ p≈ôihl√°≈°en (demo re≈æim).', 'success');
      } catch (error) {
        console.error('‚ùå Chyba p≈ôi simulaci p≈ôihl√°≈°en√≠:', error);
        showToast('Chyba p≈ôi p≈ôihl√°≈°en√≠', 'error');
      }
    }

    async function loadComments() {
      showLoading(true);
      try {
        if (commentsSystem) {
          comments = await commentsSystem.getComments(currentCampaignId, {
            sortBy: 'timestamp',
            sortOrder: 'desc',
            limit: 20,
          });
        }

        if (!comments || comments.length === 0) {
          displayDemoComments();
        } else {
          displayComments(comments);
          updateCommentCount(comments.length);
        }
      } catch (error) {
        console.error('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ koment√°≈ô≈Ø:', error);
        displayDemoComments();
      } finally {
        showLoading(false);
      }
    }

    function displayDemoComments() {
      const demoComments = [
        {
          id: 'demo-1',
          content:
            'Skvƒõl√° kampa≈à! Koneƒçnƒõ nƒõkdo, kdo se zamƒõ≈ôuje na skuteƒçnƒõ udr≈æiteln√© produkty. Urƒçitƒõ budu sledovat dal≈°√≠ spolupr√°ce.',
          authorName: 'Ekonad≈°enec',
          timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000),
          likes: 12,
          dislikes: 1,
          likedBy: [],
          dislikedBy: [],
          replies: [
            {
              id: 'demo-1-reply-1',
              content: 'Souhlas√≠m, tohle je p≈ôesnƒõ smƒõr, kter√Ωm by se znaƒçky mƒõly ub√≠rat.',
              authorName: 'ZeroWasteGuru',
              timestamp: new Date(Date.now() - 1.5 * 60 * 60 * 1000),
              likes: 3,
              parentCommentId: 'demo-1',
            },
          ],
        },
        {
          id: 'demo-2',
          content:
            'M√°m zku≈°enosti s podobn√Ωmi produkty. Bylo by super, kdyby p≈ôibyly i re√°ln√© recenze od lid√≠, ne jen influencer≈Ø.',
          authorName: 'Praktick√°M√°ma',
          timestamp: new Date(Date.now() - 4 * 60 * 60 * 1000),
          likes: 8,
          dislikes: 0,
          likedBy: [],
          dislikedBy: [],
          replies: [],
        },
        {
          id: 'demo-3',
          content:
            'Zaj√≠mav√©, ale chyb√≠ mi konkr√©tn√≠ data o dopadu na ≈æivotn√≠ prost≈ôed√≠. M√°te nƒõjak√© studie nebo ƒç√≠sla?',
          authorName: 'DataAnalyst2025',
          timestamp: new Date(Date.now() - 6 * 60 * 60 * 1000),
          likes: 15,
          dislikes: 2,
          likedBy: [],
          dislikedBy: [],
          replies: [],
        },
      ];

      comments = demoComments;
      displayComments(comments);
      updateCommentCount(comments.length);
    }

    function displayComments(commentsToShow) {
      const container = document.getElementById('commentsList');
      const noMsg = document.getElementById('noCommentsMessage');

      if (!commentsToShow || commentsToShow.length === 0) {
        container.classList.add('hidden');
        noMsg.classList.remove('hidden');
        return;
      }

      container.classList.remove('hidden');
      noMsg.classList.add('hidden');

      container.innerHTML = commentsToShow.map((c) => createCommentHTML(c)).join('');
      lucide.createIcons();
    }

    function createCommentHTML(comment) {
      const timeAgo = getTimeAgo(comment.timestamp);
      const avatarUrl =
        comment.authorAvatar ||
        `https://ui-avatars.io/api/?name=${encodeURIComponent(comment.authorName)}&background=random&color=ffffff`;

      const repliesCount = comment.replies?.length || 0;

      return `
        <div class="comment-item border border-white/10 rounded-2xl p-5 bg-neutral-900/70 hover:bg-neutral-900/90 transition" data-comment-id="${
          comment.id
        }">
          <div class="flex items-start gap-4">
            <div class="w-11 h-11 rounded-full overflow-hidden flex-shrink-0 ring-2 ring-amber-300/60">
              <img src="${avatarUrl}" alt="${comment.authorName}" class="w-full h-full object-cover" />
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-start justify-between gap-2 mb-2">
                <div class="flex flex-wrap items-center gap-2">
                  <h4 class="font-semibold text-sm text-white">${comment.authorName}</h4>
                  <span class="text-xs text-white/50">${timeAgo}</span>
                  ${comment.isEdited ? '<span class="text-[11px] text-white/40">(upraveno)</span>' : ''}
                </div>
                <div class="relative">
                  <button class="comment-menu-btn text-white/40 hover:text-white/80 transition" onclick="toggleCommentMenu('${
                    comment.id
                  }')">
                    <i data-lucide="more-horizontal" class="w-4 h-4"></i>
                  </button>
                  <div id="menu-${
                    comment.id
                  }" class="hidden absolute right-0 mt-2 w-40 bg-neutral-950 border border-white/10 rounded-xl shadow-xl text-xs text-white/80 z-20">
                    ${
                      currentUserId && currentUserId === comment.authorId
                        ? `<button onclick="editComment('${comment.id}')" class="block w-full text-left px-3 py-2 hover:bg-white/5">Upravit</button>
                           <button onclick="deleteComment('${comment.id}')" class="block w-full text-left px-3 py-2 text-red-400 hover:bg-white/5">Smazat</button>`
                        : ''
                    }
                    <button onclick="flagComment('${comment.id}')" class="block w-full text-left px-3 py-2 hover:bg-white/5">Nahl√°sit</button>
                    <button onclick="shareComment('${comment.id}')" class="block w-full text-left px-3 py-2 hover:bg-white/5">Sd√≠let</button>
                  </div>
                </div>
              </div>

              <div class="text-sm text-white/90 leading-relaxed whitespace-pre-wrap mb-3">${comment.content}</div>

              <div class="flex items-center justify-between gap-3 text-xs">
                <div class="flex items-center gap-3">
                  <button class="flex items-center gap-1 text-white/60 hover:text-emerald-300 transition ${
                    comment.likedBy?.includes(currentUserId) ? 'text-emerald-300' : ''
                  }" onclick="toggleLike('${comment.id}')">
                    <i data-lucide="thumbs-up" class="w-3.5 h-3.5"></i>
                    <span>${comment.likes || 0}</span>
                  </button>
                  <button class="flex items-center gap-1 text-white/60 hover:text-rose-300 transition ${
                    comment.dislikedBy?.includes(currentUserId) ? 'text-rose-300' : ''
                  }" onclick="toggleDislike('${comment.id}')">
                    <i data-lucide="thumbs-down" class="w-3.5 h-3.5"></i>
                    <span>${comment.dislikes || 0}</span>
                  </button>
                  <button class="flex items-center gap-1 text-white/60 hover:text-fuchsia-300 transition" onclick="replyToComment('${
                    comment.id
                  }')">
                    <i data-lucide="reply" class="w-3.5 h-3.5"></i>
                    <span>Odpovƒõdƒõt</span>
                  </button>
                </div>
                <div class="flex items-center gap-2 text-white/50">
                  ${
                    repliesCount > 0
                      ? `<button class="hover:text-white/80" onclick="toggleReplies('${comment.id}')">${repliesCount} ${{
                          1: 'odpovƒõƒè',
                          2: 'odpovƒõdi',
                          3: 'odpovƒõdi',
                          4: 'odpovƒõdi',
                        }[repliesCount] || 'odpovƒõd√≠'}</button>`
                      : ''
                  }
                </div>
              </div>

              ${
                repliesCount > 0
                  ? `<div id="replies-${comment.id}" class="mt-4 ml-3 pl-4 border-l border-white/10 space-y-3">
                      ${comment.replies.map((r) => createReplyHTML(r)).join('')}
                     </div>`
                  : ''
              }
            </div>
          </div>
        </div>
      `;
    }

    function createReplyHTML(reply) {
      const timeAgo = getTimeAgo(reply.timestamp);
      const avatarUrl =
        reply.authorAvatar ||
        `https://ui-avatars.io/api/?name=${encodeURIComponent(reply.authorName)}&background=random&color=ffffff`;

      return `
        <div class="flex items-start gap-3 text-xs">
          <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0 ring-1 ring-amber-200/60">
            <img src="${avatarUrl}" alt="${reply.authorName}" class="w-full h-full object-cover" />
          </div>
          <div class="flex-1">
            <div class="flex items-center gap-2 mb-1">
              <span class="font-semibold text-white/90">${reply.authorName}</span>
              <span class="text-[11px] text-white/50">${timeAgo}</span>
            </div>
            <p class="text-white/80 leading-relaxed mb-1">${reply.content}</p>
            <div class="flex items-center gap-3 text-[11px] text-white/60">
              <button class="flex items-center gap-1 hover:text-emerald-300" onclick="toggleReplyLike('${reply.id}')">
                <i data-lucide="thumbs-up" class="w-3 h-3"></i>
                <span>${reply.likes || 0}</span>
              </button>
              <button class="hover:text-fuchsia-300" onclick="replyToComment('${reply.parentCommentId}')">Odpovƒõdƒõt</button>
            </div>
          </div>
        </div>
      `;
    }

    async function submitComment() {
      const textarea = document.getElementById('commentTextarea');
      const content = textarea.value.trim();

      if (!content) {
        showToast('Koment√°≈ô nesm√≠ b√Ωt pr√°zdn√Ω.', 'error');
        return;
      }
      if (!currentUserId) {
        showToast('Pro komentov√°n√≠ se mus√≠te p≈ôihl√°sit.', 'error');
        return;
      }

      try {
        const newComment = {
          id: 'local-' + Date.now(),
          content,
          authorName: 'Demo u≈æivatel',
          authorId: currentUserId,
          timestamp: new Date(),
          likes: 0,
          dislikes: 0,
          likedBy: [],
          dislikedBy: [],
          replies: [],
        };

        comments.unshift(newComment);
        displayComments(comments);
        updateCommentCount(comments.length);

        textarea.value = '';
        updateCharCount();
        showToast('Koment√°≈ô byl p≈ôid√°n.', 'success');
      } catch (error) {
        console.error('‚ùå Chyba p≈ôi p≈ôid√°v√°n√≠ koment√°≈ôe:', error);
        showToast('Chyba p≈ôi p≈ôid√°v√°n√≠ koment√°≈ôe.', 'error');
      }
    }

    function cancelComment() {
      const textarea = document.getElementById('commentTextarea');
      textarea.value = '';
      updateCharCount();
    }

    function updateCharCount() {
      const textarea = document.getElementById('commentTextarea');
      const charCount = document.getElementById('charCount');
      charCount.textContent = `${textarea.value.length}/1000`;
    }

    function updateEditCharCount() {
      const textarea = document.getElementById('editCommentTextarea');
      const charCount = document.getElementById('editCharCount');
      charCount.textContent = `${textarea.value.length}/1000`;
    }

    function updateReplyCharCount() {
      const textarea = document.getElementById('replyTextarea');
      const charCount = document.getElementById('replyCharCount');
      charCount.textContent = `${textarea.value.length}/1000`;
    }

    function updateCommentCount(count) {
      document.getElementById('totalCommentsCount').textContent = `(${count})`;
      document.getElementById('campaignCommentCount').innerHTML = `<i data-lucide="message-square" class="w-4 h-4 mr-1"></i> ${count} koment√°≈ô≈Ø`;
      lucide.createIcons();
    }

    function sortComments() {
      const sortBy = document.getElementById('commentSort').value;
      let sorted = [...comments];

      if (sortBy === 'newest') {
        sorted.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      } else if (sortBy === 'oldest') {
        sorted.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      } else if (sortBy === 'popular') {
        sorted.sort((a, b) => (b.likes || 0) - (a.likes || 0));
      }

      displayComments(sorted);
    }

    function toggleSearch() {
      const bar = document.getElementById('commentSearchBar');
      bar.classList.toggle('hidden');
      if (!bar.classList.contains('hidden')) {
        document.getElementById('commentSearchInput').focus();
      }
    }

    function searchComments() {
      const term = document.getElementById('commentSearchInput').value.toLowerCase();
      if (!term) {
        displayComments(comments);
        return;
      }

      const filtered = comments.filter(
        (c) =>
          c.content.toLowerCase().includes(term) ||
          (c.authorName && c.authorName.toLowerCase().includes(term))
      );
      displayComments(filtered);
    }

    function clearSearch() {
      document.getElementById('commentSearchInput').value = '';
      displayComments(comments);
    }

    function toggleCommentMenu(commentId) {
      const menu = document.getElementById(`menu-${commentId}`);
      document.querySelectorAll('[id^="menu-"]').forEach((m) => {
        if (m !== menu) m.classList.add('hidden');
      });
      menu.classList.toggle('hidden');
    }

    function editComment(commentId) {
      const comment = comments.find((c) => c.id === commentId);
      if (!comment) return;
      currentEditingCommentId = commentId;
      document.getElementById('editCommentTextarea').value = comment.content;
      updateEditCharCount();
      document.getElementById('editCommentModal').classList.remove('hidden');
      document.getElementById(`menu-${commentId}`).classList.add('hidden');
    }

    function closeEditModal() {
      document.getElementById('editCommentModal').classList.add('hidden');
      currentEditingCommentId = null;
    }

    async function saveEdit() {
      const content = document.getElementById('editCommentTextarea').value.trim();
      if (!content) {
        showToast('Koment√°≈ô nesm√≠ b√Ωt pr√°zdn√Ω.', 'error');
        return;
      }

      const comment = comments.find((c) => c.id === currentEditingCommentId);
      if (comment) {
        comment.content = content;
        comment.isEdited = true;
        displayComments(comments);
        closeEditModal();
        showToast('Koment√°≈ô byl upraven.', 'success');
      }
    }

    function deleteComment(commentId) {
      if (!confirm('Opravdu chcete koment√°≈ô smazat?')) return;
      comments = comments.filter((c) => c.id !== commentId);
      displayComments(comments);
      updateCommentCount(comments.length);
      showToast('Koment√°≈ô byl smaz√°n.', 'success');
    }

    function replyToComment(commentId) {
      const comment = comments.find((c) => c.id === commentId);
      if (!comment) return;
      if (!currentUserId) {
        showToast('Pro odpovƒõƒè se mus√≠te p≈ôihl√°sit.', 'error');
        return;
      }

      currentReplyingToCommentId = commentId;
      document.getElementById('replyToComment').innerHTML = `
        <div class="text-xs text-white/70">
          <div class="font-semibold mb-1">${comment.authorName}</div>
          <div class="text-white/80">${comment.content.substring(0, 140)}${
        comment.content.length > 140 ? '‚Ä¶' : ''
      }</div>
        </div>
      `;
      document.getElementById('replyTextarea').value = '';
      updateReplyCharCount();
      document.getElementById('replyModal').classList.remove('hidden');
    }

    function closeReplyModal() {
      document.getElementById('replyModal').classList.add('hidden');
      currentReplyingToCommentId = null;
    }

    async function submitReply() {
      const textarea = document.getElementById('replyTextarea');
      const content = textarea.value.trim();
      if (!content) {
        showToast('Odpovƒõƒè nesm√≠ b√Ωt pr√°zdn√°.', 'error');
        return;
      }
      if (!currentUserId) {
        showToast('Pro odpovƒõƒè se mus√≠te p≈ôihl√°sit.', 'error');
        return;
      }

      const parent = comments.find((c) => c.id === currentReplyingToCommentId);
      if (!parent) return;

      const reply = {
        id: 'reply-' + Date.now(),
        content,
        authorName: 'Demo u≈æivatel',
        authorId: currentUserId,
        timestamp: new Date(),
        likes: 0,
        parentCommentId: parent.id,
      };

      if (!parent.replies) parent.replies = [];
      parent.replies.push(reply);

      displayComments(comments);
      closeReplyModal();
      showToast('Odpovƒõƒè byla p≈ôid√°na.', 'success');
    }

    function flagComment(commentId) {
      currentFlaggingCommentId = commentId;
      document.querySelectorAll('input[name="flagReason"]').forEach((r) => (r.checked = false));
      document.getElementById('flagModal').classList.remove('hidden');
      const menu = document.getElementById(`menu-${commentId}`);
      if (menu) menu.classList.add('hidden');
    }

    function closeFlagModal() {
      document.getElementById('flagModal').classList.add('hidden');
      currentFlaggingCommentId = null;
    }

    function submitFlag() {
      const selected = document.querySelector('input[name="flagReason"]:checked');
      if (!selected) {
        showToast('Vyberte pros√≠m d≈Øvod nahl√°≈°en√≠.', 'error');
        return;
      }
      closeFlagModal();
      showToast('Koment√°≈ô byl nahl√°≈°en moder√°tor≈Øm.', 'success');
    }

    function toggleReplies(commentId) {
      const el = document.getElementById(`replies-${commentId}`);
      if (!el) return;
      el.classList.toggle('hidden');
    }

    function toggleLike(commentId) {
      const comment = comments.find((c) => c.id === commentId);
      if (!comment || !currentUserId) {
        showToast('Pro hodnocen√≠ se mus√≠te p≈ôihl√°sit.', 'error');
        return;
      }

      comment.likedBy = comment.likedBy || [];
      comment.dislikedBy = comment.dislikedBy || [];
      comment.likes = comment.likes || 0;
      comment.dislikes = comment.dislikes || 0;

      if (comment.likedBy.includes(currentUserId)) {
        comment.likedBy = comment.likedBy.filter((id) => id !== currentUserId);
        comment.likes--;
      } else {
        comment.likedBy.push(currentUserId);
        comment.likes++;
        if (comment.dislikedBy.includes(currentUserId)) {
          comment.dislikedBy = comment.dislikedBy.filter((id) => id !== currentUserId);
          comment.dislikes--;
        }
      }
      displayComments(comments);
    }

    function toggleDislike(commentId) {
      const comment = comments.find((c) => c.id === commentId);
      if (!comment || !currentUserId) {
        showToast('Pro hodnocen√≠ se mus√≠te p≈ôihl√°sit.', 'error');
        return;
      }

      comment.likedBy = comment.likedBy || [];
      comment.dislikedBy = comment.dislikedBy || [];
      comment.likes = comment.likes || 0;
      comment.dislikes = comment.dislikes || 0;

      if (comment.dislikedBy.includes(currentUserId)) {
        comment.dislikedBy = comment.dislikedBy.filter((id) => id !== currentUserId);
        comment.dislikes--;
      } else {
        comment.dislikedBy.push(currentUserId);
        comment.dislikes++;
        if (comment.likedBy.includes(currentUserId)) {
          comment.likedBy = comment.likedBy.filter((id) => id !== currentUserId);
          comment.likes--;
        }
      }
      displayComments(comments);
    }

    function toggleReplyLike(replyId) {
      // Jednoduch√© lok√°ln√≠ +1/-1 bez vazby na u≈æivatele
      for (const c of comments) {
        if (!c.replies) continue;
        const r = c.replies.find((x) => x.id === replyId);
        if (r) {
          r.likes = (r.likes || 0) + 1;
          break;
        }
      }
      displayComments(comments);
    }

    function shareComment(commentId) {
      const url = window.location.href.split('#')[0] + `#comment-${commentId}`;
      if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(() => {
          showToast('Odkaz na koment√°≈ô byl zkop√≠rov√°n.', 'success');
        });
      } else {
        showToast('Kop√≠rov√°n√≠ odkazu nen√≠ podporov√°no v tomto prohl√≠≈æeƒçi.', 'error');
      }
    }

    function getTimeAgo(timestamp) {
      const t = timestamp instanceof Date ? timestamp : new Date(timestamp);
      const diffMs = Date.now() - t.getTime();
      const diffMin = Math.floor(diffMs / 60000);
      if (diffMin < 1) return 'pr√°vƒõ teƒè';
      if (diffMin < 60) return `${diffMin} min zpƒõt`;
      const diffH = Math.floor(diffMin / 60);
      if (diffH < 24) return `${diffH} h zpƒõt`;
      const diffD = Math.floor(diffH / 24);
      if (diffD < 7) return `${diffD} d zpƒõt`;
      return t.toLocaleDateString('cs-CZ');
    }

    function showLoading(show) {
      const loading = document.getElementById('commentsLoading');
      if (show) loading.classList.remove('hidden');
      else loading.classList.add('hidden');
    }

    let toastTimeout = null;
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const msg = document.getElementById('toastMessage');
      msg.textContent = message;

      toast.classList.remove('hidden');
      toast.classList.remove('bg-emerald-500', 'bg-red-500');
      toast.classList.add(type === 'error' ? 'bg-red-500' : 'bg-emerald-500');
      lucide.createIcons();

      if (toastTimeout) clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => {
        toast.classList.add('hidden');
      }, 2500);
    }
  </script>
</body>
</html>
