<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syst√©m koment√°≈ô≈Ø - Demo - Kartao.cz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="firebase-init.js"></script>
    <script src="comments-system.js"></script>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 text-white py-8">
            <div class="max-w-4xl mx-auto px-6">
                <h1 class="text-4xl font-bold mb-2 flex items-center">
                    <i data-lucide="message-square" class="w-10 h-10 mr-4"></i>
                    Syst√©m Koment√°≈ô≈Ø
                </h1>
                <p class="text-xl text-purple-100">Komunikuj s komunitou a sd√≠lej n√°zory na kampanƒõ</p>
            </div>
        </div>

        <!-- Demo Campaign Info -->
        <div class="max-w-4xl mx-auto px-6 py-8">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex items-start space-x-4">
                    <img src="https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?w=100&h=100&fit=crop&crop=face" 
                         alt="Campaign" class="w-20 h-20 rounded-xl object-cover">
                    <div class="flex-1">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Demo Kampa≈à: Ekologick√© produkty 2025</h2>
                        <p class="text-gray-600 mb-4">Propagace udr≈æiteln√Ωch produkt≈Ø pro mlad√© lidi zamƒõ≈ôen√© na zero waste a eco-friendly ≈æivotn√≠ styl.</p>
                        <div class="flex items-center space-x-6 text-sm text-gray-500">
                            <span class="flex items-center"><i data-lucide="user" class="w-4 h-4 mr-1"></i> EcoInfluencer</span>
                            <span class="flex items-center"><i data-lucide="calendar" class="w-4 h-4 mr-1"></i> 15. 11. 2025</span>
                            <span class="flex items-center"><i data-lucide="eye" class="w-4 h-4 mr-1"></i> 1,234 zobrazen√≠</span>
                            <span id="campaignCommentCount" class="flex items-center"><i data-lucide="message-square" class="w-4 h-4 mr-1"></i> 0 koment√°≈ô≈Ø</span>
                        </div>
                    </div>
                    <button class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
                        Sledovat
                    </button>
                </div>
            </div>

            <!-- Comments Section -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <!-- Comment Form -->
                <div id="commentForm" class="mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i data-lucide="edit-3" class="w-5 h-5 mr-2"></i>
                        P≈ôidat koment√°≈ô
                    </h3>
                    
                    <div id="loginPrompt" class="text-center py-8 border-2 border-dashed border-gray-300 rounded-lg">
                        <div class="text-4xl mb-4">üë§</div>
                        <h4 class="text-lg font-semibold text-gray-800 mb-2">P≈ôihlaste se pro komentov√°n√≠</h4>
                        <p class="text-gray-600 mb-4">Pro p≈ôid√°n√≠ koment√°≈ôe se mus√≠te p≈ôihl√°sit do sv√©ho √∫ƒçtu.</p>
                        <button id="loginBtn" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition">
                            P≈ôihl√°sit se
                        </button>
                    </div>

                    <div id="commentEditor" class="hidden">
                        <div class="flex items-start space-x-4">
                            <div id="currentUserAvatar" class="w-12 h-12 bg-gray-300 rounded-full flex-shrink-0">
                                <!-- User avatar will be inserted here -->
                            </div>
                            <div class="flex-1">
                                <textarea 
                                    id="commentTextarea" 
                                    placeholder="Napi≈°te sv≈Øj koment√°≈ô..."
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    rows="4"
                                    maxlength="1000"></textarea>
                                <div class="flex items-center justify-between mt-3">
                                    <div class="flex items-center space-x-4 text-sm text-gray-500">
                                        <span id="charCount">0/1000</span>
                                        <div class="flex items-center space-x-2">
                                            <input type="checkbox" id="notifyReplies" class="rounded">
                                            <label for="notifyReplies">Notifikovat o odpovƒõd√≠ch</label>
                                        </div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button id="cancelComment" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition">
                                            Zru≈°it
                                        </button>
                                        <button id="submitComment" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition disabled:opacity-50">
                                            Publikovat
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comment Filter and Sort -->
                <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-200">
                    <div class="flex items-center space-x-4">
                        <h3 class="text-lg font-semibold text-gray-800">Koment√°≈ôe</h3>
                        <span id="totalCommentsCount" class="text-sm text-gray-500">(0)</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <select id="commentSort" class="text-sm border border-gray-300 rounded-lg px-3 py-1 focus:ring-2 focus:ring-purple-500">
                            <option value="newest">Nejnovƒõj≈°√≠</option>
                            <option value="oldest">Nejstar≈°√≠</option>
                            <option value="popular">Nejobl√≠benƒõj≈°√≠</option>
                        </select>
                        <button id="toggleCommentSearch" class="text-gray-600 hover:text-purple-600 transition">
                            <i data-lucide="search" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <!-- Search Bar (Hidden by default) -->
                <div id="commentSearchBar" class="hidden mb-6">
                    <div class="relative">
                        <input 
                            type="text" 
                            id="commentSearchInput" 
                            placeholder="Hledat v koment√°≈ô√≠ch..."
                            class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <i data-lucide="search" class="w-5 h-5 text-gray-400 absolute left-3 top-3.5"></i>
                        <button id="clearSearch" class="absolute right-3 top-3 text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <!-- Comments List -->
                <div id="commentsList" class="space-y-6">
                    <!-- Comments will be populated here -->
                </div>

                <!-- Load More Comments -->
                <div id="loadMoreSection" class="hidden text-center mt-8">
                    <button id="loadMoreBtn" class="bg-gray-100 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-200 transition">
                        Naƒç√≠st v√≠ce koment√°≈ô≈Ø
                    </button>
                </div>

                <!-- No Comments Message -->
                <div id="noCommentsMessage" class="text-center py-12">
                    <div class="text-6xl mb-4">üí¨</div>
                    <h3 class="text-xl font-bold text-gray-700 mb-2">Zat√≠m ≈æ√°dn√© koment√°≈ôe</h3>
                    <p class="text-gray-600">Buƒète prvn√≠, kdo okomentuje tuto kampa≈à!</p>
                </div>

                <!-- Loading State -->
                <div id="commentsLoading" class="hidden text-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-4"></div>
                    <p class="text-gray-600">Naƒç√≠t√°m koment√°≈ôe...</p>
                </div>
            </div>
        </div>

        <!-- Comment Modal for Editing -->
        <div id="editCommentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 max-w-lg w-full mx-4">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Upravit koment√°≈ô</h3>
                <textarea 
                    id="editCommentTextarea" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-purple-500"
                    rows="4"
                    maxlength="1000"></textarea>
                <div class="flex items-center justify-between mt-4">
                    <span id="editCharCount" class="text-sm text-gray-500">0/1000</span>
                    <div class="flex space-x-3">
                        <button id="cancelEdit" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition">
                            Zru≈°it
                        </button>
                        <button id="saveEdit" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition">
                            Ulo≈æit
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reply Modal -->
        <div id="replyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 max-w-lg w-full mx-4">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Odpovƒõdƒõt na koment√°≈ô</h3>
                <div id="replyToComment" class="bg-gray-50 rounded-lg p-4 mb-4">
                    <!-- Original comment will be shown here -->
                </div>
                <textarea 
                    id="replyTextarea" 
                    placeholder="Napi≈°te svou odpovƒõƒè..."
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-purple-500"
                    rows="4"
                    maxlength="1000"></textarea>
                <div class="flex items-center justify-between mt-4">
                    <span id="replyCharCount" class="text-sm text-gray-500">0/1000</span>
                    <div class="flex space-x-3">
                        <button id="cancelReply" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition">
                            Zru≈°it
                        </button>
                        <button id="submitReply" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition">
                            Odpovƒõdƒõt
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Flag Comment Modal -->
        <div id="flagModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Nahl√°sit koment√°≈ô</h3>
                <p class="text-gray-600 mb-4">Proƒç chcete nahl√°sit tento koment√°≈ô?</p>
                <div class="space-y-3 mb-6">
                    <label class="flex items-center">
                        <input type="radio" name="flagReason" value="spam" class="mr-3">
                        <span>Spam nebo reklama</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="flagReason" value="inappropriate" class="mr-3">
                        <span>Nevhodn√Ω obsah</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="flagReason" value="harassment" class="mr-3">
                        <span>Obtƒõ≈æov√°n√≠</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="flagReason" value="misinformation" class="mr-3">
                        <span>Dezinformace</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="flagReason" value="other" class="mr-3">
                        <span>Jin√Ω d≈Øvod</span>
                    </label>
                </div>
                <div class="flex space-x-3">
                    <button id="cancelFlag" class="flex-1 px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                        Zru≈°it
                    </button>
                    <button id="submitFlag" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">
                        Nahl√°sit
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div id="toast" class="hidden fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50">
            <span id="toastMessage">√öspƒõch!</span>
        </div>
    </div>

    <script>
        let commentsSystem = null;
        let currentUserId = null;
        let currentCampaignId = 'demo-campaign-123';
        let comments = [];
        let currentEditingCommentId = null;
        let currentReplyingToCommentId = null;
        let currentFlaggingCommentId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Inicializuji Comments System...');
            
            lucide.createIcons();
            commentsSystem = new CommentsSystem();
            
            setupEventListeners();
            setupAuthStateListener();
            
            // Naƒç√≠st koment√°≈ôe
            await loadComments();
        });

        function setupAuthStateListener() {
            firebase.auth().onAuthStateChanged(user => {
                currentUserId = user?.uid;
                updateUIForAuthState(user);
            });
        }

        function updateUIForAuthState(user) {
            const loginPrompt = document.getElementById('loginPrompt');
            const commentEditor = document.getElementById('commentEditor');
            const currentUserAvatar = document.getElementById('currentUserAvatar');

            if (user) {
                loginPrompt.classList.add('hidden');
                commentEditor.classList.remove('hidden');
                
                // Nastavit avatar u≈æivatele
                if (user.photoURL) {
                    currentUserAvatar.innerHTML = `<img src="${user.photoURL}" alt="${user.displayName}" class="w-full h-full rounded-full object-cover">`;
                } else {
                    currentUserAvatar.innerHTML = `<div class="w-full h-full rounded-full bg-purple-500 text-white flex items-center justify-center font-semibold">${(user.displayName || 'U').charAt(0).toUpperCase()}</div>`;
                }
            } else {
                loginPrompt.classList.remove('hidden');
                commentEditor.classList.add('hidden');
            }
        }

        function setupEventListeners() {
            // Login
            document.getElementById('loginBtn').addEventListener('click', simulateLogin);
            
            // Comment submission
            document.getElementById('submitComment').addEventListener('click', submitComment);
            document.getElementById('cancelComment').addEventListener('click', cancelComment);
            
            // Character counting
            document.getElementById('commentTextarea').addEventListener('input', updateCharCount);
            document.getElementById('editCommentTextarea').addEventListener('input', updateEditCharCount);
            document.getElementById('replyTextarea').addEventListener('input', updateReplyCharCount);
            
            // Sorting and searching
            document.getElementById('commentSort').addEventListener('change', sortComments);
            document.getElementById('toggleCommentSearch').addEventListener('click', toggleSearch);
            document.getElementById('commentSearchInput').addEventListener('input', searchComments);
            document.getElementById('clearSearch').addEventListener('click', clearSearch);
            
            // Modal controls
            document.getElementById('cancelEdit').addEventListener('click', closeEditModal);
            document.getElementById('saveEdit').addEventListener('click', saveEdit);
            document.getElementById('cancelReply').addEventListener('click', closeReplyModal);
            document.getElementById('submitReply').addEventListener('click', submitReply);
            document.getElementById('cancelFlag').addEventListener('click', closeFlagModal);
            document.getElementById('submitFlag').addEventListener('click', submitFlag);
        }

        async function simulateLogin() {
            try {
                // Simulace p≈ôihl√°≈°en√≠ pro demo
                const mockUser = {
                    uid: 'demo-user-' + Date.now(),
                    displayName: 'Demo U≈æivatel',
                    email: 'demo@kartao.cz',
                    photoURL: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=100&h=100&fit=crop&crop=face'
                };
                
                currentUserId = mockUser.uid;
                updateUIForAuthState(mockUser);
                showToast('√öspƒõ≈°nƒõ p≈ôihl√°≈°en!', 'success');
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi simulaci p≈ôihl√°≈°en√≠:', error);
                showToast('Chyba p≈ôi p≈ôihl√°≈°en√≠', 'error');
            }
        }

        async function loadComments() {
            showLoading(true);
            
            try {
                comments = await commentsSystem.getComments(currentCampaignId, {
                    sortBy: 'timestamp',
                    sortOrder: 'desc',
                    limit: 20
                });
                
                displayComments(comments);
                updateCommentCount(comments.length);
                
                console.log(`üí¨ Naƒçteno ${comments.length} koment√°≈ô≈Ø`);
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ koment√°≈ô≈Ø:', error);
                // Zobrazit demo koment√°≈ôe pro uk√°zku
                displayDemoComments();
            } finally {
                showLoading(false);
            }
        }

        function displayDemoComments() {
            const demoComments = [
                {
                    id: 'demo-1',
                    content: 'Skvƒõl√° kampa≈à! Koneƒçnƒõ nƒõkdo, kdo se zamƒõ≈ôuje na skuteƒçnƒõ udr≈æiteln√© produkty. Urƒçitƒõ budu sledovat dal≈°√≠ ƒçl√°nky.',
                    authorName: 'Ekonad≈°enec',
                    timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000), // 2 hours ago
                    likes: 12,
                    dislikes: 1,
                    likedBy: [],
                    dislikedBy: [],
                    replies: [
                        {
                            id: 'demo-1-reply-1',
                            content: 'Souhlas√≠m! Tento smƒõr je p≈ôesnƒõ to, co pot≈ôebujeme.',
                            authorName: 'ZeroWasteGuru',
                            timestamp: new Date(Date.now() - 1.5 * 60 * 60 * 1000),
                            likes: 3,
                            dislikes: 0
                        }
                    ]
                },
                {
                    id: 'demo-2', 
                    content: 'M√°m zku≈°enosti s podobn√Ωmi produkty. Bylo by super, kdybyste p≈ôidali i sekci s recenzemi od bƒõ≈æn√Ωch u≈æivatel≈Ø, ne jen influencer≈Ø.',
                    authorName: 'Praktick√°M√°ma',
                    timestamp: new Date(Date.now() - 4 * 60 * 60 * 1000), // 4 hours ago
                    likes: 8,
                    dislikes: 0,
                    likedBy: [],
                    dislikedBy: [],
                    replies: []
                },
                {
                    id: 'demo-3',
                    content: 'Zaj√≠mav√©, ale chyb√≠ mi konkr√©tn√≠ data o dopadu na ≈æivotn√≠ prost≈ôed√≠. M√°te k tomu nƒõjak√© studie?',
                    authorName: 'DataAnalyst2025',
                    timestamp: new Date(Date.now() - 6 * 60 * 60 * 1000), // 6 hours ago
                    likes: 15,
                    dislikes: 2,
                    likedBy: [],
                    dislikedBy: [],
                    replies: []
                }
            ];
            
            displayComments(demoComments);
            updateCommentCount(demoComments.length);
        }

        function displayComments(commentsToShow) {
            const container = document.getElementById('commentsList');
            const noMessage = document.getElementById('noCommentsMessage');
            
            if (commentsToShow.length === 0) {
                container.classList.add('hidden');
                noMessage.classList.remove('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            noMessage.classList.add('hidden');
            
            container.innerHTML = commentsToShow.map(comment => 
                createCommentHTML(comment)
            ).join('');
            
            lucide.createIcons();
        }

        function createCommentHTML(comment) {
            const timeAgo = getTimeAgo(comment.timestamp);
            const avatarUrl = comment.authorAvatar || `https://ui-avatars.io/api/?name=${encodeURIComponent(comment.authorName)}&background=random`;
            
            return `
                <div class="comment-item border border-gray-200 rounded-xl p-6 hover:shadow-lg transition" data-comment-id="${comment.id}">
                    <div class="flex items-start space-x-4">
                        <div class="w-12 h-12 rounded-full overflow-hidden flex-shrink-0">
                            <img src="${avatarUrl}" alt="${comment.authorName}" class="w-full h-full object-cover">
                        </div>
                        
                        <div class="flex-1 min-w-0">
                            <!-- Author and timestamp -->
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center space-x-3">
                                    <h4 class="font-semibold text-gray-800">${comment.authorName}</h4>
                                    <span class="text-sm text-gray-500">${timeAgo}</span>
                                    ${comment.isEdited ? '<span class="text-xs text-gray-400">(upraveno)</span>' : ''}
                                </div>
                                
                                <div class="flex items-center space-x-2">
                                    <button class="comment-menu-btn text-gray-400 hover:text-gray-600 transition" onclick="toggleCommentMenu('${comment.id}')">
                                        <i data-lucide="more-horizontal" class="w-4 h-4"></i>
                                    </button>
                                    
                                    <!-- Comment menu -->
                                    <div id="menu-${comment.id}" class="hidden absolute right-0 mt-2 bg-white rounded-lg shadow-lg border py-2 z-10">
                                        ${currentUserId === comment.authorId ? 
                                            '<button onclick="editComment(\'' + comment.id + '\')" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100">Upravit</button>' +
                                            '<button onclick="deleteComment(\'' + comment.id + '\')" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Smazat</button>' 
                                            : ''
                                        }
                                        <button onclick="flagComment('${comment.id}')" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100">Nahl√°sit</button>
                                        <button onclick="shareComment('${comment.id}')" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100">Sd√≠let</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Comment content -->
                            <div class="prose prose-sm max-w-none mb-4">
                                <p class="text-gray-800 leading-relaxed whitespace-pre-wrap">${comment.content}</p>
                            </div>
                            
                            <!-- Comment actions -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <button class="comment-like-btn flex items-center space-x-1 text-gray-500 hover:text-green-600 transition ${comment.likedBy?.includes(currentUserId) ? 'text-green-600' : ''}" 
                                            onclick="toggleLike('${comment.id}')">
                                        <i data-lucide="thumbs-up" class="w-4 h-4"></i>
                                        <span>${comment.likes || 0}</span>
                                    </button>
                                    
                                    <button class="comment-dislike-btn flex items-center space-x-1 text-gray-500 hover:text-red-600 transition ${comment.dislikedBy?.includes(currentUserId) ? 'text-red-600' : ''}" 
                                            onclick="toggleDislike('${comment.id}')">
                                        <i data-lucide="thumbs-down" class="w-4 h-4"></i>
                                        <span>${comment.dislikes || 0}</span>
                                    </button>
                                    
                                    <button class="reply-btn flex items-center space-x-1 text-gray-500 hover:text-purple-600 transition" 
                                            onclick="replyToComment('${comment.id}')">
                                        <i data-lucide="reply" class="w-4 h-4"></i>
                                        <span>Odpovƒõdƒõt</span>
                                    </button>
                                </div>
                                
                                <div class="flex items-center space-x-2 text-sm text-gray-400">
                                    ${(comment.replies?.length || 0) > 0 ? 
                                        `<button class="toggle-replies-btn hover:text-gray-600 transition" onclick="toggleReplies('${comment.id}')">
                                            ${comment.replies.length} ${comment.replies.length === 1 ? 'odpovƒõƒè' : comment.replies.length < 5 ? 'odpovƒõdi' : 'odpovƒõd√≠'}
                                        </button>` : ''
                                    }
                                </div>
                            </div>
                            
                            <!-- Replies -->
                            ${(comment.replies?.length || 0) > 0 ? 
                                `<div id="replies-${comment.id}" class="mt-6 ml-8 space-y-4 border-l-2 border-gray-100 pl-6">
                                    ${comment.replies.map(reply => createReplyHTML(reply)).join('')}
                                </div>` : ''
                            }
                        </div>
                    </div>
                </div>
            `;
        }

        function createReplyHTML(reply) {
            const timeAgo = getTimeAgo(reply.timestamp);
            const avatarUrl = reply.authorAvatar || `https://ui-avatars.io/api/?name=${encodeURIComponent(reply.authorName)}&background=random`;
            
            return `
                <div class="reply-item flex items-start space-x-3">
                    <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0">
                        <img src="${avatarUrl}" alt="${reply.authorName}" class="w-full h-full object-cover">
                    </div>
                    
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2 mb-1">
                            <h5 class="font-semibold text-gray-700 text-sm">${reply.authorName}</h5>
                            <span class="text-xs text-gray-500">${timeAgo}</span>
                        </div>
                        
                        <p class="text-gray-800 text-sm leading-relaxed mb-2">${reply.content}</p>
                        
                        <div class="flex items-center space-x-3">
                            <button class="flex items-center space-x-1 text-gray-400 hover:text-green-600 transition text-xs" 
                                    onclick="toggleReplyLike('${reply.id}')">
                                <i data-lucide="thumbs-up" class="w-3 h-3"></i>
                                <span>${reply.likes || 0}</span>
                            </button>
                            
                            <button class="text-gray-400 hover:text-purple-600 transition text-xs" 
                                    onclick="replyToComment('${reply.parentCommentId}')">
                                Odpovƒõdƒõt
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function submitComment() {
            const textarea = document.getElementById('commentTextarea');
            const content = textarea.value.trim();
            
            if (!content) {
                showToast('Koment√°≈ô nesm√≠ b√Ωt pr√°zdn√Ω', 'error');
                return;
            }
            
            if (!currentUserId) {
                showToast('Mus√≠te se p≈ôihl√°sit', 'error');
                return;
            }
            
            try {
                // Pro demo vytvo≈ô√≠me nov√Ω koment√°≈ô lok√°lnƒõ
                const newComment = {
                    id: 'new-' + Date.now(),
                    content: content,
                    authorName: 'Demo U≈æivatel',
                    authorId: currentUserId,
                    timestamp: new Date(),
                    likes: 0,
                    dislikes: 0,
                    likedBy: [],
                    dislikedBy: [],
                    replies: []
                };
                
                comments.unshift(newComment);
                displayComments(comments);
                updateCommentCount(comments.length);
                
                textarea.value = '';
                updateCharCount();
                
                showToast('Koment√°≈ô byl p≈ôid√°n!', 'success');
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi p≈ôid√°v√°n√≠ koment√°≈ôe:', error);
                showToast('Chyba p≈ôi p≈ôid√°v√°n√≠ koment√°≈ôe', 'error');
            }
        }

        function cancelComment() {
            document.getElementById('commentTextarea').value = '';
            updateCharCount();
        }

        function updateCharCount() {
            const textarea = document.getElementById('commentTextarea');
            const charCount = document.getElementById('charCount');
            charCount.textContent = `${textarea.value.length}/1000`;
        }

        function updateEditCharCount() {
            const textarea = document.getElementById('editCommentTextarea');
            const charCount = document.getElementById('editCharCount');
            charCount.textContent = `${textarea.value.length}/1000`;
        }

        function updateReplyCharCount() {
            const textarea = document.getElementById('replyTextarea');
            const charCount = document.getElementById('replyCharCount');
            charCount.textContent = `${textarea.value.length}/1000`;
        }

        function updateCommentCount(count) {
            document.getElementById('totalCommentsCount').textContent = `(${count})`;
            document.getElementById('campaignCommentCount').innerHTML = `<i data-lucide="message-square" class="w-4 h-4 mr-1"></i> ${count} koment√°≈ô≈Ø`;
            lucide.createIcons();
        }

        function sortComments() {
            const sortBy = document.getElementById('commentSort').value;
            
            let sortedComments = [...comments];
            
            switch (sortBy) {
                case 'newest':
                    sortedComments.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    break;
                case 'oldest':
                    sortedComments.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    break;
                case 'popular':
                    sortedComments.sort((a, b) => (b.likes || 0) - (a.likes || 0));
                    break;
            }
            
            displayComments(sortedComments);
        }

        function toggleSearch() {
            const searchBar = document.getElementById('commentSearchBar');
            searchBar.classList.toggle('hidden');
            
            if (!searchBar.classList.contains('hidden')) {
                document.getElementById('commentSearchInput').focus();
            }
        }

        function searchComments() {
            const searchTerm = document.getElementById('commentSearchInput').value.toLowerCase();
            
            if (!searchTerm) {
                displayComments(comments);
                return;
            }
            
            const filteredComments = comments.filter(comment => 
                comment.content.toLowerCase().includes(searchTerm) ||
                comment.authorName.toLowerCase().includes(searchTerm)
            );
            
            displayComments(filteredComments);
        }

        function clearSearch() {
            document.getElementById('commentSearchInput').value = '';
            displayComments(comments);
        }

        function toggleCommentMenu(commentId) {
            const menu = document.getElementById(`menu-${commentId}`);
            // Close all other menus
            document.querySelectorAll('[id^="menu-"]').forEach(m => {
                if (m.id !== `menu-${commentId}`) {
                    m.classList.add('hidden');
                }
            });
            menu.classList.toggle('hidden');
        }

        function editComment(commentId) {
            const comment = comments.find(c => c.id === commentId);
            if (!comment) return;
            
            currentEditingCommentId = commentId;
            document.getElementById('editCommentTextarea').value = comment.content;
            updateEditCharCount();
            document.getElementById('editCommentModal').classList.remove('hidden');
            
            // Close menu
            document.getElementById(`menu-${commentId}`).classList.add('hidden');
        }

        function closeEditModal() {
            document.getElementById('editCommentModal').classList.add('hidden');
            currentEditingCommentId = null;
        }

        async function saveEdit() {
            const content = document.getElementById('editCommentTextarea').value.trim();
            
            if (!content) {
                showToast('Koment√°≈ô nesm√≠ b√Ωt pr√°zdn√Ω', 'error');
                return;
            }
            
            try {
                // Pro demo aktualizujeme lok√°lnƒõ
                const comment = comments.find(c => c.id === currentEditingCommentId);
                if (comment) {
                    comment.content = content;
                    comment.isEdited = true;
                    displayComments(comments);
                }
                
                closeEditModal();
                showToast('Koment√°≈ô byl upraven', 'success');
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi √∫pravƒõ koment√°≈ôe:', error);
                showToast('Chyba p≈ôi √∫pravƒõ koment√°≈ôe', 'error');
            }
        }

        function deleteComment(commentId) {
            if (!confirm('Opravdu chcete smazat tento koment√°≈ô?')) return;
            
            try {
                comments = comments.filter(c => c.id !== commentId);
                displayComments(comments);
                updateCommentCount(comments.length);
                showToast('Koment√°≈ô byl smaz√°n', 'success');
                
                // Close menu
                document.getElementById(`menu-${commentId}`).classList.add('hidden');
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi maz√°n√≠ koment√°≈ôe:', error);
                showToast('Chyba p≈ôi maz√°n√≠ koment√°≈ôe', 'error');
            }
        }

        function replyToComment(commentId) {
            const comment = comments.find(c => c.id === commentId);
            if (!comment) return;
            
            currentReplyingToCommentId = commentId;
            
            // Show original comment in modal
            document.getElementById('replyToComment').innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="w-10 h-10 rounded-full bg-gray-300"></div>
                    <div>
                        <h5 class="font-semibold text-gray-700 text-sm">${comment.authorName}</h5>
                        <p class="text-gray-600 text-sm mt-1">${comment.content.substring(0, 100)}${comment.content.length > 100 ? '...' : ''}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('replyTextarea').value = '';
            updateReplyCharCount();
            document.getElementById('replyModal').classList.remove('hidden');
        }

        function closeReplyModal() {
            document.getElementById('replyModal').classList.add('hidden');
            currentReplyingToCommentId = null;
        }

        async function submitReply() {
            const content = document.getElementById('replyTextarea').value.trim();
            
            if (!content) {
                showToast('Odpovƒõƒè nesm√≠ b√Ωt pr√°zdn√°', 'error');
                return;
            }
            
            try {
                // Pro demo p≈ôid√°me odpovƒõƒè lok√°lnƒõ
                const comment = comments.find(c => c.id === currentReplyingToCommentId);
                if (comment) {
                    const newReply = {
                        id: 'reply-' + Date.now(),
                        content: content,
                        authorName: 'Demo U≈æivatel',
                        authorId: currentUserId,
                        timestamp: new Date(),
                        likes: 0,
                        parentCommentId: currentReplyingToCommentId
                    };
                    
                    if (!comment.replies) comment.replies = [];
                    comment.replies.push(newReply);
                    
                    displayComments(comments);
                    showToast('Odpovƒõƒè byla p≈ôid√°na', 'success');
                }
                
                closeReplyModal();
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi p≈ôid√°v√°n√≠ odpovƒõdi:', error);
                showToast('Chyba p≈ôi p≈ôid√°v√°n√≠ odpovƒõdi', 'error');
            }
        }

        function flagComment(commentId) {
            currentFlaggingCommentId = commentId;
            document.getElementById('flagModal').classList.remove('hidden');
            
            // Close menu
            document.getElementById(`menu-${commentId}`).classList.add('hidden');
        }

        function closeFlagModal() {
            document.getElementById('flagModal').classList.add('hidden');
            currentFlaggingCommentId = null;
            
            // Clear selection
            document.querySelectorAll('input[name="flagReason"]').forEach(radio => {
                radio.checked = false;
            });
        }

        async function submitFlag() {
            const selectedReason = document.querySelector('input[name="flagReason"]:checked');
            
            if (!selectedReason) {
                showToast('Vyberte d≈Øvod nahl√°≈°en√≠', 'error');
                return;
            }
            
            try {
                // Pro demo jen zobraz√≠me zpr√°vu
                showToast('Koment√°≈ô byl nahl√°≈°en', 'success');
                closeFlagModal();
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi nahla≈°ov√°n√≠ koment√°≈ôe:', error);
                showToast('Chyba p≈ôi nahla≈°ov√°n√≠ koment√°≈ôe', 'error');
            }
        }

        function toggleLike(commentId) {
            const comment = comments.find(c => c.id === commentId);
            if (!comment) return;
            
            if (!comment.likedBy) comment.likedBy = [];
            if (!comment.dislikedBy) comment.dislikedBy = [];
            
            const hasLiked = comment.likedBy.includes(currentUserId);
            const hasDisliked = comment.dislikedBy.includes(currentUserId);
            
            if (hasLiked) {
                // Remove like
                comment.likedBy = comment.likedBy.filter(id => id !== currentUserId);
                comment.likes = Math.max(0, (comment.likes || 0) - 1);
            } else {
                // Add like
                comment.likedBy.push(currentUserId);
                comment.likes = (comment.likes || 0) + 1;
                
                // Remove dislike if exists
                if (hasDisliked) {
                    comment.dislikedBy = comment.dislikedBy.filter(id => id !== currentUserId);
                    comment.dislikes = Math.max(0, (comment.dislikes || 0) - 1);
                }
            }
            
            displayComments(comments);
        }

        function toggleDislike(commentId) {
            const comment = comments.find(c => c.id === commentId);
            if (!comment) return;
            
            if (!comment.likedBy) comment.likedBy = [];
            if (!comment.dislikedBy) comment.dislikedBy = [];
            
            const hasLiked = comment.likedBy.includes(currentUserId);
            const hasDisliked = comment.dislikedBy.includes(currentUserId);
            
            if (hasDisliked) {
                // Remove dislike
                comment.dislikedBy = comment.dislikedBy.filter(id => id !== currentUserId);
                comment.dislikes = Math.max(0, (comment.dislikes || 0) - 1);
            } else {
                // Add dislike
                comment.dislikedBy.push(currentUserId);
                comment.dislikes = (comment.dislikes || 0) + 1;
                
                // Remove like if exists
                if (hasLiked) {
                    comment.likedBy = comment.likedBy.filter(id => id !== currentUserId);
                    comment.likes = Math.max(0, (comment.likes || 0) - 1);
                }
            }
            
            displayComments(comments);
        }

        function toggleReplies(commentId) {
            const repliesContainer = document.getElementById(`replies-${commentId}`);
            repliesContainer.classList.toggle('hidden');
        }

        function shareComment(commentId) {
            // Pro demo jen zkop√≠rujeme do schr√°nky
            const url = `${window.location.href}#comment-${commentId}`;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(url).then(() => {
                    showToast('Odkaz na koment√°≈ô byl zkop√≠rov√°n', 'success');
                });
            } else {
                showToast('Odkaz: ' + url, 'info');
            }
            
            // Close menu
            document.getElementById(`menu-${commentId}`).classList.add('hidden');
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diff = now - time;
            
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (minutes < 60) {
                return `p≈ôed ${minutes}m`;
            } else if (hours < 24) {
                return `p≈ôed ${hours}h`;
            } else {
                return `p≈ôed ${days}d`;
            }
        }

        function showLoading(show) {
            const loading = document.getElementById('commentsLoading');
            const content = document.getElementById('commentsList');
            
            if (show) {
                loading.classList.remove('hidden');
                content.classList.add('hidden');
            } else {
                loading.classList.add('hidden');
                content.classList.remove('hidden');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            
            // Set color based on type
            toast.className = 'fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50';
            
            switch (type) {
                case 'success':
                    toast.classList.add('bg-green-500', 'text-white');
                    break;
                case 'error':
                    toast.classList.add('bg-red-500', 'text-white');
                    break;
                case 'info':
                    toast.classList.add('bg-blue-500', 'text-white');
                    break;
            }
            
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Close menus when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.comment-menu-btn')) {
                document.querySelectorAll('[id^="menu-"]').forEach(menu => {
                    menu.classList.add('hidden');
                });
            }
        });
    </script>
</body>
</html>