<!-- üî• Mystery Box logika pro K-Coins -->
<script>
  (function () {
    const COST = 30; // cena za otev≈ôen√≠
    const COOLDOWN_MS = 2 * 60 * 60 * 1000; // 2 hodiny
    const STORAGE_KEY = "kartao_mysteryBox_lastOpen";

    const rewards = [
      { label: "+5 K-Coins", type: "coins", amount: 5, chance: 40 },
      { label: "+15 K-Coins", type: "coins", amount: 15, chance: 25 },
      { label: "+50 K-Coins", type: "coins", amount: 50, chance: 10 },
      { label: "+1 VIP den", type: "vip", days: 1, chance: 5 },
      { label: "Sleva 10 %", type: "coupon", code: "SLEVA10", chance: 20 },
    ];

    /* üîó Ukl√°d√°n√≠ v√Ωher do ‚ÄûMoje v√Ωhry‚Äú (localStorage: kartao_rewards) */
    function saveRewardForHistory(rewardForHistory) {
      // oƒçek√°v√°: { id, title, type, date }
      let current = [];
      try {
        current = JSON.parse(localStorage.getItem("kartao_rewards") || "[]");
      } catch (e) {
        current = [];
      }

      // posledn√≠ v√Ωhra dop≈ôedu
      current.unshift(rewardForHistory);

      // limit ‚Äì t≈ôeba posledn√≠ch 50 v√Ωher
      current = current.slice(0, 50);

      localStorage.setItem("kartao_rewards", JSON.stringify(current));
    }

    function mapRewardTypeForHistory(reward) {
      if (!reward || !reward.type) return "mystery";

      if (reward.type === "coins") {
        return "mystery";      // barevn√° krabiƒçka
      } else if (reward.type === "vip") {
        return "gold-card";    // zlat√° karta
      } else if (reward.type === "coupon") {
        return "ticket";       // tiket
      }
      return "mystery";
    }

    const btn = document.getElementById("openMysteryBoxBtn");
    const statusEl = document.getElementById("mysteryBoxStatus");
    const cooldownInfoEl = document.getElementById("mysteryBoxCooldownInfo");
    const countdownEl = document.getElementById("mysteryBoxCountdown");
    const errorEl = document.getElementById("mysteryBoxError");
    const boxVisual = document.getElementById("mysteryBoxVisual");

    const modal = document.getElementById("mysteryBoxModal");
    const rewardTextEl = document.getElementById("mysteryBoxRewardText");
    const rewardDescEl = document.getElementById("mysteryBoxRewardDesc");
    const confettiContainer = document.getElementById("mysteryBoxConfetti");
    const modalCloseBtn = document.getElementById("closeMysteryBoxModalBtn");
    const modalOkBtn = document.getElementById("mysteryBoxOkBtn");

    const resetBtn = document.getElementById("resetMysteryBoxBtn");
    const creditsLabel = document.getElementById("currentCredits");

    if (!btn || !boxVisual) return;

    let isOpening = false;
    let cooldownTimer = null;

    // üî¢ zobrazen√≠ kredit≈Ø v headeru
    function updateCreditsDisplay() {
      if (!creditsLabel || !window.creditSys || typeof creditSys.getCredits !== "function") return;
      try {
        creditsLabel.textContent = creditSys.getCredits();
      } catch (e) {
        console.warn("MysteryBox: chyba p≈ôi ƒçten√≠ kredit≈Ø pro UI:", e);
      }
    }

    function getLastOpenTime() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      const ts = parseInt(raw, 10);
      return isNaN(ts) ? null : ts;
    }

    function setLastOpenTime() {
      localStorage.setItem(STORAGE_KEY, Date.now().toString());
    }

    function getRemainingCooldownMs() {
      const last = getLastOpenTime();
      if (!last) return 0;
      const diff = Date.now() - last;
      const remaining = COOLDOWN_MS - diff;
      return remaining > 0 ? remaining : 0;
    }

    function formatTime(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const h = Math.floor(totalSeconds / 3600);
      const m = Math.floor((totalSeconds % 3600) / 60);
      const s = totalSeconds % 60;
      const pad = (x) => x.toString().padStart(2, "0");
      if (h > 0) {
        return `${pad(h)}:${pad(m)}:${pad(s)}`;
      }
      return `${pad(m)}:${pad(s)}`;
    }

    function startCooldownTimer() {
      if (cooldownTimer) clearInterval(cooldownTimer);

      function tick() {
        const remaining = getRemainingCooldownMs();
        if (remaining <= 0) {
          clearInterval(cooldownTimer);
          cooldownTimer = null;
          cooldownInfoEl.classList.add("hidden");
          statusEl.innerHTML = `
            <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-500/20 text-emerald-300">
              ‚óè
            </span>
            <span>Pr√°vƒõ teƒè m≈Ø≈æe≈° otev≈ô√≠t 1√ó za <span class="font-semibold text-amber-200">2 hodiny</span>.</span>
          `;
          updateButtonState();
          return;
        }
        cooldownInfoEl.classList.remove("hidden");
        countdownEl.textContent = formatTime(remaining);
        statusEl.innerHTML = `
          <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-sky-500/20 text-sky-300">
            ‚óè
          </span>
          <span>Mystery Box je v cooldownu.</span>
        `;
        updateButtonState();
      }

      tick();
      cooldownTimer = setInterval(tick, 1000);
    }

    function isOnCooldown() {
      return getRemainingCooldownMs() > 0;
    }

    function hasEnoughCredits() {
      if (!window.creditSys || typeof creditSys.getCredits !== "function") {
        console.warn("MysteryBox: creditSys.getCredits nen√≠ dostupn√©.");
        return true; // neblokuj UI, kdy≈æ nen√≠ napojen√©
      }
      try {
        const current = creditSys.getCredits();
        return typeof current === "number" ? current >= COST : true;
      } catch (e) {
        console.warn("MysteryBox: chyba p≈ôi ƒçten√≠ kredit≈Ø:", e);
        return true;
      }
    }

    function updateButtonState() {
      const onCd = isOnCooldown();
      const enough = hasEnoughCredits();
      btn.disabled = onCd || isOpening || !enough;

      if (!enough) {
        errorEl.textContent = "Nem√°≈° dostatek K-Coins na otev≈ôen√≠ Mystery Boxu.";
      } else if (onCd) {
        errorEl.textContent = "Mystery Box p≈Øjde otev≈ô√≠t a≈æ po skonƒçen√≠ cooldownu.";
      } else {
        errorEl.textContent = "";
      }
    }

    function pickReward() {
      const roll = Math.random() * 100;
      let acc = 0;
      for (const r of rewards) {
        acc += r.chance;
        if (roll <= acc) return r;
      }
      return rewards[0];
    }

    /* üî• TADY se vyhodnocuje v√Ωhra + ukl√°d√° do Moje v√Ωhry */
    function applyReward(reward) {
      if (!reward) return;

      const historyRecord = {
        id: "mbox_" + Date.now(),
        title: reward.label || "V√Ωhra z Mystery Boxu",
        type: mapRewardTypeForHistory(reward),
        date: new Date().toISOString(),
      };

      if (reward.type === "coins") {
        if (window.creditSys && typeof creditSys.addCredits === "function") {
          try {
            creditSys.addCredits(reward.amount);
            updateCreditsDisplay();
          } catch (e) {
            console.warn("MysteryBox: chyba p≈ôi p≈ôid√°v√°n√≠ kredit≈Ø:", e);
          }
        }

        rewardTextEl.textContent = reward.label;
        rewardDescEl.textContent = `Na tvoje konto jsme p≈ôidali ${reward.amount} K-Coins.`;

        // ulo≈æit mezi v√Ωhry
        saveRewardForHistory(historyRecord);

      } else if (reward.type === "vip") {
        if (window.creditSys && typeof creditSys.addVipDays === "function") {
          try {
            creditSys.addVipDays(reward.days);
          } catch (e) {
            console.warn("MysteryBox: chyba p≈ôi p≈ôid√°v√°n√≠ VIP dne:", e);
          }
        }

        rewardTextEl.textContent = reward.label;
        rewardDescEl.textContent = `Z√≠sk√°v√°≈° VIP p≈ô√≠stup na ${reward.days} den. V√Ωhody se projev√≠ ve VIP sekci.`;

        // ulo≈æit mezi v√Ωhry
        saveRewardForHistory(historyRecord);

      } else if (reward.type === "coupon") {
        rewardTextEl.textContent = reward.label;
        rewardDescEl.textContent =
          "Z√≠skal jsi slevu 10 %. Kupon najde≈° v sekci ‚ÄûMoje v√Ωhry‚Äú a pou≈æije≈° ho p≈ôi n√°kupu.";

        // ulo≈æit mezi v√Ωhry
        saveRewardForHistory(historyRecord);
      }
    }

    function createConfetti() {
      if (!confettiContainer) return;
      confettiContainer.innerHTML = "";

      const colors = [
        "rgb(251,191,36)",
        "rgb(56,189,248)",
        "rgb(244,114,182)",
        "rgb(52,211,153)",
      ];

      const pieces = 40;
      for (let i = 0; i < pieces; i++) {
        const el = document.createElement("div");
        el.className = "confetti-piece";
        const left = Math.random() * 100;
        const delay = Math.random() * 0.4;
        const xOffset = (Math.random() - 0.5) * 120;

        el.style.left = `${left}%`;
        el.style.top = "-20px";
        el.style.backgroundColor = colors[i % colors.length];
        el.style.animationDelay = `${delay}s`;
        el.style.setProperty("--confetti-x", `${xOffset}px`);

        confettiContainer.appendChild(el);
      }
    }

    function openModal() {
      if (!modal) return;
      modal.classList.remove("hidden");
      modal.classList.add("flex");
      createConfetti();
    }

    function closeModal() {
      if (!modal) return;
      modal.classList.add("hidden");
      modal.classList.remove("flex");
      if (confettiContainer) confettiContainer.innerHTML = "";
    }

    function trySubtractCredits() {
      if (!window.creditSys || typeof creditSys.subtractCredits !== "function") {
        alert("Kreditn√≠ syst√©m nen√≠ napojen√Ω (creditSys.subtractCredits chyb√≠).");
        return true; // neblokovat testov√°n√≠ UI
      }

      if (!hasEnoughCredits()) {
        errorEl.textContent = "Nem√°≈° dostatek K-Coins na otev≈ôen√≠ Mystery Boxu.";
        return false;
      }

      try {
        creditSys.subtractCredits(COST);
        updateCreditsDisplay();
        return true;
      } catch (e) {
        console.warn("MysteryBox: chyba p≈ôi odeƒç√≠t√°n√≠ kredit≈Ø:", e);
        errorEl.textContent = "Nepoda≈ôilo se odeƒç√≠st kredity. Zkus to pros√≠m znovu.";
        return false;
      }
    }

    // üß® RESET COOLDOWNU
    function resetMysteryBoxCooldown() {
      localStorage.removeItem(STORAGE_KEY);

      if (cooldownTimer) clearInterval(cooldownTimer);
      cooldownTimer = null;

      cooldownInfoEl.classList.add("hidden");
      statusEl.innerHTML = `
        <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-500/20 text-emerald-300">
          ‚óè
        </span>
        <span>Mystery Box m≈Ø≈æe≈° otev≈ô√≠t okam≈æitƒõ.</span>
      `;

      errorEl.textContent = "";
      updateButtonState();
    }

    function handleOpenClick() {
      if (isOpening) return;
      errorEl.textContent = "";

      if (isOnCooldown()) {
        errorEl.textContent = "Mystery Box je v cooldownu. Poƒçkej, ne≈æ odpoƒçet dobƒõhne.";
        return;
      }

      if (!hasEnoughCredits()) {
        errorEl.textContent = "Nem√°≈° dostatek K-Coins na otev≈ôen√≠ Mystery Boxu.";
        return;
      }

      const ok = trySubtractCredits();
      if (!ok) return;

      isOpening = true;
      updateButtonState();

      boxVisual.classList.add("mystery-box-opening");

      setTimeout(() => {
        boxVisual.classList.remove("mystery-box-opening");

        const reward = pickReward();
        applyReward(reward);
        setLastOpenTime();
        startCooldownTimer();
        openModal();

        isOpening = false;
        updateButtonState();
      }, 1000);
    }

    // Listeners
    btn.addEventListener("click", handleOpenClick);
    boxVisual.addEventListener("click", handleOpenClick);

    if (modalCloseBtn) modalCloseBtn.addEventListener("click", closeModal);
    if (modalOkBtn) modalOkBtn.addEventListener("click", closeModal);
    if (modal) {
      modal.addEventListener("click", (e) => {
        if (e.target === modal) {
          closeModal();
        }
      });
    }

    if (resetBtn) {
      resetBtn.addEventListener("click", () => {
        resetMysteryBoxCooldown();
        alert("Mystery Box cooldown byl resetov√°n (ADMIN test).");
      });
    }

    // Inicializace
    (function init() {
      updateCreditsDisplay();
      if (isOnCooldown()) {
        startCooldownTimer();
      } else {
        updateButtonState();
      }
    })();
  })();
</script>
