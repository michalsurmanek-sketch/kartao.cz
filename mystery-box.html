<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>K-Coins Mystery Box ‚Äì Kartao.cz</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            fuchsia: tailwind.colors.fuchsia,
            amber: tailwind.colors.amber,
            neutral: tailwind.colors.neutral,
            emerald: tailwind.colors.emerald,
            sky: tailwind.colors.sky,
            rose: tailwind.colors.rose,
          },
          boxShadow: {
            soft: "0 18px 45px rgba(15,23,42,0.85)",
          },
        },
      },
    };
  </script>

  <style>
    /* ‚ú® Mystery Box ‚Äì animace a efekty */

    @keyframes mystery-pulse {
      0% { transform: translateY(0) scale(1); box-shadow: 0 0 20px rgba(56, 189, 248, 0.35); }
      50% { transform: translateY(-4px) scale(1.02); box-shadow: 0 0 40px rgba(251, 191, 36, 0.6); }
      100% { transform: translateY(0) scale(1); box-shadow: 0 0 20px rgba(56, 189, 248, 0.35); }
    }

    @keyframes mystery-open {
      0% { transform: scale(1) rotate(0deg); filter: brightness(1); }
      40% { transform: scale(1.08) rotate(-2deg); filter: brightness(1.2); }
      70% { transform: scale(0.95) rotate(2deg); filter: brightness(1.4); }
      100% { transform: scale(1.02) rotate(0deg); filter: brightness(1.5); }
    }

    .mystery-box-glow {
      animation: mystery-pulse 2.2s ease-in-out infinite;
    }

    .mystery-box-opening {
      animation: mystery-open 0.9s ease-in-out forwards;
    }

    /* Konfety */
    .confetti-piece {
      position: absolute;
      width: 6px;
      height: 10px;
      border-radius: 999px;
      opacity: 0;
      animation: confetti-fall 1.4s ease-out forwards;
    }

    @keyframes confetti-fall {
      0% {
        transform: translateY(0) translateX(0) rotate(0deg);
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      100% {
        transform: translateY(200px) translateX(var(--confetti-x, 0px)) rotate(280deg);
        opacity: 0;
      }
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-neutral-950 via-neutral-950 to-sky-950 text-white">
  <div class="min-h-screen flex flex-col">

    <!-- Horn√≠ bar + zpƒõt -->
    <header class="border-b border-white/10 bg-neutral-950/80 backdrop-blur">
      <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-2xl bg-gradient-to-tr from-amber-400 to-yellow-300 flex items-center justify-center shadow-lg shadow-amber-500/60">
            <!-- Koruna -->
            <svg viewBox="0 0 24 24" class="w-5 h-5 text-neutral-950">
              <path fill="currentColor"
                d="M5 18h14l-1-9-4 3-3-6-3 6-4-3zM6 20h12v2H6z" />
            </svg>
          </div>
          <div>
            <div class="text-xs uppercase tracking-wide text-sky-300/80">Kartao.cz ‚Ä¢ K-Coins</div>
            <div class="text-sm font-semibold">Mystery Box z√≥na</div>
          </div>
        </div>

        <a
          href="credits-dashboard.html"
          class="inline-flex items-center gap-2 rounded-2xl border border-sky-500/60 bg-sky-500/10 px-3 py-1.5 text-xs font-medium text-sky-100 hover:bg-sky-500/20"
        >
          ‚Üê Zpƒõt na kredity
        </a>
      </div>
    </header>

    <!-- Obsah -->
    <main class="flex-1">
      <div class="max-w-5xl mx-auto px-4 py-8 md:py-10">
        <!-- Nadpis / popis -->
        <div class="mb-6 md:mb-8">
          <h1 class="text-2xl md:text-3xl font-semibold tracking-tight mb-2">
            K-Coins Mystery Box üëë
          </h1>
          <p class="text-sm md:text-base text-sky-100/80 max-w-2xl">
            Vymƒõ≈à <span class="font-semibold text-amber-300">30 K-Coins</span> za ≈°anci z√≠skat n√°hodnou odmƒõnu:
            +5 / +15 / +50 K-Coins, <span class="font-semibold text-amber-300">VIP den</span> nebo
            <span class="font-semibold text-emerald-300">sleva 10 %</span>.<br>
            Mystery Box m≈Ø≈æe≈° otev≈ô√≠t maxim√°lnƒõ <span class="font-semibold text-amber-200">1√ó za 2 hodiny</span>.
          </p>
        </div>

        <!-- üß© MYSTERY BOX ‚Äì hlavn√≠ komponenta -->
        <section id="mysteryBoxSection" class="mt-4 mb-12">
          <div
            class="relative overflow-hidden rounded-3xl bg-gradient-to-br from-sky-900 via-neutral-950 to-amber-900/40 border border-sky-500/40 shadow-soft"
          >
            <!-- Z√°≈ôe v pozad√≠ -->
            <div class="pointer-events-none absolute -inset-40 bg-[radial-gradient(circle_at_top,_rgba(56,189,248,0.25),_transparent_60%),radial-gradient(circle_at_bottom,_rgba(251,191,36,0.25),_transparent_60%)] opacity-70"></div>

            <div class="relative z-10 px-6 py-6 md:px-10 md:py-8 flex flex-col md:flex-row gap-8 items-center">
              <!-- Textov√° ƒç√°st -->
              <div class="flex-1 space-y-3 md:space-y-4">
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-sky-500/15 border border-sky-400/30">
                  <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-sky-500/30 text-amber-300 text-sm">‚òÖ</span>
                  <span class="text-xs font-medium tracking-wide text-sky-100/80 uppercase">
                    Mystery Box ‚Ä¢ N√°hodn√© odmƒõny
                  </span>
                </div>
                <div class="flex items-center gap-3">
                  <h2 class="text-xl md:text-2xl font-semibold text-white tracking-tight">
                    Otev≈ôi K-Coins Mystery Box
                  </h2>
                  <!-- Korunka -->
                  <div class="w-8 h-8 rounded-2xl bg-gradient-to-tr from-amber-400 to-yellow-300 flex items-center justify-center shadow-lg shadow-amber-500/60">
                    <svg viewBox="0 0 24 24" class="w-5 h-5 text-neutral-950">
                      <path fill="currentColor"
                        d="M5 18h14l-1-9-4 3-3-6-3 6-4-3zM6 20h12v2H6z" />
                    </svg>
                  </div>
                </div>
                <p class="text-sm md:text-base text-sky-100/80 max-w-xl">
                  Zapla≈• <span class="font-semibold text-amber-300">30 K-Coins</span> a z√≠skej n√°hodnou odmƒõnu:
                  +5 / +15 / +50 K-Coins, <span class="font-semibold text-amber-300">VIP den</span> nebo
                  <span class="font-semibold text-emerald-300">slevu 10 %</span>.
                </p>

                <!-- Info o ≈°anc√≠ch -->
                <div class="grid grid-cols-2 sm:grid-cols-5 gap-2 text-[11px] md:text-xs text-sky-100/80 mt-3">
                  <div class="rounded-2xl border border-sky-500/30 bg-sky-500/10 px-2 py-1.5 text-center">
                    <div class="font-semibold text-amber-200">+5</div>
                    <div>40&nbsp;%</div>
                  </div>
                  <div class="rounded-2xl border border-sky-500/30 bg-sky-500/10 px-2 py-1.5 text-center">
                    <div class="font-semibold text-amber-200">+15</div>
                    <div>25&nbsp;%</div>
                  </div>
                  <div class="rounded-2xl border border-sky-500/30 bg-sky-500/10 px-2 py-1.5 text-center">
                    <div class="font-semibold text-amber-200">+50</div>
                    <div>10&nbsp;%</div>
                  </div>
                  <div class="rounded-2xl border border-emerald-500/40 bg-emerald-500/10 px-2 py-1.5 text-center">
                    <div class="font-semibold text-emerald-200">VIP den</div>
                    <div>5&nbsp;%</div>
                  </div>
                  <div class="rounded-2xl border border-amber-400/40 bg-amber-500/10 px-2 py-1.5 text-center">
                    <div class="font-semibold text-amber-200">Sleva 10&nbsp;%</div>
                    <div>20&nbsp;%</div>
                  </div>
                </div>

                <!-- Stav / cooldown -->
                <div class="mt-3 flex flex-col sm:flex-row gap-2 sm:items-center text-xs text-sky-100/80">
                  <div id="mysteryBoxStatus" class="flex items-center gap-2">
                    <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-500/20 text-emerald-300">
                      ‚óè
                    </span>
                    <span>Pr√°vƒõ teƒè m≈Ø≈æe≈° otev≈ô√≠t 1√ó za <span class="font-semibold text-amber-200">2 hodiny</span>.</span>
                  </div>
                  <div id="mysteryBoxCooldownInfo" class="sm:ml-3 text-[11px] text-sky-300/80 hidden">
                    Dal≈°√≠ otev≈ôen√≠ za <span id="mysteryBoxCountdown" class="font-semibold text-amber-200">--:--</span>
                  </div>
                </div>

                <!-- RESET Mystery Boxu ‚Äì ADMIN -->
                <button
                  id="resetMysteryBoxBtn"
                  class="mt-4 inline-flex items-center gap-2 rounded-2xl border border-rose-500/50 bg-rose-500/10 px-4 py-1.5 text-xs font-semibold text-rose-300 hover:bg-rose-500/20 active:scale-[0.98] transition"
                >
                  üß® Reset Mystery Box (ADMIN)
                </button>
              </div>

              <!-- Box + tlaƒç√≠tko -->
              <div class="flex flex-col items-center gap-4 md:w-64">
                <!-- Animovan√Ω box -->
                <div
                  id="mysteryBoxVisual"
                  class="relative w-40 h-40 rounded-3xl bg-gradient-to-br from-sky-500 via-blue-600 to-fuchsia-500 p-[2px] cursor-pointer mystery-box-glow"
                >
                  <div class="absolute inset-0 rounded-3xl bg-[radial-gradient(circle_at_20%_0,_rgba(251,191,36,0.45),_transparent_55%),radial-gradient(circle_at_80%_100%,_rgba(56,189,248,0.45),_transparent_55%)] opacity-90"></div>
                  <div class="relative z-10 w-full h-full rounded-3xl bg-neutral-950/95 flex flex-col items-center justify-center gap-2 border border-sky-400/40">
                    <!-- Horn√≠ svƒõtlo -->
                    <div class="absolute -top-3 w-20 h-8 bg-gradient-to-b from-amber-300/80 to-transparent blur-md opacity-60"></div>
                    <!-- Koruna naho≈ôe -->
                    <div class="w-10 h-10 rounded-2xl bg-gradient-to-tr from-amber-300 to-yellow-200 flex items-center justify-center shadow-lg shadow-amber-400/70">
                      <svg viewBox="0 0 24 24" class="w-6 h-6 text-neutral-950">
                        <path fill="currentColor"
                          d="M5 18h14l-1-9-4 3-3-6-3 6-4-3zM6 20h12v2H6z" />
                      </svg>
                    </div>
                    <!-- Ikona K -->
                    <div class="mt-2 flex items-center justify-center">
                      <div class="w-12 h-12 rounded-full bg-gradient-to-tr from-sky-500 to-emerald-400 flex items-center justify-center border border-white/20 shadow-lg shadow-sky-500/60">
                        <span class="text-2xl font-extrabold text-neutral-950 drop-shadow-[0_0_10px_rgba(250,250,250,0.7)]">
                          K
                        </span>
                      </div>
                    </div>
                    <div class="mt-1 text-[11px] font-medium tracking-wide text-sky-100/85 uppercase">
                      Mystery Box
                    </div>
                    <div class="text-[10px] text-sky-200/70">
                      Cena: <span class="font-semibold text-amber-300">30 K-Coins</span>
                    </div>
                  </div>
                </div>

                <!-- Tlaƒç√≠tko -->
                <button
                  id="openMysteryBoxBtn"
                  type="button"
                  class="inline-flex items-center justify-center gap-2 rounded-2xl bg-gradient-to-r from-amber-400 via-amber-300 to-yellow-300 px-5 py-2.5 text-sm font-semibold text-neutral-950 shadow-lg shadow-amber-500/60 hover:brightness-110 active:scale-[0.98] transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-amber-300/70 disabled:cursor-not-allowed disabled:opacity-60"
                >
                  <span>Otev≈ô√≠t Mystery Box</span>
                  <span class="text-xs px-2 py-0.5 rounded-full bg-neutral-900/10 border border-amber-500/60">
                    -30 K-Coins
                  </span>
                </button>

                <p id="mysteryBoxError" class="text-xs text-rose-300/90 min-h-[1rem] text-center"></p>
              </div>
            </div>
          </div>

          <!-- Modal s v√Ωhrou -->
          <div
            id="mysteryBoxModal"
            class="fixed inset-0 z-[80] hidden items-center justify-center bg-black/70 backdrop-blur-sm"
          >
            <div class="relative w-full max-w-md mx-4 rounded-3xl bg-neutral-950 border border-amber-400/40 shadow-soft overflow-hidden">
              <!-- Konfety -->
              <div id="mysteryBoxConfetti" class="pointer-events-none absolute inset-0 overflow-hidden"></div>

              <div class="relative z-10 px-6 py-6 md:px-8 md:py-7">
                <div class="flex justify-between items-start gap-3">
                  <div>
                    <div class="inline-flex items-center gap-2 px-2.5 py-1 rounded-full bg-emerald-500/15 border border-emerald-400/40">
                      <span class="text-xs font-semibold text-emerald-300">V√Ωhra z Mystery Boxu</span>
                    </div>
                    <h3 class="mt-3 text-xl font-semibold text-white tracking-tight">
                      Gratulujeme! üéâ
                    </h3>
                  </div>
                  <button
                    id="closeMysteryBoxModalBtn"
                    type="button"
                    class="rounded-full p-1.5 bg-neutral-900 border border-white/10 text-sky-100 hover:bg-neutral-800/80"
                  >
                    ‚úï
                  </button>
                </div>

                <div class="mt-4 rounded-2xl border border-amber-400/40 bg-gradient-to-br from-neutral-900 via-neutral-950 to-amber-900/40 px-4 py-4 flex flex-col items-center text-center gap-2">
                  <div class="flex items-center justify-center gap-3">
                    <div class="w-10 h-10 rounded-2xl bg-gradient-to-tr from-amber-300 to-yellow-200 flex items-center justify-center shadow-lg shadow-amber-400/70">
                      <svg viewBox="0 0 24 24" class="w-6 h-6 text-neutral-950">
                        <path fill="currentColor"
                          d="M5 18h14l-1-9-4 3-3-6-3 6-4-3zM6 20h12v2H6z" />
                      </svg>
                    </div>
                    <p id="mysteryBoxRewardText" class="text-lg font-semibold text-amber-200"></p>
                  </div>
                  <p id="mysteryBoxRewardDesc" class="text-xs text-sky-100/80 max-w-xs"></p>
                </div>

                <div class="mt-4 text-[11px] text-sky-300/80">
                  Tip: v≈°echny VIP a slevov√© odmƒõny m≈Ø≈æe≈° pozdƒõji zobrazit v sekci
                  <span class="font-semibold text-amber-200">Moje odmƒõny</span> (doprogramujeme na backendu).
                </div>

                <div class="mt-5 flex justify-end">
                  <button
                    id="mysteryBoxOkBtn"
                    type="button"
                    class="inline-flex items-center justify-center rounded-2xl border border-amber-400/70 bg-amber-400/10 px-4 py-1.5 text-xs font-semibold text-amber-100 hover:bg-amber-400/20"
                  >
                    Zav≈ô√≠t a pokraƒçovat
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>

  <!-- üîó Kreditn√≠ syst√©m Kartao.cz -->
  <script src="credits-system.js"></script>

  <!-- üîÅ Inicializace glob√°ln√≠ho wrapperu creditSys pro Mystery Box -->
  <script>
    const creditsSystem = new CreditsSystem(); // userId si vy≈ôe≈°√≠ s√°m

    window.creditSys = {
      getCredits: () => creditsSystem.getCredits(),
      addCredits: (amount) => creditsSystem.addCredits(amount),
      subtractCredits: (amount) => creditsSystem.subtractCredits(amount),
      addVipDays: (days) => {
        console.log("VIP +", days, "dn≈Ø (zat√≠m jen log, napoj√≠me na profil pozdƒõji)");
      },
    };
  </script>

  <!-- üî• Mystery Box logika pro K-Coins -->
  <script>
    (function () {
      const COST = 30; // cena za otev≈ôen√≠
      const COOLDOWN_MS = 2 * 60 * 60 * 1000; // 2 hodiny
      const STORAGE_KEY = "kartao_mysteryBox_lastOpen";

      const rewards = [
        { label: "+5 K-Coins", type: "coins", amount: 5, chance: 40 },
        { label: "+15 K-Coins", type: "coins", amount: 15, chance: 25 },
        { label: "+50 K-Coins", type: "coins", amount: 50, chance: 10 },
        { label: "+1 VIP den", type: "vip", days: 1, chance: 5 },
        { label: "Sleva 10 %", type: "coupon", code: "SLEVA10", chance: 20 },
      ];

      const btn = document.getElementById("openMysteryBoxBtn");
      const statusEl = document.getElementById("mysteryBoxStatus");
      const cooldownInfoEl = document.getElementById("mysteryBoxCooldownInfo");
      const countdownEl = document.getElementById("mysteryBoxCountdown");
      const errorEl = document.getElementById("mysteryBoxError");
      const boxVisual = document.getElementById("mysteryBoxVisual");

      const modal = document.getElementById("mysteryBoxModal");
      const rewardTextEl = document.getElementById("mysteryBoxRewardText");
      const rewardDescEl = document.getElementById("mysteryBoxRewardDesc");
      const confettiContainer = document.getElementById("mysteryBoxConfetti");
      const modalCloseBtn = document.getElementById("closeMysteryBoxModalBtn");
      const modalOkBtn = document.getElementById("mysteryBoxOkBtn");

      const resetBtn = document.getElementById("resetMysteryBoxBtn");

      if (!btn || !boxVisual) return;

      let isOpening = false;
      let cooldownTimer = null;

      function getLastOpenTime() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        const ts = parseInt(raw, 10);
        return isNaN(ts) ? null : ts;
      }

      function setLastOpenTime() {
        localStorage.setItem(STORAGE_KEY, Date.now().toString());
      }

      function getRemainingCooldownMs() {
        const last = getLastOpenTime();
        if (!last) return 0;
        const diff = Date.now() - last;
        const remaining = COOLDOWN_MS - diff;
        return remaining > 0 ? remaining : 0;
      }

      function formatTime(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const h = Math.floor(totalSeconds / 3600);
        const m = Math.floor((totalSeconds % 3600) / 60);
        const s = totalSeconds % 60;
        const pad = (x) => x.toString().padStart(2, "0");
        if (h > 0) {
          return `${pad(h)}:${pad(m)}:${pad(s)}`;
        }
        return `${pad(m)}:${pad(s)}`;
      }

      function startCooldownTimer() {
        if (cooldownTimer) clearInterval(cooldownTimer);

        function tick() {
          const remaining = getRemainingCooldownMs();
          if (remaining <= 0) {
            clearInterval(cooldownTimer);
            cooldownTimer = null;
            cooldownInfoEl.classList.add("hidden");
            statusEl.innerHTML = `
              <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-500/20 text-emerald-300">
                ‚óè
              </span>
              <span>Pr√°vƒõ teƒè m≈Ø≈æe≈° otev≈ô√≠t 1√ó za <span class="font-semibold text-amber-200">2 hodiny</span>.</span>
            `;
            updateButtonState();
            return;
          }
          cooldownInfoEl.classList.remove("hidden");
          countdownEl.textContent = formatTime(remaining);
          statusEl.innerHTML = `
            <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-sky-500/20 text-sky-300">
              ‚óè
            </span>
            <span>Mystery Box je v cooldownu.</span>
          `;
          updateButtonState();
        }

        tick();
        cooldownTimer = setInterval(tick, 1000);
      }

      function isOnCooldown() {
        return getRemainingCooldownMs() > 0;
      }

      function hasEnoughCredits() {
        if (!window.creditSys || typeof creditSys.getCredits !== "function") {
          console.warn("MysteryBox: creditSys.getCredits nen√≠ dostupn√©.");
          return true;
        }
        try {
          const current = creditSys.getCredits();
          return typeof current === "number" ? current >= COST : true;
        } catch (e) {
          console.warn("MysteryBox: chyba p≈ôi ƒçten√≠ kredit≈Ø:", e);
          return true;
        }
      }

      function updateButtonState() {
        const onCd = isOnCooldown();
        const enough = hasEnoughCredits();
        btn.disabled = onCd || isOpening || !enough;

        if (!enough) {
          errorEl.textContent = "Nem√°≈° dostatek K-Coins na otev≈ôen√≠ Mystery Boxu.";
        } else if (onCd) {
          errorEl.textContent = "Mystery Box p≈Øjde otev≈ô√≠t a≈æ po skonƒçen√≠ cooldownu.";
        } else {
          errorEl.textContent = "";
        }
      }

      function pickReward() {
        const roll = Math.random() * 100;
        let acc = 0;
        for (const r of rewards) {
          acc += r.chance;
          if (roll <= acc) return r;
        }
        return rewards[0];
      }

      function applyReward(reward) {
        if (!reward) return;

        if (reward.type === "coins") {
          if (window.creditSys && typeof creditSys.addCredits === "function") {
            try {
              creditSys.addCredits(reward.amount);
            } catch (e) {
              console.warn("MysteryBox: chyba p≈ôi p≈ôid√°v√°n√≠ kredit≈Ø:", e);
            }
          }
          rewardTextEl.textContent = reward.label;
          rewardDescEl.textContent = `Na tvoje konto jsme p≈ôidali ${reward.amount} K-Coins.`;
        } else if (reward.type === "vip") {
          if (window.creditSys && typeof creditSys.addVipDays === "function") {
            try {
              creditSys.addVipDays(reward.days);
            } catch (e) {
              console.warn("MysteryBox: chyba p≈ôi p≈ôid√°v√°n√≠ VIP dne:", e);
            }
          }
          rewardTextEl.textContent = reward.label;
          rewardDescEl.textContent = `Z√≠sk√°v√°≈° VIP p≈ô√≠stup na ${reward.days} den. V√Ωhody se projev√≠ ve VIP sekci.`;
        } else if (reward.type === "coupon") {
          rewardTextEl.textContent = reward.label;
          rewardDescEl.textContent =
            "Z√≠skal jsi slevu 10 %. Kupon ti zobraz√≠me v sekci ‚ÄûMoje odmƒõny‚Äú. (Napoj√≠me na backend.)";
        }
      }

      function createConfetti() {
        if (!confettiContainer) return;
        confettiContainer.innerHTML = "";

        const colors = [
          "rgb(251,191,36)",
          "rgb(56,189,248)",
          "rgb(244,114,182)",
          "rgb(52,211,153)",
        ];

        const pieces = 40;
        for (let i = 0; i < pieces; i++) {
          const el = document.createElement("div");
          el.className = "confetti-piece";
          const left = Math.random() * 100;
          const delay = Math.random() * 0.4;
          const xOffset = (Math.random() - 0.5) * 120;

          el.style.left = `${left}%`;
          el.style.top = "-20px";
          el.style.backgroundColor = colors[i % colors.length];
          el.style.animationDelay = `${delay}s`;
          el.style.setProperty("--confetti-x", `${xOffset}px`);

          confettiContainer.appendChild(el);
        }
      }

      function openModal() {
        if (!modal) return;
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        createConfetti();
      }

      function closeModal() {
        if (!modal) return;
        modal.classList.add("hidden");
        modal.classList.remove("flex");
        if (confettiContainer) confettiContainer.innerHTML = "";
      }

      function trySubtractCredits() {
        if (!window.creditSys || typeof creditSys.subtractCredits !== "function") {
          alert("Kreditn√≠ syst√©m nen√≠ napojen√Ω (creditSys.subtractCredits chyb√≠). Mystery Box jede zat√≠m jen vizu√°lnƒõ.");
          return true;
        }

        if (!hasEnoughCredits()) {
          errorEl.textContent = "Nem√°≈° dostatek K-Coins na otev≈ôen√≠ Mystery Boxu.";
          return false;
        }

        try {
          creditSys.subtractCredits(COST);
          return true;
        } catch (e) {
          console.warn("MysteryBox: chyba p≈ôi odeƒç√≠t√°n√≠ kredit≈Ø:", e);
          errorEl.textContent = "Nepoda≈ôilo se odeƒç√≠st kredity. Zkus to pros√≠m znovu.";
          return false;
        }
      }

      // üß® RESET COOLDOWNU
      function resetMysteryBoxCooldown() {
        localStorage.removeItem(STORAGE_KEY);

        if (cooldownTimer) clearInterval(cooldownTimer);
        cooldownTimer = null;

        cooldownInfoEl.classList.add("hidden");
        statusEl.innerHTML = `
          <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-emerald-500/20 text-emerald-300">
            ‚óè
          </span>
          <span>Mystery Box m≈Ø≈æe≈° otev≈ô√≠t okam≈æitƒõ.</span>
        `;

        errorEl.textContent = "";
        updateButtonState();
      }

      function handleOpenClick() {
        if (isOpening) return;
        errorEl.textContent = "";

        if (isOnCooldown()) {
          errorEl.textContent = "Mystery Box je v cooldownu. Poƒçkej, ne≈æ odpoƒçet dobƒõhne.";
          return;
        }

        if (!hasEnoughCredits()) {
          errorEl.textContent = "Nem√°≈° dostatek K-Coins na otev≈ôen√≠ Mystery Boxu.";
          return;
        }

        const ok = trySubtractCredits();
        if (!ok) return;

        isOpening = true;
        updateButtonState();

        boxVisual.classList.add("mystery-box-opening");

        setTimeout(() => {
          boxVisual.classList.remove("mystery-box-opening");

          const reward = pickReward();
          applyReward(reward);
          setLastOpenTime();
          startCooldownTimer();
          openModal();

          isOpening = false;
          updateButtonState();
        }, 1000);
      }

      // Listeners
      btn.addEventListener("click", handleOpenClick);
      boxVisual.addEventListener("click", handleOpenClick);

      if (modalCloseBtn) modalCloseBtn.addEventListener("click", closeModal);
      if (modalOkBtn) modalOkBtn.addEventListener("click", closeModal);
      if (modal) {
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            closeModal();
          }
        });
      }

      if (resetBtn) {
        resetBtn.addEventListener("click", () => {
          resetMysteryBoxCooldown();
          alert("Mystery Box cooldown byl resetov√°n (ADMIN test).");
        });
      }

      // Inicializace
      (function init() {
        if (isOnCooldown()) {
          startCooldownTimer();
        } else {
          updateButtonState();
        }
      })();
    })();
  </script>
</body>
</html>
