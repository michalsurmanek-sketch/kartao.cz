<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Kreditn√≠ho Syst√©mu</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100">
    <div class="max-w-4xl mx-auto p-6">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                <i data-lucide="bug" class="w-8 h-8 mr-3 text-red-600"></i>
                Debug Kreditn√≠ho Syst√©mu
            </h1>

            <!-- System Status -->
            <div class="grid md:grid-cols-2 gap-6 mb-8">
                <!-- Firebase Status -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h3 class="font-semibold text-blue-800 mb-3 flex items-center">
                        <i data-lucide="database" class="w-5 h-5 mr-2"></i>
                        Firebase Status
                    </h3>
                    <div id="firebaseStatus" class="text-sm space-y-2"></div>
                </div>

                <!-- User Status -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h3 class="font-semibold text-green-800 mb-3 flex items-center">
                        <i data-lucide="user" class="w-5 h-5 mr-2"></i>
                        U≈æivatel
                    </h3>
                    <div id="userStatus" class="text-sm space-y-2"></div>
                    <button id="refreshUser" class="mt-3 bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                        Aktualizovat
                    </button>
                </div>
            </div>

            <!-- Actions -->
            <div class="grid md:grid-cols-3 gap-4 mb-6">
                <button id="testWatchAd" class="bg-red-600 text-white px-4 py-3 rounded-lg hover:bg-red-700 transition-colors disabled:bg-gray-400">
                    üé¨ Test Reklama (+5 kredit≈Ø)
                </button>
                <button id="testShare" class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400">
                    üì§ Test Sd√≠len√≠ (+15 kredit≈Ø)
                </button>
                <button id="testCheckIn" class="bg-purple-600 text-white px-4 py-3 rounded-lg hover:bg-purple-700 transition-colors disabled:bg-gray-400">
                    üéØ Test Check-in (+10 kredit≈Ø)
                </button>
            </div>

            <!-- Console Log -->
            <div class="bg-gray-900 text-green-400 rounded-lg p-4 font-mono text-sm max-h-96 overflow-y-auto">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-white font-bold">Debug Console:</span>
                    <button id="clearLog" class="bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-xs">Clear</button>
                </div>
                <div id="debugLog"></div>
            </div>

            <!-- Back to main -->
            <div class="mt-6 text-center">
                <a href="credits-unified.html" class="inline-flex items-center px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                    <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
                    Zpƒõt na hlavn√≠ dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Include required scripts -->
    <script src="firebase-init.js"></script>
    <script src="credits-system-unified.js"></script>

    <script>
        // Initialize
        lucide.createIcons();
        let creditsSystem;
        let currentUser = null;

        // Console override for debugging
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info
        };

        function addToDebugLog(type, ...args) {
            const timestamp = new Date().toLocaleTimeString('cs-CZ');
            const logEntry = document.createElement('div');
            
            let color = 'text-green-400';
            let prefix = '[LOG]';
            
            if (type === 'error') {
                color = 'text-red-400';
                prefix = '[ERROR]';
            } else if (type === 'warn') {
                color = 'text-yellow-400';
                prefix = '[WARN]';
            } else if (type === 'info') {
                color = 'text-blue-400';
                prefix = '[INFO]';
            }
            
            logEntry.className = color;
            logEntry.innerHTML = `<span class="text-gray-400">[${timestamp}]</span> ${prefix} ${args.join(' ')}`;
            
            const debugLog = document.getElementById('debugLog');
            debugLog.appendChild(logEntry);
            debugLog.scrollTop = debugLog.scrollHeight;
            
            // Also call original console
            originalConsole[type](...args);
        }

        // Override console methods
        console.log = (...args) => addToDebugLog('log', ...args);
        console.error = (...args) => addToDebugLog('error', ...args);
        console.warn = (...args) => addToDebugLog('warn', ...args);
        console.info = (...args) => addToDebugLog('info', ...args);

        // Initialize system
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Spou≈°t√≠m debug kreditn√≠ho syst√©mu...');
            
            try {
                // Check Firebase availability
                updateFirebaseStatus();
                
                // Initialize credits system
                creditsSystem = new UnifiedCreditsSystem();
                await creditsSystem.init();
                console.log('‚úÖ Kreditn√≠ syst√©m inicializov√°n');

                // Setup Firebase auth listener
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    firebase.auth().onAuthStateChanged(async (user) => {
                        console.log('Firebase auth zmƒõna:', user ? `${user.email} (${user.uid})` : 'odhl√°≈°en');
                        currentUser = user;
                        await updateUserStatus();
                    });
                } else {
                    console.warn('‚ö†Ô∏è Firebase auth nen√≠ dostupn√Ω');
                }

                setupEventListeners();
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi inicializaci:', error);
            }
        });

        function setupEventListeners() {
            // Clear log button
            document.getElementById('clearLog').addEventListener('click', () => {
                document.getElementById('debugLog').innerHTML = '';
            });

            // Refresh user button
            document.getElementById('refreshUser').addEventListener('click', async () => {
                await updateUserStatus();
            });

            // Test buttons
            document.getElementById('testWatchAd').addEventListener('click', async () => {
                await testCredits('WATCH_AD', 'Sledov√°n√≠ reklamy');
            });

            document.getElementById('testShare').addEventListener('click', async () => {
                await testCredits('SHARE_POST', 'Sd√≠len√≠ p≈ô√≠spƒõvku');
            });

            document.getElementById('testCheckIn').addEventListener('click', async () => {
                await testCheckIn();
            });
        }

        async function testCredits(taskType, description) {
            if (!currentUser) {
                console.error('‚ùå Nen√≠ p≈ôihl√°≈°en√Ω u≈æivatel');
                return;
            }

            console.log(`üß™ Testuji ${description} (${taskType})...`);
            
            try {
                const result = await creditsSystem.addCredits(currentUser.uid, taskType, {
                    source: 'debug_test',
                    timestamp: new Date().toISOString()
                });

                if (result && result.success) {
                    console.log(`‚úÖ ${description} √∫spƒõ≈°n√©! +${result.creditsEarned} kredit≈Ø`);
                    console.log('üìä Nov√Ω z≈Østatek:', result.newBalance);
                    await updateUserStatus();
                } else {
                    console.error(`‚ùå ${description} selhalo:`, result?.message || 'Nezn√°m√° chyba');
                }
            } catch (error) {
                console.error(`üí• Chyba p≈ôi ${description}:`, error.message);
            }
        }

        async function testCheckIn() {
            if (!currentUser) {
                console.error('‚ùå Nen√≠ p≈ôihl√°≈°en√Ω u≈æivatel');
                return;
            }

            console.log('üß™ Testuji denn√≠ check-in...');
            
            try {
                const result = await creditsSystem.dailyCheckIn(currentUser.uid);

                if (result && result.success) {
                    console.log(`‚úÖ Check-in √∫spƒõ≈°n√Ω! +${result.creditsEarned} kredit≈Ø`);
                    console.log('üî• Streak:', result.streakDays, 'dn√≠');
                    await updateUserStatus();
                } else {
                    console.error('‚ùå Check-in selhal:', result?.message || 'Nezn√°m√° chyba');
                }
            } catch (error) {
                console.error('üí• Chyba p≈ôi check-in:', error.message);
            }
        }

        function updateFirebaseStatus() {
            const statusDiv = document.getElementById('firebaseStatus');
            
            let status = [];
            
            // Check Firebase app
            if (typeof firebase !== 'undefined') {
                status.push('‚úÖ Firebase SDK naƒçten');
                
                // Check auth
                if (firebase.auth) {
                    status.push('‚úÖ Firebase Auth dostupn√Ω');
                } else {
                    status.push('‚ùå Firebase Auth nedostupn√Ω');
                }
                
                // Check firestore
                if (firebase.firestore) {
                    status.push('‚úÖ Firestore dostupn√Ω');
                } else {
                    status.push('‚ùå Firestore nedostupn√Ω');
                }
            } else {
                status.push('‚ùå Firebase SDK nenaƒçten');
            }

            // Check demo auth
            status.push('‚ÑπÔ∏è Demo Auth odebr√°n - pouze ostr√Ω provoz');

            statusDiv.innerHTML = status.map(s => `<div>${s}</div>`).join('');
        }

        async function updateUserStatus() {
            const statusDiv = document.getElementById('userStatus');
            
            if (!currentUser) {
                statusDiv.innerHTML = '<div class="text-red-600">‚ùå Nep≈ôihl√°≈°en√Ω u≈æivatel</div>';
                toggleButtons(false);
                return;
            }

            try {
                console.log('üîç Aktualizuji status u≈æivatele...');
                
                // Get user role
                const role = await creditsSystem.getUserRole(currentUser.uid);
                console.log('üë§ Role u≈æivatele:', role);
                
                // Get credits if creator
                let credits = null;
                if (role === 'tvurce') {
                    credits = await creditsSystem.getUserCredits(currentUser.uid);
                    console.log('üí∞ Kredity u≈æivatele:', credits);
                }

                let status = [];
                status.push(`‚úÖ P≈ôihl√°≈°en: ${currentUser.email}`);
                status.push(`üÜî UID: ${currentUser.uid}`);
                status.push(`üë§ Role: ${role || 'nezn√°m√°'}`);
                
                if (credits) {
                    status.push(`üí∞ Kredity: ${credits.balance || 0}`);
                    status.push(`üìà Level: ${credits.level || 1} (${credits.levelName || 'N/A'})`);
                    status.push(`üî• Streak: ${credits.streakDays || 0} dn√≠`);
                    status.push(`üìä Celkem: ${credits.totalEarned || 0}`);
                }

                statusDiv.innerHTML = status.map(s => `<div>${s}</div>`).join('');
                toggleButtons(role === 'tvurce');
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi aktualizaci u≈æivatele:', error);
                statusDiv.innerHTML = `<div class="text-red-600">‚ùå Chyba: ${error.message}</div>`;
                toggleButtons(false);
            }
        }

        function toggleButtons(enabled) {
            ['testWatchAd', 'testShare', 'testCheckIn'].forEach(id => {
                document.getElementById(id).disabled = !enabled;
            });
        }
    </script>
</body>
</html>